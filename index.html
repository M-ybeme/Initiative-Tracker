<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Initiative Tracker</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <link href="/css/site.css" rel="stylesheet" />
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />
  <style>
    .bgimage{ background:url('images/BGMap.png') no-repeat center center fixed; background-size:cover; }
    .bg-orange{ background-color:#fd7e14 !important; color:#212529 !important; }
    .drag-handle{ cursor:move; }
    .active-turn{ border-left:5px solid #1d9e6d !important; color:#f8f9fa !important; font-weight:bold; }
    #saveHistorySelect{ min-width:200px; }

    /* Compact status icon row */
    .status-icon-row{ display:flex; flex-wrap:wrap; gap:.25rem; align-items:center; }
    .status-chip{ font-size:1rem; line-height:1; }
    .status-chip[data-remaining]:after{
      content: attr(data-remaining);
      display:inline-block; font-size:.7rem; margin-left:.15rem; opacity:.8;
    }
    .conc-btn{ border:1px dashed rgba(255,255,255,.3); }
    .conc-on{ border-color:#ffc107; color:#ffc107; }
    .hp-controls .btn{ padding:.1rem .35rem; line-height:1; }

    /* Sticky table header for long lists */
    table thead th{ position:sticky; top:0; background:#1a1d20; z-index:1; }

    @media (max-width:576px){
      .btn,.form-control{ padding:.6rem .8rem; font-size:1rem; }
      .table td,.table th{ padding:.6rem .5rem; }
    }

    .notes-cell {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    .notes-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .status-icons {
      display: flex;
      gap: 0.25rem;
      flex-wrap: wrap;
      font-size: 1rem;
    }
    .status-icons span {
      cursor: default;
    }
  </style>
</head>
<body class="bgimage">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"><i class="bi bi-list"></i></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="index.html">Initiative</a></li>
          <li class="nav-item"><a class="nav-link" href="name.html">Name Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="loot.html">Loot Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="npc.html">NPC Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="tav.html">Tavern/Inn Gen</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="content pt-3">
    <div class="container-fluid text-center backdrop">
      <h1 class="display-1 mb-0">Initiative Tracker</h1>
      <p class="lead">Manage initiative, health, AC, notes, status effects, and combat rounds.</p>

      <div class="row g-3 align-items-center justify-content-center my-2">
        <div class="col-12 col-lg-7 d-flex flex-wrap gap-2 justify-content-center">
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked>
            <label class="form-check-label" for="autoSaveToggle">Auto-Save</label>
          </div>

          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="lockOrderToggle">
            <label class="form-check-label" for="lockOrderToggle">Lock Order</label>
          </div>

          <button id="manualSaveBtn" class="btn btn-outline-success">Manual Save</button>
          <button id="copyOrderBtn" class="btn btn-outline-light">Copy Turn Order</button>

          <select id="saveHistorySelect" class="form-select form-select-sm w-auto">
            <option disabled selected>Load Previous Save</option>
          </select>

          <input type="file" id="import-file" accept=".json" class="d-none" />
          <button id="export-btn" class="btn btn-outline-warning">Export Session</button>
          <button id="import-btn" class="btn btn-outline-secondary">Import Session</button>
        </div>
      </div>

      <form id="initiative-form" class="mb-4">
        <div class="row g-2 justify-content-center">
          <div class="col-12 col-md-3"><input id="character-name" class="form-control" type="text" placeholder="Character Name" required></div>
          <div class="col-6 col-md-2"><input id="initiative-roll" class="form-control" type="number" placeholder="Initiative" required></div>
          <div class="col-6 col-md-2"><input id="character-health" class="form-control" type="number" placeholder="Max HP" required></div>
          <div class="col-6 col-md-2"><input id="character-ac" class="form-control" type="number" placeholder="AC" required></div>
          <div class="col-6 col-md-2"><input id="character-notes" class="form-control" type="text" placeholder="Notes (optional)"></div>
          <div class="col-12 col-md-1"><button class="btn btn-outline-success w-100" type="submit">Add</button></div>
        </div>
      </form>

      <h2>Combat Round: <span id="combat-round">1</span></h2>

      <!-- Dice Roller -->
      <div class="my-4 text-light">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
          <button class="btn btn-outline-info dice-btn" data-dice="4">Roll d4</button>
          <button class="btn btn-outline-info dice-btn" data-dice="6">Roll d6</button>
          <button class="btn btn-outline-info dice-btn" data-dice="8">Roll d8</button>
          <button class="btn btn-outline-info dice-btn" data-dice="10">Roll d10</button>
          <button class="btn btn-outline-info dice-btn" data-dice="12">Roll d12</button>
          <button class="btn btn-outline-info dice-btn" data-dice="20">Roll d20</button>
          <button class="btn btn-outline-info dice-btn" data-dice="100">Roll d100</button>
        </div>
        <div class="mt-3">
          <label for="custom-dice-input" class="form-label">Custom Roll:</label>
          <div class="input-group w-auto mx-auto">
            <input id="custom-dice-input" type="text" class="form-control form-control-sm" placeholder="e.g. 2d6+3">
            <button id="roll-custom-dice" class="btn btn-outline-warning btn-sm">Roll</button>
          </div>
        </div>
        <div class="text-light mt-2" id="dice-result" style="font-size: 1.25rem;"></div>
        <div class="mt-3">
          <button class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#dice-history">Toggle Roll History</button>
          <button class="btn btn-outline-danger btn-sm" id="clear-dice-history">Clear Dice History</button>
          <div class="collapse mt-2" id="dice-history">
            <div class="card card-body bg-dark text-light" id="dice-history-log" style="max-height: 200px; overflow-y: auto;"></div>
          </div>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-striped text-light align-middle">
            <thead>
              <tr>
                <th></th>
                <th>Turn</th>
                <th>Character</th>
                <th>Initiative</th>
                <th>AC</th>
                <th>Health</th>
                <th>Notes & Effects</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="initiative-order"></tbody>
          </table>
        </div>
      </div>

      <!-- Mobile Cards -->
      <div id="mobile-initiative-order" class="d-block d-md-none"></div>

      <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
        <button id="next-turn" class="btn btn-outline-success">Next Turn</button>
        <button id="reset-turns" class="btn btn-outline-danger">Reset Rounds</button>
        <button id="clear-all" class="btn btn-outline-light">Clear All</button>
        <button id="clear-storage" class="btn btn-outline-warning">Clear Saved Data</button>
        <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#sessionNotes" aria-controls="sessionNotes">
          <i class="bi bi-journal-text me-1"></i> Session Notes
        </button>
      </div>
    </div>
  </main>

  <!-- Status Modal -->
  <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="statusModalLabel">Edit Status Effects</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Current effects -->
          <div id="status-badges" class="mb-3 d-flex flex-wrap gap-2"></div>

          <!-- Add effect -->
          <div class="input-group mb-2">
            <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Add Effect
            </button>
            <ul class="dropdown-menu dropdown-menu-dark" id="status-dropdown-list"></ul>
            <input id="status-duration" type="number" min="0" class="form-control" placeholder="Duration (rounds, optional)">
            <button id="add-status-btn" class="btn btn-outline-success">Add</button>
          </div>
          <div class="form-text text-secondary">Leave duration blank for indefinite effects. Effects with a duration tick down each new round.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Session Notes Offcanvas -->
  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="sessionNotes" aria-labelledby="sessionNotesLabel">
    <div class="offcanvas-header">
      <h5 id="sessionNotesLabel">Session Notes</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <textarea id="session-notes" class="form-control mb-3" rows="10" placeholder="Enter your session notes..."></textarea>
      <div class="d-flex justify-content-between gap-2">
        <button id="save-notes" class="btn btn-outline-success w-100">Save</button>
        <button id="export-notes" class="btn btn-outline-warning w-100">Export</button>
        <button id="import-notes" class="btn btn-outline-secondary w-100">Import</button>
      </div>
      <input type="file" id="import-notes-file" class="d-none" accept=".txt,.md,.json" />
    </div>
  </div>

  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="row footer-main">
      <div class="col">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-12 col-md-4 text-md-start text-center order-last order-md-first">
              &copy; 2025 Marlo Mayberry
            </div>
            <div class="col-12 col-md-4 text-center">
              <img src="/images/White logo - no background.png" height="50" alt="logo">
            </div>
            <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end">
              <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener"><i class="bi bi-linkedin p-2"></i></a>
              <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener"><i class="bi bi-github p-2"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
  (()=>{
    const $ = (id) => document.getElementById(id);

    // ---------- Notes autosave ----------
    const notesKey = 'sessionNotes';
    function loadNotes(){ const s = localStorage.getItem(notesKey); if(s) $('session-notes').value = s; }
    function saveNotes(){ localStorage.setItem(notesKey, $('session-notes').value); }
    document.addEventListener('DOMContentLoaded', loadNotes);
    $('session-notes').addEventListener('input', saveNotes);
    $('save-notes').addEventListener('click', ()=>{ saveNotes(); alert('Notes saved.'); });
    $('export-notes').addEventListener('click', ()=>{
      const blob = new Blob([$('session-notes').value], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`session_notes_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('import-notes').addEventListener('click', ()=> $('import-notes-file').click());
    $('import-notes-file').addEventListener('change', function(){
      const f=this.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = e => { $('session-notes').value = e.target.result; saveNotes(); alert('Notes imported.'); };
      r.readAsText(f); this.value='';
    });

    // ---------- Status palette ----------
    const statusEffects = [
      { name:'Blinded', icon:'üëÅÔ∏è' }, { name:'Exhaustion', icon:'üí§' }, { name:'Incapacitated', icon:'üò¥' },
      { name:'Petrified', icon:'ü™®' }, { name:'Restrained', icon:'ü™¢' }, { name:'Charmed', icon:'üîÆ' },
      { name:'Frightened', icon:'üò±' }, { name:'Invisible', icon:'üîé' }, { name:'Poisoned', icon:'‚ò†Ô∏è' },
      { name:'Unconscious', icon:'üò™' }, { name:'Deafened', icon:'üîà' }, { name:'Grappled', icon:'ü§º‚Äç‚ôÇÔ∏è' },
      { name:'Paralyzed', icon:'üîê' }, { name:'Prone', icon:'üõå' }
    ];

    // ---------- State ----------
    let characters = [];
    let currentTurn = 0;
    let combatRound = 1;
    let autoSaveEnabled = true;
    let diceHistory = [];
    let modalCharacterIndex = null;
    const statusModal = new bootstrap.Modal(document.getElementById('statusModal'));

    // ---------- Persistence ----------
    function saveState(manual=false){
      const key = manual ? `initiativeTrackerData_${new Date().toISOString()}` : 'initiativeTrackerData';
      const payload = { characters, currentTurn, combatRound, diceHistory };
      localStorage.setItem(key, JSON.stringify(payload));
      if (manual) updateSaveHistory();
    }
    function loadState(){
      const raw = localStorage.getItem('initiativeTrackerData');
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        characters = (data.characters||[]).map(c => normalizeChar(c));
        currentTurn = data.currentTurn||0;
        combatRound = data.combatRound||1;
        diceHistory = Array.isArray(data.diceHistory) ? data.diceHistory : [];
      }catch(e){ console.warn('Load failed', e); }
    }
    function normalizeChar(c){
      return {
        name: c.name,
        initiative: c.initiative|0,
        currentHP: c.currentHP|0,
        maxHP: c.maxHP|0,
        ac: (c.ac ?? null),
        notes: c.notes||'',
        concentration: !!c.concentration,
        status: (c.status||[]).map(s => typeof s==='string'
          ? { name:s, icon:(statusEffects.find(e=>e.name===s)?.icon||'‚ùì') }
          : { name:s.name, icon:s.icon||(statusEffects.find(e=>e.name===s.name)?.icon||'‚ùì'), remaining: (s.remaining ?? undefined) })
      };
    }

    // ---------- UI Helpers ----------
    function hpClass(percent){
      if (percent <= 0) return 'bg-secondary text-light text-decoration-line-through';
      if (percent <= 25) return 'bg-danger text-light';
      if (percent <= 50) return 'bg-warning text-dark';
      if (percent <= 75) return 'bg-orange text-dark';
      return 'bg-success text-light';
    }
    function maybeSortByInitiative(){
      if ($('lockOrderToggle')?.checked) return;
      characters.sort((a,b)=> b.initiative - a.initiative);
    }
    function buildDiceHistory(){
      const wrap = $('dice-history-log'); wrap.innerHTML='';
      diceHistory.forEach(entry=>{
        const div = document.createElement('div');
        div.className = 'border-bottom pb-1 mb-1';
        div.innerHTML = `<strong>${entry.timestamp}</strong>: ${entry.text}`;
        wrap.appendChild(div);
      });
    }
    function addToHistory(text){
      diceHistory.unshift({ text, timestamp: new Date().toLocaleTimeString() });
      buildDiceHistory();
      if (autoSaveEnabled) saveState();
    }
    function statusTooltipText(c){
      const parts = [];
      if (c.concentration) parts.push('Concentration: ON');
      if (c.status.length){
        parts.push('Effects:');
        c.status.forEach(s=>{
          if (typeof s.remaining === 'number') parts.push(`- ${s.name} (${s.remaining})`);
          else parts.push(`- ${s.name}`);
        });
      }else{
        parts.push('Effects: none');
      }
      return parts.join('\n');
    }

    // ---------- Build UI ----------
    function buildTable(){
      $('combat-round').textContent = combatRound;
      const tableBody = $('initiative-order');
      const mobileBody = $('mobile-initiative-order');
      tableBody.innerHTML = '';
      mobileBody.innerHTML = '';

      characters.forEach((c,i)=>{
        const pct = Math.round((c.currentHP / c.maxHP) * 100);

        // --- Desktop row ---
        const tr = document.createElement('tr');
        if (i === currentTurn) tr.classList.add('active-turn');
        tr.innerHTML = `
          <td class="drag-handle"><i class="bi bi-grip-vertical"></i></td>
          <td>${i===currentTurn ? '<i class="bi bi-caret-right-fill"></i>' : ''}</td>
          <td class="${pct<=0 ? 'text-decoration-line-through' : ''}">
            ${c.name}
            ${c.concentration ? '<span class="ms-1 text-warning" title="Concentration"><i class="bi bi-star-fill"></i></span>' : ''}
          </td>
          <td>
            <input type="number" class="form-control form-control-sm init-input" value="${c.initiative}" data-index="${i}" data-commit="init">
          </td>
          <td>${c.ac ?? '-'}</td>
          <td>
            <div class="d-flex align-items-center">
              <input type="number" class="form-control form-control-sm health-input ${hpClass(pct)}" value="${c.currentHP}" data-index="${i}" style="max-width:6rem">
              <div class="btn-group btn-group-sm ms-1 hp-controls" role="group">
                <button class="btn btn-outline-light hit-btn" data-delta="-5" data-index="${i}">-5</button>
                <button class="btn btn-outline-light hit-btn" data-delta="-1" data-index="${i}">-1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="1" data-index="${i}">+1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="5" data-index="${i}">+5</button>
              </div>
            </div>
          </td>
          <td>
            <div class="text-start">
              <input type="text" class="form-control form-control-sm notes-input mb-1" placeholder="Notes..." value="${c.notes}" data-index="${i}">
              <div class="d-flex align-items-center justify-content-between">
                <div class="status-icon-row"
                  data-bs-toggle="tooltip"
                  data-bs-placement="top"
                  title="${statusTooltipText(c)}">
                  ${c.status.map(s=>{
                    const rem = (typeof s.remaining==='number') ? ` data-remaining="${s.remaining}"` : '';
                    return `<span class="status-chip" ${rem} title="${s.name}">${s.icon}</span>`;
                  }).join('')}
                </div>
                <div class="d-flex align-items-center gap-1">
                  <button class="btn btn-sm conc-btn ${c.concentration?'conc-on':''}" title="Toggle Concentration" data-index="${i}">
                    <i class="bi ${c.concentration?'bi-star-fill':'bi-star'}"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-info status-btn" data-index="${i}" title="Edit Status"><i class="bi bi-emoji-smile"></i></button>
                </div>
              </div>
            </div>
          </td>
          <td class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-success duplicate-btn" data-index="${i}" title="Duplicate"><i class="bi bi-files"></i></button>
            <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}" title="Delete"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tableBody.appendChild(tr);

        // --- Mobile card ---
        const card = document.createElement('div');
        card.className = 'card mb-2 text-start';
        if (i === currentTurn) card.classList.add('border-success');
        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title mb-1">
              ${c.name}
              <small class="text-muted">(${c.initiative} Init, AC ${c.ac ?? '-'})</small>
              ${c.concentration ? '<span class="ms-1 text-warning" title="Concentration"><i class="bi bi-star-fill"></i></span>' : ''}
            </h5>
            <div class="mb-1">HP:
              <input type="number" class="form-control form-control-sm health-input ${hpClass(pct)} d-inline-block" style="max-width:6rem" value="${c.currentHP}" data-index="${i}">
              <div class="btn-group btn-group-sm ms-1 hp-controls">
                <button class="btn btn-outline-light hit-btn" data-delta="-5" data-index="${i}">-5</button>
                <button class="btn btn-outline-light hit-btn" data-delta="-1" data-index="${i}">-1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="1" data-index="${i}">+1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="5" data-index="${i}">+5</button>
              </div>
            </div>
            <div class="mb-1">Notes:
              <input type="text" class="form-control form-control-sm notes-input d-inline-block" style="max-width:100%" value="${c.notes}" data-index="${i}">
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <div class="status-icon-row"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                title="${statusTooltipText(c)}">
                ${c.status.map(s=>{
                  const rem = (typeof s.remaining==='number') ? ` data-remaining="${s.remaining}"` : '';
                  return `<span class="status-chip" ${rem} title="${s.name}">${s.icon}</span>`;
                }).join('')}
              </div>
              <div class="d-flex align-items-center gap-1">
                <button class="btn btn-sm conc-btn ${c.concentration?'conc-on':''}" title="Toggle Concentration" data-index="${i}">
                  <i class="bi ${c.concentration?'bi-star-fill':'bi-star'}"></i>
                </button>
                <button class="btn btn-sm btn-outline-info status-btn" data-index="${i}" title="Edit Status"><i class="bi bi-emoji-smile"></i></button>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-2 gap-1">
              <button class="btn btn-sm btn-outline-light move-up" data-index="${i}"><i class="bi bi-arrow-up"></i></button>
              <button class="btn btn-sm btn-outline-light move-down" data-index="${i}"><i class="bi bi-arrow-down"></i></button>
              <button class="btn btn-sm btn-outline-success duplicate-btn" data-index="${i}"><i class="bi bi-files"></i></button>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        `;
        mobileBody.appendChild(card);
      });

      // Tooltips (re-init each build)
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el, { trigger: 'hover', html: false });
      });

      // Wire inputs (HP)
      document.querySelectorAll('.hit-btn').forEach(b=>{
        b.addEventListener('click', function(){
          const idx = +this.dataset.index;
          const delta = +this.dataset.delta;
          const c = characters[idx];
          c.currentHP = Math.max(0, Math.min(c.maxHP, (c.currentHP|0) + delta));
          buildTable();
        });
      });
      document.querySelectorAll('.health-input').forEach(inp=>{
        inp.addEventListener('input', function(){
          const idx = +this.dataset.index;
          characters[idx].currentHP = parseInt(this.value,10) || 0;
          buildTable();
        });
      });

      // Initiative (commit to edit)
      document.querySelectorAll('.init-input[data-commit="init"]').forEach(inp=>{
        let original = inp.value;
        const idx = +inp.dataset.index;
        function commit(){
          const val = parseInt(inp.value,10) || 0;
          characters[idx].initiative = val;
          maybeSortByInitiative();
          buildTable();
        }
        inp.addEventListener('keydown', e=>{
          if (e.key === 'Enter') { e.preventDefault(); commit(); }
          if (e.key === 'Escape') { inp.value = original; inp.blur(); }
        });
        inp.addEventListener('focus', ()=> { original = inp.value; });
        inp.addEventListener('blur', commit);
      });

      // Notes
      document.querySelectorAll('.notes-input').forEach(inp=>{
        inp.addEventListener('input', function(){ characters[this.dataset.index].notes = this.value; if (autoSaveEnabled) saveState(); });
      });

      // Concentration toggle
      document.querySelectorAll('.conc-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          characters[idx].concentration = !characters[idx].concentration;
          buildTable();
        });
      });

      // Status Modal open
      document.querySelectorAll('.status-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          modalCharacterIndex = +this.dataset.index;
          openStatusModal(modalCharacterIndex);
        });
      });

      // Duplicate/Delete
      document.querySelectorAll('.duplicate-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          const copy = JSON.parse(JSON.stringify(characters[idx]));
          copy.name += ' (copy)';
          characters.splice(idx+1, 0, copy);
          buildTable();
        });
      });
      document.querySelectorAll('.delete-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          characters.splice(idx,1);
          if (currentTurn >= characters.length) currentTurn = 0;
          if (!characters.length) combatRound = 1;
          buildTable();
        });
      });

      // Mobile up/down
      document.querySelectorAll('.move-up').forEach(btn=>{
        btn.addEventListener('click', function(){
          const i = +this.dataset.index; if (i<=0) return;
          [characters[i-1], characters[i]] = [characters[i], characters[i-1]];
          buildTable();
        });
      });
      document.querySelectorAll('.move-down').forEach(btn=>{
        btn.addEventListener('click', function(){
          const i = +this.dataset.index; if (i>=characters.length-1) return;
          [characters[i+1], characters[i]] = [characters[i], characters[i+1]];
          buildTable();
        });
      });

      // Sortable (desktop)
      new Sortable($('initiative-order'), {
        handle: '.drag-handle', animation: 150,
        onEnd: function(evt){
          const [moved] = characters.splice(evt.oldIndex,1);
          characters.splice(evt.newIndex,0,moved);
          buildTable();
        }
      });

      buildDiceHistory();
      if (autoSaveEnabled) saveState();
    }

    // ---------- Status Modal logic ----------
    function openStatusModal(i){
      const c = characters[i];
      // badges
      const badges = $('status-badges'); badges.innerHTML = '';
      c.status.forEach(s=>{
        const span = document.createElement('span');
        const rem = typeof s.remaining==='number' ? ` (${s.remaining})` : '';
        span.className = 'badge bg-secondary px-2 py-1';
        span.innerHTML = `${s.icon} ${s.name}${rem}
          <i class="bi bi-x ms-1 remove-status" data-eff="${s.name}" role="button" title="Remove"></i>`;
        badges.appendChild(span);
      });
      badges.querySelectorAll('.remove-status').forEach(x=>{
        x.addEventListener('click', function(){
          const eff = this.dataset.eff;
          c.status = c.status.filter(ss => ss.name !== eff);
          openStatusModal(i); // refresh
        });
      });

      // dropdown
      const list = $('status-dropdown-list'); list.innerHTML = '';
      statusEffects.forEach(effect=>{
        const has = c.status.some(s=> s.name === effect.name);
        const li = document.createElement('li');
        li.innerHTML = `<a class="dropdown-item ${has?'disabled text-muted':''}" href="#" data-eff="${effect.name}">${effect.icon} ${effect.name}</a>`;
        list.appendChild(li);
      });

      let pendingEffect = null;
      list.querySelectorAll('a[data-eff]').forEach(a=>{
        a.addEventListener('click', function(e){
          e.preventDefault();
          if (this.classList.contains('disabled')) return;
          pendingEffect = this.dataset.eff;
        });
      });

      $('add-status-btn').onclick = function(){
        if (!pendingEffect) { alert('Choose an effect first.'); return; }
        const durVal = parseInt($('status-duration').value,10);
        const base = statusEffects.find(x=>x.name===pendingEffect) || {icon:'‚ùì'};
        const eff = { name: pendingEffect, icon: base.icon };
        if (!isNaN(durVal) && durVal > 0) eff.remaining = durVal;
        c.status.push(eff);
        $('status-duration').value = '';
        pendingEffect = null;
        statusModal.hide();
        buildTable();
      };

      statusModal.show();
    }

    // ---------- Round & durations ----------
    function tickStatusDurationsOnNewRound(){
      characters.forEach(c=>{
        c.status = (c.status||[]).map(s=>{
          if (typeof s.remaining === 'number' && s.remaining > 0){
            return { ...s, remaining: s.remaining - 1 };
          }
          return s;
        }).filter(s=> s.remaining === undefined || s.remaining > 0);
      });
    }

    // ---------- Dice ----------
    document.querySelectorAll('.dice-btn').forEach(btn=>{
      btn.addEventListener('click', function(){
        const sides = parseInt(this.dataset.dice,10);
        const result = Math.floor(Math.random()*sides)+1;
        const out = `Rolled d${sides}: ${result}`;
        $('dice-result').textContent = `üé≤ ${out}`;
        addToHistory(out);
      });
    });
    $('roll-custom-dice').addEventListener('click', function(){
      const input = $('custom-dice-input').value.trim();
      const m = input.toLowerCase().match(/^(\d*)d(\d+)([+-]\d+)?$/);
      if(!m) return alert('Invalid format. Use XdY+Z (e.g., 2d6+3)');
      const num = parseInt(m[1]||'1',10), sides = parseInt(m[2],10), mod = parseInt(m[3]||'0',10);
      const rolls = Array.from({length:num}, ()=> Math.floor(Math.random()*sides)+1);
      const total = rolls.reduce((a,b)=>a+b,0) + mod;
      const modStr = mod ? (mod>0?` + ${mod}`:` - ${Math.abs(mod)}`) : '';
      const out = `Rolled ${num}d${sides}${modStr}: [${rolls.join(', ')}] = ${total}`;
      $('dice-result').textContent = `üé≤ ${out}`;
      addToHistory(out);
    });
    $('clear-dice-history').addEventListener('click', ()=>{
      if (!confirm('Clear all dice history?')) return;
      diceHistory = []; buildDiceHistory(); if (autoSaveEnabled) saveState();
    });

    // ---------- Controls ----------
    $('initiative-form').addEventListener('submit', e=>{
      e.preventDefault();
      const name = $('character-name').value.trim();
      const init = parseInt($('initiative-roll').value,10);
      const maxHP = parseInt($('character-health').value,10);
      const ac = parseInt($('character-ac').value,10);
      const notes = $('character-notes').value.trim();
      if(!name || isNaN(init) || isNaN(maxHP) || isNaN(ac)) return;

      characters.push({ name, initiative:init, currentHP:maxHP, maxHP, notes, ac, status:[], concentration:false });
      maybeSortByInitiative();
      e.target.reset();
      buildTable();
    });

    $('next-turn').addEventListener('click', ()=>{
      if (!characters.length) return;
      const len = characters.length;
      let prev = currentTurn;
      let attempts = 0;
      do{
        currentTurn = (currentTurn + 1) % len;
        if (currentTurn === 0) {
          combatRound++;
          tickStatusDurationsOnNewRound();
        }
        attempts++;
      }while(characters[currentTurn].currentHP <= 0 && attempts < len);
      buildTable();
      document.querySelector('.active-turn')?.scrollIntoView({ block:'nearest' });
    });

    $('reset-turns').addEventListener('click', ()=>{ currentTurn=0; combatRound=1; buildTable(); });
    $('clear-all').addEventListener('click', ()=>{ characters=[]; currentTurn=0; combatRound=1; buildTable(); });

    $('manualSaveBtn').addEventListener('click', ()=>{ saveState(true); alert('Manual save complete.'); });
    $('autoSaveToggle').addEventListener('change', e=>{ autoSaveEnabled = e.target.checked; });
    $('copyOrderBtn').addEventListener('click', ()=>{
      const out = characters.map((c,i)=> `${i+1}. ${c.name} (Init ${c.initiative})`).join('\n');
      if (!out) return;
      navigator.clipboard.writeText(out);
    });

    function updateSaveHistory(){
      const sel = $('saveHistorySelect');
      sel.innerHTML = '<option disabled selected>Load Previous Save</option>';
      Object.keys(localStorage).filter(k=>k.startsWith('initiativeTrackerData_')).sort().reverse().forEach(key=>{
        const t = key.replace('initiativeTrackerData_','');
        const opt = document.createElement('option');
        opt.value = key; opt.textContent = new Date(t).toLocaleString();
        sel.appendChild(opt);
      });
    }
    $('saveHistorySelect').addEventListener('change', function(){
      const raw = localStorage.getItem(this.value); if(!raw) return;
      try{
        const data = JSON.parse(raw);
        characters = (data.characters||[]).map(c=>normalizeChar(c));
        currentTurn = data.currentTurn||0;
        combatRound = data.combatRound||1;
        diceHistory = Array.isArray(data.diceHistory) ? data.diceHistory : [];
        buildTable();
      }catch(e){ alert('Failed to load that save.'); }
    });

    // Export/Import
    $('export-btn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({characters,currentTurn,combatRound,diceHistory}, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`initiativeTracker_${new Date().toISOString()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('import-btn').addEventListener('click', ()=> $('import-file').click());
    $('import-file').addEventListener('change', function(){
      const f = this.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = e=>{
        try{
          const d = JSON.parse(e.target.result);
          characters = (d.characters||[]).map(c=>normalizeChar(c));
          currentTurn = d.currentTurn||0;
          combatRound = d.combatRound||1;
          diceHistory = d.diceHistory||[];
          buildTable(); alert('Session imported.');
        }catch(err){ alert('Failed to import session.'); }
      };
      r.readAsText(f); this.value='';
    });

    // Keyboard shortcuts (not when typing)
    document.addEventListener('keydown', e=>{
      const tag = document.activeElement?.tagName || '';
      if (tag === 'INPUT' || tag === 'TEXTAREA') return;
      if (e.key==='n') $('next-turn').click();
      else if (e.key==='r') $('reset-turns').click();
      else if (e.key==='c') $('copyOrderBtn').click();
      else if (e.key==='s') $('manualSaveBtn').click();
      else if (e.key==='l') $('lockOrderToggle').click();
    });

    // Boot
    loadState();
    updateSaveHistory();
    buildTable();
    window.addEventListener('beforeunload', ()=>{ if (autoSaveEnabled) saveState(); });
  })();
  </script>
</body>
</html>
