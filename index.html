<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Initiative Tracker</title>

  <!-- Bootstrap + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

  <style>
    .bgimage{ background:url('images/BGMap.png') no-repeat center center fixed; background-size:cover; }
    .bg-orange{ background-color:#fd7e14 !important; color:#212529 !important; }
    .drag-handle{ cursor:move; }
    .active-turn{ border-left:5px solid #1d9e6d !important; color:#f8f9fa !important; font-weight:bold; }
    #saveHistorySelect{ min-width:200px; }

    /* Give help button a subtle glow on dark theme */
    #helpBtn { box-shadow: 0 0 0.25rem rgba(13,202,240,.65); }
    #helpBtn:hover { box-shadow: 0 0 0.6rem rgba(13,202,240,.85); }

    /* Compact status icon row */
    .status-icon-row{ display:flex; flex-wrap:wrap; gap:.3rem; align-items:center; }
    .status-chip{ font-size:1.05rem; line-height:1; user-select:none; }
    .status-chip[data-remaining]::after{ content: attr(data-remaining); font-size:.7rem; margin-left:.15rem; opacity:.8; }
    .conc-btn{ border:1px dashed rgba(255,255,255,.35); }
    .conc-on{ border-color:#ffc107; color:#ffc107; }
    .hp-controls .btn{ padding:.1rem .35rem; line-height:1; }

    /* Sticky table header */
    table thead th{ position:sticky; top:0; background:#161a1d; z-index:1; }

    /* Keep Notes & Effects tidy */
    .notes-actions{ display:flex; gap:.35rem; align-items:center; }
    .notes-actions .btn{ padding:.15rem .45rem; }

    @media (max-width:576px){
      .btn,.form-control{ padding:.6rem .8rem; font-size:1rem; }
      .table td,.table th{ padding:.6rem .5rem; }
    }

    /* Controls: tidy, evenly spaced layout */
    .controls-grid{
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: .5rem .75rem;
      align-items: center;
    }
    .controls-grid .form-check { /* switches don't need full width */
      justify-self: start;
    }
    @media (min-width: 1200px){
      /* on xl+ keep it nice and wide but balanced */
      .controls-grid{
        grid-template-columns: repeat(6, 1fr);
      }
    }

    /* --- Added: compact UI for temp HP & death saves --- */
    .temphp-wrap { display:flex; align-items:center; gap:.25rem; }
    .temphp-badge { font-size:.75rem; padding:.15rem .35rem; border:1px dashed rgba(255,255,255,.35); border-radius:.35rem; }
    .temp-btns .btn { padding:.1rem .3rem; line-height:1; }

    .death-saves { display:flex; align-items:center; gap:.35rem; }
    .ds-pill { font-size:.75rem; padding:.15rem .4rem; border-radius:.5rem; }
    .ds-pill.success { background:rgba(25,135,84,.15); border:1px solid rgba(25,135,84,.45); }
    .ds-pill.fail { background:rgba(220,53,69,.15); border:1px solid rgba(220,53,69,.45); }
    .ds-btns .btn { padding:.1rem .35rem; line-height:1; }
    .ds-stable { font-size:.75rem; color:#20c997; }


    /* Faster enter "pop" */
    #rollToast.showing, #rollToast.show { animation: rollPop .24s cubic-bezier(.2,.8,.2,1); }
    @keyframes rollPop {
      0%   { transform: translate(-50%,-50%) scale(.88); opacity:.15; }
      100% { transform: translate(-50%,-50%) scale(1);   opacity:1; }
    }

    /* Faster fade-out (Bootstrap uses .fade) */
    .toast.fade { transition-duration: .14s; }

    /* Respect reduced motion */
    @media (prefers-reduced-motion: reduce) {
      #rollToast.showing, #rollToast.show { animation: none; }
      .toast.fade { transition-duration: 0s; }
    }
  </style>
</head>
<body class="bgimage">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></i></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="index.html">Initiative</a></li>
          <li class="nav-item"><a class="nav-link" href="name.html">Name Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="loot.html">Loot Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="npc.html">NPC Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="tav.html">Tavern/Inn Gen</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="content pt-3">
    <div class="container-fluid text-center backdrop">
      <h1 class="display-1 mb-0">Initiative Tracker</h1>
      <p class="lead">Manage initiative, health, AC, notes, status effects, and combat rounds.</p>

      <!-- Controls row -->
      <div class="row g-3 align-items-center justify-content-center my-2">
        <div class="col-12 col-xl-7">
          <div class="controls-grid">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="autoSaveToggle" checked>
              <label class="form-check-label" for="autoSaveToggle">Auto-Save</label>
            </div>
          
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="lockOrderToggle">
              <label class="form-check-label" for="lockOrderToggle">Lock Order</label>
            </div>
          
            <button id="manualSaveBtn" class="btn btn-outline-success w-100">Manual Save</button>
            <button id="copyOrderBtn" class="btn btn-outline-light w-100">Copy Turn Order</button>
          
            <select id="saveHistorySelect" class="form-select w-100">
              <option disabled selected>Load Previous Save</option>
            </select>
          
            <div class="d-none">
              <input type="file" id="import-file" accept=".json" />
            </div>
          
            <button id="export-btn" class="btn btn-outline-warning w-100">Export Session</button>
            <button id="import-btn" class="btn btn-outline-secondary w-100">Import Session</button>
          
            <button id="helpBtn" class="btn btn-info text-dark w-100" type="button"
                    data-bs-toggle="offcanvas" data-bs-target="#helpCanvas" aria-controls="helpCanvas">
              <i class="bi bi-question-circle me-1"></i> Help
            </button>
          </div>
        </div>


        <!-- Saved Characters (templates) -->
        <div class="col-12 col-xl-5">
          <div class="accordion" id="savedCharactersAccordion">
            <div class="accordion-item">
              <h2 class="accordion-header" id="savedCharactersHeading">
                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#savedCharactersCollapse" aria-expanded="false" aria-controls="savedCharactersCollapse">
                  Saved Character Templates (Max: 20)
                </button>
              </h2>
              <div id="savedCharactersCollapse" class="accordion-collapse collapse" aria-labelledby="savedCharactersHeading" data-bs-parent="#savedCharactersAccordion">
                <div class="accordion-body bg-dark text-light">
                  <div class="row g-2">
                    <div class="col-md-3"><input id="save-name" class="form-control" type="text" placeholder="Name" /></div>
                    <div class="col-md-2"><input id="save-health" class="form-control" type="number" placeholder="Max HP" /></div>
                    <div class="col-md-2"><input id="save-ac" class="form-control" type="number" placeholder="AC" /></div>
                    <div class="col-md-3">
                      <select id="save-type" class="form-select">
                        <option>PC</option>
                        <option>Companion</option>
                        <option>NPC</option>
                        <option>Enemy</option>
                      </select>
                    </div>
                    <div class="col-md-2"><button id="save-character-btn" class="btn btn-outline-success w-100">Save Template</button></div>
                  </div>

                  <div class="row g-2 mt-2">
                    <div class="col-sm-6"><input id="saved-search" class="form-control" type="text" placeholder="Search saved characters..." /></div>
                    <div class="col-sm-6 d-flex gap-2 justify-content-sm-end">
                      <select id="saved-type-filter" class="form-select w-auto">
                        <option value="">All Types</option>
                        <option>PC</option>
                        <option>Companion</option>
                        <option>NPC</option>
                        <option>Enemy</option>
                      </select>
                      <button id="clear-saved-btn" class="btn btn-outline-danger">Clear All</button>
                    </div>
                  </div>

                  <div class="row g-2 mt-2">
                    <div class="col-md-6">
                      <select id="loadCharacterSelect" class="form-select">
                        <option disabled selected>Load Saved Character</option>
                      </select>
                    </div>
                    <div class="col-md-6 d-flex gap-2">
                      <button id="load-to-form-btn" class="btn btn-outline-light w-100">Load to Form</button>
                      <button id="add-to-tracker-btn" class="btn btn-outline-success w-100">Add to Tracker</button>
                    </div>
                  </div>

                  <ul id="saved-characters-list" class="list-group mt-3"></ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div><!-- /controls row -->

      <!-- Add row -->
      <form id="initiative-form" class="mb-4">
        <div class="row g-2 justify-content-center">
          <div class="col-12 col-md-3"><input id="character-name" class="form-control" type="text" placeholder="Character Name" required></div>
          <div class="col-6 col-md-2"><input id="initiative-roll" class="form-control" type="number" placeholder="Initiative" required></div>
          <div class="col-6 col-md-2"><input id="character-health" class="form-control" type="number" placeholder="Max HP" required></div>
          <div class="col-6 col-md-2"><input id="character-ac" class="form-control" type="number" placeholder="AC" required></div>
          <div class="col-6 col-md-2">
            <select id="character-type" class="form-select">
              <option>PC</option>
              <option>Companion</option>
              <option>NPC</option>
              <option>Enemy</option>
            </select>
          </div>
          <div class="col-12 col-md-1"><button class="btn btn-outline-success w-100" type="submit">Add</button></div>
        </div>
      </form>

      <h2>Combat Round: <span id="combat-round">1</span></h2>

      <!-- Dice Roller -->
      <div class="my-4 text-light">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
          <button class="btn btn-outline-info dice-btn" data-dice="4">Roll d4</button>
          <button class="btn btn-outline-info dice-btn" data-dice="6">Roll d6</button>
          <button class="btn btn-outline-info dice-btn" data-dice="8">Roll d8</button>
          <button class="btn btn-outline-info dice-btn" data-dice="10">Roll d10</button>
          <button class="btn btn-outline-info dice-btn" data-dice="12">Roll d12</button>
          <button class="btn btn-outline-info dice-btn" data-dice="20">Roll d20</button>
          <button class="btn btn-outline-info dice-btn" data-dice="100">Roll d100</button>
          <button class="btn btn-outline-info" id="roll-adv">Adv (d20)</button>
          <button class="btn btn-outline-info" id="roll-dis">Dis (d20)</button>
        </div>
        <div class="mt-3">
          <label for="custom-dice-input" class="form-label">Custom Roll:</label>
          <div class="input-group w-auto mx-auto">
            <input id="custom-dice-input" type="text" class="form-control form-control-sm"
             placeholder="e.g. 2d6+1d4+3, 4d6kh3, adv" aria-label="Custom dice expression">
            <button id="roll-custom-dice" class="btn btn-outline-warning btn-sm">Roll</button>
          </div>
          <div class="form-text text-secondary">
            Supports multi-terms, +/‚àí, keep high/low (kh/kl), and adv/dis.
            Examples: <code>2d6+1d4+3</code>, <code>4d6kh3</code>, <code>2d20kl1</code>, <code>adv</code>
          </div>
        </div>
        <div class="text-light mt-2" id="dice-result" style="font-size: 1.25rem;"></div>
        <div class="mt-3">
          <button class="btn btn-outline-light btn-sm" data-bs-toggle="collapse" data-bs-target="#dice-history">Toggle Roll History</button>
          <button class="btn btn-outline-danger btn-sm" id="clear-dice-history">Clear Dice History</button>
          <div class="collapse mt-2" id="dice-history">
            <div class="card card-body bg-dark text-light" id="dice-history-log" style="max-height: 200px; overflow-y: auto;"></div>
          </div>
        </div>
      </div>

      <!-- Desktop Table -->
      <div class="d-none d-md-block">
        <div class="table-responsive">
          <table class="table table-striped text-light align-middle">
            <thead>
              <tr>
                <th></th>
                <th>Turn</th>
                <th>Character</th>
                <th>Type</th>
                <th>Initiative</th>
                <th>AC</th>
                <th>Health</th>
                <th>Notes & Effects</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="initiative-order"></tbody>
          </table>
        </div>
      </div>

      <!-- Mobile Cards -->
      <div id="mobile-initiative-order" class="d-block d-md-none"></div>

      <!-- Footer action buttons -->
      <div class="mt-3 d-flex gap-2 justify-content-center flex-wrap">
        <button id="next-turn" class="btn btn-outline-success">Next Turn</button>
        <button id="undo-btn" class="btn btn-outline-secondary"><i class="bi bi-arrow-counterclockwise me-1"></i> Undo</button>
        <button id="reset-turns" class="btn btn-outline-danger">Reset Rounds</button>
        <button id="clear-all" class="btn btn-outline-light">Clear All</button>
        <button id="clear-storage" class="btn btn-outline-warning">Clear Saved Data</button>
        <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#sessionNotes" aria-controls="sessionNotes">
          <i class="bi bi-journal-text me-1"></i> Session Notes
        </button>
      </div>

    </div>
  </main>

  <!-- Status Modal -->
  <div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="statusModalLabel">Edit Status Effects</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Current effects -->
          <div id="status-badges" class="mb-3 d-flex flex-wrap gap-2"></div>

          <!-- Add effect -->
          <div class="input-group mb-2">
            <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
              Add Effect
            </button>
            <ul class="dropdown-menu dropdown-menu-dark" id="status-dropdown-list"></ul>
            <input id="status-duration" type="number" min="0" class="form-control" placeholder="Duration (rounds, optional)">
            <button id="add-status-btn" class="btn btn-outline-success">Add</button>
          </div>
          <div class="form-text text-secondary">Leave duration blank for indefinite effects. Effects with a duration tick down each new round.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div class="modal fade" id="notesModal" tabindex="-1" aria-labelledby="notesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header">
          <h5 class="modal-title" id="notesModalLabel">Notes</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <textarea id="notes-text" class="form-control" rows="8" placeholder="Enter notes..."></textarea>
        </div>
        <div class="modal-footer">
          <button id="notes-save-btn" class="btn btn-success">Save Notes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Session Notes Offcanvas -->
  <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="sessionNotes" aria-labelledby="sessionNotesLabel">
    <div class="offcanvas-header">
      <h5 id="sessionNotesLabel">Session Notes</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
      <textarea id="session-notes" class="form-control mb-3" rows="10" placeholder="Enter your session notes..."></textarea>
      <div class="d-flex justify-content-between gap-2">
        <button id="save-notes" class="btn btn-outline-success w-100">Save</button>
        <button id="export-notes" class="btn btn-outline-warning w-100">Export</button>
        <button id="import-notes" class="btn btn-outline-secondary w-100">Import</button>
      </div>
      <input type="file" id="import-notes-file" class="d-none" accept=".txt,.md,.json" />
    </div>
  </div>

    <!-- Help Offcanvas -->
  <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="helpCanvas" aria-labelledby="helpCanvasLabel">
    <div class="offcanvas-header">
      <h5 id="helpCanvasLabel" class="mb-0"><i class="bi bi-magic me-2"></i>How to Use</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body">
      <!-- Alert-Info header (matches help color on other pages) -->
      <div class="alert alert-info text-light">
        <strong>Quick Start:</strong> Add characters, set initiative, and click <em>Next Turn</em>. 
        Use the HP +/- to track damage or healing. Click the <i class="bi bi-star-fill"></i> to toggle Concentration.
      </div>

      <!-- Help Accordion -->
      <div class="accordion" id="helpAccordion">

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpGettingStarted">
              Getting Started
            </button>
          </h2>
          <div id="helpGettingStarted" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ol class="mb-0">
                <li>Fill in <strong>Character Name</strong>, <strong>Initiative</strong>, <strong>Max HP</strong>, and <strong>AC</strong>, then click <em>Add</em>.</li>
                <li>Repeat for each combatant. The list sorts by initiative unless <em>Lock Order</em> is enabled.</li>
                <li>Press <strong>Next Turn</strong> to advance through the order; after everyone acts, the <em>Combat Round</em> increases.</li>
              </ol>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpHP">
              Health, Damage, & Concentration
            </button>
          </h2>
          <div id="helpHP" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-2">
                <li>Use <strong>HP +/-</strong> to apply damage or healing, or type directly into the HP field.</li>
                <li><strong>Temp HP</strong> (THP) appears as a badge next to HP with its own <em>¬±</em> buttons.
                  Damage consumes THP first; only leftover damage reduces real HP.</li>
                <li>Click the <strong>star</strong> <i class="bi bi-star"></i>/<i class="bi bi-star-fill text-warning"></i> to toggle <strong>Concentration</strong>.</li>
                <li><strong>Concentration checks</strong> only trigger when you take real HP damage (after THP absorption). The tracker totals your real HP damage across the round and reminds you at round end.</li>
                <li><strong>Healing</strong> above 0 HP automatically resets any death saves and removes <em>Stable</em>.</li>
              </ul>
              <div class="alert alert-info text-light mb-0">
                <strong>Concentration DC:</strong> Roll <em>d20 + CON mod</em> (+ proficiency if proficient)
                vs <strong>DC = max(10, ‚åädamage this round / 2‚åã)</strong>.
              </div>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpDeathSaves">
              Death Saves
            </button>
          </h2>
          <div id="helpDeathSaves" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-2">
                <li>When a creature drops to 0 HP, a <strong>Death Saves</strong> control appears:
                  <span class="ds-pill success">S: #</span> and <span class="ds-pill fail">F: #</span>.</li>
                <li>Use <strong>+S</strong> / <strong>+F</strong> to record successes or fails; use ‚Ü∫ to reset them.</li>
                <li>At <strong>3 successes</strong>, the creature becomes <em>Stable</em> (shown as ‚ÄúStable‚Äù).</li>
                <li><strong>Any healing</strong> that brings the creature above 0 HP clears all death saves and removes <em>Stable</em>.</li>
              </ul>
              <p class="small text-secondary mb-0">Rules nuance: This tracker does not auto-apply instant death from massive damage‚Äîyou can adjudicate that as DM.</p>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpStatuses">
              Status Effects & Notes
            </button>
          </h2>
          <div id="helpStatuses" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-0">
                <li>Click the <strong>smiley</strong> <i class="bi bi-emoji-smile"></i> to add/remove conditions (e.g., Prone, Poisoned).</li>
                <li>Optionally set a <strong>duration (rounds)</strong>; durations tick down automatically at the start of each new round.</li>
                <li>Click <strong>Notes</strong> <i class="bi bi-journal-text"></i> to store character-specific reminders.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpDice">
              Dice Roller
            </button>
          </h2>
          <div id="helpDice" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-0">
                <li>Use quick buttons for d4, d6, d8, d10, d12, d20, or d100.</li>
                <li>Type complex rolls like <code>2d6+1d4+3</code>, <code>4d6kh3</code> (keep highest 3), or <code>2d20kl1</code> (disadvantage). Use <code>adv</code>/<code>dis</code> as shortcuts.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpTemplates">
              Saved Character Templates
            </button>
          </h2>
          <div id="helpTemplates" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-0">
                <li>Save up to 20 frequently used characters with AC/HP/type. Names must be unique; saving an existing name updates it.</li>
                <li>Search, filter, and quickly <em>Load to Form</em> or <em>Add to Tracker</em>.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpSaving">
              Saving, History, Import/Export
            </button>
          </h2>
          <div id="helpSaving" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-0">
                <li><strong>Auto-Save</strong> keeps your session updated in the browser.</li>
                <li><strong>Manual Save</strong> creates a timestamped backup you can reload from <em>Load Previous Save</em>.</li>
                <li><strong>Export</strong> downloads a JSON; <strong>Import</strong> loads a previous session.</li>
                <li><strong>Persistence:</strong> all data saves locally in your browser (localstorage). No server required.</li>
                <li><strong>Undo:</strong> the <em>Undo</em> button reverts the most recent change (HP, THP, notes, statuses, reorders, etc.), up to ~50 steps. Undo history isn‚Äôt kept after a page reload.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpTurns">
              Initiative, Turn Order & Rounds
            </button>
          </h2>
          <div id="helpTurns" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-0">
                <li>Edit initiative inline; order re-sorts unless <em>Lock Order</em> is on.</li>
                <li>Drag rows (grab the ‚ãÆ‚ãÆ handle on the left on Desktop) or use up/down (mobile) to reorder.</li>
                <li><strong>Next Round</strong> advances; a full cycle increments the round and ticks durations.</li>
                <li>While<strong> Lock Order</strong> is on editing initiative won't resort.</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpShortcuts">
              Keyboard Shortcuts
            </button>
          </h2>
          <div id="helpShortcuts" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <div class="alert alert-info text-light mb-2">
                <code>N</code> Next Turn ‚Ä¢ <code>R</code> Reset Rounds ‚Ä¢ <code>C</code> Copy Order ‚Ä¢ 
                <code>S</code> Manual Save ‚Ä¢ <code>L</code> Lock Order
              </div>
              <p class="mb-0 small text-secondary">Shortcuts are disabled while typing in inputs or textareas.</p>
            </div>
          </div>
        </div>

        <div class="accordion-item bg-dark text-light border-secondary">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#helpNotes">
              Session Notes
            </button>
          </h2>
          <div id="helpNotes" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
            <div class="accordion-body">
              <ul class="mb-0">
                <li>Use the <strong>Session Notes</strong> panel (right side) to keep general notes.</li>
                <li>Notes auto-save; you can also Export/Import plain text.</li>
              </ul>
            </div>
          </div>
        </div>

      </div><!-- /accordion -->
    </div><!-- /offcanvas-body -->
  </div>


  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="row footer-main">
      <div class="col">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-12 col-md-4 text-md-start text-center order-last order-md-first">
              &copy; 2025 Marlo Mayberry
            </div>
            <div class="col-12 col-md-4 text-center">
              <img src="/images/White logo - no background.png" height="50" alt="logo">
            </div>
            <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end">
              <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener"><i class="bi bi-linkedin p-2"></i></a>
              <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener"><i class="bi bi-github p-2"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div id="rollToast"
       class="toast position-fixed top-50 start-50 translate-middle"
       role="status" aria-live="polite" aria-atomic="true"
       data-bs-delay="900" style="z-index: 1080;">
    <div class="toast-body fs-3 fw-bold text-center"></div>
  </div>


  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
  (() => {
    const $ = id => document.getElementById(id);

    let statusModal = null;
    let notesModal = null;
    let sortableInstance = null;

    function initModals() {
      const statusEl = document.getElementById('statusModal');
      if (statusEl) statusModal = bootstrap.Modal.getOrCreateInstance(statusEl);
      const notesEl = document.getElementById('notesModal');
      if (notesEl) notesModal = bootstrap.Modal.getOrCreateInstance(notesEl);
    }

    // If DOM already ready, init immediately; else wait
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initModals);
    } else {
      initModals();
    }


    // ---------- Session notes ----------
    const notesKey = 'sessionNotes';
    function loadNotes(){ const s = localStorage.getItem(notesKey); if(s) $('session-notes').value = s; }
    function saveNotes(){ localStorage.setItem(notesKey, $('session-notes').value); }
    document.addEventListener('DOMContentLoaded', loadNotes);
    $('session-notes').addEventListener('input', saveNotes);
    $('save-notes').addEventListener('click', ()=>{ saveNotes(); alert('Notes saved.'); });
    $('export-notes').addEventListener('click', ()=>{
      const blob = new Blob([$('session-notes').value], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`session_notes_${new Date().toISOString().slice(0,10)}.txt`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('import-notes').addEventListener('click', ()=> $('import-notes-file').click());
    $('import-notes-file').addEventListener('change', function(){
      const f=this.files[0]; if(!f) return;
      const r = new FileReader(); r.onload = e => { $('session-notes').value = e.target.result; saveNotes(); alert('Notes imported.'); };
      r.readAsText(f); this.value='';
    });

    // ---------- Status palette ----------
    const statusEffects = [
      { name:'Blinded', icon:'üëÅÔ∏è' }, { name:'Exhaustion', icon:'üí§' }, { name:'Incapacitated', icon:'üò¥' },
      { name:'Petrified', icon:'ü™®' }, { name:'Restrained', icon:'ü™¢' }, { name:'Charmed', icon:'üîÆ' },
      { name:'Frightened', icon:'üò±' }, { name:'Invisible', icon:'üîé' }, { name:'Poisoned', icon:'‚ò†Ô∏è' },
      { name:'Unconscious', icon:'üò™' }, { name:'Deafened', icon:'üîà' }, { name:'Grappled', icon:'ü§º‚Äç‚ôÇÔ∏è' },
      { name:'Paralyzed', icon:'üîê' }, { name:'Prone', icon:'üõå' }
    ];

    // ---------- State ----------
    let characters = [];
    let currentTurn = 0;
    let combatRound = 1;
    let autoSaveEnabled = true;
    let diceHistory = [];
    let modalCharacterIndex = null; // for both status + notes
    let undoStack = [];             // <-- Added: simple history stack
    const UNDO_LIMIT = 50;          // cap memory


    // ---------- Persistence ----------
    function normalizeChar(c){
      return {
        name: c.name,
        type: c.type || 'PC',
        initiative: +c.initiative || 0,
        currentHP: +c.currentHP || 0,
        maxHP: +c.maxHP || 0,
        tempHP: +c.tempHP || 0, // <-- Added
        ac: (c.ac ?? null),
        notes: c.notes || '',
        concentration: !!c.concentration,
        deathSaves: {                 // <-- Added
          s: Math.min(3, Math.max(0, +(c.deathSaves?.s ?? 0))),
          f: Math.min(3, Math.max(0, +(c.deathSaves?.f ?? 0))),
          stable: !!(c.deathSaves?.stable)
        },
        status: (c.status || []).map(s => typeof s === 'string'
          ? { name:s, icon:(statusEffects.find(e=>e.name===s)?.icon||'‚ùì') }
          : { name:s.name, icon:s.icon||(statusEffects.find(e=>e.name===s.name)?.icon||'‚ùì'), remaining:(typeof s.remaining==='number'?s.remaining:undefined) })
      };
    }
    function saveState(manual=false){
      const key = manual ? `initiativeTrackerData_${new Date().toISOString()}` : 'initiativeTrackerData';
      const payload = { characters, currentTurn, combatRound, diceHistory };
      localStorage.setItem(key, JSON.stringify(payload));
      if (manual) updateSaveHistory();
    }
    function loadState(){
      const raw = localStorage.getItem('initiativeTrackerData');
      if(!raw) return;
      try{
        const data = JSON.parse(raw);
        characters = (data.characters||[]).map(normalizeChar);
        currentTurn = data.currentTurn||0;
        combatRound = data.combatRound||1;
        diceHistory = Array.isArray(data.diceHistory) ? data.diceHistory : [];
      }catch(e){ console.warn('Load failed', e); }
    }

    // ---------- Undo ----------
    function snapshot() {
      // Deep copy core game state
      return JSON.parse(JSON.stringify({ characters, currentTurn, combatRound }));
    }
    function pushHistory(label='') {
      undoStack.push({ state: snapshot(), label, ts: Date.now() });
      if (undoStack.length > UNDO_LIMIT) undoStack.shift();
    }
    function undoLast() {
      const last = undoStack.pop();
      if (!last) return;
      const { state } = last;
      characters = (state.characters || []).map(normalizeChar);
      currentTurn = state.currentTurn ?? 0;
      combatRound = state.combatRound ?? 1;
      buildTable();
    }
    
    // ---------- Saved character templates ----------
    const TKEY='savedCharacters';
    function getSaved(){ try{ return JSON.parse(localStorage.getItem(TKEY)||'[]'); }catch{ return []; } }
    function setSaved(list){ localStorage.setItem(TKEY, JSON.stringify(list)); }
    function addSavedTemplate(t){
      const list = getSaved();
      if (list.length >= 20) { alert('Max 20 saved characters.'); return false; }
      const idx = list.findIndex(x=>x.name.toLowerCase()===t.name.toLowerCase());
      if (idx>=0) list[idx]=t; else list.push(t);
      setSaved(list);
      buildSavedUI();
      return true;
    }
    function removeSavedByName(name){
      const list = getSaved().filter(x=>x.name!==name);
      setSaved(list); buildSavedUI();
    }
    function clearSavedAll(){ localStorage.removeItem(TKEY); buildSavedUI(); }

    function buildSavedUI(){
      // dropdown
      const select = $('loadCharacterSelect');
      select.innerHTML = '<option disabled selected>Load Saved Character</option>';
      const list = getSaved();
      list.forEach(c=>{
        const opt = document.createElement('option');
        opt.value = c.name; opt.textContent = `${c.name} (${c.type})`;
        select.appendChild(opt);
      });

      // searchable list
      const ul = $('saved-characters-list'); ul.innerHTML='';
      const q = $('saved-search').value.trim().toLowerCase();
      const typeFilter = $('saved-type-filter').value;
      list
        .filter(c => (!q || c.name.toLowerCase().includes(q)) && (!typeFilter || c.type===typeFilter))
        .forEach(c=>{
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center bg-dark text-light border-light';
          li.innerHTML = `
            <span><strong>${c.name}</strong> ‚Äî <em>${c.type}</em> ‚Ä¢ AC: ${c.ac} ‚Ä¢ HP: ${c.maxHP}</span>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-light" data-act="load" data-name="${c.name}">Load</button>
              <button class="btn btn-sm btn-outline-success" data-act="add" data-name="${c.name}">Add</button>
              <button class="btn btn-sm btn-outline-danger" data-act="del" data-name="${c.name}">Delete</button>
            </div>`;
          ul.appendChild(li);
        });

      ul.querySelectorAll('button[data-act]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const name = btn.dataset.name;
          const c = getSaved().find(x=>x.name===name);
          if (!c) return;
          if (btn.dataset.act==='load'){
            $('character-name').value = c.name;
            $('initiative-roll').value = c.initiative||0;
            $('character-health').value = c.maxHP||0;
            $('character-ac').value = c.ac||0;
            $('character-type').value = c.type||'PC';
          } else if (btn.dataset.act==='add'){
            const nc = normalizeChar({...c, currentHP:c.maxHP});
            characters.push(nc);
            maybeSortByInitiative();
            buildTable();
          } else if (btn.dataset.act==='del'){
            removeSavedByName(name);
          }
        });
      });
    }

    // Saved template form
    $('save-character-btn').addEventListener('click', ()=>{
      const name = $('save-name').value.trim();
      const maxHP = parseInt($('save-health').value,10);
      const ac = parseInt($('save-ac').value,10);
      const type = $('save-type').value;
      if (!name || isNaN(maxHP) || isNaN(ac)) { alert('Please enter valid Name, Max HP, and AC.'); return; }
      addSavedTemplate({ name, maxHP, ac, type, initiative:0 });
      $('save-name').value=''; $('save-health').value=''; $('save-ac').value='';
    });
    $('saved-search').addEventListener('input', buildSavedUI);
    $('saved-type-filter').addEventListener('change', buildSavedUI);
    $('clear-saved-btn').addEventListener('click', ()=>{
      if(confirm('Delete ALL saved character templates?')) clearSavedAll();
    });

    $('loadCharacterSelect').addEventListener('change', function(){
      const c = getSaved().find(x=>x.name===this.value); if(!c) return;
      $('character-name').value = c.name;
      $('initiative-roll').value = c.initiative||0;
      $('character-health').value = c.maxHP||0;
      $('character-ac').value = c.ac||0;
      $('character-type').value = c.type||'PC';
    });
    $('load-to-form-btn').addEventListener('click', ()=>{
      const sel = $('loadCharacterSelect'); if (!sel.value || sel.selectedIndex===0) return alert('Pick a saved character first.');
      const c = getSaved().find(x=>x.name===sel.value); if(!c) return;
      $('character-name').value = c.name;
      $('initiative-roll').value = c.initiative||0;
      $('character-health').value = c.maxHP||0;
      $('character-ac').value = c.ac||0;
      $('character-type').value = c.type||'PC';
    });
    $('add-to-tracker-btn').addEventListener('click', ()=>{
      const sel = $('loadCharacterSelect'); if (!sel.value || sel.selectedIndex===0) return alert('Pick a saved character first.');
      const c = getSaved().find(x=>x.name===sel.value); if(!c) return;
      characters.push(normalizeChar({...c, currentHP:c.maxHP}));
      maybeSortByInitiative(); buildTable();
    });

  // ---------- Dice ----------
  function addToHistory(text){
    diceHistory.unshift({ text, timestamp: new Date().toLocaleTimeString() });
    buildDiceHistory();
    if (autoSaveEnabled) saveState();
  }
  function buildDiceHistory(){
    const wrap = $('dice-history-log'); wrap.innerHTML='';
    diceHistory.forEach(entry=>{
      const div = document.createElement('div');
      div.className = 'border-bottom pb-1 mb-1';
      div.innerHTML = `<strong>${entry.timestamp}</strong>: ${entry.text}`;
      wrap.appendChild(div);
    });
  }

  // Parser: supports +/- terms, multi-terms, and keep-high/low
  //  - "2d6+1d4+3", "4d6kh3" (keep highest 3), "2d20kl1" (disadv), "2d20kh1" (adv)
  //  - Flat modifiers like +3 or -1
  const termRe = /([+-]?)\s*(?:(\d*)d(\d+)(?:k(h|l)(\d+))?)|([+-]?\d+)/ig;

  function rollDiceExpr(exprRaw) {
    const expr = exprRaw.replace(/\s+/g,'').toLowerCase();
    let total = 0, parts = [], match;
    let any = false;

    // Basic validation ‚Äì only digits, d, k, h/l, +/-, and letters a/d/v/i/s for "adv/dis" passthrough handling
    if (!/^[0-9dkhl+\-\sadvini]*$/i.test(expr)) {
      throw new Error('Invalid characters.');
    }

    while((match = termRe.exec(expr)) !== null){
      any = true;
      if (match[6]) { // flat mod
        const n = parseInt(match[6],10);
        if (Number.isNaN(n)) continue;
        total += n;
        parts.push({type:'mod', n});
        continue;
      }
      const sign = match[1] === '-' ? -1 : 1;
      const count = parseInt(match[2]||'1',10);
      const sides = parseInt(match[3],10);
      const keepDir = match[4]; // 'h' or 'l'
      const keepN = match[5] ? parseInt(match[5],10) : null;

      if (!sides || count<=0) continue;

      const rolls = Array.from({length:count}, ()=> 1 + Math.floor(Math.random()*sides));
      let used = rolls.slice();

      if (keepN && keepN > 0 && keepN < rolls.length) {
        used = rolls.slice().sort((a,b)=>a-b);
        used = (keepDir === 'h') ? used.slice(-keepN) : used.slice(0, keepN);
      }

      const subtotal = sign * used.reduce((a,b)=>a+b,0);
      total += subtotal;
      parts.push({type:'dice', sign, count, sides, rolls, used, keepDir, keepN, subtotal});
    }

    if (!any) throw new Error('Nothing to roll.');
    return { total, parts };
  }

  function formatParts(parts){
    return parts.map(p=>{
      if (p.type==='mod') return `${p.n>=0?'+':''}${p.n}`;
      const head = `${p.sign<0?'-':''}${p.count}d${p.sides}${p.keepN?`k${p.keepDir}${p.keepN}`:''}`;
      return `${head} [${p.rolls.join(', ')}]${p.keepN?` ‚Üí kept [${p.used.join(', ')}]`:''}`;
    }).join(' ');
  }

  function showRoll(total, detailText){
    const el = document.querySelector('#rollToast .toast-body');
    el.innerHTML = `üé≤ ${total}<div class="small opacity-75 mt-1">${detailText||''}</div>`;
    const toastEl = document.getElementById('rollToast');
    // Ensure autohide + short delay every time
    const t = new bootstrap.Toast(toastEl, { autohide: true, delay: 900 });
    t.show();
  }


  // Quick buttons now use the expression roller too
  document.querySelectorAll('.dice-btn').forEach(btn=>{
    btn.addEventListener('click', function(){
      const sides = parseInt(this.dataset.dice,10);
      const r = rollDiceExpr(`1d${sides}`);
      const line = `Rolled 1d${sides}: [${r.parts[0].rolls.join(', ')}] = ${r.total}`;
      $('dice-result').textContent = `üé≤ ${line}`;
      showRoll(r.total, `1d${sides}`);
      addToHistory(line);
    });
  });

  // Advantage / Disadvantage (assume plain d20)
  $('roll-adv').addEventListener('click', ()=>{
    const r = rollDiceExpr('2d20kh1');
    const p = r.parts[0];
    const line = `Advantage (2d20kh1): [${p.rolls.join(', ')}] ‚Üí kept [${p.used.join(', ')}] = ${r.total}`;
    $('dice-result').textContent = `üé≤ ${line}`;
    showRoll(r.total, 'Advantage');
    addToHistory(line);
  });
  $('roll-dis').addEventListener('click', ()=>{
    const r = rollDiceExpr('2d20kl1');
    const p = r.parts[0];
    const line = `Disadvantage (2d20kl1): [${p.rolls.join(', ')}] ‚Üí kept [${p.used.join(', ')}] = ${r.total}`;
    $('dice-result').textContent = `üé≤ ${line}`;
    showRoll(r.total, 'Disadvantage');
    addToHistory(line);
  });

  // Custom input supports multi-terms & kh/kl
  $('roll-custom-dice').addEventListener('click', function(){
    const input = $('custom-dice-input').value.trim();
    if (!input) return;

    // little sugar: allow "adv" / "dis" as shortcuts
    let expr = input.toLowerCase();
    if (expr === 'adv') expr = '2d20kh1';
    if (expr === 'dis') expr = '2d20kl1';

    try{
      const r = rollDiceExpr(expr);
      const details = formatParts(r.parts);
      const line = `Rolled ${expr}: ${details} = ${r.total}`;
      $('dice-result').textContent = `üé≤ ${line}`;
      showRoll(r.total, expr);
      addToHistory(line);
    }catch(e){
      alert("Invalid format.\nExamples:\n  2d6+3\n  2d6+1d4+3\n  4d6kh3 (keep highest 3)\n  2d20kl1 (disadvantage)");
    }
  });

  $('clear-dice-history').addEventListener('click', ()=>{
    if (confirm("Clear all dice history?")) { diceHistory = []; buildDiceHistory(); if (autoSaveEnabled) saveState(); }
  });


    // ---------- Helpers ----------
    function hpClass(percent){
      if (percent <= 0) return 'bg-secondary text-light text-decoration-line-through';
      if (percent <= 25) return 'bg-danger text-light';
      if (percent <= 50) return 'bg-warning text-dark';
      if (percent <= 75) return 'bg-orange text-dark';
      return 'bg-success text-light';
    }
    function maybeSortByInitiative(){ if ($('lockOrderToggle')?.checked) return; characters.sort((a,b)=> b.initiative - a.initiative); }
    function statusTooltipText(c){
      const parts = [];
      if (c.concentration) parts.push('Concentration: ON');
      if (c.status.length){
        parts.push('Effects:');
        c.status.forEach(s=> parts.push(`- ${s.name}${typeof s.remaining==='number' ? ` (${s.remaining})` : ''}`));
      }else{
        parts.push('Effects: none');
      }
      return parts.join('\n');
    }

    // ---------- Build UI ----------
    function buildTable(){
      $('combat-round').textContent = combatRound;
      const tableBody = $('initiative-order');
      const mobileBody = $('mobile-initiative-order');
      tableBody.innerHTML = '';
      mobileBody.innerHTML = '';

      characters.forEach((c,i)=>{
        const pct = Math.max(0, Math.round((c.currentHP / c.maxHP) * 100));

        // Desktop row
        const tr = document.createElement('tr');
        if (i === currentTurn) tr.classList.add('active-turn');
        tr.innerHTML = `
          <td class="drag-handle"><i class="bi bi-grip-vertical"></i></td>
          <td>${i===currentTurn ? '<i class="bi bi-caret-right-fill"></i>' : ''}</td>
          <td class="${pct<=0 ? 'text-decoration-line-through' : ''}">
            ${c.name}
            ${c.concentration ? '<span class="ms-1 text-warning" title="Concentration"><i class="bi bi-star-fill"></i></span>' : ''}
          </td>
          <td>${c.type}</td>
          <td><input type="number" class="form-control form-control-sm init-input" value="${c.initiative}" data-index="${i}" data-commit="init"></td>
          <td>${c.ac ?? '-'}</td>
          <td>
            <div class="d-flex align-items-center">
              <input type="number" class="form-control form-control-sm health-input ${hpClass(pct)}" value="${c.currentHP}" data-index="${i}" style="max-width:6rem">
              <div class="btn-group btn-group-sm ms-1 hp-controls" role="group">
                <button class="btn btn-outline-light hit-btn" data-delta="-5" data-index="${i}">-5</button>
                <button class="btn btn-outline-light hit-btn" data-delta="-1" data-index="${i}">-1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="1" data-index="${i}">+1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="5" data-index="${i}">+5</button>
              </div>
              <div class="tempHP ms-2 temphp-wrap">
                <span class="temphp-badge">THP: <span class="temphp-val">${c.tempHP||0}</span></span>
                <div class="btn-group btn-group-sm temp-btns" role="group">
                  <button class="btn btn-outline-info temphp-btn" data-index="${i}" data-delta="-1">-1</button>
                  <button class="btn btn-outline-info temphp-btn" data-index="${i}" data-delta="1">+1</button>
                </div>
              </div>
            </div>
          </td>

          <td>
            <div class="d-flex align-items-center justify-content-between w-100">
              <div class="d-flex align-items-center gap-2">
                <div class="status-icon-row" data-bs-toggle="tooltip" data-bs-placement="top" title="${statusTooltipText(c)}">
                  ${c.status.map(s=>{
                    const rem = (typeof s.remaining==='number') ? ` data-remaining="${s.remaining}"` : '';
                    return `<span class="status-chip"${rem} title="${s.name}">${s.icon}</span>`;
                  }).join('') || '<span class="text-secondary" style="opacity:.6;">‚Äî</span>'}
                </div>
                ${c.currentHP<=0 ? `
                  <div class="death-saves" title="Death Saves">
                    ${c.deathSaves.stable ? `<span class="ds-stable">Stable</span>` : `
                      <span class="ds-pill success">S: ${c.deathSaves.s}</span>
                      <span class="ds-pill fail">F: ${c.deathSaves.f}</span>
                      <div class="btn-group btn-group-sm ds-btns" role="group">
                        <button class="btn btn-outline-success ds-add" data-index="${i}" data-kind="s">+S</button>
                        <button class="btn btn-outline-danger ds-add" data-index="${i}" data-kind="f">+F</button>
                        <button class="btn btn-outline-secondary ds-reset" data-index="${i}" title="Reset">‚Ü∫</button>
                      </div>
                    `}
                  </div>` : ``}
              </div>
              <div class="notes-actions">
                <button class="btn btn-sm btn-outline-light notes-btn" data-index="${i}" title="Notes"><i class="bi bi-journal-text"></i></button>
                <button class="btn btn-sm conc-btn ${c.concentration?'conc-on':''}" title="Toggle Concentration" data-index="${i}">
                  <i class="bi ${c.concentration?'bi-star-fill':'bi-star'}"></i>
                </button>
                <button class="btn btn-sm btn-outline-info status-btn" data-index="${i}" title="Edit Status"><i class="bi bi-emoji-smile"></i></button>
              </div>
            </div>
          </td>

          <td class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-success duplicate-btn" data-index="${i}" title="Duplicate"><i class="bi bi-files"></i></button>
            <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}" title="Delete"><i class="bi bi-trash"></i></button>
          </td>
        `;
        tableBody.appendChild(tr);

        // Mobile card
        const card = document.createElement('div');
        card.className = 'card mb-2 text-start '+(i===currentTurn?'border-success':'');
        card.innerHTML = `
          <div class="card-body">
            <h5 class="card-title mb-1">
              ${c.name} <small class="text-muted">(${c.type} ‚Ä¢ Init ${c.initiative} ‚Ä¢ AC ${c.ac ?? '-'})</small>
              ${c.concentration ? '<span class="ms-1 text-warning" title="Concentration"><i class="bi bi-star-fill"></i></span>' : ''}
            </h5>
            <div class="mb-1">HP:
              <input type="number" class="form-control form-control-sm health-input ${hpClass(pct)} d-inline-block" style="max-width:6rem" value="${c.currentHP}" data-index="${i}">
              <div class="btn-group btn-group-sm ms-1 hp-controls">
                <button class="btn btn-outline-light hit-btn" data-delta="-5" data-index="${i}">-5</button>
                <button class="btn btn-outline-light hit-btn" data-delta="-1" data-index="${i}">-1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="1" data-index="${i}">+1</button>
                <button class="btn btn-outline-light hit-btn" data-delta="5" data-index="${i}">+5</button>
              </div>
            </div>
            <div class="d-flex align-items-center justify-content-between">
              <div class="status-icon-row" data-bs-toggle="tooltip" title="${statusTooltipText(c)}">
                ${c.status.map(s=>{
                  const rem = (typeof s.remaining==='number') ? ` data-remaining="${s.remaining}"` : '';
                  return `<span class="status-chip"${rem} title="${s.name}">${s.icon}</span>`;
                }).join('') || '<span class="text-secondary" style="opacity:.6;">‚Äî</span>'}
              </div>
              <div class="notes-actions">
                <button class="btn btn-sm btn-outline-light notes-btn" data-index="${i}" title="Notes"><i class="bi bi-journal-text"></i></button>
                <button class="btn btn-sm conc-btn ${c.concentration?'conc-on':''}" title="Toggle Concentration" data-index="${i}">
                  <i class="bi ${c.concentration?'bi-star-fill':'bi-star'}"></i>
                </button>
                <button class="btn btn-sm btn-outline-info status-btn" data-index="${i}" title="Edit Status"><i class="bi bi-emoji-smile"></i></button>
              </div>
            </div>
            <div class="d-flex justify-content-end mt-2 gap-1">
              <button class="btn btn-sm btn-outline-light move-up" data-index="${i}"><i class="bi bi-arrow-up"></i></button>
              <button class="btn btn-sm btn-outline-light move-down" data-index="${i}"><i class="bi bi-arrow-down"></i></button>
              <button class="btn btn-sm btn-outline-success duplicate-btn" data-index="${i}"><i class="bi bi-files"></i></button>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-index="${i}"><i class="bi bi-trash"></i></button>
            </div>
          </div>
        `;
        mobileBody.appendChild(card);
      });

      // Tooltips
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
      bootstrap.Tooltip.getOrCreateInstance(el, { trigger: 'hover', html: false });
      });


      // HP adjust
      document.querySelectorAll('.hit-btn').forEach(b => {
        b.addEventListener('click', function() {
          const idx = +this.dataset.index;
          const delta = +this.dataset.delta;
          const c = characters[idx];
        
          pushHistory(`HP ${delta>=0?'+':''}${delta} for ${c.name}`);
        
          if (delta < 0) {
            // Damage: consume temp HP first
            let dmg = -delta;
            const usedThp = Math.min(c.tempHP || 0, dmg);
            c.tempHP = (c.tempHP || 0) - usedThp;
            dmg -= usedThp;
            if (dmg > 0) {
              const oldHP = c.currentHP;
              c.currentHP = Math.max(0, Math.min(c.maxHP, c.currentHP - dmg));
              const taken = Math.max(0, oldHP - c.currentHP);
              c.damageTakenThisRound = (c.damageTakenThisRound || 0) + taken;
            }
          } else {
            // Healing
            const oldHP = c.currentHP;
            c.currentHP = Math.max(0, Math.min(c.maxHP, c.currentHP + delta));
            // Any healing resets death saves & stable
            if (c.currentHP > 0) c.deathSaves = { s:0, f:0, stable:false };
          }
          buildTable();
        });
      });

      document.querySelectorAll('.temphp-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          const d  = +this.dataset.delta;
          const c  = characters[idx];
          pushHistory(`TempHP ${d>=0?'+':''}${d} for ${c.name}`);
          c.tempHP = Math.max(0, (c.tempHP||0) + d);
          buildTable();
        });
      });

      function updateDeathState(c) {
        // cap and derive "stable" at 3 successes, no auto-death to keep it GM-controlled
        c.deathSaves.s = Math.min(3, Math.max(0, c.deathSaves.s|0));
        c.deathSaves.f = Math.min(3, Math.max(0, c.deathSaves.f|0));
        if (c.deathSaves.s >= 3) { c.deathSaves.stable = true; }
      }

      document.querySelectorAll('.ds-add').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          const kind = this.dataset.kind; // 's' or 'f'
          const c = characters[idx];
          if (c.currentHP > 0) return; // no DS above 0 HP
          pushHistory(`Death Save +${kind.toUpperCase()} for ${c.name}`);
          if (kind === 's') c.deathSaves.s = Math.min(3, (c.deathSaves.s||0) + 1);
          else c.deathSaves.f = Math.min(3, (c.deathSaves.f||0) + 1);
          updateDeathState(c);
          buildTable();
        });
      });
      document.querySelectorAll('.ds-reset').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          const c = characters[idx];
          pushHistory(`Death Saves reset for ${c.name}`);
          c.deathSaves = { s:0, f:0, stable:false };
          buildTable();
        });
      });


      document.querySelectorAll('.health-input').forEach(inp=>{
        let pushed = false;
        inp.addEventListener('focus', function(){
          pushed = false;
          this.dataset._orig = this.value;
        });
        inp.addEventListener('blur', function(){
          const idx = +this.dataset.index;
          const newHP = Math.max(0, Math.min(characters[idx].maxHP, parseInt(this.value, 10) || 0));
          const oldHP = characters[idx].currentHP;
          if (!pushed && newHP !== oldHP) pushHistory(`HP set for ${characters[idx].name}`);
          if (newHP < oldHP) {
            characters[idx].damageTakenThisRound = (characters[idx].damageTakenThisRound || 0) + (oldHP - newHP);
          } else if (newHP > 0) {
            // Healing resets DS
            characters[idx].deathSaves = { s:0, f:0, stable:false };
          }
          characters[idx].currentHP = newHP;
          buildTable();
        });
        inp.addEventListener('input', function(){
          // live typing: do nothing heavy; final commit happens on blur
        });
      });

      // Initiative commit (Enter / blur)
      document.querySelectorAll('.init-input[data-commit="init"]').forEach(inp=>{
        let original = inp.value;
        const idx = +inp.dataset.index;
        const commit = ()=>{
          const newVal = parseInt(inp.value,10) || 0;
          if (characters[idx].initiative !== newVal) {
            pushHistory(`Set initiative for ${characters[idx].name}`);
            characters[idx].initiative = newVal;        // <-- set it
            maybeSortByInitiative();
            buildTable();
          }
        };
        inp.addEventListener('keydown', e=>{
          if (e.key === 'Enter'){ e.preventDefault(); commit(); }
          if (e.key === 'Escape'){ inp.value = original; inp.blur(); }
        });
        inp.addEventListener('focus', ()=> original = inp.value);
        inp.addEventListener('blur', commit);
      });

      // Notes modal open
      document.querySelectorAll('.notes-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          modalCharacterIndex = +this.dataset.index;
          const c = characters[modalCharacterIndex];
          $('notesModalLabel').textContent = `Notes ‚Äî ${c.name}`;
          $('notes-text').value = c.notes || '';
          if (notesModal) {
            notesModal.show();
          } else {
            const modalEl = document.getElementById('notesModal');
            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          }

                  });
                });
                $('notes-save-btn').onclick = ()=>{
                  if (modalCharacterIndex==null) return;
                  characters[modalCharacterIndex].notes = $('notes-text').value;
                  modalCharacterIndex = null;
                  if (notesModal) {
            notesModal.hide();
          } else {
            const modalEl = document.getElementById('notesModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal?.hide();
          }

        if (autoSaveEnabled) saveState();
      };

      // Concentration toggle
      document.querySelectorAll('.conc-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          pushHistory(`Toggle Concentration for ${characters[idx].name}`);
          characters[idx].concentration = !characters[idx].concentration;
          buildTable();
        });
      });

      // Status Modal open
      document.querySelectorAll('.status-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          modalCharacterIndex = +this.dataset.index;
          openStatusModal(modalCharacterIndex);
        });
      });

      // Duplicate/Delete
      document.querySelectorAll('.duplicate-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          pushHistory(`Duplicate ${characters[idx].name}`);
          const copy = JSON.parse(JSON.stringify(characters[idx]));
          copy.name += ' (copy)';
          characters.splice(idx+1, 0, copy);
          buildTable();
        });
      });
      document.querySelectorAll('.delete-btn').forEach(btn=>{
        btn.addEventListener('click', function(){
          const idx = +this.dataset.index;
          pushHistory(`Delete ${characters[idx].name}`);
          characters.splice(idx,1);
          if (currentTurn >= characters.length) currentTurn = 0;
          if (!characters.length) combatRound = 1;
          buildTable();
        });
      });
      
      // Mobile move
      document.querySelectorAll('.move-up').forEach(btn=>{
        btn.addEventListener('click', function(){
          const i = +this.dataset.index; if (i<=0) return;
          pushHistory('Reorder (up)');
          [characters[i-1], characters[i]] = [characters[i], characters[i-1]];
          buildTable();
        });
      });
      document.querySelectorAll('.move-down').forEach(btn=>{
        btn.addEventListener('click', function(){
          const i = +this.dataset.index; if (i>=characters.length-1) return;
          pushHistory('Reorder (down)');
          [characters[i+1], characters[i]] = [characters[i], characters[i+1]];
          buildTable();
        });
      });
      
      // Sortable (desktop) ‚Äî init once, reuse
      if (!sortableInstance) {
        const tbodyEl = $('initiative-order');
        if (tbodyEl) {
          sortableInstance = new Sortable(tbodyEl, {
            handle: '.drag-handle',
            animation: 150,
            onEnd: function(evt){
              pushHistory('Reorder (drag)');
              const [moved] = characters.splice(evt.oldIndex,1);
              characters.splice(evt.newIndex,0,moved);
              buildTable();
            }
          });
        }
      } else {
        // keep disabled state in sync with "Lock Order"
        sortableInstance.option('disabled', $('lockOrderToggle')?.checked === true);
      }

      buildDiceHistory();
      if (autoSaveEnabled) saveState();
    }

    // First-visit helper: show the Help panel once
    if (!localStorage.getItem('initiativeHelpSeen')) {
      const el = $('helpCanvas');
      if (el) bootstrap.Offcanvas.getOrCreateInstance(el).show();
      localStorage.setItem('initiativeHelpSeen', '1');
    }

    // ---------- Status Modal logic ----------
    function openStatusModal(i){
      const c = characters[i];

      // Badges
      const badges = $('status-badges'); badges.innerHTML = '';
      c.status.forEach(s=>{
        const rem = (typeof s.remaining==='number' && s.remaining>=0) ? ` (${s.remaining})` : '';
        const span = document.createElement('span');
        span.className = 'badge bg-secondary px-2 py-1';
        span.innerHTML = `${s.icon} ${s.name}${rem}
          <i class="bi bi-x ms-1 remove-status" data-eff="${s.name}" role="button" title="Remove"></i>`;
        badges.appendChild(span);
      });
      badges.querySelectorAll('.remove-status').forEach(x=>{
      x.addEventListener('click', function(){
        const eff = this.dataset.eff;
        pushHistory(`Remove ${eff} from ${c.name}`);
        c.status = c.status.filter(ss => ss.name !== eff);
        buildTable();
        openStatusModal(i);
      });
    });


      // Dropdown
      const list = $('status-dropdown-list'); list.innerHTML = '';
      statusEffects.forEach(effect=>{
        const has = c.status.some(s=> s.name === effect.name);
        const li = document.createElement('li');
        li.innerHTML = `<a class="dropdown-item ${has?'disabled text-muted':''}" href="#" data-eff="${effect.name}">${effect.icon} ${effect.name}</a>`;
        list.appendChild(li);
      });

      let pendingEffect = null;
      list.querySelectorAll('a[data-eff]').forEach(a=>{
        a.addEventListener('click', function(e){
          e.preventDefault();
          if (this.classList.contains('disabled')) return;
          pendingEffect = this.dataset.eff;
        });
      });

      $('add-status-btn').onclick = function(){
        if (!pendingEffect) { alert('Choose an effect first.'); return; }
        const durVal = parseInt($('status-duration').value,10);
        const base = statusEffects.find(x=>x.name===pendingEffect) || {icon:'‚ùì'};
        const eff = { name: pendingEffect, icon: base.icon };
        if (!isNaN(durVal) && durVal >= 0) eff.remaining = durVal;

        pushHistory(`Add ${pendingEffect} to ${c.name}`);
        c.status.push(eff);
        $('status-duration').value = '';
        // keep modal open
        statusModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('statusModal'));
        statusModal.show();

        buildTable();
      };

      
      
      const modalEl = document.getElementById('statusModal');
if (!modalEl) {
  console.error('Status modal element missing');
  return;
}
statusModal = bootstrap.Modal.getOrCreateInstance(modalEl);
statusModal.show();

    }

    // ---------- Round & durations ----------
    function tickStatusDurationsOnNewRound(){
      characters.forEach(c=>{
        c.status = (c.status||[])
          .map(s=>{
            if (typeof s.remaining === 'number' && s.remaining > 0){
              return {...s, remaining: s.remaining - 1};
            }
            return s;
          })
          .filter(s=> s.remaining === undefined || s.remaining > 0);
      });
    }

    function handleEndOfRoundConcentration() {
     characters.forEach(c => {
      if (c.concentration && c.damageTakenThisRound > 0) {
        const damage = c.damageTakenThisRound;
        const dc = Math.max(10, Math.floor(damage / 2));
        alert(`${c.name} took ${damage} damage this round.
        Concentration Check Required:
        Roll a d20 + Constitution modifier (+ proficiency if proficient)
        vs DC ${dc}.
        \nDC = max(10, half of ${damage})`);

              // Reset damage counter each round
              c.damageTakenThisRound = 0;
            } else {
              c.damageTakenThisRound = 0;
            }
      });
    }


    // ---------- Controls ----------
    $('initiative-form').addEventListener('submit', e=>{
      e.preventDefault();
      const name = $('character-name').value.trim();
      const init = parseInt($('initiative-roll').value,10);
      const maxHP = parseInt($('character-health').value,10);
      const ac = parseInt($('character-ac').value,10);
      const type = $('character-type').value;
      if(!name || isNaN(init) || isNaN(maxHP) || isNaN(ac)) return;

      characters.push({
        name, type, initiative:init,
        currentHP:maxHP, maxHP, tempHP:0,
        notes:'', ac, status:[], concentration:false,
        deathSaves:{ s:0, f:0, stable:false },
        damageTakenThisRound: 0
      });
      maybeSortByInitiative();
      e.target.reset();
      buildTable();
    });

    $('next-turn').addEventListener('click', ()=>{
      if (!characters.length) return;
      const len = characters.length;
      let attempts = 0;
      do{
        currentTurn = (currentTurn + 1) % len;
        if (currentTurn === 0) {
        combatRound++;
        tickStatusDurationsOnNewRound();
        handleEndOfRoundConcentration();
      }

        attempts++;
      }while(characters[currentTurn].currentHP <= 0 && attempts < len);
      buildTable();
      document.querySelector('.active-turn')?.scrollIntoView({ block:'nearest' });
    });

    $('reset-turns').addEventListener('click', ()=>{ currentTurn=0; combatRound=1; buildTable(); });
    $('clear-all').addEventListener('click', ()=>{ characters=[]; currentTurn=0; combatRound=1; buildTable(); });
    $('clear-storage').addEventListener('click', ()=>{
      if (!confirm('Clear ALL local saved data (sessions, templates, notes)?')) return;
      localStorage.clear(); characters=[]; currentTurn=0; combatRound=1;
      buildSavedUI(); buildTable();
      alert('All saved data cleared.');
    });

    $('undo-btn').addEventListener('click', undoLast);
    $('manualSaveBtn').addEventListener('click', ()=>{ saveState(true); alert('Manual save complete.'); });
    $('autoSaveToggle').addEventListener('change', e=>{ autoSaveEnabled = e.target.checked; });
    $('lockOrderToggle').addEventListener('change', e=>{
      if (sortableInstance) sortableInstance.option('disabled', e.target.checked);
    });
    $('copyOrderBtn').addEventListener('click', ()=>{
      const out = characters.map((c,i)=> `${i+1}. ${c.name} (${c.type}) ‚Äî Init ${c.initiative}`).join('\n');
      if (!out) return;
      navigator.clipboard.writeText(out);
    });

    function updateSaveHistory(){
      const sel = $('saveHistorySelect');
      sel.innerHTML = '<option disabled selected>Load Previous Save</option>';
      Object.keys(localStorage)
        .filter(k=>k.startsWith('initiativeTrackerData_'))
        .sort().reverse()
        .forEach(key=>{
          const t = key.replace('initiativeTrackerData_','');
          const opt = document.createElement('option');
          opt.value = key; opt.textContent = new Date(t).toLocaleString();
          sel.appendChild(opt);
        });
    }
    $('saveHistorySelect').addEventListener('change', function(){
      const raw = localStorage.getItem(this.value); if(!raw) return;
      try{
        const data = JSON.parse(raw);
        characters = (data.characters||[]).map(normalizeChar);
        currentTurn = data.currentTurn||0;
        combatRound = data.combatRound||1;
        diceHistory = Array.isArray(data.diceHistory) ? data.diceHistory : [];
        buildTable();
      }catch(e){ alert('Failed to load that save.'); }
    });

    // Export/Import session
    $('export-btn').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify({characters,currentTurn,combatRound,diceHistory}, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`initiativeTracker_${new Date().toISOString()}.json`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });
    $('import-btn').addEventListener('click', ()=> $('import-file').click());
    $('import-file').addEventListener('change', function(){
      const f = this.files[0]; if(!f) return;
      const r = new FileReader();
      r.onload = e=>{
        try{
          const d = JSON.parse(e.target.result);
          characters = (d.characters||[]).map(normalizeChar);
          currentTurn = d.currentTurn||0;
          combatRound = d.combatRound||1;
          diceHistory = d.diceHistory||[];
          buildTable(); alert('Session imported successfully.');
        }catch(err){ alert('Failed to import session. Invalid file.'); }
      };
      r.readAsText(f); this.value='';
    });

    // Keyboard shortcuts (not when typing)
    document.addEventListener('keydown', e=>{
      const tag = document.activeElement?.tagName || '';
      if (tag === 'INPUT' || tag === 'TEXTAREA') return;
      if (e.key==='n') $('next-turn').click();
      else if (e.key==='r') $('reset-turns').click();
      else if (e.key==='c') $('copyOrderBtn').click();
      else if (e.key==='s') $('manualSaveBtn').click();
      else if (e.key==='l') $('lockOrderToggle').click();
    });

    // Boot
    loadState();
    updateSaveHistory();
    buildSavedUI();
    buildTable();
    window.addEventListener('beforeunload', ()=>{ if (autoSaveEnabled) saveState(); });
  })();
  </script>
</body>
</html>
