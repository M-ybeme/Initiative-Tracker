<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Tavern/Inn</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css" />
  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/site.js"></script>
  <style>
    .bgimage{
      background: url('images/BGMap.png') no-repeat center center fixed;
      background-size: cover;
    }
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn {
      border-left: 5px solid #1d9e6d !important;
      color: #f8f9fa !important;
      font-weight: bold;
    }
    #saveHistorySelect { min-width: 200px; }
  </style>
</head>
<body class="bgimage">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Initiative</a></li>
          <li class="nav-item"><a class="nav-link" href="name.html">Name Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="loot.html">Loot Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="npc.html">NPC Gen</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="tav.html">Tavern/Inn Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="battlemap.html">Battle Map</a></li>
          <li class="nav-item"><a class="nav-link" href="encounterbuilder.html">Encounter Builder</a></li>
          <li class="nav-item"><a class="nav-link" href="characters.html">Characters</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="content pt-3">
    <h1 class="d-flex justify-content-center"> Tavern Inn Generator</h1>
    <div class="container-fluid text-center backdrop">

      <!-- ===== Tavern/Inn Generator (drop-in) ===== -->
      <div class="row g-3">
        <!-- Settings -->
        <div class="col-12 col-lg-4">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary"><h5 class="mb-0">Tavern/Inn Settings</h5></div>
            <div class="card-body">
              <div class="mb-2">
                <label for="tv-settlement" class="form-label">Settlement</label>
                <select id="tv-settlement" class="form-select">
                  <option value="village">Village</option>
                  <option value="town" selected>Town</option>
                  <option value="capital">Capital</option>
                </select>
              </div>

              <div class="row g-2">
                <div class="col-6">
                  <label for="tv-quality" class="form-label">Quality</label>
                  <select id="tv-quality" class="form-select">
                    <option value="rough">Rough</option>
                    <option value="common" selected>Common</option>
                    <option value="cozy">Cozy</option>
                    <option value="fine">Fine</option>
                  </select>
                </div>
                <div class="col-6">
                  <label for="tv-size" class="form-label">Size</label>
                  <select id="tv-size" class="form-select">
                    <option value="small">Small</option>
                    <option value="medium" selected>Medium</option>
                    <option value="large">Large</option>
                  </select>
                </div>
              </div>

              <div class="row g-2 mt-1">
                <div class="col-6">
                  <label for="tv-seed" class="form-label">Seed (optional)</label>
                  <input id="tv-seed" class="form-control" type="text" placeholder="e.g. session-15">
                </div>
                <div class="col-6">
                  <label for="tv-uniquepct" class="form-label">Unique touch %</label>
                  <input id="tv-uniquepct" class="form-control" type="number" inputmode="numeric" min="0" max="100" value="35">
                </div>
              </div>

              <div class="form-check mt-2">
                <input class="form-check-input" type="checkbox" id="tv-showStaff" checked>
                <label class="form-check-label" for="tv-showStaff">Include staff snippets</label>
              </div>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="tv-showRooms" checked>
                <label class="form-check-label" for="tv-showRooms">Include room listings</label>
              </div>

              <div class="d-grid d-sm-flex gap-2 mt-3">
                <button class="btn btn-success w-100 w-sm-auto" id="tv-generate"><i class="bi bi-cup-hot me-1"></i>Generate</button>
                <button class="btn btn-outline-light w-100 w-sm-auto" id="tv-copy"><i class="bi bi-clipboard me-1"></i>Copy</button>
                <button class="btn btn-warning w-100 w-sm-auto" id="tv-download"><i class="bi bi-download me-1"></i>Download .txt</button>
                <button class="btn btn-danger w-100 w-sm-auto" id="tv-clear"><i class="bi bi-trash me-1"></i>Clear</button>
              </div>

              <div class="alert alert-info mt-3 text-start">
                <div class="fw-semibold mb-1"><i class="bi bi-info-circle"></i> Tip</div>
                This tool builds the <strong>menu, drinks, rooms, staff, name, sign, and ambience</strong>.<br>
                <small class="text-secondary">Click "Generate Full NPC Details" on any staff member to expand them with full personality traits!</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Results -->
        <div class="col-12 col-lg-8">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary"><h5 class="mb-0">Tavern/Inn</h5></div>
            <div class="card-body">
              <div id="tv-meta" class="d-flex flex-wrap gap-2 small text-secondary mb-2"></div>

              <div class="text-start mb-3">
                <div id="tv-sign" class="fs-5 fw-semibold"></div>
                <div id="tv-amb" class="d-flex flex-wrap gap-2 mt-1"></div>
                <div id="tv-unique" class="text-info small mt-2"></div>
              </div>

              <div class="row g-3">
                <div class="col-12">
                  <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary"><h6 class="mb-0">Meals</h6></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="tv-tbl w-100">
                          <thead><tr><th style="width:35%">Item</th><th style="width:45%">Description</th><th style="width:20%">Price</th></tr></thead>
                          <tbody id="tv-meals"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12">
                  <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary"><h6 class="mb-0">Drinks</h6></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="tv-tbl w-100">
                          <thead><tr><th style="width:25%">Item</th><th style="width:20%">Type</th><th style="width:35%">Notes</th><th style="width:20%">Price</th></tr></thead>
                          <tbody id="tv-drinks"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12" id="tv-rooms-wrap">
                  <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary"><h6 class="mb-0">Rooms</h6></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="tv-tbl w-100">
                          <thead><tr><th style="width:28%">Type</th><th style="width:42%">Amenities</th><th style="width:15%">Price / night</th><th style="width:15%">Available</th></tr></thead>
                          <tbody id="tv-rooms"></tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12" id="tv-staff-wrap">
                  <div class="card bg-dark border-secondary">
                    <div class="card-header border-secondary"><h6 class="mb-0">Staff</h6></div>
                    <div class="card-body">
                      <div class="row row-cols-1 row-cols-sm-2 g-2" id="tv-staff"></div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <style>
        .tv-pill{border:1px solid rgba(255,255,255,.15);border-radius:50rem;padding:.15rem .5rem}
        .tv-tag{border:1px solid rgba(255,255,255,.15);border-radius:50rem;padding:.1rem .5rem;font-size:.85rem}
        .tv-card{border:1px solid rgba(255,255,255,.15);border-radius:.6rem;padding:.6rem;background:rgba(0,0,0,.2)}
        .tv-staff-title{font-weight:600}
        .tv-tbl th,.tv-tbl td{padding:.35rem .5rem;border-bottom:1px solid rgba(255,255,255,.08);vertical-align:top}
        .tv-tbl th{color:#9aa0a6;font-weight:600}
        @media (max-width:576px){
          .tv-tbl thead{display:none}
          .tv-tbl tr{display:block;margin-bottom:.5rem;border:1px solid rgba(255,255,255,.08);border-radius:.5rem;padding:.25rem}
          .tv-tbl td{display:block;border:0}
          .tv-tbl td::before{content:attr(data-label) ": ";font-weight:600;color:#9aa0a6}
        }
      </style>

      <script>
      (()=>{
        // ---------- Seeded RNG ----------
        function hashString(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return (h>>>0)>>>0}
        function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
        function prand(seedStr){const s = seedStr? hashString(seedStr) : Math.floor(Math.random()*2**32); return mulberry32(s) }
        const $ = (id)=>document.getElementById(id);
        function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
        function pickN(rng, arr, n){ const a=[...arr]; const out=[]; for(let i=0;i<n&&a.length;i++){ out.push(a.splice(Math.floor(rng()*a.length),1)[0]); } return out; }
        function clamp(v,min,max){ return Math.max(min,Math.min(max,v)) }

        // ---------- Data Pools ----------
        const SETTLEMENT = {
          village:{ price:[1.05,1.20], room:[1.0, 3], meals:6, drinks:7, staff:3 },
          town:{    price:[0.95,1.10], room:[1.0, 6], meals:8, drinks:9, staff:4 },
          capital:{ price:[0.90,1.05], room:[1.0,10], meals:10,drinks:12,staff:5 }
        };
        const QUALITY = {
          rough:{ mult:0.9, tags:["rough-hewn benches","sawdust underfoot","smoky rafters","loud by night"] },
          common:{ mult:1.0, tags:["well-swept floor","sturdy tables","busy at supper","lamplit"] },
          cozy:{ mult:1.2, tags:["crackling hearth","soft chairs","warm lighting","fresh bread scent"] },
          fine:{ mult:1.5, tags:["polished wood","quiet service","fine glassware","linen tablecloths"] }
        };

        const AMBIENCE = ["low murmur","fire-lit","lamplit","clean","cozy","drafty","lively","quiet","rowdy after dusk","musician on market nights","card games","dice at back table","chalk menu board","cat by the hearth","fresh sawdust","hops aroma","yeast and bread","woodsmoke","herbal tea scents","oiled hinges"];

        const MEAL_BASE = [
          {n:"Hearty stew", p:[8,14], dBits:["thick broth","root vegetables","barley"], side:["heel of bread","pickled onions","herb dumpling"]},
          {n:"Roast fowl", p:[10,18], dBits:["crisp skin","pan gravy"], side:["buttered greens","spiced carrots","oaten loaf slice"]},
          {n:"Vegetable pie", p:[7,12], dBits:["flaky crust","savory herbs"], side:["gravy boat","cress salad","chutney"]},
          {n:"Fisherman’s plate", p:[10,16], dBits:["pan-fried","lemon and herb"], side:["brown bread","peas and onions","tart sauce"]},
          {n:"Sausage & mash", p:[8,13], dBits:["onion gravy"], side:["braised cabbage","buttered peas","ale mustard"]},
          {n:"Herder’s platter", p:[6,11], dBits:["cheese wedge","cured meats"], side:["apple slices","pickles","rye heel"]},
          {n:"Spiced lentils", p:[6,10], dBits:["garlic oil","cumin"], side:["flatbread","yogurt spoon","parsley"]},
          {n:"Pottage of the day", p:[5,9], dBits:["seasonal vegetables"], side:["brown crust","chive butter","salt"]},
          {n:"Roast root medley", p:[6,10], dBits:["honey glaze","rosemary"], side:["seeded roll","sprig of thyme","herbed salt"]},
          {n:"Pie of the day", p:[7,14], dBits:["steam-piping","pepper"], side:["gravy boat","pickled relish","greens"]}
        ];
        const DRINKS = {
          ale:[
            {n:"Amber ale", p:[3,6], notes:["malty","clean finish"]},
            {n:"Brown ale", p:[3,6], notes:["nutty","toffee hint"]},
            {n:"Dark stout", p:[4,7], notes:["roasted","creamy head"]},
            {n:"Honey wheat", p:[3,6], notes:["light","honeyed"]}
          ],
          cider:[
            {n:"Apple cider (sweet)", p:[3,5], notes:["orchard-fresh"]},
            {n:"Apple cider (dry)", p:[3,5], notes:["crisp","tannin edge"]},
            {n:"Pear cider", p:[3,5], notes:["soft fruit"]}
          ],
          wine:[
            {n:"Table red", p:[5,9], notes:["berry","dry"]},
            {n:"Table white", p:[5,9], notes:["floral","light"]},
            {n:"Mulled wine", p:[6,10], notes:["spiced","warm"]}
          ],
          spirits:[
            {n:"Grain spirit", p:[6,12], notes:["sharp","clean"]},
            {n:"Rye whiskey", p:[8,16], notes:["pepper","oak"]},
            {n:"Herbal bitters", p:[6,12], notes:["aromatic","digestif"]}
          ],
          soft:[
            {n:"Buttermilk", p:[2,4], notes:["cool","filling"]},
            {n:"Herbal tea", p:[2,4], notes:["mint","chamomile"]},
            {n:"Small beer", p:[2,4], notes:["very light"]}
          ]
        };
        const HOUSE_TWISTS = [
          "house loaf served warm with herbed butter",
          "signature onion jam on the side",
          "smoked salt finish from a local kiln",
          "citrus-peel garnish on select plates",
          "pickled vegetables made in-house",
          "stoneware mugs stamped with a simple maker’s circle",
          "the cook prefers a hint of clove in stews",
          "fresh herbs grown in window boxes",
          "brined meats for extra tenderness",
          "dessert is a rotating fruit tart slice"
        ];
        const HOUSE_SPECIAL_DRINK = [
          "spiced ale warmed by the hearth",
          "cider with a ribbon of honey",
          "red wine mulled with orange peel",
          "dark stout floated with cream",
          "tea blend of mint and nettle",
          "clarified cider with a dash of bitters"
        ];

        const STAFF_ROLES = ["Proprietor","Barkeep","Cook","Server","Server"];
        const AGE = ["young adult","middle-aged","older","elderly","seasoned","fresh-faced","spry elder","timeworn"];
        const BUILD = ["slight","lean","average","sturdy","broad-shouldered","lithe","stocky","wiry","compact","athletic"];
        const HAIR_STYLE = ["short-cropped","curly","straight","braided","shaved","shoulder-length","coiled","loose waves","ringlets","messy bun"];
        const HAIR_COLOR = ["dark","fair","ginger","gray-streaked","white","sandy","jet-black","chestnut","auburn","ash-blond"];
        const EYES = ["grey","brown","green","blue","hazel","amber"];
        const ATTIRE = ["work-stained apron","patched cloak","neat tunic","travel-worn coat","simple uniform","layered shawl","tool belt and vest","well-kept robes","rolled-up sleeves","sturdy boots"];
        const DEMEANOR = ["brisk","courteous","cheerful","wary","even-tempered","no-nonsense","patient","eager","soft-spoken","forthright"];
        const VOICE_TIMBRE = ["warm","raspy","nasal","gravelly","breathy","clear","booming","soft","reedy","velvety"];
        const VOICE_PITCH = ["low","mid","high","baritone","alto"];
        const VOICE_ACCENT = ["local lilt","coastal drawl","northern clip","merchant cant","street patter","formal diction","sing-song inflection"];
        const MANNER = ["rubs thumb and forefinger","tilts head before answering","drums fingers on surfaces","keeps hands clasped","taps foot softly","hums under breath","adjusts spectacles","checks pocket contents","fidgets with a ring","smooths hair back"];

        // ---------- Helpers ----------
        function within(rng,[a,b]){ return a + rng()*(b-a) }
        function money(sp){ if(sp>=10){const gp=sp/10; return (gp%1?gp.toFixed(1):gp.toFixed(0))+" gp"; } return sp+" sp"; }
        function priceScale(rng, settlement, quality){
          const s = within(rng, SETTLEMENT[settlement].price);
          const q = QUALITY[quality].mult;
          return s*q;
        }
        function roomCapacity(size){
          return size==="small"? [1,3] : size==="large"? [4,10] : [2,6];
        }

        /* ---------- Inn Sign Name Pools + builder ---------- */
        const SIGN_COLORS = ["Red","Blue","Black","White","Golden","Silver","Green","Brown","Scarlet","Crimson","Emerald","Sable","Azure","Ivory","Amber"];
        const SIGN_TRAITS = ["Prancing","Sleeping","Laughing","Roaring","Leaping","Dancing","Crowned","Gilded","Lucky","Winking","Crooked","Humble","Wary","Merry","Rusty"];
        const SIGN_ANIMALS = ["Fox","Boar","Stag","Bear","Hound","Swan","Badger","Horse","Ram","Hare","Cock","Goat","Ox","Wolf","Mermaid","Dragon","Griffin","Unicorn"];
        const SIGN_OBJECTS = ["Crown","Anchor","Anvil","Bell","Wheel","Lantern","Rose","Gate","Star","Key","Barrel","Boot","Flask","Crescent","Hammer","Plough","Ship","Candle"];
        const SIGN_TITLES = ["King","Queen","Knight","Maiden","Miller","Cooper","Shepherd","Sailor","Smith","Bishop","Hunter","Innkeeper","Carpenter","Potter","Tailor"];
        const SIGN_NUMS = ["Two","Three","Four","Seven","Nine","Twelve"];

        function pluralize(word){
          if(/(s|x|z|ch|sh)$/i.test(word)) return word+"es";
          if(/y$/i.test(word) && !/[aeiou]y$/i.test(word)) return word.slice(0,-1)+"ies";
          return word+"s";
        }
        // Returns { name, motif }
        function buildInnName(rng){
          const pattern = Math.floor(rng()*7);
          switch(pattern){
            case 0: { const color = pick(rng,SIGN_COLORS), animal = pick(rng,SIGN_ANIMALS);
              return { name: `The ${color} ${animal}`, motif: `a ${color.toLowerCase()} ${animal.toLowerCase()}` }; }
            case 1: { const trait = pick(rng,SIGN_TRAITS), animal = pick(rng,SIGN_ANIMALS);
              return { name: `The ${trait} ${animal}`, motif: `a ${animal.toLowerCase()} showing ${trait.toLowerCase()}` }; }
            case 2: { const color = pick(rng,SIGN_COLORS), obj = pick(rng,SIGN_OBJECTS);
              return { name: `The ${color} ${obj}`, motif: `a ${color.toLowerCase()} ${obj.toLowerCase()}` }; }
            case 3: { const num = pick(rng,SIGN_NUMS), obj = pick(rng,SIGN_OBJECTS);
              return { name: `The ${num} ${pluralize(obj)}`, motif: `${num.toLowerCase()} ${pluralize(obj.toLowerCase())}` }; }
            case 4: { const animal = pick(rng,SIGN_ANIMALS), obj = pick(rng,SIGN_OBJECTS);
              return { name: `${animal} & ${obj}`, motif: `two icons: a ${animal.toLowerCase()} and a ${obj.toLowerCase()}` }; }
            case 5: { const color = pick(rng,SIGN_COLORS), title = pick(rng,SIGN_TITLES);
              return { name: `The ${color} ${title}`, motif: `a ${color.toLowerCase()} ${title.toLowerCase()}` }; }
            default: { const title = pick(rng,SIGN_TITLES), obj = pick(rng,SIGN_OBJECTS);
              return { name: `${title} & ${obj}`, motif: `two icons: a ${title.toLowerCase()} and a ${obj.toLowerCase()}` }; }
          }
        }

        // ---------- Builders ----------
        function buildAmbience(rng, settlement, quality){
          const tags = new Set();
          QUALITY[quality].tags.forEach(t=>tags.add(t));
          pickN(rng, AMBIENCE, 4).forEach(t=>tags.add(t));
          return [...tags];
        }
        function buildMeals(rng, count, mult){
          const rows=[]; const seen=new Set();
          let guard=0;
          while(rows.length<count && guard++<200){
            const b = pick(rng, MEAL_BASE);
            const sides = pick(rng, b.side);
            const bits = pickN(rng, b.dBits, Math.max(1, Math.floor(rng()*b.dBits.length)));
            const name = b.n;
            const desc = `${bits.join(", ")}; ${sides}`;
            if(seen.has(name+desc)) continue; seen.add(name+desc);
            const sp = Math.round(within(rng,b.p)*mult);
            rows.push({name, desc, price: money(Math.max(3,sp))});
          }
          if(rows.length) rows[0].desc += ` — ${pick(rng, HOUSE_TWISTS)}`;
          return rows;
        }
        function flattenDrinkList(){
          const all=[];
          for(const [type,arr] of Object.entries(DRINKS)){ arr.forEach(x=>all.push({...x,type})); }
          return all;
        }
        function buildDrinks(rng, count, mult){
          const list = flattenDrinkList();
          const rows=[]; const seen=new Set();
          let guard=0;
          while(rows.length<count && guard++<200){
            const d = pick(rng, list);
            const notes = pickN(rng, d.notes, 2).join(", ");
            const name = d.n;
            const key = name+"|"+notes;
            if(seen.has(key)) continue; seen.add(key);
            const sp = Math.round(within(rng,d.p)*mult);
            rows.push({name, type:d.type, notes, price: money(Math.max(2,sp))});
          }
          rows.unshift({name:"House specialty", type:"special", notes:pick(rng, HOUSE_SPECIAL_DRINK), price: money(Math.max(3, Math.round(6*mult)))});
          return rows;
        }
        function buildRooms(rng, settlement, quality, size, mult){
          const [minCap,maxCap]=roomCapacity(size);
          const base = [
            {type:"Common-room cot", p:[8,12], am:["blanket","shared hearth"], baseQty:[4,12]},
            {type:"Bunk room bed", p:[12,20], am:["shared washbasin","trunk space"], baseQty:[2,10]},
            {type:"Small private", p:[18,30], am:["lockable door","washbasin"], baseQty:[1,6]},
            {type:"Standard private", p:[25,40], am:["window","washbasin","writing desk"], baseQty:[1,6]},
            {type:"Comfort room", p:[35,60], am:["thicker mattress","hearth or hot brick"], baseQty:[0,4]},
            {type:"Suite", p:[60,120], am:["sitting area","good fireplace"], baseQty:[0,2]}
          ];
          const rows=[];
          base.forEach(row=>{
            const range = row.baseQty;
            const cap = Math.max(0, Math.floor(minCap + rng()*(maxCap-minCap+1)));
            const avail = Math.max(0, Math.min(range[1], Math.floor(rng()*(range[0]+cap))));
            let sp = Math.round(within(rng,row.p)*mult);
            if(quality==="rough") sp = Math.round(sp*0.9);
            if(quality==="cozy") sp = Math.round(sp*1.15);
            if(quality==="fine") sp = Math.round(sp*1.4);
            rows.push({type:row.type, am:row.am.join(", "), price: money(Math.max(8,sp)), avail});
          });
          return rows;
        }
        function buildStaff(rng, count){
          const staff=[];
          for(let i=0;i<count;i++){
            const role = STAFF_ROLES[i] || "Server";
            const age = pick(rng, AGE), build=pick(rng, BUILD), hair=`${pick(rng,HAIR_STYLE)} ${pick(rng,HAIR_COLOR)}`, eyes=pick(rng,EYES), attire=pick(rng,ATTIRE), dem=pick(rng,DEMEANOR);
            const voice = `${pick(rng,VOICE_TIMBRE)}, ${pick(rng,VOICE_PITCH)}; ${pick(rng,VOICE_ACCENT)}`;
            const manner = pick(rng, MANNER);
            const desc = `A ${age}, ${build} ${role.toLowerCase()} with ${hair} and ${eyes} eyes, wearing a ${attire}. ${dem} manner.`;
            staff.push({role, desc, voice, manner});
          }
          return staff;
        }

        // ---------- Generate ----------
        function generate(){
          const settlement = $("tv-settlement").value;
          const quality = $("tv-quality").value;
          const size = $("tv-size").value;
          const seed = $("tv-seed").value.trim();
          const uniquePct = clamp(+$("tv-uniquepct").value||35,0,100);
          const showStaff = $("tv-showRooms").checked; // intentionally left – next line corrects mapping
          // correct flags:
          const showStaffReal = $("tv-showStaff").checked;
          const showRooms = $("tv-showRooms").checked;

          const rng = prand(seed);
          const mult = priceScale(rng, settlement, quality);

          // meta
          const meta = $("tv-meta"); meta.innerHTML="";
          [["Settlement",settlement],["Quality",quality],["Size",size],["Seed",seed||"(random)"]]
            .forEach(([k,v])=>{ const s=document.createElement("span"); s.className="tv-pill"; s.textContent=`${k}: ${v}`; meta.appendChild(s); });

          // name + ambience
          const { name: tavName, motif } = buildInnName(rng);
          $("tv-sign").innerHTML = `<span class="fw-semibold">Name:</span> ${tavName} <span class="text-secondary small">— sign: ${motif}</span>`;

          $("tv-amb").innerHTML = "";
          buildAmbience(rng, settlement, quality).forEach(t=>{
            const span = document.createElement("span"); span.className="tv-tag"; span.textContent=t; $("tv-amb").appendChild(span);
          });
          $("tv-unique").textContent = (rng()*100 < uniquePct) ? `Unique touch: ${pick(rng, HOUSE_TWISTS)}.` : "";

          // meals
          const mealCount = SETTLEMENT[settlement].meals + (size==="large"?2: size==="small"?0:1);
          const meals = buildMeals(rng, mealCount, mult);
          const mealsT = $("tv-meals"); mealsT.innerHTML="";
          meals.forEach(m=>{
            const tr=document.createElement("tr");
            tr.innerHTML = `<td data-label="Item">${m.name}</td><td data-label="Description">${m.desc}</td><td data-label="Price">${m.price}</td>`;
            mealsT.appendChild(tr);
          });

          // drinks
          const drinkCount = SETTLEMENT[settlement].drinks + (size==="large"?3: size==="small"?0:1);
          const drinks = buildDrinks(rng, drinkCount, mult);
          const drinksT = $("tv-drinks"); drinksT.innerHTML="";
          drinks.forEach(d=>{
            const tr=document.createElement("tr");
            tr.innerHTML = `<td data-label="Item">${d.name}</td><td data-label="Type">${d.type}</td><td data-label="Notes">${d.notes}</td><td data-label="Price">${d.price}</td>`;
            drinksT.appendChild(tr);
          });

          // rooms
          const wrapRooms = $("tv-rooms-wrap");
          if(showRooms){
            wrapRooms.style.display="";
            const rooms = buildRooms(rng, settlement, quality, size, mult);
            const roomsT = $("tv-rooms"); roomsT.innerHTML="";
            rooms.forEach(r=>{
              const tr=document.createElement("tr");
              tr.innerHTML = `<td data-label="Type">${r.type}</td><td data-label="Amenities">${r.am}</td><td data-label="Price / night">${r.price}</td><td data-label="Available">${r.avail}</td>`;
              roomsT.appendChild(tr);
            });
          }else{
            wrapRooms.style.display="none";
          }

          // staff
          const wrapStaff = $("tv-staff-wrap");
          if(showStaffReal){
            wrapStaff.style.display="";
            const count = SETTLEMENT[settlement].staff + (size==="large"?1:0);
            const staff = buildStaff(rng, count);
            const grid = $("tv-staff"); grid.innerHTML="";
            staff.forEach(s=>{
              const col = document.createElement("div"); col.className="col";
              const card = document.createElement("div"); card.className="tv-card";
              card.innerHTML = `<div class="tv-staff-title">${s.role}</div>
                <div class="small">${s.desc}</div>
                <div class="small text-secondary">Voice: ${s.voice}; Mannerism: ${s.manner}.</div>
                <div class="mt-2">
                  <button class="btn btn-outline-info btn-sm w-100 tv-npc-gen-btn"
                    data-role="${s.role}"
                    data-desc="${s.desc.replace(/"/g, '&quot;')}"
                    data-voice="${s.voice.replace(/"/g, '&quot;')}"
                    data-manner="${s.manner.replace(/"/g, '&quot;')}">
                    <i class="bi bi-person-plus-fill me-1"></i>Generate Full NPC Details
                  </button>
                </div>`;
              col.appendChild(card); grid.appendChild(col);
            });
          }else{
            wrapStaff.style.display="none";
          }
        }

        // ---------- Serialize / Copy / Download ----------
        function serializeOut(){
          const nameLine = $("tv-sign").innerText.trim();
          const amb = [...document.querySelectorAll("#tv-amb .tv-tag")].map(x=>x.textContent).join(", ");
          const unique = $("tv-unique").innerText.trim();
          const meals = [...document.querySelectorAll("#tv-meals tr")]
            .map(tr=>`- ${tr.children[0].innerText} | ${tr.children[1].innerText} | ${tr.children[2].innerText}`).join("\n");
          const drinks = [...document.querySelectorAll("#tv-drinks tr")]
            .map(tr=>`- ${tr.children[0].innerText} (${tr.children[1].innerText}) | ${tr.children[2].innerText} | ${tr.children[3].innerText}`).join("\n");
          const rooms = [...document.querySelectorAll("#tv-rooms tr")]
            .map(tr=>`- ${tr.children[0].innerText} | ${tr.children[1].innerText} | ${tr.children[2].innerText} | ${tr.children[3].innerText} available`).join("\n");
          const staff = [...document.querySelectorAll("#tv-staff .tv-card")]
            .map(c=>c.innerText.replace(/\n+/g," — ")).join("\n");

          return [
            nameLine,
            amb ? `Ambience: ${amb}` : "",
            unique,
            meals ? "Meals:\n"+meals : "",
            drinks ? "Drinks:\n"+drinks : "",
            rooms ? "Rooms:\n"+rooms : "",
            staff ? "Staff:\n"+staff : ""
          ].filter(Boolean).join("\n\n");
        }
        function copyOut(){
          const text = serializeOut();
          if(text.trim()) navigator.clipboard.writeText(text);
        }
        function downloadOut(){
          const text = serializeOut();
          if(!text.trim()) return;
          const blob = new Blob([text], {type:"text/plain"});
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a"); a.href=url; a.download="tavern_inn.txt"; a.click(); URL.revokeObjectURL(url);
        }

        // ---------- NPC Integration (Staff → Full NPC) ----------
        function generateFullNPCFromStaff(role, desc, voice, manner){
          // Parse description to extract details
          const settlement = $("tv-settlement").value || "town";
          const seed = $("tv-seed").value.trim() + "-" + role + "-" + Date.now();
          const rng = prand(seed);

          // Build full NPC details using existing tavern staff data
          const npc = {
            role,
            desc,
            voice,
            mannerisms: manner + "; " + pick(rng, MANNER),
            quirk: pick(rng, ["collects buttons","keeps a neat ledger of tiny favors","names their tools","insists on exact change","carries a smooth lucky pebble","takes dawn walks daily","brews a personal tea blend","never swears","wears mismatched socks","polishes gear at the same hour"]),
            wants: [
              pick(rng, ["to make a fair sale","a quiet day of steady work","better tools","news from the road","to impress a supervisor","to trade for supplies","to hire short-term help","to clear a small debt","to finish on time"]),
              pick(rng, ["to maintain a good reputation","to teach an apprentice","repeat customers","to avoid shortages","a day off soon","a fair hearing","more storage space","to learn a new skill"])
            ].join("; "),
            avoids: [
              pick(rng, ["attention from officials","long haggling","rowdy crowds","credit purchases","wasting materials","lateness","broken promises","public arguments"]),
              pick(rng, ["being overheard","theft","refund disputes","wet weather","idle gossip about them","mud tracked indoors","smoldering coals near stock"])
            ].join("; "),
            secret: pick(rng, ["owes money to a local merchant guild","once witnessed a crime but never reported it","has a hidden stash of silver coins","secretly practices minor magic","keeps a journal of overheard conversations","is related to minor nobility","fled from another town years ago","knows the location of a smuggler's cache","has a false identity","once worked for a thieves' guild","is being blackmailed over a past indiscretion","sends anonymous donations to the local temple","saved a noble's life once","has a hidden family in another city","knows a secret passage under the town","once served in a war under a false name"])
          };

          return npc;
        }

        function showNPCModal(npc){
          // Create modal if it doesn't exist
          let modal = document.getElementById("npcModal");
          if(!modal){
            modal = document.createElement("div");
            modal.id = "npcModal";
            modal.className = "modal fade";
            modal.tabIndex = -1;
            modal.innerHTML = `
              <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-dark text-light">
                  <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="npcModalTitle">Full NPC Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body" id="npcModalBody"></div>
                  <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-outline-light" id="npcCopyBtn"><i class="bi bi-clipboard me-1"></i>Copy</button>
                    <button type="button" class="btn btn-primary" id="npcOpenInGenBtn"><i class="bi bi-box-arrow-up-right me-1"></i>Open in NPC Gen</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>`;
            document.body.appendChild(modal);
          }

          // Populate modal content
          const body = document.getElementById("npcModalBody");
          body.innerHTML = `
            <div class="npc-details">
              <div class="mb-3">
                <h6 class="text-info">Role</h6>
                <p>${npc.role}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Description</h6>
                <p>${npc.desc}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Voice</h6>
                <p>${npc.voice}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Mannerisms</h6>
                <p>${npc.mannerisms}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Quirk</h6>
                <p>${npc.quirk}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Wants</h6>
                <p>${npc.wants}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Wants to Avoid</h6>
                <p>${npc.avoids}</p>
              </div>
              <div class="mb-3">
                <h6 class="text-info">Secret</h6>
                <p>${npc.secret}</p>
              </div>
            </div>`;

          // Setup copy button
          document.getElementById("npcCopyBtn").onclick = ()=>{
            const text = [
              `Role: ${npc.role}`,
              `Description: ${npc.desc}`,
              `Voice: ${npc.voice}`,
              `Mannerisms: ${npc.mannerisms}`,
              `Quirk: ${npc.quirk}`,
              `Wants: ${npc.wants}`,
              `Wants to Avoid: ${npc.avoids}`,
              `Secret: ${npc.secret}`
            ].join("\n\n");
            navigator.clipboard.writeText(text);
          };

          // Setup "Open in NPC Gen" button
          document.getElementById("npcOpenInGenBtn").onclick = ()=>{
            // Store NPC data in localStorage for NPC Gen to pick up
            const npcData = {
              fromTavern: true,
              role: npc.role,
              desc: npc.desc,
              voice: npc.voice,
              mannerisms: npc.mannerisms,
              quirk: npc.quirk,
              wants: npc.wants,
              avoids: npc.avoids,
              secret: npc.secret,
              timestamp: Date.now()
            };
            localStorage.setItem("tavern-npc-handoff", JSON.stringify(npcData));
            window.open("npc.html?from=tavern", "_blank");
          };

          // Show modal
          const bsModal = new bootstrap.Modal(modal);
          bsModal.show();
        }

        // Wire up
        document.addEventListener("DOMContentLoaded", ()=>{
          $("tv-generate").addEventListener("click", generate);
          $("tv-copy").addEventListener("click", copyOut);
          $("tv-download").addEventListener("click", downloadOut);
          $("tv-clear").addEventListener("click", ()=>{
            $("tv-meta").innerHTML=""; $("tv-sign").textContent=""; $("tv-amb").innerHTML=""; $("tv-unique").textContent="";
            $("tv-meals").innerHTML=""; $("tv-drinks").innerHTML=""; $("tv-rooms").innerHTML=""; $("tv-staff").innerHTML="";
          });

          // Event delegation for NPC generation buttons
          document.addEventListener("click", (e)=>{
            if(e.target.closest(".tv-npc-gen-btn")){
              const btn = e.target.closest(".tv-npc-gen-btn");
              const role = btn.getAttribute("data-role");
              const desc = btn.getAttribute("data-desc");
              const voice = btn.getAttribute("data-voice");
              const manner = btn.getAttribute("data-manner");
              const npc = generateFullNPCFromStaff(role, desc, voice, manner);
              showNPCModal(npc);
            }
          });

          generate();
        });
      })();
      </script>
      <!-- ===== /Tavern/Inn Generator ===== -->

    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="footer-main py-3">
      <div class="container">
        <div class="row align-items-center text-center text-md-start">
          <!-- Left: Copyright -->
          <div class="col-12 col-md-4 mb-2 mb-md-0 text-md-start text-center">
            <small class="text-muted">&copy; 2025 Maybeme | The DM’s Toolbox</small>
          </div>

          <!-- Center: Logo -->
          <div class="col-12 col-md-4 text-center mb-2 mb-md-0">
            <img src="/images/White logo - no background.png" height="40" alt="Logo" class="footer-logo">
          </div>

          <!-- Right: Social Links -->
          <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end align-items-center gap-2">
            <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener" aria-label="LinkedIn">
              <i class="bi bi-linkedin"></i>
            </a>
            <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener" aria-label="GitHub">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://ko-fi.com/maybemestoolbox" class="socialicons d-flex align-items-center" target="_blank" rel="noopener" title="Support The DM’s Toolbox on Ko-fi">
              <i class="bi bi-cup-hot"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </footer>
</body>
</html>
