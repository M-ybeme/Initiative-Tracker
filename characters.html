<!DOCTYPE html> 
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Characters</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <link href="/css/characters-mobile.css" rel="stylesheet" />
  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/site.js"></script>
  <script src="/js/generated/srd-allowlist.js"></script>
  <script src="/js/modules/srd-content-filter.js"></script>

  <style>
    .bgimage{
      background: url('images/BGMap.png') no-repeat center center fixed;
      background-size: cover;
    }
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn {
      border-left: 5px solid #1d9e6d !important;
      color: #f8f9fa !important;
      font-weight: bold;
    }
    #saveHistorySelect { min-width: 200px; }

    .backdrop {
      background: rgba(0, 0, 0, 0.65);
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .portrait-frame {
      overflow: hidden;
      position: relative;
      border-radius: 0.5rem;
      border: 1px solid rgba(255,255,255,0.15);
      background-color: rgba(15,15,15,0.9);
    }

    .portrait-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      user-select: none;
      -webkit-user-drag: none;
      max-width: none;
      max-height: none;
      min-width: 100%;
      min-height: 100%;
    }

    .skill-table th,
    .skill-table td {
      padding: 0.25rem 0.4rem;
      vertical-align: middle;
    }

    .skill-table input[type="number"] {
      max-width: 3.5rem;
    }

    .save-pill {
      border-radius: 0.5rem;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 0.5rem 0.6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .save-pill .save-pill-top {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
      justify-content: center;
    }

    .save-pill label {
      margin-bottom: 0;
      min-width: 35px;
      font-weight: bold;
    }

    .save-pill input[type="number"] {
      max-width: 3.5rem;
      min-width: 3.5rem;
    }

    .save-pill .btn-group {
      width: 100%;
    }

    .save-pill .btn-group button {
      flex: 1;
    }

    /* Combat/DM View Styles */
    /* Combat View - Responsive Layout */
    .combat-card-view {
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    /* Mobile: single column, max 400px */
    @media (max-width: 767.98px) {
      .combat-card-view {
        max-width: 400px;
        margin: 0 auto;
      }
    }

    /* Tablet: wider but still centered */
    @media (min-width: 768px) and (max-width: 991.98px) {
      .combat-card-view {
        max-width: 720px;
        margin: 0 auto;
      }
    }

    /* Desktop: full width */
    @media (min-width: 992px) {
      .combat-card-view {
        max-width: 100%;
      }
    }

    /* Combat Layout Grid */
    .combat-layout {
      display: grid;
      gap: 1.5rem;
    }

    /* Mobile: single column */
    @media (max-width: 767.98px) {
      .combat-layout {
        grid-template-columns: 1fr;
        grid-template-areas:
          "header"
          "vitals"
          "abilities"
          "saves"
          "actions"
          "spells"
          "resources";
      }
    }

    /* Tablet: 2 columns */
    @media (min-width: 768px) and (max-width: 991.98px) {
      .combat-layout {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "header header"
          "vitals abilities"
          "saves saves"
          "actions spells"
          "resources resources";
      }
    }

    /* Desktop: 3+ columns */
    @media (min-width: 992px) {
      .combat-layout {
        grid-template-columns: minmax(200px, 280px) 1fr 1fr;
        grid-template-areas:
          "header vitals abilities"
          "header saves saves"
          "actions actions spells"
          "resources resources resources";
      }
    }

    /* Large desktop: even wider */
    @media (min-width: 1200px) {
      .combat-layout {
        grid-template-columns: minmax(220px, 300px) 1fr 1fr 1fr;
        grid-template-areas:
          "header vitals abilities saves"
          "header actions actions spells"
          "resources resources resources resources";
      }
    }

    .combat-area-header { grid-area: header; }
    .combat-area-vitals { grid-area: vitals; }
    .combat-area-abilities { grid-area: abilities; }
    .combat-area-saves { grid-area: saves; }
    .combat-area-actions { grid-area: actions; }
    .combat-area-spells { grid-area: spells; }
    .combat-area-resources { grid-area: resources; }

    .combat-portrait-frame {
      width: 100%;
      aspect-ratio: 3 / 4;
      max-height: 280px;
      overflow: hidden;
      position: relative;
      border-radius: 0.75rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(15, 15, 15, 0.9);
      margin-bottom: 1rem;
    }

    @media (min-width: 992px) {
      .combat-portrait-frame {
        max-height: 320px;
      }
    }

    .combat-portrait-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      user-select: none;
      -webkit-user-drag: none;
      max-width: none;
      max-height: none;
      min-width: 100%;
      min-height: 100%;
    }

    .combat-info-line {
      display: flex;
      justify-content: space-between;
      padding: 0.4rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.9rem;
    }

    .combat-info-line:last-child {
      border-bottom: none;
    }

    .combat-info-label {
      font-weight: bold;
      color: #adb5bd;
      min-width: 100px;
    }

    .combat-info-value {
      color: #f8f9fa;
      text-align: right;
      flex-grow: 1;
    }

    /* Vital Stats Grid (AC, HP, Speed, Init, Prof, PP) */
    .combat-stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    @media (min-width: 768px) {
      .combat-stat-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (min-width: 1200px) {
      .combat-stat-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .combat-stat-box {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      padding: 0.5rem;
      text-align: center;
    }

    .combat-stat-box.highlight-hp {
      border-color: rgba(34, 197, 94, 0.5);
      background: rgba(34, 197, 94, 0.1);
    }

    .combat-stat-box.highlight-ac {
      border-color: rgba(59, 130, 246, 0.5);
      background: rgba(59, 130, 246, 0.1);
    }

    .combat-stat-label {
      font-size: 0.7rem;
      color: #adb5bd;
      text-transform: uppercase;
      margin-bottom: 0.15rem;
    }

    .combat-stat-value {
      font-size: 1.25rem;
      font-weight: bold;
      color: #f8f9fa;
    }

    @media (min-width: 992px) {
      .combat-stat-value {
        font-size: 1.4rem;
      }
    }

    /* Ability Scores Grid */
    .combat-ability-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.35rem;
    }

    @media (max-width: 575.98px) {
      .combat-ability-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .combat-ability-box {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0.4rem;
      padding: 0.4rem 0.25rem;
      text-align: center;
    }

    .combat-ability-label {
      font-size: 0.65rem;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
    }

    .combat-ability-score {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    .combat-ability-mod {
      font-size: 1rem;
      font-weight: bold;
      color: #f8f9fa;
    }

    /* Saves Grid */
    .combat-saves-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 0.35rem;
    }

    @media (max-width: 575.98px) {
      .combat-saves-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .combat-save-box {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0.4rem;
      padding: 0.4rem 0.25rem;
      text-align: center;
    }

    .combat-save-box.proficient {
      border-color: rgba(34, 197, 94, 0.4);
      background: rgba(34, 197, 94, 0.08);
    }

    .combat-save-label {
      font-size: 0.65rem;
      color: #6b7280;
      text-transform: uppercase;
      font-weight: 600;
    }

    .combat-save-value {
      font-size: 1rem;
      font-weight: bold;
      color: #f8f9fa;
    }

    /* Spell Slots */
    .combat-slots-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .combat-slot-item {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 0.4rem;
      padding: 0.35rem 0.6rem;
      text-align: center;
      min-width: 60px;
    }

    .combat-slot-level {
      font-size: 0.65rem;
      color: #a78bfa;
      text-transform: uppercase;
    }

    .combat-slot-count {
      font-size: 0.9rem;
      font-weight: bold;
      color: #c4b5fd;
    }

    .combat-section-title {
      font-size: 0.9rem;
      font-weight: bold;
      color: #f8f9fa;
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .combat-section-title i {
      color: #6b7280;
    }

    .combat-panel {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 0.75rem;
      padding: 1rem;
    }

    .combat-action-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0.5rem;
      padding: 0.6rem;
      margin-bottom: 0.4rem;
    }

    .combat-action-name {
      font-weight: bold;
      color: #f8f9fa;
      font-size: 0.9rem;
      margin-bottom: 0.2rem;
    }

    .combat-action-detail {
      color: #adb5bd;
      font-size: 0.8rem;
      margin-bottom: 0.15rem;
    }

    .combat-spell-item {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 0.5rem;
      padding: 0.4rem 0.6rem;
      margin-bottom: 0.35rem;
    }

    .combat-spell-name {
      font-weight: bold;
      color: #c4b5fd;
      font-size: 0.85rem;
    }

    .combat-spell-meta {
      color: #adb5bd;
      font-size: 0.7rem;
    }

    /* Conditions display */
    .combat-conditions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.35rem;
    }

    .combat-condition-badge {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5;
      padding: 0.2rem 0.5rem;
      border-radius: 0.3rem;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .combat-condition-badge.positive {
      background: rgba(34, 197, 94, 0.2);
      border-color: rgba(34, 197, 94, 0.4);
      color: #86efac;
    }

    .combat-condition-badge.clickable-concentration {
      cursor: pointer;
      transition: all 0.2s;
    }

    .combat-condition-badge.clickable-concentration:hover {
      background: rgba(239, 68, 68, 0.4);
      transform: scale(1.05);
    }

    /* Resources Row */
    .combat-resources-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      align-items: flex-start;
    }

    .combat-resource-group {
      flex: 1;
      min-width: 150px;
    }

    .combat-hit-dice-btn {
      font-size: 0.85rem;
    }

    .combat-death-save-btn {
      font-size: 0.75rem;
    }

    /* Hide full sheet when in combat mode */
    body.combat-mode #fullCharacterSheet {
      display: none;
    }

    body.combat-mode #combatCardView {
      display: block;
    }

    body:not(.combat-mode) #combatCardView {
      display: none;
    }

    /* ===== Interactive Combat View Enhancements ===== */

    /* Interactive HP */
    .interactive-hp {
      cursor: pointer;
      position: relative;
      transition: transform 0.2s ease;
    }

    .interactive-hp:hover {
      transform: scale(1.02);
    }

    .interactive-hp.active {
      border-color: rgba(34, 197, 94, 0.6) !important;
    }

    .combat-hp-display {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .combat-hp-temp {
      font-size: 0.65rem;
      color: #38bdf8;
      margin-top: 0.1rem;
    }

    .combat-hp-controls {
      position: absolute;
      bottom: -50px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 100;
      background: #1f2937;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 0.5rem;
      padding: 0.35rem;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .combat-hp-btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .combat-hp-bar {
      height: 4px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 2px;
      margin-top: 0.4rem;
      overflow: hidden;
    }

    .combat-hp-bar-fill {
      height: 100%;
      transition: width 0.3s ease, background 0.3s ease;
      border-radius: 2px;
    }

    .combat-hp-bar-fill.hp-full { background: #22c55e; }
    .combat-hp-bar-fill.hp-mid { background: #eab308; }
    .combat-hp-bar-fill.hp-low { background: #ef4444; }
    .combat-hp-bar-fill.hp-critical {
      background: #ef4444;
      animation: hpPulse 1s infinite;
    }

    @keyframes hpPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes damageFlash {
      0% { background: rgba(239, 68, 68, 0.4); }
      100% { background: transparent; }
    }

    .interactive-hp.damage-flash {
      animation: damageFlash 0.3s ease-out;
    }

    /* Roll Buttons in Combat Actions */
    .combat-roll-buttons {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.25rem;
    }

    .combat-roll-buttons .btn-group {
      flex-wrap: nowrap;
    }

    .combat-roll-buttons .btn {
      padding: 0.2rem 0.4rem;
      font-size: 0.7rem;
    }

    .combat-roll-buttons .btn.btn-outline-primary {
      color: #6ea8fe !important;
      border-color: #6ea8fe !important;
    }

    .combat-roll-buttons .btn.btn-outline-primary:hover,
    .combat-roll-buttons .btn.btn-outline-primary:focus {
      color: #fff !important;
      background-color: #0d6efd !important;
      border-color: #0d6efd !important;
    }

    /* Inline Roll Result */
    .combat-roll-result {
      background: rgba(139, 92, 246, 0.15);
      border: 1px solid rgba(139, 92, 246, 0.4);
      border-radius: 0.4rem;
      padding: 0.5rem 0.75rem;
      margin-top: 0.5rem;
      animation: resultFadeIn 0.2s ease-out;
    }

    @keyframes resultFadeIn {
      from { opacity: 0; transform: translateY(-5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .combat-roll-result .roll-total {
      font-size: 1.3rem;
      font-weight: bold;
    }

    .combat-roll-result .roll-crit { color: #4ade80; }
    .combat-roll-result .roll-fumble { color: #f87171; }
    .combat-roll-result .roll-detail {
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    /* Clickable Saves, Stats, and Ability Checks */
    .combat-save-box.clickable-roll,
    .combat-stat-box.clickable-roll,
    .combat-ability-box.clickable-roll {
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .combat-save-box.clickable-roll:hover,
    .combat-stat-box.clickable-roll:hover,
    .combat-ability-box.clickable-roll:hover {
      background: rgba(139, 92, 246, 0.2);
      transform: scale(1.05);
      border-color: rgba(139, 92, 246, 0.5);
    }

    .combat-save-box.clickable-roll:active,
    .combat-stat-box.clickable-roll:active,
    .combat-ability-box.clickable-roll:active {
      transform: scale(0.98);
    }

    /* Cast Spell Button */
    .combat-cast-btn {
      padding: 0.15rem 0.5rem;
      font-size: 0.7rem;
      white-space: nowrap;
    }

    .combat-spell-item.casting {
      animation: castPulse 0.3s ease-out;
      border-color: rgba(255, 193, 7, 0.6);
    }

    @keyframes castPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); background: rgba(255, 193, 7, 0.2); }
      100% { transform: scale(1); }
    }

    /* Slot Status Indicators */
    .combat-slot-count.slots-full { color: #4ade80; }
    .combat-slot-count.slots-mid { color: #fbbf24; }
    .combat-slot-count.slots-low { color: #f87171; }
    .combat-slot-count.slots-empty { color: #6b7280; text-decoration: line-through; }

    /* Dice History Modal */
    .dice-history-item {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.2s ease;
    }

    .dice-history-item:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .dice-history-item:last-child {
      border-bottom: none;
    }

    .dice-history-item .roll-badge {
      font-size: 1.25rem;
      min-width: 3rem;
      text-align: center;
      padding: 0.25rem 0.5rem;
    }

    .dice-history-item .roll-badge.crit {
      background: linear-gradient(135deg, #059669, #10b981) !important;
    }

    .dice-history-item .roll-badge.fumble {
      background: linear-gradient(135deg, #dc2626, #ef4444) !important;
    }

    .dice-history-item .roll-details {
      font-family: 'Courier New', monospace;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .dice-history-item .roll-time {
      font-size: 0.7rem;
      color: #6b7280;
    }

    .dice-history-empty {
      text-align: center;
      padding: 3rem 1rem;
      color: #6b7280;
    }

    .dice-history-empty i {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }
  </style>
</head>
<body class="bgimage">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/DMsToolboxLogo.png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Combat
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="initiative.html">Initiative Tracker</a></li>
              <li><a class="dropdown-item" href="battlemap.html">Battle Map</a></li>
              <li><a class="dropdown-item" href="encounterbuilder.html">Encounter Builder</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Generators
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="name.html">Name Generator</a></li>
              <li><a class="dropdown-item" href="loot.html">Loot Generator</a></li>
              <li><a class="dropdown-item" href="shop.html">Shop Generator</a></li>
              <li><a class="dropdown-item" href="npc.html">NPC Generator</a></li>
              <li><a class="dropdown-item" href="tav.html">Tavern/Inn Generator</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Campaign
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" aria-current="page" href="characters.html">Characters</a></li>
              <li><a class="dropdown-item" href="journal.html">Journal</a></li>
              <li><a class="dropdown-item" href="reference.html">Compendium</a></li>
            </ul>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="content pt-4">
    <div class="container-fluid mt-5 pt-3">
      <div class="container backdrop text-light">
        <div class="alert alert-warning text-start" role="status">
          <div class="fw-semibold"><i class="bi bi-shield-lock me-1"></i>SRD Scope</div>
          <small>
            Races, subclasses, feats, and spells shown here are limited to SRD 5.2 (2024 PHB) unless you load a private content pack locally.
            Keep any non-SRD references in private packs rather than the public repo.
            <a href="docs/CONTENT_PACK_AUTHORING.md" target="_blank" class="text-warning text-decoration-underline">
              <i class="bi bi-file-earmark-text me-1"></i>Create Your Own Content Pack
            </a>
            <span class="mx-2">|</span>
            <span class="text-decoration-underline" data-bs-toggle="tooltip" data-bs-placement="top" title="Press Ctrl+Alt+D to open the diagnostics panel, then use Manage Content Packs to import purchased or homebrew data for the wizards.">
              How to load private packs
            </span>
          </small>
        </div>
        <!-- Header + Character Selector / Actions -->
        <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 gap-3">
          <div>
            <h2 class="mb-0">Character Manager</h2>
            <small class="text-muted">DM-focused character sheets with portraits, saved locally in your browser.</small>
          </div>

          <div class="ms-md-auto w-100 w-md-auto d-flex flex-column flex-lg-row gap-2 align-items-stretch align-items-lg-center mt-3 mt-md-0">
            <div class="d-flex flex-column flex-lg-row gap-2 align-items-stretch align-items-lg-center flex-grow-1">
              <select id="characterSelect" class="form-select" aria-label="Select Character">
                <!-- Populated by JS -->
              </select>

              <div class="btn-group flex-wrap" role="group" aria-label="Character actions">
                <button type="button" class="btn btn-sm btn-outline-light" id="newCharacterBtn">
                  <i class="bi bi-person-plus me-1"></i>New
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="saveCharacterBtn">
                  <i class="bi bi-save me-1"></i>Save
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="deleteCharacterBtn">
                  <i class="bi bi-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 justify-content-start justify-content-lg-end">
              <!-- Print/Export Character Sheet Dropdown -->
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-light dropdown-toggle" id="printExportDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Print or export character sheet">
                  <i class="bi bi-printer me-1"></i>Print/Export Sheet
                </button>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="printExportDropdown">
                  <li><a class="dropdown-item" href="#" id="printSheetBtn"><i class="bi bi-printer me-2"></i>Print Character Sheet</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" id="exportPdfBtn"><i class="bi bi-file-pdf me-2"></i>Export as PDF</a></li>
                  <li><a class="dropdown-item" href="#" id="exportPngBtn"><i class="bi bi-file-image me-2"></i>Export as PNG Image</a></li>
                  <li><a class="dropdown-item" href="#" id="exportWordBtn"><i class="bi bi-file-word me-2"></i>Export as Word (.docx)</a></li>
                </ul>
              </div>

              <button type="button" class="btn btn-sm btn-outline-info" id="exportCharacterBtn" title="Export current character as JSON">
                <i class="bi bi-download me-1"></i>Export
              </button>
              <button type="button" class="btn btn-sm btn-outline-warning" id="sendToTrackerBtn" title="Send current character to the Initiative Tracker">
                <i class="bi bi-arrow-right-circle me-1"></i>Send to Initiative Tracker
              </button>
              <button type="button" class="btn btn-sm btn-outline-success" id="sendToBattleMapBtn" title="Send current character as a token to the Battle Map">
                <i class="bi bi-geo-alt-fill me-1"></i>Send to Battle Map
              </button>
              <button type="button" class="btn btn-sm btn-outline-info" id="exportAllCharactersBtn" title="Export all characters as JSON">
                <i class="bi bi-archive me-1"></i>Export All
              </button>
              <button type="button" class="btn btn-sm btn-primary" id="helpBtn" title="View help and guide" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle me-1"></i>Help
              </button>

              <div class="position-relative">
                <input type="file" id="importFileInput" accept="application/json" class="d-none" />
                <button type="button" class="btn btn-sm btn-outline-warning" id="importCharacterBtn" title="Import character JSON">
                  <i class="bi bi-upload me-1"></i>Import
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Last updated & Storage Info -->
        <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="d-flex align-items-center gap-3">
            <small id="lastUpdatedText" class="text-muted"></small>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="dmCombatModeToggle" title="Toggle DM/Combat View">
              <label class="form-check-label text-light" for="dmCombatModeToggle">
                <i class="bi bi-lightning-charge me-1"></i>Combat View
              </label>
            </div>
          </div>
          <small id="storageUsageText" class="text-muted">
            <i class="bi bi-database me-1"></i>
            <span id="storageUsageValue">Calculating...</span>
          </small>
        </div>

        <!-- Main layout -->
        <div id="fullCharacterSheet" class="row g-3">
          <!-- LEFT COLUMN -->
          <div class="col-12 col-lg-8">
            <!-- Basic Identity -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseBasicInfo" aria-expanded="true" aria-controls="collapseBasicInfo" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Basic Information</strong>
              </div>
              <div class="collapse show" id="collapseBasicInfo">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="charName" class="form-label">Character Name</label>
                    <input type="text" id="charName" class="form-control form-control-sm" placeholder="Valen Khorath" />
                  </div>
                  <div class="col-md-6">
                    <label for="playerName" class="form-label">Player Name</label>
                    <input type="text" id="playerName" class="form-control form-control-sm" placeholder="Player / seat" />
                  </div>

                  <div class="col-md-3">
                    <label for="charRace" class="form-label">Race / Ancestry</label>
                    <input type="text" id="charRace" class="form-control form-control-sm" placeholder="Tiefling, Human, Owlin..." />
                  </div>
                  <div class="col-md-3">
                    <label for="charClass" class="form-label">
                      Class / Subclass
                      <button type="button" class="btn btn-sm btn-outline-info ms-2" id="manageMulticlassBtn" style="padding: 0 6px; font-size: 0.7rem;">
                        <i class="bi bi-diagram-3"></i> Multiclass
                      </button>
                    </label>
                    <input type="text" id="charClass" class="form-control form-control-sm" placeholder="Wizard (Evocation)..." />
                    <small class="text-muted">For multiclass: Wizard / Fighter</small>
                  </div>
                  <div class="col-md-3">
                    <label for="charBackground" class="form-label">Background</label>
                    <input type="text" id="charBackground" class="form-control form-control-sm" placeholder="Acolyte, Criminal, Sage..." />
                  </div>
                  <div class="col-md-2">
                    <label for="charLevel" class="form-label">Level</label>
                    <input type="number" min="1" max="20" id="charLevel" class="form-control form-control-sm" />
                  </div>
                  <div class="col-md-1">
                    <label for="charAlignment" class="form-label">Alignment</label>
                    <input type="text" id="charAlignment" class="form-control form-control-sm" placeholder="NG" />
                  </div>

                  <!-- XP Tracking (optional — milestone users can ignore) -->
                  <div class="col-12">
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                      <label class="form-label mb-0 small text-nowrap">XP</label>
                      <span id="xpDisplay"
                            class="badge bg-secondary border border-secondary px-2 py-1"
                            style="cursor:pointer; font-size:0.85rem; min-width:8rem; text-align:center;"
                            title="Click to add or subtract XP">
                        <span id="xpValue">0</span><span id="xpNextDisplay" class="text-muted"> / —</span>
                      </span>
                      <div class="flex-grow-1">
                        <div class="progress mb-1" style="height:10px;">
                          <div id="xpProgressBar"
                               class="progress-bar bg-secondary"
                               role="progressbar"
                               style="width:0%"
                               aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                          <small id="xpProgressLabel" class="text-muted"></small>
                          <small id="xpLevelUpBadge"
                                 class="text-warning fw-bold d-none"
                                 style="cursor:pointer;"
                                 title="Click to open Level Up wizard">&#x2B06; Level Up!</small>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="col-md-12">
                    <label for="charRoleNotes" class="form-label">Party Role / DM Notes</label>
                    <textarea id="charRoleNotes" rows="2" class="form-control form-control-sm"
                              placeholder="Tank, face, skill monkey, spell slot battery, chaos gremlin... plus any quick reminders for you as DM."></textarea>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Resources & Rest -->
                         <!-- Combat Snapshot -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseCombat" aria-expanded="true" aria-controls="collapseCombat" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Combat Snapshot</strong>
              </div>
              <div class="collapse show" id="collapseCombat">
              <div class="card-body">
                <div class="row g-2 mb-2">
                  <div class="col-4 col-md-2">
                    <label for="charAC" class="form-label small">AC</label>
                    <input type="number"
                           id="charAC"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                  <div class="col-4 col-md-3">
                    <label for="charMaxHP" class="form-label small">Max HP</label>
                    <input type="number"
                           id="charMaxHP"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                  <div class="col-4 col-md-3">
                    <label for="charCurrentHP" class="form-label small">Current HP</label>
                    <input type="number"
                           id="charCurrentHP"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="charTempHP" class="form-label small">Temp HP</label>
                    <input type="number"
                           id="charTempHP"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                </div>

                <!-- HP Adjustment Buttons -->
                <div class="row g-2 mb-2">
                  <div class="col-12">
                    <div class="btn-group w-100" role="group" aria-label="HP adjustments">
                      <button type="button" class="btn btn-sm btn-success" data-hp-adjust="heal">
                        <i class="bi bi-plus-circle"></i> Heal
                      </button>
                      <button type="button" class="btn btn-sm btn-danger" data-hp-adjust="damage">
                        <i class="bi bi-dash-circle"></i> Damage
                      </button>
                      <button type="button" class="btn btn-sm btn-info" data-hp-adjust="temp">
                        <i class="bi bi-shield-plus"></i> Temp HP
                      </button>
                      <button type="button" class="btn btn-sm btn-warning" data-hp-adjust="max">
                        <i class="bi bi-arrow-up"></i> Max
                      </button>
                    </div>
                  </div>
                </div>

                <div class="row g-2 mb-2">
                  <div class="col-6 col-md-4">
                    <label for="charSpeed" class="form-label small">Speed</label>
                    <input type="text"
                           id="charSpeed"
                           class="form-control form-control-sm"
                           placeholder="30 ft, 40 ft fly..." />
                  </div>
                  <div class="col-6 col-md-4">
                    <label for="charInitMod" class="form-label small">Initiative Mod</label>
                    <div class="input-group input-group-sm">
                      <input type="number"
                             id="charInitMod"
                             class="form-control form-control-sm text-center"
                             placeholder="0" />
                      <button type="button"
                              class="btn btn-outline-light"
                              id="rollInitiativeBtn"
                              title="Roll Initiative">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="charConditions" class="form-label small">Active Conditions</label>
                    <input type="text"
                           id="charConditions"
                           class="form-control form-control-sm"
                           placeholder="Blessed, Hexed, etc." />
                  </div>
                </div>

                <!-- Inspiration & Concentration -->
                <div class="row g-2">
                  <div class="col-6 col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="charInspiration" />
                      <label class="form-check-label small" for="charInspiration">
                        <i class="bi bi-star-fill text-warning"></i> Inspiration
                      </label>
                    </div>
                  </div>
                  <div class="col-6 col-md-8">
                    <div class="d-flex align-items-center gap-2">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="charConcentrating" />
                        <label class="form-check-label small" for="charConcentrating">
                          <i class="bi bi-lightning-fill text-info"></i> Concentrating
                        </label>
                      </div>
                      <input type="text"
                             id="charConcentrationSpell"
                             class="form-control form-control-sm"
                             placeholder="Spell name"
                             style="max-width: 150px;" />
                    </div>
                  </div>
                </div>

                <!-- Condition Toggles -->
                <div class="mt-3">
                  <label class="form-label small">Quick Conditions</label>
                  <div class="d-flex flex-wrap gap-1" id="conditionToggles">
                    <!-- Common D&D 5e conditions -->
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Blinded">Blinded</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Charmed">Charmed</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Deafened">Deafened</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Frightened">Frightened</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Grappled">Grappled</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Incapacitated">Incapacitated</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Invisible">Invisible</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Paralyzed">Paralyzed</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Petrified">Petrified</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Poisoned">Poisoned</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Prone">Prone</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Restrained">Restrained</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Stunned">Stunned</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Unconscious">Unconscious</button>
                    <button type="button" class="btn btn-sm btn-outline-info condition-btn" data-condition="Concentrating">Concentrating</button>
                    <button type="button" class="btn btn-sm btn-outline-success condition-btn" data-condition="Blessed">Blessed</button>
                    <button type="button" class="btn btn-sm btn-outline-warning condition-btn" data-condition="Hexed">Hexed</button>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Currency -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseCurrency" aria-expanded="true" aria-controls="collapseCurrency" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Currency</strong>
              </div>
              <div class="collapse show" id="collapseCurrency">
              <div class="card-body">
                <div class="row g-2">
                  <div class="col">
                    <label for="currencyCP" class="form-label small">CP</label>
                    <input type="number" id="currencyCP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencySP" class="form-label small">SP</label>
                    <input type="number" id="currencySP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencyEP" class="form-label small">EP</label>
                    <input type="number" id="currencyEP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencyGP" class="form-label small">GP</label>
                    <input type="number" id="currencyGP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencyPP" class="form-label small">PP</label>
                    <input type="number" id="currencyPP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Death Saves & Exhaustion -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseDeathSaves" aria-expanded="false" aria-controls="collapseDeathSaves" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Death Saves & Exhaustion</strong>
              </div>
              <div class="collapse" id="collapseDeathSaves">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="form-label small mb-0">Death Saves</label>
                      <button type="button" class="btn btn-sm btn-danger" id="rollDeathSaveBtn">
                        <i class="bi bi-dice-5"></i> Roll Death Save
                      </button>
                    </div>
                    <div class="d-flex flex-column gap-2">
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-success small" style="min-width: 70px;">Successes:</span>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveSuccess1" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveSuccess2" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveSuccess3" />
                        </div>
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-danger small" style="min-width: 70px;">Failures:</span>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveFailure1" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveFailure2" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveFailure3" />
                        </div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="deathSaveStable" />
                        <label class="form-check-label small" for="deathSaveStable">Stable</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label for="exhaustionLevel" class="form-label small">Exhaustion Level</label>
                    <input type="number" id="exhaustionLevel" class="form-control form-control-sm" min="0" max="10" placeholder="0" />
                    <small class="text-muted d-block mt-1">
                      <span id="exhaustionDescription">0 = No exhaustion</span>
                    </small>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <div class="card bg-dark border-secondary mb-3" id="section-resources">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseResources" aria-expanded="true" aria-controls="collapseResources" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Resources &amp; Rests</strong>
              </div>
              <div class="collapse show" id="collapseResources">
              <div class="card-body">
                <!-- Rest Buttons -->
                <div class="d-flex justify-content-end gap-2 mb-3">
                  <button type="button" class="btn btn-sm btn-outline-light" id="shortRestBtn">
                    <i class="bi bi-moon"></i> Short Rest
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-success" id="longRestBtn">
                    <i class="bi bi-moon-stars"></i> Long Rest
                  </button>
                </div>
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label for="charHitDice" class="form-label small">Hit Dice</label>
                    <input type="text"
                           id="charHitDice"
                           class="form-control form-control-sm"
                           placeholder="e.g. 5d10" />
                  </div>
                  <div class="col-6">
                    <label for="charHitDiceRemaining" class="form-label small">Hit Dice Remaining</label>
                    <input type="text"
                           id="charHitDiceRemaining"
                           class="form-control form-control-sm"
                           placeholder="e.g. 3d10" />
                  </div>
                </div>
              
                <label class="form-label small">Tracked Resources</label>
                <div class="small text-muted mb-1">
                  Use for rages, ki points, superiority dice, Channel Divinity, etc.
                </div>
              
                <!-- Three generic resource rows -->
                <div class="mb-2">
                  <div class="row g-1 align-items-center mb-1">
                    <div class="col-6">
                      <input type="text"
                             id="res1Name"
                             class="form-control form-control-sm"
                             placeholder="Resource name" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res1Current"
                             class="form-control form-control-sm text-center"
                             placeholder="Now" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res1Max"
                             class="form-control form-control-sm text-center"
                             placeholder="Max" />
                    </div>
                  </div>
                </div>
              
                <div class="mb-2">
                  <div class="row g-1 align-items-center mb-1">
                    <div class="col-6">
                      <input type="text"
                             id="res2Name"
                             class="form-control form-control-sm"
                             placeholder="Resource name" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res2Current"
                             class="form-control form-control-sm text-center"
                             placeholder="Now" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res2Max"
                             class="form-control form-control-sm text-center"
                             placeholder="Max" />
                    </div>
                  </div>
                </div>
              
                <div class="mb-2">
                  <div class="row g-1 align-items-center mb-1">
                    <div class="col-6">
                      <input type="text"
                             id="res3Name"
                             class="form-control form-control-sm"
                             placeholder="Resource name" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res3Current"
                             class="form-control form-control-sm text-center"
                             placeholder="Now" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res3Max"
                             class="form-control form-control-sm text-center"
                             placeholder="Max" />
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Ability Scores + Modifiers (with Ability Check rolls) -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseAbilities" aria-expanded="true" aria-controls="collapseAbilities" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Ability Scores & Modifiers</strong>
                <small class="text-muted">Shift+Click = Advantage, Ctrl+Click = Disadvantage</small>
              </div>
              <div class="collapse show" id="collapseAbilities">
              <div class="card-body">
                <div class="row g-3 text-center">
                  <!-- STR -->
                  <div class="col-6 col-md-2">
                    <label for="statStr" class="form-label">STR</label>
                    <input type="number"
                           id="statStr"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modStr"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Auto"
                           readonly />
                    <div class="btn-group btn-group-sm w-100" role="group">
                      <button type="button" class="btn btn-success p-0 px-1 ability-check-btn" data-ability="Str" data-roll-type="advantage" title="Roll STR check with Advantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-primary p-0 px-1 ability-check-btn" data-ability="Str" data-roll-type="normal" title="Roll STR check">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-danger p-0 px-1 ability-check-btn" data-ability="Str" data-roll-type="disadvantage" title="Roll STR check with Disadvantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <!-- DEX -->
                  <div class="col-6 col-md-2">
                    <label for="statDex" class="form-label">DEX</label>
                    <input type="number"
                           id="statDex"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modDex"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Auto"
                           readonly />
                    <div class="btn-group btn-group-sm w-100" role="group">
                      <button type="button" class="btn btn-success p-0 px-1 ability-check-btn" data-ability="Dex" data-roll-type="advantage" title="Roll DEX check with Advantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-primary p-0 px-1 ability-check-btn" data-ability="Dex" data-roll-type="normal" title="Roll DEX check">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-danger p-0 px-1 ability-check-btn" data-ability="Dex" data-roll-type="disadvantage" title="Roll DEX check with Disadvantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <!-- CON -->
                  <div class="col-6 col-md-2">
                    <label for="statCon" class="form-label">CON</label>
                    <input type="number"
                           id="statCon"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modCon"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Auto"
                           readonly />
                    <div class="btn-group btn-group-sm w-100" role="group">
                      <button type="button" class="btn btn-success p-0 px-1 ability-check-btn" data-ability="Con" data-roll-type="advantage" title="Roll CON check with Advantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-primary p-0 px-1 ability-check-btn" data-ability="Con" data-roll-type="normal" title="Roll CON check">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-danger p-0 px-1 ability-check-btn" data-ability="Con" data-roll-type="disadvantage" title="Roll CON check with Disadvantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <!-- INT -->
                  <div class="col-6 col-md-2">
                    <label for="statInt" class="form-label">INT</label>
                    <input type="number"
                           id="statInt"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modInt"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Auto"
                           readonly />
                    <div class="btn-group btn-group-sm w-100" role="group">
                      <button type="button" class="btn btn-success p-0 px-1 ability-check-btn" data-ability="Int" data-roll-type="advantage" title="Roll INT check with Advantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-primary p-0 px-1 ability-check-btn" data-ability="Int" data-roll-type="normal" title="Roll INT check">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-danger p-0 px-1 ability-check-btn" data-ability="Int" data-roll-type="disadvantage" title="Roll INT check with Disadvantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <!-- WIS -->
                  <div class="col-6 col-md-2">
                    <label for="statWis" class="form-label">WIS</label>
                    <input type="number"
                           id="statWis"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modWis"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Auto"
                           readonly />
                    <div class="btn-group btn-group-sm w-100" role="group">
                      <button type="button" class="btn btn-success p-0 px-1 ability-check-btn" data-ability="Wis" data-roll-type="advantage" title="Roll WIS check with Advantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-primary p-0 px-1 ability-check-btn" data-ability="Wis" data-roll-type="normal" title="Roll WIS check">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-danger p-0 px-1 ability-check-btn" data-ability="Wis" data-roll-type="disadvantage" title="Roll WIS check with Disadvantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <!-- CHA -->
                  <div class="col-6 col-md-2">
                    <label for="statCha" class="form-label">CHA</label>
                    <input type="number"
                           id="statCha"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modCha"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Auto"
                           readonly />
                    <div class="btn-group btn-group-sm w-100" role="group">
                      <button type="button" class="btn btn-success p-0 px-1 ability-check-btn" data-ability="Cha" data-roll-type="advantage" title="Roll CHA check with Advantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-primary p-0 px-1 ability-check-btn" data-ability="Cha" data-roll-type="normal" title="Roll CHA check">
                        <i class="bi bi-dice-5"></i>
                      </button>
                      <button type="button" class="btn btn-danger p-0 px-1 ability-check-btn" data-ability="Cha" data-roll-type="disadvantage" title="Roll CHA check with Disadvantage">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Saving Throws -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseSaves" aria-expanded="true" aria-controls="collapseSaves" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Saving Throws</strong>
                <small class="text-muted">Shift+Click = Advantage, Ctrl+Click = Disadvantage</small>
              </div>
              <div class="collapse show" id="collapseSaves">
              <div class="card-body">
                <div class="row g-2">
                  <!-- STR save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveStrProf" />
                        </div>
                        <label for="saveStrBonus" class="fw-bold small">STR</label>
                        <input type="number" id="saveStrBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="str" data-roll-type="advantage" title="Roll STR save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="str" data-roll-type="normal" title="Roll STR save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="str" data-roll-type="disadvantage" title="Roll STR save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- DEX save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveDexProf" />
                        </div>
                        <label for="saveDexBonus" class="fw-bold small">DEX</label>
                        <input type="number" id="saveDexBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="dex" data-roll-type="advantage" title="Roll DEX save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="dex" data-roll-type="normal" title="Roll DEX save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="dex" data-roll-type="disadvantage" title="Roll DEX save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- CON save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveConProf" />
                        </div>
                        <label for="saveConBonus" class="fw-bold small">CON</label>
                        <input type="number" id="saveConBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="con" data-roll-type="advantage" title="Roll CON save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="con" data-roll-type="normal" title="Roll CON save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="con" data-roll-type="disadvantage" title="Roll CON save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- INT save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveIntProf" />
                        </div>
                        <label for="saveIntBonus" class="fw-bold small">INT</label>
                        <input type="number" id="saveIntBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="int" data-roll-type="advantage" title="Roll INT save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="int" data-roll-type="normal" title="Roll INT save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="int" data-roll-type="disadvantage" title="Roll INT save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- WIS save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveWisProf" />
                        </div>
                        <label for="saveWisBonus" class="fw-bold small">WIS</label>
                        <input type="number" id="saveWisBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="wis" data-roll-type="advantage" title="Roll WIS save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="wis" data-roll-type="normal" title="Roll WIS save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="wis" data-roll-type="disadvantage" title="Roll WIS save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- CHA save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveChaProf" />
                        </div>
                        <label for="saveChaBonus" class="fw-bold small">CHA</label>
                        <input type="number" id="saveChaBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="cha" data-roll-type="advantage" title="Roll CHA save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="cha" data-roll-type="normal" title="Roll CHA save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="cha" data-roll-type="disadvantage" title="Roll CHA save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  <label for="saveNotes" class="form-label">Saving Throw Notes</label>
                  <textarea id="saveNotes" rows="2" class="form-control form-control-sm"
                            placeholder="e.g. Advantage vs frightened, resistance to fire, etc."></textarea>
                </div>
              </div>
              </div>
            </div>

            <!-- Skills -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseSkills" aria-expanded="true" aria-controls="collapseSkills" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Skills</strong>
                <small class="text-muted">Exp = Expertise (×2 Prof) | Shift/Ctrl for Adv/Dis</small>
              </div>
              <div class="collapse show" id="collapseSkills">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-dark table-striped align-middle mb-2 skill-table">
                    <thead>
                      <tr class="text-muted small">
                        <th scope="col" style="width:2rem;">Prof</th>
                        <th scope="col" style="width:2rem;">Exp</th>
                        <th scope="col" style="width:3rem;">Mod</th>
                        <th scope="col">Skill</th>
                        <th scope="col" style="width:4rem;" class="text-center">Bonus</th>
                        <th scope="col" style="width:3rem;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillAcrobaticsProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillAcrobaticsExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>DEX</td>
                        <td>Acr<span class="d-none d-md-inline">obatics</span></td>
                        <td class="text-center">
                          <input type="number" id="skillAcrobaticsBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="acrobatics" data-roll-type="advantage" title="Roll Acrobatics with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="acrobatics" data-roll-type="normal" title="Roll Acrobatics">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="acrobatics" data-roll-type="disadvantage" title="Roll Acrobatics with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillAnimalHandlingProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillAnimalHandlingExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Animal Handling</td>
                        <td class="text-center">
                          <input type="number" id="skillAnimalHandlingBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="animalHandling" data-roll-type="advantage" title="Roll Animal Handling with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="animalHandling" data-roll-type="normal" title="Roll Animal Handling">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="animalHandling" data-roll-type="disadvantage" title="Roll Animal Handling with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillArcanaProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillArcanaExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Arcana</td>
                        <td class="text-center">
                          <input type="number" id="skillArcanaBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="arcana" data-roll-type="advantage" title="Roll Arcana with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="arcana" data-roll-type="normal" title="Roll Arcana">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="arcana" data-roll-type="disadvantage" title="Roll Arcana with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillAthleticsProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillAthleticsExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>STR</td>
                        <td>Athletics</td>
                        <td class="text-center">
                          <input type="number" id="skillAthleticsBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="athletics" data-roll-type="advantage" title="Roll Athletics with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="athletics" data-roll-type="normal" title="Roll Athletics">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="athletics" data-roll-type="disadvantage" title="Roll Athletics with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillDeceptionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillDeceptionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Deception</td>
                        <td class="text-center">
                          <input type="number" id="skillDeceptionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="deception" data-roll-type="advantage" title="Roll Deception with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="deception" data-roll-type="normal" title="Roll Deception">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="deception" data-roll-type="disadvantage" title="Roll Deception with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillHistoryProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillHistoryExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>History</td>
                        <td class="text-center">
                          <input type="number" id="skillHistoryBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="history" data-roll-type="advantage" title="Roll History with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="history" data-roll-type="normal" title="Roll History">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="history" data-roll-type="disadvantage" title="Roll History with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillInsightProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillInsightExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Insight</td>
                        <td class="text-center">
                          <input type="number" id="skillInsightBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="insight" data-roll-type="advantage" title="Roll Insight with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="insight" data-roll-type="normal" title="Roll Insight">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="insight" data-roll-type="disadvantage" title="Roll Insight with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillIntimidationProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillIntimidationExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Intimidation</td>
                        <td class="text-center">
                          <input type="number" id="skillIntimidationBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="intimidation" data-roll-type="advantage" title="Roll Intimidation with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="intimidation" data-roll-type="normal" title="Roll Intimidation">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="intimidation" data-roll-type="disadvantage" title="Roll Intimidation with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillInvestigationProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillInvestigationExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Investigation</td>
                        <td class="text-center">
                          <input type="number" id="skillInvestigationBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="investigation" data-roll-type="advantage" title="Roll Investigation with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="investigation" data-roll-type="normal" title="Roll Investigation">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="investigation" data-roll-type="disadvantage" title="Roll Investigation with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillMedicineProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillMedicineExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Medicine</td>
                        <td class="text-center">
                          <input type="number" id="skillMedicineBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="medicine" data-roll-type="advantage" title="Roll Medicine with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="medicine" data-roll-type="normal" title="Roll Medicine">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="medicine" data-roll-type="disadvantage" title="Roll Medicine with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillNatureProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillNatureExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Nature</td>
                        <td class="text-center">
                          <input type="number" id="skillNatureBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="nature" data-roll-type="advantage" title="Roll Nature with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="nature" data-roll-type="normal" title="Roll Nature">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="nature" data-roll-type="disadvantage" title="Roll Nature with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerceptionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerceptionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Perception</td>
                        <td class="text-center">
                          <input type="number" id="skillPerceptionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="perception" data-roll-type="advantage" title="Roll Perception with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="perception" data-roll-type="normal" title="Roll Perception">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="perception" data-roll-type="disadvantage" title="Roll Perception with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerformanceProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerformanceExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Performance</td>
                        <td class="text-center">
                          <input type="number" id="skillPerformanceBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="performance" data-roll-type="advantage" title="Roll Performance with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="performance" data-roll-type="normal" title="Roll Performance">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="performance" data-roll-type="disadvantage" title="Roll Performance with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillPersuasionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillPersuasionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Persuasion</td>
                        <td class="text-center">
                          <input type="number" id="skillPersuasionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="persuasion" data-roll-type="advantage" title="Roll Persuasion with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="persuasion" data-roll-type="normal" title="Roll Persuasion">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="persuasion" data-roll-type="disadvantage" title="Roll Persuasion with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillReligionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillReligionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Religion</td>
                        <td class="text-center">
                          <input type="number" id="skillReligionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="religion" data-roll-type="advantage" title="Roll Religion with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="religion" data-roll-type="normal" title="Roll Religion">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="religion" data-roll-type="disadvantage" title="Roll Religion with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillSleightOfHandProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillSleightOfHandExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>DEX</td>
                        <td>Sleight of Hand</td>
                        <td class="text-center">
                          <input type="number" id="skillSleightOfHandBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="sleightOfHand" data-roll-type="advantage" title="Roll Sleight of Hand with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="sleightOfHand" data-roll-type="normal" title="Roll Sleight of Hand">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="sleightOfHand" data-roll-type="disadvantage" title="Roll Sleight of Hand with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillStealthProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillStealthExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>DEX</td>
                        <td>Stealth</td>
                        <td class="text-center">
                          <input type="number" id="skillStealthBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="stealth" data-roll-type="advantage" title="Roll Stealth with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="stealth" data-roll-type="normal" title="Roll Stealth">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="stealth" data-roll-type="disadvantage" title="Roll Stealth with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillSurvivalProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillSurvivalExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Survival</td>
                        <td class="text-center">
                          <input type="number" id="skillSurvivalBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="survival" data-roll-type="advantage" title="Roll Survival with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="survival" data-roll-type="normal" title="Roll Survival">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="survival" data-roll-type="disadvantage" title="Roll Survival with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>

                    </tbody>
                  </table>
                </div>
                <label for="skillsNotes" class="form-label">Additional Skills / Expertise Notes</label>
                <textarea id="skillsNotes" rows="2" class="form-control form-control-sm"
                          placeholder="Expertise, jack-of-all-trades, custom skills, etc."></textarea>
              </div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="col-12 col-lg-4">
            <!-- Roll History Panel (Sticky) -->
            <div class="card bg-dark border-secondary mb-3" id="rollHistoryPanel">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center" id="rollHistoryHeader" style="cursor: pointer;">
                <strong><i class="bi bi-dice-5 me-1"></i>Roll History</strong>
                <div>
                  <button type="button" class="btn btn-sm btn-outline-danger" id="clearHistoryBtn">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <div id="rollHistoryList">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>

            <!-- Portrait (preview only, edits via modal) -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapsePortrait" aria-expanded="false" aria-controls="collapsePortrait" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Character Portrait</strong>
              </div>
              <div class="collapse" id="collapsePortrait">
              <div class="card-body">
                <div id="portraitContainer"
                     class="portrait-frame mb-3"
                     style="height: 320px;">
                  <img id="portraitPreview"
                       class="portrait-image d-none"
                       alt="Character portrait preview" />
                  <span id="portraitPlaceholderText" class="text-muted position-absolute top-50 start-50 translate-middle text-center">
                    No portrait selected
                  </span>
                </div>

                <div class="mb-2">
                  <label for="portraitFile" class="form-label">Upload Portrait Image</label>
                  <input type="file" id="portraitFile" class="form-control form-control-sm" accept="image/*" />
                  <small class="text-muted">Stored as base64 in your browser’s local storage.</small>
                </div>

                <div class="mb-2">
                  <label for="portraitUrl" class="form-label">Or Use Image URL</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                    <input type="url" id="portraitUrl" class="form-control" placeholder="https://example.com/image.png" />
                    <button class="btn btn-outline-light" type="button" id="applyPortraitUrlBtn">Use URL</button>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button type="button" class="btn btn-sm btn-outline-light" id="editPortraitBtn">
                    <i class="bi bi-crop me-1"></i>Edit Portrait Framing
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger ms-auto" id="clearPortraitBtn">
                    <i class="bi bi-x-circle me-1"></i>Clear Portrait
                  </button>
                </div>
              </div>
              </div>
            </div>

            <!-- Senses -->
            <div class="card bg-dark border-secondary mb-3" id="section-extras">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseSenses" aria-expanded="true" aria-controls="collapseSenses" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Senses</strong>
                <div class="small text-muted" onclick="event.stopPropagation();">
                  Prof. Bonus: <span id="charProficiencyBonusDisplay">+2</span>
                </div>
              </div>
              <div class="collapse show" id="collapseSenses">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-4">
                    <label for="charPassivePerception" class="form-label small">Passive Perception</label>
                    <input type="number"
                           id="charPassivePerception"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <div class="col-4">
                    <label for="charPassiveInvestigation" class="form-label small">Passive Investigation</label>
                    <input type="number"
                           id="charPassiveInvestigation"
                           class="form-control form-control-sm text-center" />
                  </div>
                  <div class="col-4">
                    <label for="charPassiveInsight" class="form-label small">Passive Insight</label>
                    <input type="number"
                           id="charPassiveInsight"
                           class="form-control form-control-sm text-center" />
                  </div>
                
                  <div class="col-12">
                    <label class="form-label">Additional Sense Types</label>
                    <div class="row g-2 mb-2">
                      <div class="col-6 col-md-3">
                        <label for="senseDarkvision" class="form-label small">Darkvision (ft.)</label>
                        <input type="number" id="senseDarkvision" class="form-control form-control-sm text-center" placeholder="—" min="0" />
                      </div>
                      <div class="col-6 col-md-3">
                        <label for="senseBlindsight" class="form-label small">Blindsight (ft.)</label>
                        <input type="number" id="senseBlindsight" class="form-control form-control-sm text-center" placeholder="—" min="0" />
                      </div>
                      <div class="col-6 col-md-3">
                        <label for="senseTremorsense" class="form-label small">Tremorsense (ft.)</label>
                        <input type="number" id="senseTremorsense" class="form-control form-control-sm text-center" placeholder="—" min="0" />
                      </div>
                      <div class="col-6 col-md-3">
                        <label for="senseTruesight" class="form-label small">Truesight (ft.)</label>
                        <input type="number" id="senseTruesight" class="form-control form-control-sm text-center" placeholder="—" min="0" />
                      </div>
                    </div>
                    <textarea id="sensesNotes" rows="1" class="form-control form-control-sm"
                              placeholder="Other senses or special perception notes..."></textarea>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Detailed Notes with DDB-style tabs -->
            <div class="card bg-dark border-secondary mb-3" id="section-notes">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseNotes" aria-expanded="false" aria-controls="collapseNotes" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Detailed Notes</strong>
              </div>
              <div class="collapse" id="collapseNotes">
              <div class="card-body">
                <!-- Tabs for this block -->
                <ul class="nav nav-tabs small mb-3" id="detailTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active"
                            id="detail-actions-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-actions-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-actions-pane"
                            aria-selected="true">
                      Action Notes
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-spells-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-spells-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-spells-pane"
                            aria-selected="false">
                      Spells
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-inventory-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-inventory-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-inventory-pane"
                            aria-selected="false">
                      Inventory
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-features-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-features-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-features-pane"
                            aria-selected="false">
                      Features &amp; Traits
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-background-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-background-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-background-pane"
                            aria-selected="false">
                      Background
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-notes-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-notes-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-notes-pane"
                            aria-selected="false">
                      Notes
                    </button>
                  </li>
                </ul>

                <div class="tab-content">
                  <!-- Action Notes -->
                  <div class="tab-pane fade show active"
                       id="detail-actions-pane"
                       role="tabpanel"
                       aria-labelledby="detail-actions-tab">

                    <!-- Attacks Section -->
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                          <label class="form-label mb-0 fw-bold">Attacks & Actions</label>
                          <div class="text-muted small">Green = Advantage/Crit · White = Normal · Red = Disadvantage/Half</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" id="addAttackBtn">
                          <i class="bi bi-plus-circle me-1"></i>Add Attack
                        </button>
                      </div>
                      <div id="attacksList" class="list-group list-group-flush small">
                        <!-- Populated by JS -->
                      </div>
                    </div>

                    <hr class="border-secondary my-3" />

                    <label for="charTableNotes" class="form-label">At-the-Table Reminders</label>
                    <textarea id="charTableNotes" rows="10" class="form-control form-control-sm"
                              placeholder="Short, brutal notes: what they want right now, likely actions, roleplay voice, conflicts, etc."></textarea>
                  </div>

                  <!-- Spells -->
                  <div class="tab-pane fade"
                       id="detail-spells-pane"
                       role="tabpanel"
                       aria-labelledby="detail-spells-tab">
                    <div class="mb-2" id="section-spells">
                      <label class="form-label">Spells / Resources</label>

                      <!-- Inner Spells Tabs -->
                      <ul class="nav nav-tabs small" id="spellsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                          <button class="nav-link active"
                                  id="spells-notes-tab"
                                  data-bs-toggle="tab"
                                  data-bs-target="#spells-notes-pane"
                                  type="button"
                                  role="tab"
                                  aria-controls="spells-notes-pane"
                                  aria-selected="true">
                            Notes
                          </button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="nav-link"
                                  id="spells-list-tab"
                                  data-bs-toggle="tab"
                                  data-bs-target="#spells-list-pane"
                                  type="button"
                                  role="tab"
                                  aria-controls="spells-list-pane"
                                  aria-selected="false">
                            Spell List
                          </button>
                        </li>
                      </ul>
                  
                      <div class="tab-content border border-secondary border-top-0 rounded-bottom p-2 bg-black bg-opacity-25">
                        <!-- Notes tab (freeform field) -->
                        <div class="tab-pane fade show active"
                             id="spells-notes-pane"
                             role="tabpanel"
                             aria-labelledby="spells-notes-tab">
                          <textarea id="charSpells" rows="10" class="form-control form-control-sm"
                                    placeholder="Signature spells, pact slots, channel divinity, rage uses, ki, etc."></textarea>
                        </div>
                    
                        <!-- Spell List tab -->
                        <div class="tab-pane fade"
                           id="spells-list-pane"
                           role="tabpanel"
                           aria-labelledby="spells-list-tab">

                        <!-- Spellcasting Ability & Derived Stats -->
                        <div class="mb-3 p-2 border border-secondary rounded bg-dark bg-opacity-50">
                          <div class="row g-2 align-items-end">
                            <div class="col-12 col-md-4">
                              <label for="spellcastingAbility" class="form-label small mb-1">Spellcasting Ability</label>
                              <select id="spellcastingAbility" class="form-select form-select-sm">
                                <option value="">None</option>
                                <option value="int">Intelligence</option>
                                <option value="wis">Wisdom</option>
                                <option value="cha">Charisma</option>
                              </select>
                            </div>
                            <div class="col-6 col-md-4">
                              <label class="form-label small mb-1">Spell Save DC</label>
                              <div class="form-control form-control-sm text-center bg-secondary bg-opacity-25" id="spellSaveDC">—</div>
                            </div>
                            <div class="col-6 col-md-4">
                              <label class="form-label small mb-1">Spell Attack Bonus</label>
                              <div class="form-control form-control-sm text-center bg-secondary bg-opacity-25" id="spellAttackBonus">—</div>
                            </div>
                          </div>
                        </div>

                        <!-- NEW: Spell Slots + Pact Slots -->
                        <div class="mb-3">
                          <label class="form-label small">Spell Slots</label>
                          <div class="table-responsive">
                            <table class="table table-sm table-dark align-middle mb-2">
                              <thead class="small text-muted">
                                <tr>
                                  <th style="width:4rem;">Level</th>
                                  <th style="width:5rem;">Max</th>
                                  <th style="width:5rem;">Used</th>
                                  <th style="width:auto">Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td>1st</td>
                                  <td><input id="slots1Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots1Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td> <!-- NEW CELL -->
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="1">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="1">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="1">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>2nd</td>
                                  <td><input id="slots2Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots2Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td> 
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="2">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="2">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="2">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>3rd</td>
                                  <td><input id="slots3Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots3Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="3">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="3">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="3">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>4th</td>
                                  <td><input id="slots4Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots4Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="4">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="4">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="4">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>5th</td>
                                  <td><input id="slots5Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots5Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="5">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="5">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="5">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>6th</td>
                                  <td><input id="slots6Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots6Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="6">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="6">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="6">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>7th</td>
                                  <td><input id="slots7Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots7Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="7">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="7">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="7">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>8th</td>
                                  <td><input id="slots8Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots8Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="8">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="8">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="8">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>9th</td>
                                  <td><input id="slots9Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots9Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="9">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="9">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="9">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        
                          <div class="row g-2 align-items-end small">
                            <div class="col-4">
                              <label for="pactLevel" class="form-label mb-1">Pact Slot Level</label>
                              <input id="pactLevel" type="number" min="1" max="9"
                                     class="form-control form-control-sm text-center" />
                            </div>
                            <div class="col-4">
                              <label for="pactMax" class="form-label mb-1">Pact Slots</label>
                              <input id="pactMax" type="number" min="0"
                                     class="form-control form-control-sm text-center" />
                            </div>
                            <div class="col-4">
                              <label for="pactUsed" class="form-label mb-1">Used</label>
                              <input id="pactUsed" type="number" min="0"
                                     class="form-control form-control-sm text-center" />
                            </div>
                          </div>
                        </div>
                      
                        <!-- Existing search + results stay unchanged below this -->
                        <div class="mb-2">
                          <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text"
                                   class="form-control"
                                   id="spellSearchInput"
                                   placeholder="Search spell name, tag, or class..."
                                   autocomplete="off" />
                          </div>
                          <div id="spellSearchResults" class="list-group list-group-flush small"></div>
                        </div>

                          <!-- Custom / homebrew spell entry -->
                          <div class="mb-3">
                            <button class="btn btn-sm btn-outline-success mb-2"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#customSpellCollapse"
                                    aria-expanded="false"
                                    aria-controls="customSpellCollapse">
                              <i class="bi bi-magic me-1"></i>Add Custom / Homebrew Spell
                            </button>

                            <div class="collapse" id="customSpellCollapse">
                              <div class="border border-secondary rounded p-2 bg-black bg-opacity-25">
                                <div class="row g-2 mb-2">
                                  <div class="col-12">
                                    <label for="customSpellNameInput" class="form-label small mb-1">Name / Title</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellNameInput"
                                           placeholder="Spell name (required)" />
                                  </div>
                                  <div class="col-4">
                                    <label for="customSpellLevelInput" class="form-label small mb-1">Level</label>
                                    <input type="number"
                                           min="0"
                                           max="9"
                                           class="form-control form-control-sm"
                                           id="customSpellLevelInput" />
                                  </div>
                                  <div class="col-8">
                                    <label for="customSpellSchoolInput" class="form-label small mb-1">School</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellSchoolInput"
                                           placeholder="Evocation, Illusion..." />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellCastingInput" class="form-label small mb-1">Casting Time</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellCastingInput"
                                           placeholder="1 action, bonus action..." />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellRangeInput" class="form-label small mb-1">Range</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellRangeInput"
                                           placeholder="60 ft, Self (30-ft cone)..." />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellComponentsInput" class="form-label small mb-1">Components</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellComponentsInput"
                                           placeholder="V,S,M (a pearl worth 100 gp)" />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellDurationInput" class="form-label small mb-1">Duration</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellDurationInput"
                                           placeholder="Instantaneous, 1 minute, up to 1 hour..." />
                                  </div>
                                  <div class="col-6 d-flex align-items-center">
                                    <div class="form-check mt-3">
                                      <input class="form-check-input"
                                             type="checkbox"
                                             id="customSpellConcentrationInput" />
                                      <label class="form-check-label small" for="customSpellConcentrationInput">
                                        Concentration
                                      </label>
                                    </div>
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellClassesInput" class="form-label small mb-1">Classes</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellClassesInput"
                                           placeholder="Wizard, Cleric (comma-separated)" />
                                  </div>
                                  <div class="col-12">
                                    <label for="customSpellTagsInput" class="form-label small mb-1">Tags</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellTagsInput"
                                           placeholder="damage, control, fire (comma-separated)" />
                                  </div>
                                  <div class="col-12">
                                    <label for="customSpellBodyInput" class="form-label small mb-1">Description</label>
                                    <textarea class="form-control form-control-sm"
                                              id="customSpellBodyInput"
                                              rows="3"
                                              placeholder="Full spell rules text / summary."></textarea>
                                  </div>
                                </div>

                                <div class="d-flex justify-content-end">
                                  <button class="btn btn-sm btn-success"
                                          type="button"
                                          id="saveCustomSpellBtn">
                                    <i class="bi bi-plus-circle me-1"></i>Add to Known Spells
                                  </button>
                                </div>

                                <small class="text-muted d-block mt-1">
                                  Custom spells are stored only on this character’s spell list.
                                </small>
                              </div>
                            </div>
                          </div>
                      
                          <!-- Prepared Spells Counter (for preparing casters) -->
                          <div class="alert alert-info small mt-3 d-none" id="preparedSpellsAlert">
                            <div class="d-flex justify-content-between align-items-center">
                              <span>
                                <i class="bi bi-book me-1"></i>
                                <strong>Prepared Spells:</strong>
                                <span id="preparedSpellCount">0</span> / <span id="maxPreparedSpells">0</span>
                              </span>
                              <span class="badge bg-secondary" id="preparedSpellStatus">OK</span>
                            </div>
                            <small class="text-muted d-block mt-1">
                              Subclass spells are always prepared and don't count toward this limit.
                            </small>
                          </div>

                          <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                              <span class="fw-bold small">Known Spells</span>
                              <button type="button"
                                      class="btn btn-sm btn-outline-danger"
                                      id="clearSpellListBtn">
                                Clear All
                              </button>
                            </div>
                            <ul class="list-group list-group-flush small" id="characterSpellList">
                              <!-- Populated by JS -->
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Inventory -->
                  <div class="tab-pane fade"
                       id="detail-inventory-pane"
                       role="tabpanel"
                       aria-labelledby="detail-inventory-tab">
                    <div class="mt-2" id="section-inventory">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Inventory</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addInventoryItemBtn">
                          <i class="bi bi-plus-circle me-1"></i>Add Item
                        </button>
                      </div>

                      <!-- Encumbrance Display -->
                      <div class="card bg-secondary border-secondary mb-3">
                        <div class="card-body p-2">
                          <div class="row g-2 text-center small">
                            <div class="col-4">
                              <div class="fw-bold">Total Weight</div>
                              <div id="totalWeight">0 lb</div>
                            </div>
                            <div class="col-4">
                              <div class="fw-bold">Carrying Capacity</div>
                              <div id="carryingCapacity">-- lb</div>
                            </div>
                            <div class="col-4">
                              <div class="fw-bold">Encumbrance</div>
                              <div id="encumbranceStatus">
                                <span class="badge bg-success">Normal</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Inventory Table -->
                      <div class="table-responsive">
                        <table class="table table-sm table-dark table-bordered" id="inventoryTable">
                          <thead>
                            <tr>
                              <th style="width: 35%;">Item Name</th>
                              <th style="width: 10%;" class="text-center">Qty</th>
                              <th style="width: 12%;" class="text-center">Weight (lb)</th>
                              <th style="width: 10%;" class="text-center">Equipped</th>
                              <th style="width: 10%;" class="text-center">Attuned</th>
                              <th style="width: 13%;" class="text-center">Total</th>
                              <th style="width: 10%;" class="text-center">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="inventoryTableBody">
                            <tr class="text-muted">
                              <td colspan="7" class="text-center py-3">
                                <small>No items yet. Click "Add Item" to start building your inventory.</small>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <!-- Features & Traits -->
                  <div class="tab-pane fade"
                       id="detail-features-pane"
                       role="tabpanel"
                       aria-labelledby="detail-features-tab">
                    <div class="mt-2" id="section-features">
                      <label for="charFeatures" class="form-label">Features & Feats</label>
                      <textarea id="charFeatures" rows="10" class="form-control form-control-sm"
                                placeholder="Key class features, feats, reactions, bonus actions, etc. Focus on what matters for you behind the screen."></textarea>
                    </div>
                  </div>

                  <!-- Background -->
                  <div class="tab-pane fade"
                       id="detail-background-pane"
                       role="tabpanel"
                       aria-labelledby="detail-background-tab">
                    <div class="mt-2" id="section-background">
                      <label for="charNotes" class="form-label">Story, Hooks &amp; Secrets</label>
                      <textarea id="charNotes" rows="10" class="form-control form-control-sm"
                                placeholder="Backstory beats, faction ties, secrets, upcoming reveals, relationship notes, etc."></textarea>
                    </div>
                  </div>

                  <!-- Generic Notes -->
                  <div class="tab-pane fade"
                       id="detail-notes-pane"
                       role="tabpanel"
                       aria-labelledby="detail-notes-tab">
                    <div class="mt-2">
                      <label for="charExtraNotes" class="form-label">Miscellaneous Notes</label>
                      <textarea id="charExtraNotes" rows="10" class="form-control form-control-sm"
                                placeholder="Scratch space, prep notes, anything that doesn’t fit the other tabs."></textarea>
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>

          </div>
        </div> <!-- /row -->

        <!-- Combat Card View (Hidden by default, shown when combat mode is toggled) -->
        <div id="combatCardView" class="combat-card-view">
          <div class="combat-layout">

            <!-- Header Area: Portrait + Name + Basic Info -->
            <div class="combat-area-header">
              <div class="combat-portrait-frame" id="combatPortraitFrame">
                <img id="combatPortraitImage" class="combat-portrait-image d-none" alt="Character portrait" />
                <span id="combatPortraitPlaceholder" class="text-muted position-absolute top-50 start-50 translate-middle text-center">
                  No portrait
                </span>
              </div>
              <h3 class="text-center mb-2" id="combatCharName">Character Name</h3>
              <div class="text-center text-muted small mb-2">
                <span id="combatRace">-</span> <span id="combatClass">-</span> <span class="badge bg-secondary" id="combatLevel">1</span>
              </div>
              <!-- Conditions (shown under name on all sizes) -->
              <div class="combat-section-title"><i class="bi bi-exclamation-triangle"></i> Conditions</div>
              <div id="combatConditions" class="combat-conditions">
                <span class="text-muted fst-italic small">None</span>
              </div>
              <!-- Dice History Button -->
              <button type="button" class="btn btn-outline-info btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#diceHistoryModal">
                <i class="bi bi-clock-history me-1"></i>Roll History
              </button>
            </div>

            <!-- Vitals Area: AC, HP, Speed, Initiative, Prof, PP -->
            <div class="combat-area-vitals combat-panel">
              <div class="combat-section-title"><i class="bi bi-heart-pulse"></i> Vitals</div>
              <div class="combat-stat-grid">
                <div class="combat-stat-box highlight-ac">
                  <div class="combat-stat-label">AC</div>
                  <div class="combat-stat-value" id="combatAC">10</div>
                </div>
                <div class="combat-stat-box highlight-hp interactive-hp" id="combatHPBox">
                  <div class="combat-stat-label">HP</div>
                  <div class="combat-stat-value">
                    <span id="combatCurrentHP">10</span>/<span id="combatMaxHP">10</span>
                  </div>
                  <div class="combat-temp-hp d-none" id="combatTempHPDisplay">
                    <i class="bi bi-shield-plus"></i> <span id="combatTempHP">0</span> temp
                  </div>
                  <div class="combat-hp-bar">
                    <div class="combat-hp-bar-fill hp-full" id="combatHPBarFill" style="width: 100%;"></div>
                  </div>
                  <div class="combat-hp-controls d-none" id="combatHPControls">
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-danger" onclick="handleCombatHP('damage')" title="Take Damage">
                        <i class="bi bi-dash-lg"></i>
                      </button>
                      <button type="button" class="btn btn-success" onclick="handleCombatHP('heal')" title="Heal">
                        <i class="bi bi-plus-lg"></i>
                      </button>
                      <button type="button" class="btn btn-info" onclick="handleCombatHP('temp')" title="Add Temp HP">
                        <i class="bi bi-shield-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="combat-stat-box">
                  <div class="combat-stat-label">Speed</div>
                  <div class="combat-stat-value" id="combatSpeed">30</div>
                </div>
                <div class="combat-stat-box clickable-roll" id="combatInitiativeBox" title="Click to roll initiative">
                  <div class="combat-stat-label">Init</div>
                  <div class="combat-stat-value" id="combatInitiative">+0</div>
                </div>
                <div class="combat-stat-box">
                  <div class="combat-stat-label">Prof</div>
                  <div class="combat-stat-value" id="combatProfBonus">+2</div>
                </div>
                <div class="combat-stat-box">
                  <div class="combat-stat-label">PP</div>
                  <div class="combat-stat-value" id="combatPassivePerception">10</div>
                </div>
              </div>
              <!-- Spellcasting stats (if applicable) -->
              <div id="combatSpellStatsSection" class="mt-3 d-none">
                <div class="d-flex gap-2 justify-content-center">
                  <div class="combat-stat-box" style="flex: 1;">
                    <div class="combat-stat-label">Spell DC</div>
                    <div class="combat-stat-value" id="combatSpellDC">--</div>
                  </div>
                  <div class="combat-stat-box" style="flex: 1;">
                    <div class="combat-stat-label">Spell Atk</div>
                    <div class="combat-stat-value" id="combatSpellAttack">--</div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Abilities Area: STR, DEX, CON, INT, WIS, CHA scores + mods (clickable for ability checks) -->
            <div class="combat-area-abilities combat-panel">
              <div class="combat-section-title"><i class="bi bi-bar-chart"></i> Ability Checks</div>
              <div class="combat-ability-grid" id="combatAbilityGrid">
                <div class="combat-ability-box clickable-roll" data-ability="Str" title="Click to roll STR check">
                  <div class="combat-ability-label">STR</div>
                  <div class="combat-ability-mod" id="combatModStr">+0</div>
                  <div class="combat-ability-score" id="combatScoreStr">10</div>
                </div>
                <div class="combat-ability-box clickable-roll" data-ability="Dex" title="Click to roll DEX check">
                  <div class="combat-ability-label">DEX</div>
                  <div class="combat-ability-mod" id="combatModDex">+0</div>
                  <div class="combat-ability-score" id="combatScoreDex">10</div>
                </div>
                <div class="combat-ability-box clickable-roll" data-ability="Con" title="Click to roll CON check">
                  <div class="combat-ability-label">CON</div>
                  <div class="combat-ability-mod" id="combatModCon">+0</div>
                  <div class="combat-ability-score" id="combatScoreCon">10</div>
                </div>
                <div class="combat-ability-box clickable-roll" data-ability="Int" title="Click to roll INT check">
                  <div class="combat-ability-label">INT</div>
                  <div class="combat-ability-mod" id="combatModInt">+0</div>
                  <div class="combat-ability-score" id="combatScoreInt">10</div>
                </div>
                <div class="combat-ability-box clickable-roll" data-ability="Wis" title="Click to roll WIS check">
                  <div class="combat-ability-label">WIS</div>
                  <div class="combat-ability-mod" id="combatModWis">+0</div>
                  <div class="combat-ability-score" id="combatScoreWis">10</div>
                </div>
                <div class="combat-ability-box clickable-roll" data-ability="Cha" title="Click to roll CHA check">
                  <div class="combat-ability-label">CHA</div>
                  <div class="combat-ability-mod" id="combatModCha">+0</div>
                  <div class="combat-ability-score" id="combatScoreCha">10</div>
                </div>
              </div>
            </div>

            <!-- Saves Area: Saving throw bonuses -->
            <div class="combat-area-saves combat-panel">
              <div class="combat-section-title"><i class="bi bi-shield-check"></i> Saving Throws</div>
              <div class="combat-saves-grid" id="combatSavesGrid">
                <div class="combat-save-box clickable-roll" id="combatSaveStrBox" data-ability="Str" title="Click to roll STR save">
                  <div class="combat-save-label">STR</div>
                  <div class="combat-save-value" id="combatSaveStr">+0</div>
                </div>
                <div class="combat-save-box clickable-roll" id="combatSaveDexBox" data-ability="Dex" title="Click to roll DEX save">
                  <div class="combat-save-label">DEX</div>
                  <div class="combat-save-value" id="combatSaveDex">+0</div>
                </div>
                <div class="combat-save-box clickable-roll" id="combatSaveConBox" data-ability="Con" title="Click to roll CON save">
                  <div class="combat-save-label">CON</div>
                  <div class="combat-save-value" id="combatSaveCon">+0</div>
                </div>
                <div class="combat-save-box clickable-roll" id="combatSaveIntBox" data-ability="Int" title="Click to roll INT save">
                  <div class="combat-save-label">INT</div>
                  <div class="combat-save-value" id="combatSaveInt">+0</div>
                </div>
                <div class="combat-save-box clickable-roll" id="combatSaveWisBox" data-ability="Wis" title="Click to roll WIS save">
                  <div class="combat-save-label">WIS</div>
                  <div class="combat-save-value" id="combatSaveWis">+0</div>
                </div>
                <div class="combat-save-box clickable-roll" id="combatSaveChaBox" data-ability="Cha" title="Click to roll CHA save">
                  <div class="combat-save-label">CHA</div>
                  <div class="combat-save-value" id="combatSaveCha">+0</div>
                </div>
              </div>
            </div>

            <!-- Actions Area: Attacks and Actions -->
            <div class="combat-area-actions combat-panel">
              <div class="combat-section-title"><i class="bi bi-lightning-charge"></i> Actions & Attacks</div>
              <div id="combatActions" class="small">
                <!-- Populated by JS -->
              </div>
            </div>

            <!-- Spells Area: Spell slots + prepared spells -->
            <div class="combat-area-spells combat-panel" id="combatSpellsSection">
              <div class="combat-section-title"><i class="bi bi-magic"></i> Spells</div>
              <!-- Spell Slots -->
              <div id="combatSpellSlotsSection" class="mb-3">
                <div class="small text-muted mb-1">Spell Slots</div>
                <div class="combat-slots-grid" id="combatSpellSlots">
                  <!-- Populated by JS -->
                </div>
              </div>
              <!-- Pact Slots -->
              <div id="combatPactSlotsSection" class="mb-3 d-none">
                <div class="small text-muted mb-1">Pact Slots</div>
                <div class="combat-slots-grid" id="combatPactSlots">
                  <!-- Populated by JS -->
                </div>
              </div>
              <!-- Spell List -->
              <div class="small text-muted mb-1">Prepared Spells</div>
              <div id="combatSpells" class="small" style="max-height: 300px; overflow-y: auto;">
                <!-- Populated by JS -->
              </div>
            </div>

            <!-- Resources Area: Hit Dice, Death Saves, Exhaustion -->
            <div class="combat-area-resources combat-panel">
              <div class="combat-section-title"><i class="bi bi-journal-text"></i> Resources</div>
              <div class="combat-resources-row">
                <div class="combat-resource-group">
                  <div class="small text-muted mb-1">Hit Dice</div>
                  <div class="d-flex align-items-center gap-2">
                    <button type="button" class="btn btn-sm btn-outline-success combat-hit-dice-btn" id="combatHitDiceBtn" title="Click to roll hit dice and heal">
                      <i class="bi bi-heart-pulse me-1"></i><span id="combatHitDice">1d8</span>
                    </button>
                    <span class="small text-muted">remaining</span>
                  </div>
                </div>
                <div class="combat-resource-group">
                  <div class="small text-muted mb-1">Death Saves</div>
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-success small"><i class="bi bi-check-circle"></i> <span id="combatDeathSuccess">0</span></span>
                    <span class="text-danger small"><i class="bi bi-x-circle"></i> <span id="combatDeathFailure">0</span></span>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-warning mt-1 combat-death-save-btn" id="combatDeathSaveBtn" title="Roll a death saving throw">
                    <i class="bi bi-dice-5 me-1"></i>Roll Death Save
                  </button>
                </div>
                <div class="combat-resource-group">
                  <div class="small text-muted mb-1">Exhaustion</div>
                  <span class="badge bg-warning text-dark" id="combatExhaustion">0</span>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="footer-main py-3">
      <div class="container">
        <div class="row align-items-center text-center text-md-start">
          <!-- Left: Copyright -->
          <div class="col-12 col-md-4 mb-2 mb-md-0 text-md-start text-center">
            <small class="text-muted">&copy; 2025 Maybeme | The DM’s Toolbox</small>
          </div>

          <!-- Center: Logo -->
          <div class="col-12 col-md-4 text-center mb-2 mb-md-0">
            <img src="/images/White logo MM- no background.png" height="40" alt="Logo" class="footer-logo">
          </div>

          <!-- Right: Social Links + Settings -->
          <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end align-items-center gap-2">
            <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener" aria-label="LinkedIn">
              <i class="bi bi-linkedin"></i>
            </a>
            <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener" aria-label="GitHub">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://ko-fi.com/maybemestoolbox" class="socialicons d-flex align-items-center" target="_blank" rel="noopener" title="Support The DM's Toolbox on Ko-fi">
              <i class="bi bi-cup-hot"></i>
            </a>
            <button type="button" class="socialicons" onclick="window.toggleDiagnosticsPanel?.()"
                    title="Open Settings &amp; Diagnostics" aria-label="Open Settings and Diagnostics panel">
              <i class="bi bi-gear"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Attack Editor Modal -->
  <div class="modal fade" id="attackModal" tabindex="-1" aria-labelledby="attackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="attackModalLabel">Add/Edit Attack</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="attackEditIndex" value="" />

          <div class="mb-3">
            <label for="attackName" class="form-label">Attack Name</label>
            <input type="text" class="form-control form-control-sm" id="attackName" placeholder="Longsword, Fire Bolt, Unarmed Strike..." />
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="attackType" class="form-label">Attack Type</label>
              <select class="form-select form-select-sm" id="attackType">
                <option value="melee-weapon">Melee Weapon Attack</option>
                <option value="ranged-weapon">Ranged Weapon Attack</option>
                <option value="melee-spell">Melee Spell Attack</option>
                <option value="ranged-spell">Ranged Spell Attack</option>
                <option value="save">Saving Throw</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-6">
              <label for="attackRange" class="form-label">Range</label>
              <input type="text" class="form-control form-control-sm" id="attackRange" placeholder="5 ft, 30/120 ft..." />
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="attackBonus" class="form-label">Attack Bonus</label>
              <input type="text" class="form-control form-control-sm" id="attackBonus" placeholder="+5, +8..." />
            </div>
            <div class="col-6">
              <label for="attackSaveDC" class="form-label">Save DC (if applicable)</label>
              <input type="text" class="form-control form-control-sm" id="attackSaveDC" placeholder="DC 15, DC 18..." />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Primary Damage</label>
            <div class="row g-2">
              <div class="col-7">
                <input type="text" class="form-control form-control-sm" id="attackDamage" placeholder="1d8+3" />
                <div class="form-text small">Dice notation (e.g., 1d8+3)</div>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="attackDamageType" placeholder="slashing" />
                <div class="form-text small">Damage type</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Additional Damage (optional)</label>
            <div class="row g-2">
              <div class="col-7">
                <input type="text" class="form-control form-control-sm" id="attackDamage2" placeholder="2d6" />
                <div class="form-text small">Dice notation (e.g., 2d6)</div>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="attackDamageType2" placeholder="radiant" />
                <div class="form-text small">Damage type</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="attackProperties" class="form-label">Properties / Notes</label>
            <textarea class="form-control form-control-sm" id="attackProperties" rows="2" placeholder="Versatile (1d10), reach, finesse, magical..."></textarea>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="saveAttackBtn">
            <i class="bi bi-check2-circle me-1"></i>Save Attack
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Portrait Editing Modal -->
  <div class="modal fade" id="portraitModal" tabindex="-1" aria-labelledby="portraitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="portraitModalLabel">Adjust Portrait Framing</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 portrait-frame" style="height: 420px; cursor: grab;" id="portraitContainerModal">
            <img id="portraitPreviewModal"
                 class="portrait-image d-none"
                 alt="Portrait being edited" />
            <span id="portraitPlaceholderModal"
                  class="text-muted position-absolute top-50 start-50 translate-middle text-center">
              No image loaded
            </span>
          </div>

          <div class="mb-3">
            <label for="portraitZoomModal" class="form-label mb-1">Zoom</label>
            <input type="range" id="portraitZoomModal" min="1" max="3" step="0.05" class="form-range" />
            <small class="text-muted">Drag inside the frame to reposition the portrait.</small>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="savePortraitModalBtn">
            <i class="bi bi-check2-circle me-1"></i>Save Portrait
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Item Editor Modal -->
  <div class="modal fade" id="inventoryItemModal" tabindex="-1" aria-labelledby="inventoryItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="inventoryItemModalLabel">Add/Edit Item</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="inventoryItemEditIndex" value="" />

          <div class="mb-3">
            <label for="inventoryItemName" class="form-label">Item Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm" id="inventoryItemName" placeholder="Longsword, Potion of Healing, Backpack..." required />
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="inventoryItemQuantity" class="form-label">Quantity <span class="text-danger">*</span></label>
              <input type="number" class="form-control form-control-sm" id="inventoryItemQuantity" min="1" value="1" required />
            </div>
            <div class="col-6">
              <label for="inventoryItemWeight" class="form-label">Weight per Item (lb)</label>
              <input type="number" class="form-control form-control-sm" id="inventoryItemWeight" min="0" step="0.1" value="0" placeholder="0" />
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="inventoryItemEquipped" />
                <label class="form-check-label" for="inventoryItemEquipped">
                  Equipped
                </label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="inventoryItemAttuned" />
                <label class="form-check-label" for="inventoryItemAttuned">
                  Attuned
                </label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="inventoryItemNotes" class="form-label">Notes (optional)</label>
            <textarea class="form-control form-control-sm" id="inventoryItemNotes" rows="2" placeholder="Item description, properties, or other notes..."></textarea>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="saveInventoryItemBtn">
            <i class="bi bi-check2-circle me-1"></i>Save Item
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Token Preview Modal -->
  <div class="modal fade" id="tokenPreviewModal" tabindex="-1" aria-labelledby="tokenPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="tokenPreviewModalLabel">Adjust Battle Map Token</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Position and zoom your character portrait to fit in the circular token.</p>

          <!-- Circular token preview -->
          <div class="d-flex justify-content-center mb-3">
            <div style="width: 250px; height: 250px; position: relative; border-radius: 50%; overflow: hidden; background: #1a1a1a; border: 3px solid #495057;">
              <canvas id="tokenPreviewCanvas" width="250" height="250" style="cursor: grab; display: block;"></canvas>
            </div>
          </div>

          <!-- Zoom control -->
          <div class="mb-3">
            <label for="tokenZoom" class="form-label mb-1">Zoom</label>
            <input type="range" id="tokenZoom" min="0.5" max="3" step="0.05" value="1" class="form-range" />
            <small class="text-muted">Drag the preview image to reposition. Use zoom to fit your portrait in the circle.</small>
          </div>

          <!-- Reset button -->
          <div class="text-center">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetTokenPosition">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Position
            </button>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmSendToMapBtn">
            <i class="bi bi-geo-alt-fill me-1"></i>Send to Battle Map
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Character Creation Wizard Modal -->
  <div class="modal fade" id="characterCreationModal" tabindex="-1" aria-labelledby="characterCreationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="wizardTitle">Character Creation Wizard</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="wizardBody">
          <!-- Wizard content populated by JS -->
        </div>
        <div class="modal-footer border-secondary d-flex justify-content-between" id="wizardFooter">
          <!-- Wizard buttons populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Hit Dice Healing Modal -->
  <div class="modal fade" id="hitDiceModal" tabindex="-1" aria-labelledby="hitDiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="hitDiceModalLabel">
            <i class="bi bi-heart-pulse me-2"></i>Spend Hit Dice to Heal
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info text-light mb-3">
            <strong>Short Rest Healing:</strong> Spend hit dice to regain HP. Roll the die and add your Constitution modifier to the result.
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0"><strong>Current HP:</strong></label>
              <span id="hdModalCurrentHP" class="badge bg-danger fs-6">0 / 0</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label mb-0"><strong>Available Hit Dice:</strong></label>
              <span id="hdModalAvailable" class="badge bg-secondary fs-6">0d0</span>
            </div>
          </div>

          <div class="mb-3">
            <label for="hdSpendCount" class="form-label">How many hit dice to spend?</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="hdDecrement">-</button>
              <input type="number" class="form-control text-center" id="hdSpendCount" value="1" min="0" max="0" />
              <button class="btn btn-outline-secondary" type="button" id="hdIncrement">+</button>
            </div>
            <div class="form-text">Constitution modifier: <span id="hdConMod">+0</span></div>
          </div>

          <div id="hdRollResults" class="mb-3" style="display: none;">
            <div class="alert alert-success text-light">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Rolls:</strong>
                <span id="hdRollDetails" class="font-monospace"></span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <strong>Total Healing:</strong>
                <span id="hdTotalHealing" class="fs-5 text-success fw-bold"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="hdRollBtn">
            <i class="bi bi-dice-5 me-1"></i>Roll Hit Dice
          </button>
          <button type="button" class="btn btn-success" id="hdApplyBtn" style="display: none;">
            <i class="bi bi-check2-circle me-1"></i>Apply Healing
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container for Mobile Roll Notifications -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">
    <div id="rollToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="rollToastBody">
          <!-- Roll result content -->
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Multiclass Management Modal -->
  <div class="modal fade" id="multiclassModal" tabindex="-1" aria-labelledby="multiclassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="multiclassModalLabel">
            <i class="bi bi-diagram-3 me-2"></i>Manage Multiclass Levels
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle me-1"></i>
            Allocate your character's total level across multiple classes. The system will automatically calculate spell slots using multiclass rules.
          </p>

          <div class="mb-3">
            <label class="form-label">Total Character Level: <strong id="multiclassTotalLevel">1</strong></label>
            <div class="progress" style="height: 25px;">
              <div id="multiclassLevelBar" class="progress-bar" role="progressbar" style="width: 0%">
                <span id="multiclassLevelText">0 / 1</span>
              </div>
            </div>
          </div>

          <div id="multiclassClassList" class="mb-3">
            <!-- Class entries will be dynamically added here -->
          </div>

          <button type="button" class="btn btn-sm btn-outline-success" id="addMulticlassBtn">
            <i class="bi bi-plus-circle me-1"></i>Add Class
          </button>

          <hr class="border-secondary my-3">

          <div id="multiclassPrereqWarnings" class="alert alert-warning d-none">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <strong>Prerequisites not met:</strong>
            <ul id="multiclassPrereqList" class="mb-0 mt-2"></ul>
          </div>

          <div id="multiclassSpellSlotPreview" class="d-none">
            <h6 class="mb-2">Spell Slots Preview:</h6>
            <div class="row g-2">
              <div class="col">
                <small class="text-muted d-block">Shared Slots</small>
                <div id="multiclassSharedSlots" class="small"></div>
              </div>
              <div class="col" id="multiclassPactSlotSection" style="display: none;">
                <small class="text-muted d-block">Pact Magic</small>
                <div id="multiclassPactSlots" class="small"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="applyMulticlassBtn">
            <i class="bi bi-check2-circle me-1"></i>Apply Multiclass
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="helpModalLabel">
            <i class="bi bi-question-circle-fill me-2 text-primary"></i>
            Character Sheet Help & Guide
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Tab Navigation -->
          <ul class="nav nav-tabs mb-3" id="helpTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="getting-started-tab" data-bs-toggle="tab" data-bs-target="#getting-started" type="button" role="tab">
                <i class="bi bi-play-circle me-1"></i>Getting Started
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="character-info-tab" data-bs-toggle="tab" data-bs-target="#character-info" type="button" role="tab">
                <i class="bi bi-person-badge me-1"></i>Character Info
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="stats-combat-tab" data-bs-toggle="tab" data-bs-target="#stats-combat" type="button" role="tab">
                <i class="bi bi-shield-shaded me-1"></i>Stats & Combat
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="spells-tab" data-bs-toggle="tab" data-bs-target="#spells" type="button" role="tab">
                <i class="bi bi-stars me-1"></i>Spells
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="level-up-tab" data-bs-toggle="tab" data-bs-target="#level-up" type="button" role="tab">
                <i class="bi bi-arrow-up-circle me-1"></i>Leveling Up
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab">
                <i class="bi bi-lightning-charge me-1"></i>Features
              </button>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content" id="helpTabContent">
            <!-- Getting Started Tab -->
            <div class="tab-pane fade show active" id="getting-started" role="tabpanel">
              <h5 class="text-primary mb-3">Welcome to the Character Manager!</h5>
              <p class="lead">This tool helps you create, manage, and level up D&D 5e characters with ease.</p>

              <div class="accordion accordion-flush" id="gettingStartedAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#create-character">
                      <i class="bi bi-person-plus me-2 text-success"></i>Creating Your First Character
                    </button>
                  </h2>
                  <div id="create-character" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <ol>
                        <li><strong>Click the "New" button</strong> at the top of the page</li>
                        <li><strong>Follow the wizard:</strong>
                          <ul>
                            <li>Enter character name and basic info</li>
                            <li>Choose race (see scaling features if applicable)</li>
                            <li>Select class and subclass (if level 1-3)</li>
                            <li>Roll or assign ability scores</li>
                            <li>Pick skills and equipment</li>
                          </ul>
                        </li>
                        <li><strong>Click "Create Character"</strong> to finish</li>
                        <li>Your character is automatically saved to browser storage</li>
                      </ol>
                      <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Characters are stored locally in your browser. Use "Export" to create backup files!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#saving-loading">
                      <i class="bi bi-save me-2 text-warning"></i>Saving & Loading Characters
                    </button>
                  </h2>
                  <div id="saving-loading" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <h6>Auto-Save</h6>
                      <p>Characters automatically save when you click the <strong>"Save" button</strong> or after certain actions like leveling up.</p>

                      <h6>Loading</h6>
                      <p>Use the <strong>character dropdown</strong> at the top to switch between saved characters.</p>

                      <h6>Export/Import</h6>
                      <ul>
                        <li><strong>Export:</strong> Downloads character as JSON file (backup)</li>
                        <li><strong>Export All:</strong> Downloads all characters as one file</li>
                        <li><strong>Import:</strong> Loads character from a JSON file</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#combat-view">
                      <i class="bi bi-lightning-charge me-2 text-warning"></i>Combat View Toggle
                    </button>
                  </h2>
                  <div id="combat-view" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <h6>What is Combat View?</h6>
                      <p>Combat View transforms the full character sheet into a compact combat card that shows only the information needed during battle.</p>

                      <h6>How to Use</h6>
                      <ol>
                        <li>Toggle the <strong>"Combat View"</strong> switch in the header (next to "Last Updated")</li>
                        <li>The page transforms into a compact card showing:
                          <ul>
                            <li>Character portrait (if available)</li>
                            <li>Essential stats: AC, HP, Speed</li>
                            <li>Combat info: Initiative, Proficiency Bonus, Passive Perception</li>
                            <li>All ability checks and saving throws (click to roll)</li>
                            <li>Active conditions</li>
                            <li>All attacks with to-hit bonuses and damage (click to roll inline)</li>
                            <li>Spell slots and spells organized by level</li>
                            <li>Death saves tracker with Roll button</li>
                            <li>Hit Dice with Roll button</li>
                          </ul>
                        </li>
                        <li>Toggle back to access the full sheet for editing</li>
                      </ol>

                      <h6>Interactive Rolls</h6>
                      <ul>
                        <li><strong>Ability checks & saves:</strong> Click any stat to roll (normal, advantage, or disadvantage)</li>
                        <li><strong>Initiative:</strong> Click the initiative value to roll for initiative</li>
                        <li><strong>Attacks:</strong> Click an attack to roll to-hit and damage inline</li>
                        <li><strong>Hit Dice:</strong> Click the Roll button to roll a hit die during short rest</li>
                      </ul>

                      <h6>HP in Combat View</h6>
                      <p>Click the HP area to reveal inline damage, heal, and temp HP controls without leaving combat view.</p>

                      <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Use the <strong>Dice History</strong> button in combat view to review your last 50 rolls!
                      </div>

                      <div class="alert alert-success">
                        <i class="bi bi-check-circle me-1"></i>
                        <strong>Auto-Updates:</strong> Combat view automatically refreshes when you switch characters or make changes to attacks/spells!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#page-layout">
                      <i class="bi bi-layout-text-window me-2 text-info"></i>Understanding the Page Layout
                    </button>
                  </h2>
                  <div id="page-layout" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <p>The character sheet is organized into sections:</p>
                      <ul>
                        <li><strong>Top Bar:</strong> Character selection, New/Save/Delete, Export, Level Up, Help, Combat View toggle</li>
                        <li><strong>Left Column:</strong> Character info (name, race, class, level, backstory, portrait)</li>
                        <li><strong>Center Column:</strong> Stats (abilities, skills, proficiency, senses)</li>
                        <li><strong>Right Column:</strong> Combat info (HP, AC, attacks, death saves)</li>
                        <li><strong>Bottom Tabs:</strong> Action Notes, Spells, Inventory, Features & Traits, Background, Notes</li>
                      </ul>
                      <div class="alert alert-success">
                        <i class="bi bi-phone me-1"></i>
                        <strong>Mobile Friendly:</strong> On smaller screens, columns stack vertically for easy scrolling!
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Character Info Tab -->
            <div class="tab-pane fade" id="character-info" role="tabpanel">
              <h5 class="text-primary mb-3">Character Information</h5>
              <p>The left side of the sheet contains your character's identity and story.</p>

              <div class="accordion accordion-flush" id="characterInfoAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#basic-info">
                      <i class="bi bi-card-text me-2"></i>Basic Information
                    </button>
                  </h2>
                  <div id="basic-info" class="accordion-collapse collapse" data-bs-parent="#characterInfoAccordion">
                    <div class="accordion-body">
                      <table class="table table-sm table-dark">
                        <tr>
                          <td><strong>Character Name</strong></td>
                          <td>Your character's name (editable field)</td>
                        </tr>
                        <tr>
                          <td><strong>Class / Subclass</strong></td>
                          <td>e.g., "Fighter (Champion)" or "Wizard / Rogue" for multiclass</td>
                        </tr>
                        <tr>
                          <td><strong>Level</strong></td>
                          <td>Current character level (1-20)</td>
                        </tr>
                        <tr>
                          <td><strong>Race</strong></td>
                          <td>Your character's race (e.g., Human, Elf, Dragonborn)</td>
                        </tr>
                        <tr>
                          <td><strong>Background</strong></td>
                          <td>Story background (e.g., Soldier, Noble, Acolyte)</td>
                        </tr>
                        <tr>
                          <td><strong>Alignment</strong></td>
                          <td>Moral compass (e.g., Lawful Good, Chaotic Neutral)</td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#backstory-portrait">
                      <i class="bi bi-book me-2"></i>Backstory & Portrait
                    </button>
                  </h2>
                  <div id="backstory-portrait" class="accordion-collapse collapse" data-bs-parent="#characterInfoAccordion">
                    <div class="accordion-body">
                      <h6>Backstory</h6>
                      <p>Click <strong>"Backstory"</strong> to expand a text area where you can write your character's history, personality traits, bonds, flaws, and ideals.</p>

                      <h6>Portrait</h6>
                      <p>Click <strong>"Character Portrait"</strong> to:</p>
                      <ul>
                        <li>Upload an image from your computer</li>
                        <li>Use a URL from the web</li>
                        <li>Adjust position/zoom with the preview tool</li>
                      </ul>
                      <p class="text-muted small">Portrait is saved with your character and displayed in the frame.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#multiclass-btn">
                      <i class="bi bi-diagram-3 me-2"></i>Multiclass Button
                    </button>
                  </h2>
                  <div id="multiclass-btn" class="accordion-collapse collapse" data-bs-parent="#characterInfoAccordion">
                    <div class="accordion-body">
                      <p>The <strong>"Multiclass" button</strong> next to the Class field lets you:</p>
                      <ul>
                        <li>Add multiple classes (e.g., Paladin 3 / Fighter 2)</li>
                        <li>See spell slot calculations for multiclass casters</li>
                        <li>Manage level distribution across classes</li>
                      </ul>
                      <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Prerequisites:</strong> Multiclassing requires meeting ability score minimums (checked automatically).
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats & Combat Tab -->
            <div class="tab-pane fade" id="stats-combat" role="tabpanel">
              <h5 class="text-primary mb-3">Stats, Skills & Combat</h5>

              <div class="accordion accordion-flush" id="statsCombatAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ability-scores">
                      <i class="bi bi-graph-up me-2"></i>Ability Scores
                    </button>
                  </h2>
                  <div id="ability-scores" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <p>The six core abilities (STR, DEX, CON, INT, WIS, CHA) are shown in the center column.</p>
                      <ul>
                        <li><strong>Score:</strong> The ability score value (8-20)</li>
                        <li><strong>Modifier:</strong> Auto-calculated bonus/penalty</li>
                        <li><strong>Save:</strong> Checkbox for proficiency + calculated bonus</li>
                      </ul>
                      <p class="text-muted">Modifiers are used for skills, saves, and attacks. They update automatically when you change scores.</p>

                      <h6>Rolling Checks</h6>
                      <p>Each ability and saving throw has three roll buttons:</p>
                      <ul>
                        <li><strong>+ (Advantage):</strong> Roll two d20s, take the higher result</li>
                        <li><strong>Normal:</strong> Roll one d20</li>
                        <li><strong>− (Disadvantage):</strong> Roll two d20s, take the lower result</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#skills-section">
                      <i class="bi bi-gear me-2"></i>Skills & Proficiencies
                    </button>
                  </h2>
                  <div id="skills-section" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <p>Skills are listed below ability scores. Each skill has:</p>
                      <ul>
                        <li><strong>Checkbox:</strong> Check if proficient</li>
                        <li><strong>Expertise (⭐):</strong> Click star icon for double proficiency</li>
                        <li><strong>Bonus:</strong> Auto-calculated total (ability modifier + proficiency if applicable)</li>
                        <li><strong>Roll buttons:</strong> Advantage (+), Normal, and Disadvantage (−) roll buttons for quick in-session checks</li>
                      </ul>
                      <p><strong>Proficiency Bonus:</strong> Shown at the top, increases at levels 5, 9, 13, 17.</p>
                      <p><strong>Initiative:</strong> Uses DEX modifier + any bonuses (like Alert feat).</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hp-ac">
                      <i class="bi bi-heart-fill me-2"></i>HP, AC & Combat Stats
                    </button>
                  </h2>
                  <div id="hp-ac" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <h6>Hit Points</h6>
                      <ul>
                        <li><strong>Current HP:</strong> Your current hit points</li>
                        <li><strong>Max HP:</strong> Maximum hit points</li>
                        <li><strong>Temp HP:</strong> Temporary hit points (absorbed first)</li>
                        <li><strong>Hit Dice:</strong> Remaining hit dice available for short rests. Recover half on a long rest.</li>
                      </ul>

                      <h6>Armor Class (AC)</h6>
                      <p>Your defense value. Higher = harder to hit.</p>

                      <h6>Speed</h6>
                      <p>Movement speed in feet per turn.</p>

                      <h6>Death Saves</h6>
                      <p>When at 0 HP, track successes and failures. 3 successes = stabilized, 3 failures = death. Reset after a long rest.</p>

                      <h6>Inspiration & Concentration</h6>
                      <ul>
                        <li><strong>Inspiration:</strong> Check the box when the DM grants inspiration.</li>
                        <li><strong>Concentration:</strong> Check when maintaining a concentration spell — a reminder to track concentration checks when damaged.</li>
                      </ul>

                      <h6>Exhaustion</h6>
                      <p>Track exhaustion level (0–10) in the right column. Levels impose increasingly severe penalties per the D&D 5e rules.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#attacks-section">
                      <i class="bi bi-lightning-fill me-2"></i>Attacks & Actions
                    </button>
                  </h2>
                  <div id="attacks-section" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Attacks</strong> section lets you track your weapons and actions:</p>
                      <ul>
                        <li><strong>Add Attack:</strong> Click "+" to create a new attack entry</li>
                        <li>Enter attack name, bonus, damage, and type</li>
                        <li><strong>Delete:</strong> Click trash icon to remove</li>
                      </ul>
                      <p>Common attacks: Longsword, Shortbow, Fire Bolt, Eldritch Blast, etc.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Spells Tab -->
            <div class="tab-pane fade" id="spells" role="tabpanel">
              <h5 class="text-primary mb-3">Spellcasting</h5>

              <div class="accordion accordion-flush" id="spellsAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#spell-slots">
                      <i class="bi bi-circle me-2"></i>Spell Slots
                    </button>
                  </h2>
                  <div id="spell-slots" class="accordion-collapse collapse" data-bs-parent="#spellsAccordion">
                    <div class="accordion-body">
                      <p>Spell slots appear automatically for spellcasting classes:</p>
                      <ul>
                        <li><strong>Max:</strong> Total slots available</li>
                        <li><strong>Used:</strong> Slots you've expended</li>
                        <li><strong>+/- buttons:</strong> Quickly adjust used slots</li>
                        <li><strong>Reset:</strong> Set used slots back to 0 (after long rest)</li>
                      </ul>
                      <p><strong>Pact Magic (Warlock):</strong> Shown separately with different recovery rules.</p>
                      <p class="text-muted">Multiclass spell slots are calculated automatically using PHB rules!</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#known-spells">
                      <i class="bi bi-stars me-2"></i>Known Spells List
                    </button>
                  </h2>
                  <div id="known-spells" class="accordion-collapse collapse" data-bs-parent="#spellsAccordion">
                    <div class="accordion-body">
                      <p>In the <strong>Spells tab</strong> at the bottom of the page:</p>
                      <ul>
                        <li>Spells are organized by level (Cantrips, 1st, 2nd, etc.)</li>
                        <li><strong>Add Spell:</strong> Type name and press Enter</li>
                        <li><strong>Remove:</strong> Click X next to spell name</li>
                        <li>Spells learned during level-up are added automatically</li>
                      </ul>
                      <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Spells are automatically suggested during level-up based on your class!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#spell-dc">
                      <i class="bi bi-crosshair me-2"></i>Spell Save DC & Attack Bonus
                    </button>
                  </h2>
                  <div id="spell-dc" class="accordion-collapse collapse" data-bs-parent="#spellsAccordion">
                    <div class="accordion-body">
                      <p>These are calculated automatically based on your spellcasting ability:</p>
                      <ul>
                        <li><strong>Spell Save DC:</strong> 8 + proficiency + ability modifier</li>
                        <li><strong>Spell Attack Bonus:</strong> proficiency + ability modifier</li>
                      </ul>
                      <p>The spellcasting ability depends on your class (INT for Wizard, WIS for Cleric, CHA for Sorcerer, etc.)</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Level Up Tab -->
            <div class="tab-pane fade" id="level-up" role="tabpanel">
              <h5 class="text-primary mb-3">Leveling Up Your Character</h5>

              <div class="accordion accordion-flush" id="levelUpAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#level-up-process">
                      <i class="bi bi-arrow-up-circle me-2"></i>Level-Up Process
                    </button>
                  </h2>
                  <div id="level-up-process" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <ol>
                        <li>Click the <strong>"Level Up" button</strong> at the top</li>
                        <li>Follow the step-by-step wizard:
                          <ul>
                            <li><strong>Step 1:</strong> Choose to continue in current class or multiclass</li>
                            <li><strong>Step 2:</strong> Select subclass (if reaching selection level)</li>
                            <li><strong>Step 3:</strong> Choose HP increase (roll or take average)</li>
                            <li><strong>Step 4:</strong> Racial features (if unlocked at this level)</li>
                            <li><strong>Step 5:</strong> Learn new spells (for spellcasters)</li>
                            <li><strong>Step 6:</strong> Choose ASI or feat (at levels 4, 8, 12, 16, 19)</li>
                            <li><strong>Step 7:</strong> Review new class features</li>
                            <li><strong>Step 8:</strong> Confirm changes</li>
                          </ul>
                        </li>
                        <li>Character automatically saves after level-up</li>
                      </ol>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#multiclass-levelup">
                      <i class="bi bi-diagram-3 me-2"></i>Multiclassing
                    </button>
                  </h2>
                  <div id="multiclass-levelup" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <p>At Step 1 of level-up, you can choose to multiclass into a new class:</p>
                      <ul>
                        <li>Prerequisites are checked automatically (ability scores)</li>
                        <li>You gain level 1 features of the new class</li>
                        <li>Your character becomes "Paladin / Fighter" format</li>
                        <li>Spell slots are calculated using multiclass rules</li>
                      </ul>
                      <p>Use the <strong>Multiclass button</strong> on the character sheet to manage level distribution later.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#asi-feats">
                      <i class="bi bi-plus-square me-2"></i>ASI & Feats
                    </button>
                  </h2>
                  <div id="asi-feats" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <p>At certain levels (usually 4, 8, 12, 16, 19), you can choose:</p>

                      <h6>Ability Score Improvement (ASI)</h6>
                      <ul>
                        <li>Increase one score by +2</li>
                        <li>OR increase two scores by +1 each</li>
                        <li>Maximum ability score is 20</li>
                      </ul>

                      <h6>Feat</h6>
                      <p>Choose from the SRD-ready feat list including standbys like Alert, Lucky, War Caster, Great Weapon Master, Sentinel, Sharpshooter, and more. Many feats also grant +1 to an ability score.</p>
                      <div class="alert alert-warning small mb-0" role="status">
                        <i class="bi bi-lock-fill me-1" aria-hidden="true"></i>
                        Looking for Tasha's or Xanathar's feats? Those non-SRD options stay hidden until you load a private content pack.
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#racial-features-levelup">
                      <i class="bi bi-star me-2"></i>Racial Features
                    </button>
                  </h2>
                  <div id="racial-features-levelup" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <p>Some races unlock features at specific levels:</p>
                      <ul>
                        <li><strong>Tiefling (Levels 3 & 5):</strong> Gain Hellish Rebuke and Darkness spells automatically.</li>
                        <li><strong>Dragonborn:</strong> Breath weapon damage and save DC scale every few levels.</li>
                      </ul>
                      <p>These appear automatically during level-up when you reach the appropriate level!</p>

                      <div class="alert alert-warning small" role="status">
                        <i class="bi bi-info-circle me-1" aria-hidden="true"></i>
                        Additional level-based racial unlocks (Aasimar transformations, Genasi spells, etc.) require a private content pack and stay hidden in the SRD-only build.
                      </div>

                      <div class="alert alert-success">
                        <i class="bi bi-graph-up me-1"></i>
                        <strong>Scaling Features:</strong> Some racial features (like the Dragonborn Breath Weapon) scale with level. Reference tables are shown during character creation!
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Features Tab -->
            <div class="tab-pane fade" id="features" role="tabpanel">
              <h5 class="text-primary mb-3">Features & Other Tools</h5>

              <div class="accordion accordion-flush" id="featuresAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#inventory-tab">
                      <i class="bi bi-backpack me-2"></i>Inventory Management
                    </button>
                  </h2>
                  <div id="inventory-tab" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Inventory tab</strong> at the bottom lets you track:</p>
                      <ul>
                        <li><strong>Equipment:</strong> Armor, weapons, tools</li>
                        <li><strong>Items:</strong> Potions, scrolls, misc items</li>
                        <li><strong>Currency:</strong> CP, SP, EP, GP, PP</li>
                      </ul>
                      <p>Click <strong>"Add Item"</strong> to open the item modal with name, quantity, weight, and description fields. Items can also be marked as <strong>Equipped</strong> or <strong>Attuned</strong>.</p>
                      <p><strong>Encumbrance:</strong> Total carried weight and carrying capacity are shown at the top of the tab. The status indicator changes color as you approach your limit.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#features-traits-tab">
                      <i class="bi bi-lightning-charge me-2"></i>Features & Traits
                    </button>
                  </h2>
                  <div id="features-traits-tab" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Features & Traits tab</strong> shows:</p>
                      <ul>
                        <li>Class features gained from leveling up</li>
                        <li>Racial traits</li>
                        <li>Feats you've chosen</li>
                        <li>Special abilities</li>
                      </ul>
                      <p>This is automatically populated as you level up. You can also add custom features manually.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#action-notes-tab">
                      <i class="bi bi-journal-text me-2"></i>Action Notes Tab
                    </button>
                  </h2>
                  <div id="action-notes-tab" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Action Notes tab</strong> contains two sections:</p>
                      <ul>
                        <li><strong>Attacks & Actions:</strong> Your saved attacks with quick roll buttons. Attack rolls are color-coded — green for advantage/crit, white for normal, red for disadvantage/half.</li>
                        <li><strong>At-the-Table Reminders:</strong> A freeform text area for session notes, reminders, or anything you need handy during play.</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#background-notes-tab">
                      <i class="bi bi-book me-2"></i>Background & Notes Tabs
                    </button>
                  </h2>
                  <div id="background-notes-tab" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <ul>
                        <li><strong>Background tab:</strong> A dedicated text area for story hooks, secrets, faction ties, relationships, and long-form narrative notes.</li>
                        <li><strong>Notes tab:</strong> A general-purpose scratchpad for anything that doesn't fit elsewhere — session summaries, treasure leads, NPC names, etc.</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#send-to-tools">
                      <i class="bi bi-send me-2"></i>Send to Other Tools
                    </button>
                  </h2>
                  <div id="send-to-tools" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>Integrate with other DM Toolbox features:</p>

                      <h6>Send to Initiative Tracker</h6>
                      <p>Adds your character to the combat tracker with HP, AC, and initiative.</p>

                      <h6>Send to Battle Map</h6>
                      <p>Creates a token on the battle map using your portrait image.</p>

                      <p class="text-muted">These buttons are at the top of the page!</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tips-tricks">
                      <i class="bi bi-lightbulb me-2"></i>Tips & Tricks
                    </button>
                  </h2>
                  <div id="tips-tricks" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <ul>
                        <li><strong>Always Save:</strong> Click Save after making changes to ensure they persist</li>
                        <li><strong>Export Regularly:</strong> Create backup JSON files of important characters</li>
                        <li><strong>Short Rest button:</strong> Resets short-rest resources. Roll hit dice from the right column to recover HP.</li>
                        <li><strong>Long Rest button:</strong> Resets spell slots, hit dice (half recovered), death saves, and other long-rest resources.</li>
                        <li><strong>Use Multiclass Manager:</strong> Better control over level distribution than manual editing</li>
                        <li><strong>Spell Slots:</strong> Use +/- buttons for quick tracking during sessions</li>
                        <li><strong>Death Saves:</strong> Reset these after a long rest!</li>
                        <li><strong>Hit Dice:</strong> Track what you've used and recover half on long rest</li>
                        <li><strong>Portrait Zoom:</strong> Adjust your portrait position in the modal for perfect framing</li>
                        <li><strong>Dice History:</strong> Use the Dice History button in combat view to review recent rolls</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dice History Modal -->
  <div class="modal fade" id="diceHistoryModal" tabindex="-1" aria-labelledby="diceHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="diceHistoryModalLabel">
            <i class="bi bi-dice-5 me-2 text-primary"></i>Dice Roll History
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <div id="diceHistoryModalList" style="max-height: 60vh; overflow-y: auto;"></div>
        </div>
        <div class="modal-footer border-secondary">
          <span class="text-muted small me-auto">Max 50 entries</span>
          <button type="button" class="btn btn-outline-danger btn-sm" id="clearDiceHistoryModalBtn">
            <i class="bi bi-trash me-1"></i>Clear History
          </button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/indexed-db-storage.js"></script>
  <script src="/data/srd/spells-data.js"></script>
  <script src="/data/srd/level-up-data.js"></script>
  <script src="/js/character-creation-wizard.js"></script>
  <script src="/js/level-up-system.js"></script>
  <script src="/js/character.js"></script>
  <script src="/js/multiclass-ui.js"></script>
  <script src="/js/character-sheet-export.js"></script>

  <!-- Combat/DM Mode Toggle Functionality -->
  <script>
    (function() {
      const dmCombatModeToggle = document.getElementById('dmCombatModeToggle');

      // Function to update combat card view with current character data
      function updateCombatCardView() {
        // Get character data from the form fields
        const charName = document.getElementById('charName')?.value || 'Character Name';
        const charRace = document.getElementById('charRace')?.value || '-';
        const charClass = document.getElementById('charClass')?.value || '-';
        const charLevel = document.getElementById('charLevel')?.value || '1';

        // Basic stats (using correct field IDs)
        const ac = document.getElementById('charAC')?.value || '10';
        const currentHp = document.getElementById('charCurrentHP')?.value || '10';
        const maxHp = document.getElementById('charMaxHP')?.value || '10';
        const speed = document.getElementById('charSpeed')?.value || '30';
        const profBonus = document.getElementById('proficiencyBonus')?.value || '+2';
        const passivePerception = document.getElementById('passivePerception')?.value || '10';

        // Initiative (DEX modifier)
        const dexMod = document.getElementById('modDex')?.value || '0';

        // Hit dice (show remaining, not total)
        const hitDiceRemaining = document.getElementById('charHitDiceRemaining')?.value || '0d8';
        const hitDice = hitDiceRemaining;

        // Format with + sign for positive values
        const formatMod = (val) => {
          const num = parseInt(val, 10);
          if (isNaN(num)) return '+0';
          return num >= 0 ? `+${num}` : `${num}`;
        };

        // Ability Scores and Modifiers
        const abilities = ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha'];
        abilities.forEach(ability => {
          const score = document.getElementById(`stat${ability}`)?.value || '10';
          const mod = document.getElementById(`mod${ability}`)?.value || '0';
          const scoreEl = document.getElementById(`combatScore${ability}`);
          const modEl = document.getElementById(`combatMod${ability}`);
          if (scoreEl) scoreEl.textContent = score;
          if (modEl) modEl.textContent = formatMod(mod);
        });

        // Saving throws - read from the correct input IDs (saveStrBonus, saveDexBonus, etc.)
        const saveAbilities = ['Str', 'Dex', 'Con', 'Int', 'Wis', 'Cha'];
        saveAbilities.forEach(ability => {
          const saveVal = document.getElementById(`save${ability}Bonus`)?.value;
          const saveEl = document.getElementById(`combatSave${ability}`);
          const saveBox = document.getElementById(`combatSave${ability}Box`);
          const profCheck = document.getElementById(`save${ability}Prof`)?.checked;

          if (saveEl) saveEl.textContent = formatMod(saveVal);
          if (saveBox) {
            if (profCheck) {
              saveBox.classList.add('proficient');
            } else {
              saveBox.classList.remove('proficient');
            }
          }
        });

        // Get portrait data
        const portraitPreview = document.getElementById('portraitPreview');
        const combatPortraitImage = document.getElementById('combatPortraitImage');
        const combatPortraitPlaceholder = document.getElementById('combatPortraitPlaceholder');

        // Update portrait
        if (portraitPreview && !portraitPreview.classList.contains('d-none')) {
          combatPortraitImage.src = portraitPreview.src;
          combatPortraitImage.style.transform = portraitPreview.style.transform || 'translate(-50%, -50%) scale(1)';
          combatPortraitImage.classList.remove('d-none');
          combatPortraitPlaceholder.classList.add('d-none');
        } else {
          combatPortraitImage.classList.add('d-none');
          combatPortraitPlaceholder.classList.remove('d-none');
        }

        // Update all combat card fields
        document.getElementById('combatCharName').textContent = charName;
        document.getElementById('combatClass').textContent = charClass;
        document.getElementById('combatRace').textContent = charRace;
        document.getElementById('combatLevel').textContent = charLevel;
        document.getElementById('combatAC').textContent = ac;
        // HP is now updated via updateCombatHP() for interactive display
        document.getElementById('combatSpeed').textContent = `${speed} ft`;
        document.getElementById('combatInitiative').textContent = formatMod(dexMod);
        document.getElementById('combatHitDice').textContent = hitDice;
        document.getElementById('combatProfBonus').textContent = profBonus;
        document.getElementById('combatPassivePerception').textContent = passivePerception;

        // Spellcasting stats
        const spellDC = document.getElementById('spellSaveDC')?.textContent || '--';
        const spellAttack = document.getElementById('spellAttackBonus')?.textContent || '--';
        const combatSpellStatsSection = document.getElementById('combatSpellStatsSection');
        const combatSpellDC = document.getElementById('combatSpellDC');
        const combatSpellAttack = document.getElementById('combatSpellAttack');

        if (spellDC && spellDC !== '—' && spellDC !== '--') {
          if (combatSpellStatsSection) combatSpellStatsSection.classList.remove('d-none');
          if (combatSpellDC) combatSpellDC.textContent = spellDC;
          if (combatSpellAttack) combatSpellAttack.textContent = spellAttack;
        } else {
          if (combatSpellStatsSection) combatSpellStatsSection.classList.add('d-none');
        }

        // Update interactive HP display
        updateCombatHP();

        // Update conditions display
        updateCombatConditions();

        // Update spell slots
        updateCombatSpellSlots();

        // Death saves
        let successCount = 0;
        let failureCount = 0;
        for (let i = 1; i <= 3; i++) {
          if (document.getElementById(`deathSaveSuccess${i}`)?.checked) successCount++;
          if (document.getElementById(`deathSaveFailure${i}`)?.checked) failureCount++;
        }
        const combatDeathSuccess = document.getElementById('combatDeathSuccess');
        const combatDeathFailure = document.getElementById('combatDeathFailure');
        if (combatDeathSuccess) combatDeathSuccess.textContent = successCount;
        if (combatDeathFailure) combatDeathFailure.textContent = failureCount;

        // Exhaustion
        const exhaustion = document.getElementById('exhaustionLevel')?.value || '0';
        const combatExhaustion = document.getElementById('combatExhaustion');
        if (combatExhaustion) combatExhaustion.textContent = exhaustion;

        // Update Actions/Attacks
        updateCombatActions();

        // Update Spells
        updateCombatSpells();
      }

      // Function to update conditions display
      function updateCombatConditions() {
        const conditionsEl = document.getElementById('combatConditions');
        if (!conditionsEl) return;

        // Get active conditions from the condition buttons
        const activeConditions = [];
        document.querySelectorAll('.condition-btn.active').forEach(btn => {
          activeConditions.push(btn.dataset.condition);
        });

        // Also check text input for manual conditions
        const conditionsInput = document.getElementById('charConditions')?.value;
        if (conditionsInput && conditionsInput.trim()) {
          conditionsInput.split(',').forEach(c => {
            const trimmed = c.trim();
            if (trimmed && !activeConditions.includes(trimmed)) {
              activeConditions.push(trimmed);
            }
          });
        }

        if (activeConditions.length === 0) {
          conditionsEl.innerHTML = '<span class="text-muted fst-italic small">None</span>';
          return;
        }

        // Render condition badges
        let html = '';
        const positiveConditions = ['Blessed', 'Inspired', 'Hasted'];
        activeConditions.forEach(condition => {
          const isPositive = positiveConditions.includes(condition);
          // Add clickable class and spell name for Concentrating condition
          let extraClasses = '';
          let displayText = condition;
          if (condition === 'Concentrating') {
            extraClasses = ' clickable-concentration';
            if (window.currentConcentrationSpell) {
              displayText = `Concentrating: ${window.currentConcentrationSpell}`;
            }
          }
          html += `<span class="combat-condition-badge ${isPositive ? 'positive' : ''}${extraClasses}" title="Click to end" data-condition="${condition}">${displayText}</span>`;
        });
        conditionsEl.innerHTML = html;
      }

      // Function to update spell slots display
      function updateCombatSpellSlots() {
        const slotsContainer = document.getElementById('combatSpellSlots');
        const slotsSection = document.getElementById('combatSpellSlotsSection');
        const pactContainer = document.getElementById('combatPactSlots');
        const pactSection = document.getElementById('combatPactSlotsSection');

        if (!slotsContainer) return;

        let hasAnySlots = false;
        let slotsHtml = '';

        // Regular spell slots (levels 1-9)
        for (let level = 1; level <= 9; level++) {
          const maxEl = document.getElementById(`slots${level}Max`);
          const usedEl = document.getElementById(`slots${level}Used`);
          const max = parseInt(maxEl?.value, 10) || 0;
          const used = parseInt(usedEl?.value, 10) || 0;

          if (max > 0) {
            hasAnySlots = true;
            const remaining = Math.max(0, max - used);
            const percentage = (remaining / max) * 100;

            // Color class based on remaining percentage
            let colorClass = 'slots-full';
            if (remaining === 0) colorClass = 'slots-empty';
            else if (percentage <= 25) colorClass = 'slots-low';
            else if (percentage <= 50) colorClass = 'slots-mid';

            slotsHtml += `
              <div class="combat-slot-item" data-level="${level}">
                <div class="combat-slot-level">${level}${level === 1 ? 'st' : level === 2 ? 'nd' : level === 3 ? 'rd' : 'th'}</div>
                <div class="combat-slot-count ${colorClass}">${remaining}/${max}</div>
              </div>
            `;
          }
        }

        if (hasAnySlots) {
          slotsContainer.innerHTML = slotsHtml;
          if (slotsSection) slotsSection.classList.remove('d-none');
        } else {
          if (slotsSection) slotsSection.classList.add('d-none');
        }

        // Pact slots (Warlock)
        const pactMax = parseInt(document.getElementById('pactMax')?.value, 10) || 0;
        const pactUsed = parseInt(document.getElementById('pactUsed')?.value, 10) || 0;
        const pactLevel = parseInt(document.getElementById('pactLevel')?.value, 10) || 1;

        if (pactMax > 0 && pactContainer && pactSection) {
          const pactRemaining = Math.max(0, pactMax - pactUsed);
          const pactPercentage = (pactRemaining / pactMax) * 100;

          // Color class based on remaining percentage
          let pactColorClass = 'slots-full';
          if (pactRemaining === 0) pactColorClass = 'slots-empty';
          else if (pactPercentage <= 25) pactColorClass = 'slots-low';
          else if (pactPercentage <= 50) pactColorClass = 'slots-mid';

          pactContainer.innerHTML = `
            <div class="combat-slot-item" data-level="pact">
              <div class="combat-slot-level">Lvl ${pactLevel}</div>
              <div class="combat-slot-count ${pactColorClass}">${pactRemaining}/${pactMax}</div>
            </div>
          `;
          pactSection.classList.remove('d-none');
        } else if (pactSection) {
          pactSection.classList.add('d-none');
        }
      }

      // Function to render actions/attacks in combat view
      function updateCombatActions() {
        const combatActionsEl = document.getElementById('combatActions');
        if (!combatActionsEl) return;

        // Access the global currentAttackList from character.js
        const attackList = window.currentAttackList || [];

        if (!attackList.length) {
          combatActionsEl.innerHTML = '<div class="text-muted fst-italic">No attacks or actions added.</div>';
          return;
        }

        let html = '';
        attackList.forEach((attack, index) => {
          const attackTypeLabel = {
            'melee-weapon': 'Melee Weapon',
            'ranged-weapon': 'Ranged Weapon',
            'melee-spell': 'Melee Spell',
            'ranged-spell': 'Ranged Spell',
            'save': 'Save DC',
            'other': 'Other'
          }[attack.type] || attack.type;

          html += `<div class="combat-action-item" data-attack-index="${index}">`;
          html += '<div class="d-flex justify-content-between align-items-start">';
          html += '<div class="flex-grow-1">';
          html += `<div class="combat-action-name">${attack.name || 'Unnamed Attack'}</div>`;
          html += `<div class="combat-action-detail">${attackTypeLabel}`;

          if (attack.range) {
            html += ` · ${attack.range}`;
          }

          if (attack.bonus) {
            html += ` · <span class="badge bg-primary bg-opacity-75">${attack.bonus} to hit</span>`;
          }

          if (attack.saveDC) {
            html += ` · <span class="badge bg-warning bg-opacity-75 text-dark">DC ${attack.saveDC}</span>`;
          }

          html += '</div>';

          if (attack.damage) {
            const dmgType = attack.damageType ? ` ${attack.damageType}` : '';
            html += `<div class="combat-action-detail"><strong>Damage:</strong> ${attack.damage}${dmgType}`;

            if (attack.damage2) {
              const dmgType2 = attack.damageType2 ? ` ${attack.damageType2}` : '';
              html += ` + ${attack.damage2}${dmgType2}`;
            }

            html += '</div>';
          }

          if (attack.notes) {
            html += `<div class="combat-action-detail small"><em>${attack.notes}</em></div>`;
          }

          html += '</div>'; // end flex-grow-1

          // Roll buttons - only show if there's a bonus (attack roll) or damage
          if (attack.bonus || attack.damage) {
            html += '<div class="combat-roll-buttons ms-2">';
            if (attack.bonus && attack.type !== 'save') {
              html += `<div class="btn-group btn-group-sm mb-1">
                <button type="button" class="btn btn-outline-primary combat-roll-hit" data-index="${index}" data-type="normal" title="Roll to hit">
                  <i class="bi bi-dice-5"></i> Hit
                </button>
                <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                  <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                  <li><a class="dropdown-item combat-roll-hit" href="#" data-index="${index}" data-type="advantage"><i class="bi bi-caret-up-fill text-success me-1"></i>Advantage</a></li>
                  <li><a class="dropdown-item combat-roll-hit" href="#" data-index="${index}" data-type="disadvantage"><i class="bi bi-caret-down-fill text-danger me-1"></i>Disadvantage</a></li>
                </ul>
              </div>`;
            }
            if (attack.damage) {
              html += `<div class="btn-group btn-group-sm">
                <button type="button" class="btn btn-outline-danger combat-roll-damage" data-index="${index}" data-type="normal" title="Roll damage">
                  <i class="bi bi-fire"></i> Dmg
                </button>
                <button type="button" class="btn btn-outline-danger dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown" aria-expanded="false">
                  <span class="visually-hidden">Toggle Dropdown</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                  <li><a class="dropdown-item combat-roll-damage" href="#" data-index="${index}" data-type="critical"><i class="bi bi-star-fill text-warning me-1"></i>Critical Hit</a></li>
                </ul>
              </div>`;
            }
            html += '</div>';
          }

          html += '</div>'; // end d-flex

          // Inline roll result area
          html += `<div class="combat-roll-result d-none" id="combatRollResult${index}"></div>`;

          html += '</div>'; // end combat-action-item
        });

        combatActionsEl.innerHTML = html;
      }

      // Function to render spells in combat view
      function updateCombatSpells() {
        const combatSpellsEl = document.getElementById('combatSpells');
        const combatSpellsSection = document.getElementById('combatSpellsSection');
        if (!combatSpellsEl || !combatSpellsSection) return;

        // Access the global currentSpellList from character.js
        const spellList = window.currentSpellList || [];

        if (!spellList.length) {
          combatSpellsSection.classList.add('d-none');
          return;
        }

        combatSpellsSection.classList.remove('d-none');

        // Determine if this character uses pact slots instead of regular slots
        const hasPactMagic = (parseInt(document.getElementById('pactMax')?.value, 10) || 0) > 0;

        // Group spells by level
        const spellsByLevel = {};
        spellList.forEach(spell => {
          const level = spell.level ?? 0;
          if (!spellsByLevel[level]) {
            spellsByLevel[level] = [];
          }
          spellsByLevel[level].push(spell);
        });

        let html = '';

        // Sort levels (cantrips first, then 1-9)
        const levels = Object.keys(spellsByLevel).map(Number).sort((a, b) => a - b);

        let spellIndex = 0;
        levels.forEach(level => {
          const levelLabel = level === 0 ? 'Cantrips' : `Level ${level}`;
          const spells = spellsByLevel[level];

          html += `<div class="mb-2"><strong class="text-light">${levelLabel}</strong></div>`;

          spells.forEach(spell => {
            const title = spell.title || spell.name || 'Unknown';
            const prepared = spell.prepared ? '<span class="badge bg-success bg-opacity-75 ms-1" style="font-size: 0.7rem;">Prep</span>' : '';
            const isCantrip = level === 0;

            html += `<div class="combat-spell-item d-flex justify-content-between align-items-start" data-spell-index="${spellIndex}" data-spell-level="${level}">`;
            html += '<div class="flex-grow-1">';
            html += `<div class="combat-spell-name">${title} ${prepared}</div>`;

            const meta = [];
            if (spell.school) meta.push(spell.school);
            if (spell.casting_time) meta.push(`Cast: ${spell.casting_time}`);
            if (spell.range) meta.push(`Range: ${spell.range}`);
            if (spell.concentration) meta.push('Concentration');

            if (meta.length) {
              html += `<div class="combat-spell-meta">${meta.join(' · ')}</div>`;
            }

            html += '</div>';

            // Cast button
            html += `<button type="button" class="btn btn-outline-warning combat-cast-btn ms-2"
              data-spell-index="${spellIndex}"
              data-spell-level="${level}"
              data-spell-name="${title.replace(/"/g, '&quot;')}"
              title="${isCantrip ? 'Cast cantrip' : hasPactMagic ? 'Cast using pact slot' : 'Cast using spell slot'}">
              <i class="bi bi-magic"></i> Cast
            </button>`;

            html += '</div>';
            spellIndex++;
          });
        });

        combatSpellsEl.innerHTML = html;
      }

      // ========================================
      // Interactive HP Functions
      // ========================================

      // Update the combat HP display (called by updateCombatCardView and after HP changes)
      function updateCombatHP() {
        const currentHp = parseInt(document.getElementById('charCurrentHP')?.value, 10) || 0;
        const maxHp = parseInt(document.getElementById('charMaxHP')?.value, 10) || 1;
        const tempHp = parseInt(document.getElementById('charTempHP')?.value, 10) || 0;

        // Update HP values
        const currentEl = document.getElementById('combatCurrentHP');
        const maxEl = document.getElementById('combatMaxHP');
        const tempEl = document.getElementById('combatTempHP');
        const tempDisplay = document.getElementById('combatTempHPDisplay');
        const hpBarFill = document.getElementById('combatHPBarFill');

        if (currentEl) currentEl.textContent = currentHp;
        if (maxEl) maxEl.textContent = maxHp;

        // Show/hide temp HP
        if (tempHp > 0) {
          if (tempEl) tempEl.textContent = tempHp;
          if (tempDisplay) tempDisplay.classList.remove('d-none');
        } else {
          if (tempDisplay) tempDisplay.classList.add('d-none');
        }

        // Update HP bar
        if (hpBarFill) {
          const percentage = Math.max(0, Math.min(100, (currentHp / maxHp) * 100));
          hpBarFill.style.width = percentage + '%';

          // Update color class
          hpBarFill.classList.remove('hp-full', 'hp-mid', 'hp-low');
          if (percentage > 50) {
            hpBarFill.classList.add('hp-full');
          } else if (percentage > 25) {
            hpBarFill.classList.add('hp-mid');
          } else {
            hpBarFill.classList.add('hp-low');
          }
        }
      }

      // Toggle HP controls visibility
      function toggleCombatHPControls(event) {
        event.stopPropagation();
        const controls = document.getElementById('combatHPControls');
        if (controls) {
          controls.classList.toggle('d-none');
        }
      }

      // Close HP controls when clicking outside
      document.addEventListener('click', function(e) {
        const hpBox = document.getElementById('combatHPBox');
        const controls = document.getElementById('combatHPControls');
        if (controls && hpBox && !hpBox.contains(e.target)) {
          controls.classList.add('d-none');
        }
      });

      // Handle HP actions (damage, heal, temp)
      window.handleCombatHP = function(action) {
        event.stopPropagation();

        const currentHpInput = document.getElementById('charCurrentHP');
        const maxHpInput = document.getElementById('charMaxHP');
        const tempHpInput = document.getElementById('charTempHP');

        if (!currentHpInput || !maxHpInput) return;

        const currentHp = parseInt(currentHpInput.value, 10) || 0;
        const maxHp = parseInt(maxHpInput.value, 10) || 1;
        const tempHp = parseInt(tempHpInput?.value, 10) || 0;

        let amount;
        let promptText;

        switch(action) {
          case 'damage':
            promptText = 'Enter damage amount:';
            break;
          case 'heal':
            promptText = 'Enter healing amount:';
            break;
          case 'temp':
            promptText = 'Enter temporary HP amount:';
            break;
          default:
            return;
        }

        amount = parseInt(prompt(promptText), 10);
        if (isNaN(amount) || amount <= 0) return;

        let newCurrentHp = currentHp;
        let newTempHp = tempHp;
        let damageToConcentration = 0;

        if (action === 'damage') {
          damageToConcentration = amount;
          // Temp HP absorbs damage first
          if (newTempHp > 0) {
            if (amount <= newTempHp) {
              newTempHp -= amount;
              amount = 0;
            } else {
              amount -= newTempHp;
              newTempHp = 0;
            }
          }
          newCurrentHp = Math.max(0, newCurrentHp - amount);
        } else if (action === 'heal') {
          newCurrentHp = Math.min(maxHp, newCurrentHp + amount);
          // Reset death saves if HP is now above 0
          if (newCurrentHp > 0 && typeof window.resetDeathSaves === 'function') {
            window.resetDeathSaves();
          }
        } else if (action === 'temp') {
          // Temp HP doesn't stack, take higher value
          newTempHp = Math.max(newTempHp, amount);
        }

        // Update the main form inputs
        currentHpInput.value = newCurrentHp;
        if (tempHpInput) tempHpInput.value = newTempHp;

        // Trigger change event to sync and save
        currentHpInput.dispatchEvent(new Event('input', { bubbles: true }));

        // Update combat HP display
        updateCombatHP();

        // Check for concentration if damaged
        if (action === 'damage' && damageToConcentration > 0) {
          if (typeof window.handleConcentrationCheck === 'function') {
            window.handleConcentrationCheck(damageToConcentration);
            // Update combat conditions display after potential concentration loss
            updateCombatConditions();
          }
        }

        // Save character if the function exists
        if (typeof window.saveCurrentCharacter === 'function') {
          window.saveCurrentCharacter();
        }
      };

      // HP box click handler
      const combatHPBox = document.getElementById('combatHPBox');
      if (combatHPBox) {
        combatHPBox.addEventListener('click', toggleCombatHPControls);
      }

      // ========================================
      // Combat Dice Rolling Functions
      // ========================================

      // Roll a single die
      function rollDie(sides) {
        return Math.floor(Math.random() * sides) + 1;
      }

      // Parse dice notation (e.g., "2d6+3") and roll
      function parseDiceAndRoll(notation, doubleDice = false) {
        if (!notation) return { total: 0, breakdown: '0', rolls: [] };

        const parts = notation.match(/(\d+)d(\d+)([+-]\d+)?/i);
        if (!parts) {
          // Try to parse as just a modifier
          const mod = parseInt(notation, 10);
          if (!isNaN(mod)) {
            return { total: mod, breakdown: String(mod), rolls: [] };
          }
          return { total: 0, breakdown: '0', rolls: [] };
        }

        let numDice = parseInt(parts[1], 10);
        const sides = parseInt(parts[2], 10);
        const modifier = parts[3] ? parseInt(parts[3], 10) : 0;

        // Double dice for critical hits
        if (doubleDice) {
          numDice *= 2;
        }

        const rolls = [];
        let sum = 0;
        for (let i = 0; i < numDice; i++) {
          const roll = rollDie(sides);
          rolls.push(roll);
          sum += roll;
        }

        const total = sum + modifier;
        const modStr = modifier >= 0 ? `+${modifier}` : String(modifier);
        const breakdown = `${numDice}d${sides}${modStr} = [${rolls.join(', ')}]${modStr} = ${total}`;

        return { total, breakdown, rolls, sides, modifier };
      }

      // Roll attack (d20 + bonus)
      function rollCombatAttack(attackIndex, rollType) {
        try {
          const attackList = window.currentAttackList || [];
          const attack = attackList[attackIndex];
          if (!attack || !attack.bonus) return;

          const bonus = parseInt(attack.bonus, 10) || 0;
          let roll1 = rollDie(20);
          let roll2 = rollDie(20);
          let finalRoll, advantage;

          if (rollType === 'advantage') {
            finalRoll = Math.max(roll1, roll2);
            advantage = 'Advantage';
          } else if (rollType === 'disadvantage') {
            finalRoll = Math.min(roll1, roll2);
            advantage = 'Disadvantage';
          } else {
            finalRoll = roll1;
            roll2 = null;
            advantage = null;
          }

          const total = finalRoll + bonus;
          const isCrit = finalRoll === 20;
          const isFumble = finalRoll === 1;

          // Build result display
          let html = '<div class="d-flex align-items-center gap-2">';
          html += `<span class="roll-total ${isCrit ? 'roll-crit' : ''} ${isFumble ? 'roll-fumble' : ''}">${total}</span>`;
          html += '<span class="small text-muted">';
          if (advantage) {
            html += `${advantage}: [${roll1}, ${roll2}] → ${finalRoll}`;
          } else {
            html += `d20: ${finalRoll}`;
          }
          const bonusStr = bonus >= 0 ? `+${bonus}` : String(bonus);
          html += ` ${bonusStr}`;
          if (isCrit) html += ' <span class="badge bg-success">CRIT!</span>';
          if (isFumble) html += ' <span class="badge bg-danger">FUMBLE!</span>';
          html += '</span></div>';

          showInlineRollResult(attackIndex, html);

          // Add to roll history if available
          try {
            if (typeof window.addToRollHistory === 'function') {
              const rollsArray = advantage ? [roll1, roll2] : [finalRoll];
              window.addToRollHistory({
                notation: advantage ? '2d20' : '1d20',
                description: `${attack.name} (${rollType === 'normal' ? 'Attack' : advantage})`,
                rolls: rollsArray,
                chosen: finalRoll,
                modifier: bonus,
                total: total,
                timestamp: new Date().toISOString(),
                isCritical: isCrit,
                isFumble: isFumble,
                isAdvantage: rollType === 'advantage',
                isDisadvantage: rollType === 'disadvantage'
              });
            }
          } catch (e) { /* ignore history errors */ }

          // Show toast
          try {
            if (typeof window.showRollToast === 'function') {
              window.showRollToast(`${attack.name} Attack`, total, isCrit ? 'Critical!' : isFumble ? 'Fumble!' : null);
            }
          } catch (e) { /* ignore toast errors */ }
        } catch (err) {
          console.error('Error rolling attack:', err);
        }
      }

      // Roll damage
      function rollCombatDamage(attackIndex, rollType) {
        try {
          const attackList = window.currentAttackList || [];
          const attack = attackList[attackIndex];
          if (!attack || !attack.damage) return;

          const isCrit = rollType === 'critical';
          const result1 = parseDiceAndRoll(attack.damage, isCrit);
          let total = result1.total;
          let breakdown = result1.breakdown;

          // Handle secondary damage
          if (attack.damage2) {
            const result2 = parseDiceAndRoll(attack.damage2, isCrit);
            total += result2.total;
            breakdown += ` + ${result2.breakdown}`;
          }

          // Build result display
          const dmgType = attack.damageType || '';
          let html = '<div class="d-flex align-items-center gap-2">';
          html += `<span class="roll-total text-danger">${total}</span>`;
          html += `<span class="small text-muted">${breakdown}`;
          if (dmgType) html += ` ${dmgType}`;
          if (isCrit) html += ' <span class="badge bg-warning text-dark">CRIT!</span>';
          html += '</span></div>';

          showInlineRollResult(attackIndex, html);

          // Add to roll history
          try {
            if (typeof window.addToRollHistory === 'function') {
              window.addToRollHistory({
                notation: attack.damage + (isCrit ? ' (crit)' : ''),
                description: `${attack.name} Damage${isCrit ? ' (Crit)' : ''}`,
                rolls: allRolls,
                modifier: mod,
                total: total,
                timestamp: new Date().toISOString(),
                isCritical: false,
                isFumble: false
              });
            }
          } catch (e) { /* ignore history errors */ }

          // Show toast
          try {
            if (typeof window.showRollToast === 'function') {
              window.showRollToast(`${attack.name} Damage`, total, isCrit ? 'Critical!' : null);
            }
          } catch (e) { /* ignore toast errors */ }
        } catch (err) {
          console.error('Error rolling damage:', err);
        }
      }

      // Show inline roll result
      function showInlineRollResult(attackIndex, html) {
        const resultEl = document.getElementById(`combatRollResult${attackIndex}`);
        if (resultEl) {
          resultEl.innerHTML = html;
          resultEl.classList.remove('d-none');

          // Auto-hide after 10 seconds
          setTimeout(() => {
            resultEl.classList.add('d-none');
          }, 10000);
        }
      }

      // Roll saving throw from combat view
      function rollCombatSave(ability) {
        try {
          const saveBonus = document.getElementById(`save${ability}Bonus`)?.value || '0';
          const bonus = parseInt(saveBonus, 10) || 0;

          const roll = rollDie(20);
          const total = roll + bonus;
          const isCrit = roll === 20;
          const isFumble = roll === 1;

          const bonusStr = bonus >= 0 ? `+${bonus}` : String(bonus);
          const abilityName = {
            'Str': 'Strength', 'Dex': 'Dexterity', 'Con': 'Constitution',
            'Int': 'Intelligence', 'Wis': 'Wisdom', 'Cha': 'Charisma'
          }[ability] || ability;

          // Try to add to roll history (optional)
          try {
            if (typeof window.addToRollHistory === 'function') {
              window.addToRollHistory({
                notation: '1d20',
                description: `${abilityName} Save`,
                rolls: [roll],
                modifier: bonus,
                total: total,
                timestamp: new Date().toISOString(),
                isCritical: isCrit,
                isFumble: isFumble
              });
            }
          } catch (e) { /* ignore history errors */ }

          // Try to show toast, fallback to alert
          let toastShown = false;
          try {
            if (typeof window.showRollToast === 'function') {
              let extra = null;
              if (isCrit) extra = 'Natural 20!';
              if (isFumble) extra = 'Natural 1!';
              window.showRollToast(`${abilityName} Save`, total, extra);
              toastShown = true;
            }
          } catch (e) { /* ignore toast errors */ }

          if (!toastShown) {
            let result = `${abilityName} Save: ${total}\n(d20: ${roll} ${bonusStr})`;
            if (isCrit) result += '\nNatural 20!';
            if (isFumble) result += '\nNatural 1!';
            alert(result);
          }

          // Update the save box to show the result briefly
          const saveBox = document.getElementById(`combatSave${ability}Box`);
          if (saveBox) {
            const valueEl = saveBox.querySelector('.combat-save-value');
            const originalText = valueEl?.textContent;
            if (valueEl) {
              valueEl.innerHTML = `<span class="${isCrit ? 'text-success' : isFumble ? 'text-danger' : ''}">${total}</span>`;
              setTimeout(() => {
                valueEl.textContent = originalText;
              }, 2000);
            }
          }
        } catch (err) {
          console.error('Error rolling save:', err);
          alert('Error rolling save. Check console for details.');
        }
      }

      // Roll ability check from combat view (uses modifier only, not save proficiency)
      function rollCombatAbilityCheck(ability) {
        try {
          const modValue = document.getElementById(`mod${ability}`)?.value || '0';
          const modifier = parseInt(modValue, 10) || 0;

          const roll = rollDie(20);
          const total = roll + modifier;
          const isCrit = roll === 20;
          const isFumble = roll === 1;

          const modStr = modifier >= 0 ? `+${modifier}` : String(modifier);
          const abilityName = {
            'Str': 'Strength', 'Dex': 'Dexterity', 'Con': 'Constitution',
            'Int': 'Intelligence', 'Wis': 'Wisdom', 'Cha': 'Charisma'
          }[ability] || ability;

          // Try to add to roll history (optional)
          try {
            if (typeof window.addToRollHistory === 'function') {
              window.addToRollHistory({
                notation: '1d20',
                description: `${abilityName} Check`,
                rolls: [roll],
                modifier: modifier,
                total: total,
                timestamp: new Date().toISOString(),
                isCritical: isCrit,
                isFumble: isFumble
              });
            }
          } catch (e) { /* ignore history errors */ }

          // Try to show toast, fallback to alert
          let toastShown = false;
          try {
            if (typeof window.showRollToast === 'function') {
              let extra = null;
              if (isCrit) extra = 'Natural 20!';
              if (isFumble) extra = 'Natural 1!';
              window.showRollToast(`${abilityName} Check`, total, extra);
              toastShown = true;
            }
          } catch (e) { /* ignore toast errors */ }

          if (!toastShown) {
            let result = `${abilityName} Check: ${total}\n(d20: ${roll} ${modStr})`;
            if (isCrit) result += '\nNatural 20!';
            if (isFumble) result += '\nNatural 1!';
            alert(result);
          }

          // Update the ability box to show the result briefly
          const abilityBox = document.querySelector(`.combat-ability-box[data-ability="${ability}"]`);
          if (abilityBox) {
            const modEl = abilityBox.querySelector('.combat-ability-mod');
            const originalText = modEl?.textContent;
            if (modEl) {
              modEl.innerHTML = `<span class="${isCrit ? 'text-success' : isFumble ? 'text-danger' : ''}">${total}</span>`;
              setTimeout(() => {
                modEl.textContent = originalText;
              }, 2000);
            }
          }
        } catch (err) {
          console.error('Error rolling ability check:', err);
          alert('Error rolling ability check. Check console for details.');
        }
      }

      // Roll initiative from combat view
      function rollCombatInitiative() {
        try {
          // Get initiative modifier (usually DEX mod, but could have other bonuses)
          const initModEl = document.getElementById('charInitMod');
          const dexModEl = document.getElementById('modDex');

          // Use charInitMod if available, otherwise use DEX mod
          let bonus = 0;
          if (initModEl && initModEl.value) {
            bonus = parseInt(initModEl.value, 10) || 0;
          } else if (dexModEl) {
            bonus = parseInt(dexModEl.value, 10) || 0;
          }

          const roll = rollDie(20);
          const total = roll + bonus;
          const isCrit = roll === 20;
          const isFumble = roll === 1;

          const bonusStr = bonus >= 0 ? `+${bonus}` : String(bonus);

          // Try to add to roll history (optional)
          try {
            if (typeof window.addToRollHistory === 'function') {
              window.addToRollHistory({
                notation: '1d20',
                description: 'Initiative',
                rolls: [roll],
                modifier: bonus,
                total: total,
                timestamp: new Date().toISOString(),
                isCritical: isCrit,
                isFumble: isFumble
              });
            }
          } catch (e) { /* ignore history errors */ }

          // Try to show toast, fallback to alert
          let toastShown = false;
          try {
            if (typeof window.showRollToast === 'function') {
              let extra = null;
              if (isCrit) extra = 'Natural 20!';
              if (isFumble) extra = 'Natural 1!';
              window.showRollToast('Initiative', total, extra);
              toastShown = true;
            }
          } catch (e) { /* ignore toast errors */ }

          if (!toastShown) {
            let result = `Initiative: ${total}\n(d20: ${roll} ${bonusStr})`;
            if (isCrit) result += '\nNatural 20!';
            if (isFumble) result += '\nNatural 1!';
            alert(result);
          }

          // Update the initiative box to show the result briefly
          const initBox = document.getElementById('combatInitiativeBox');
          if (initBox) {
            const valueEl = initBox.querySelector('.combat-stat-value');
            const originalText = valueEl?.textContent;
            if (valueEl) {
              valueEl.innerHTML = `<span class="${isCrit ? 'text-success' : isFumble ? 'text-danger' : 'text-warning'}">${total}</span>`;
              setTimeout(() => {
                valueEl.textContent = originalText;
              }, 3000);
            }
          }
        } catch (err) {
          console.error('Error rolling initiative:', err);
          alert('Error rolling initiative. Check console for details.');
        }
      }

      // Initiative box click handler
      const combatInitBox = document.getElementById('combatInitiativeBox');
      if (combatInitBox) {
        combatInitBox.addEventListener('click', rollCombatInitiative);
      }

      // Event delegation for combat roll buttons
      const combatActionsEl = document.getElementById('combatActions');
      if (combatActionsEl) {
        combatActionsEl.addEventListener('click', function(e) {
          const hitBtn = e.target.closest('.combat-roll-hit');
          const dmgBtn = e.target.closest('.combat-roll-damage');

          if (hitBtn) {
            e.preventDefault();
            const index = parseInt(hitBtn.dataset.index, 10);
            const type = hitBtn.dataset.type || 'normal';
            rollCombatAttack(index, type);
          }

          if (dmgBtn) {
            e.preventDefault();
            const index = parseInt(dmgBtn.dataset.index, 10);
            const type = dmgBtn.dataset.type || 'normal';
            rollCombatDamage(index, type);
          }
        });
      }

      // Event delegation for save boxes (using grid container)
      const combatSavesGrid = document.getElementById('combatSavesGrid');
      if (combatSavesGrid) {
        combatSavesGrid.addEventListener('click', function(e) {
          try {
            const saveBox = e.target.closest('.combat-save-box');
            if (saveBox) {
              const ability = saveBox.dataset.ability;
              if (ability) {
                rollCombatSave(ability);
              }
            }
          } catch (err) {
            console.error('Error in save box click:', err);
          }
        });
      } else {
        console.warn('combatSavesGrid not found');
      }

      // Event delegation for ability check boxes (using grid container)
      const combatAbilityGrid = document.getElementById('combatAbilityGrid');
      if (combatAbilityGrid) {
        combatAbilityGrid.addEventListener('click', function(e) {
          try {
            const abilityBox = e.target.closest('.combat-ability-box');
            if (abilityBox) {
              const ability = abilityBox.dataset.ability;
              if (ability) {
                rollCombatAbilityCheck(ability);
              }
            }
          } catch (err) {
            console.error('Error in ability check box click:', err);
          }
        });
      } else {
        console.warn('combatAbilityGrid not found');
      }

      // ========================================
      // Dice History Modal Functions
      // ========================================

      // Render dice history in modal
      function renderDiceHistoryModal() {
        const listEl = document.getElementById('diceHistoryModalList');
        if (!listEl) return;

        // Access the global roll history from character.js
        const history = window.rollHistory || [];

        if (!history.length) {
          listEl.innerHTML = '<div class="p-4 text-center text-muted"><i class="bi bi-dice-5 fs-1 mb-2 d-block opacity-50"></i>No dice rolls yet.<br>Roll some dice to see history here!</div>';
          return;
        }

        let html = '';
        // Show newest first
        [...history].reverse().forEach((roll, index) => {
          const isCrit = roll.isCrit || roll.details?.includes('CRIT');
          const isFumble = roll.isFumble || roll.details?.includes('FUMBLE');

          let badgeClass = 'bg-secondary';
          if (isCrit) badgeClass = 'crit';
          if (isFumble) badgeClass = 'fumble';

          // Format timestamp
          let timeStr = '';
          if (roll.timestamp) {
            const date = new Date(roll.timestamp);
            timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          }

          // Icon based on roll type
          let icon = 'bi-dice-5';
          if (roll.type === 'attack') icon = 'bi-crosshair';
          if (roll.type === 'damage') icon = 'bi-fire';
          if (roll.type === 'save') icon = 'bi-shield-check';
          if (roll.type === 'skill') icon = 'bi-person-check';

          html += `
            <div class="dice-history-item d-flex align-items-center gap-3">
              <div class="roll-badge rounded d-flex align-items-center justify-content-center ${badgeClass}">
                ${roll.total || roll.result || '?'}
              </div>
              <div class="flex-grow-1">
                <div class="fw-bold"><i class="bi ${icon} me-1 text-muted"></i>${roll.label || roll.type || 'Roll'}</div>
                <div class="small text-muted">${roll.details || ''}</div>
              </div>
              <div class="small text-muted">${timeStr}</div>
            </div>
          `;
        });

        listEl.innerHTML = html;
      }

      // Render on modal open
      const diceHistoryModal = document.getElementById('diceHistoryModal');
      if (diceHistoryModal) {
        diceHistoryModal.addEventListener('show.bs.modal', renderDiceHistoryModal);
      }

      // Clear history button
      const clearHistoryBtn = document.getElementById('clearDiceHistoryModalBtn');
      if (clearHistoryBtn) {
        clearHistoryBtn.addEventListener('click', function() {
          if (confirm('Clear all dice roll history?')) {
            if (window.rollHistory) {
              window.rollHistory.length = 0;
            }
            // Also clear the existing roll history display if it exists
            if (typeof window.renderRollHistory === 'function') {
              window.renderRollHistory();
            }
            renderDiceHistoryModal();
          }
        });
      }

      // ========================================
      // Spell Casting Functions
      // ========================================

      // Get spell slot status for a level
      function getPactSlotStatus() {
        const pactMax  = parseInt(document.getElementById('pactMax')?.value,  10) || 0;
        const pactUsed = parseInt(document.getElementById('pactUsed')?.value, 10) || 0;
        const pactLevel = parseInt(document.getElementById('pactLevel')?.value, 10) || 1;
        const remaining = Math.max(0, pactMax - pactUsed);
        const percentage = pactMax > 0 ? (remaining / pactMax) * 100 : 0;
        return { max: pactMax, used: pactUsed, remaining, percentage, pactLevel, isCantrip: false, isPact: true };
      }

      function getSpellSlotStatus(level) {
        if (level === 0) return { max: 0, used: 0, remaining: Infinity, percentage: 100, isCantrip: true };

        const maxEl = document.getElementById(`slots${level}Max`);
        const usedEl = document.getElementById(`slots${level}Used`);
        const max = parseInt(maxEl?.value, 10) || 0;
        const used = parseInt(usedEl?.value, 10) || 0;
        const remaining = Math.max(0, max - used);
        const percentage = max > 0 ? (remaining / max) * 100 : 0;

        // No regular slots at this level — fall back to pact slots (Warlock / pact magic)
        if (max === 0) {
          const pact = getPactSlotStatus();
          if (pact.max > 0) return pact;
        }

        return { max, used, remaining, percentage, isCantrip: false, isPact: false };
      }

      // Use a spell slot from combat view
      function useSpellSlotFromCombat(level) {
        if (level === 0) return true; // Cantrips don't use slots

        const maxEl  = document.getElementById(`slots${level}Max`);
        const usedEl = document.getElementById(`slots${level}Used`);
        const max  = parseInt(maxEl?.value,  10) || 0;
        const used = parseInt(usedEl?.value, 10) || 0;

        // No regular slots — try pact slots
        if (max === 0) {
          const pactMaxEl  = document.getElementById('pactMax');
          const pactUsedEl = document.getElementById('pactUsed');
          const pactMax  = parseInt(pactMaxEl?.value,  10) || 0;
          const pactUsed = parseInt(pactUsedEl?.value, 10) || 0;

          if (pactMax === 0 || !pactMaxEl || !pactUsedEl) {
            alert(`No spell slots or pact slots remaining!`);
            return false;
          }
          if (pactUsed >= pactMax) {
            alert(`No pact slots remaining!`);
            return false;
          }

          pactUsedEl.value = pactUsed + 1;
          pactUsedEl.dispatchEvent(new Event('input', { bubbles: true }));
          updateCombatSpellSlots();
          if (typeof window.saveCurrentCharacter === 'function') window.saveCurrentCharacter();
          return true;
        }

        // Regular slot
        if (used >= max) {
          alert(`No level ${level} spell slots remaining!`);
          return false;
        }

        usedEl.value = used + 1;
        usedEl.dispatchEvent(new Event('input', { bubbles: true }));
        updateCombatSpellSlots();
        if (typeof window.saveCurrentCharacter === 'function') window.saveCurrentCharacter();
        return true;
      }

      // Cast spell handler
      function castSpell(spellIndex, spellLevel, spellName) {
        const level = parseInt(spellLevel, 10);
        const status = getSpellSlotStatus(level);

        // Get the spell from the global spell list to check concentration
        const spellList = window.currentSpellList || [];
        const spell = spellList[spellIndex];
        const requiresConcentration = spell?.concentration || false;

        // Check if already concentrating on a different spell
        if (requiresConcentration && typeof window.isConcentrating === 'function' && window.isConcentrating()) {
          const currentSpell = window.currentConcentrationSpell || 'another spell';
          const proceed = confirm(
            `You are currently concentrating on ${currentSpell}.\n\n` +
            `Casting ${spellName} will end your concentration on ${currentSpell}.\n\n` +
            `Continue?`
          );
          if (!proceed) return;
        }

        // Cantrip - just show feedback
        if (status.isCantrip) {
          showCastFeedback(spellIndex, `Cast ${spellName}!`, 'success');
          return;
        }

        const slotLabel = status.isPact ? `pact slot (lvl ${status.pactLevel})` : `level ${level} slot`;

        // No slots available
        if (status.remaining === 0) {
          alert(`No ${slotLabel}s remaining!\n\nYou have used all ${status.max}.`);
          return;
        }

        // Last slot warning
        if (status.remaining === 1) {
          const proceed = confirm(`This is your last ${slotLabel}!\n\nCast ${spellName}?`);
          if (!proceed) return;
        }

        // Use the slot
        if (useSpellSlotFromCombat(level)) {
          const newStatus = getSpellSlotStatus(level);
          let feedbackMsg = `Cast ${spellName}! (${newStatus.remaining}/${newStatus.max} ${status.isPact ? 'pact slots' : 'slots'} left)`;

          // Handle concentration
          if (requiresConcentration && typeof window.setConcentration === 'function') {
            window.setConcentration(true, spellName);
            feedbackMsg += ' [Concentrating]';
            // Update combat conditions display
            updateCombatConditions();
          }

          showCastFeedback(spellIndex, feedbackMsg, 'success');
        }
      }

      // Show visual feedback for casting
      function showCastFeedback(spellIndex, message, type) {
        // Find the spell item
        const spellItem = document.querySelector(`[data-spell-index="${spellIndex}"]`);
        if (!spellItem) return;

        // Create feedback element
        const feedback = document.createElement('div');
        feedback.className = `combat-cast-feedback alert alert-${type === 'success' ? 'success' : 'warning'} py-1 px-2 mb-0 mt-1`;
        feedback.style.fontSize = '0.75rem';
        feedback.innerHTML = `<i class="bi bi-check-circle me-1"></i>${message}`;

        // Remove any existing feedback
        const existing = spellItem.querySelector('.combat-cast-feedback');
        if (existing) existing.remove();

        spellItem.appendChild(feedback);

        // Auto-remove after 3 seconds
        setTimeout(() => {
          feedback.remove();
        }, 3000);
      }

      // Event delegation for spell casting
      const combatSpellsEl = document.getElementById('combatSpells');
      if (combatSpellsEl) {
        combatSpellsEl.addEventListener('click', function(e) {
          const castBtn = e.target.closest('.combat-cast-btn');
          if (castBtn) {
            e.preventDefault();
            const spellIndex = castBtn.dataset.spellIndex;
            const spellLevel = castBtn.dataset.spellLevel;
            const spellName = castBtn.dataset.spellName;
            castSpell(spellIndex, spellLevel, spellName);
          }
        });
      }

      // Event delegation for clicking Concentrating badge to end concentration
      const combatConditionsEl = document.getElementById('combatConditions');
      if (combatConditionsEl) {
        combatConditionsEl.addEventListener('click', function(e) {
          const badge = e.target.closest('.clickable-concentration');
          if (badge) {
            e.preventDefault();
            const spellName = window.currentConcentrationSpell || 'your spell';
            if (confirm(`End concentration on ${spellName}?`)) {
              if (typeof window.setConcentration === 'function') {
                window.setConcentration(false);
              }
              updateCombatConditions();
            }
          }
        });
      }

      // Roll death save from combat view
      function rollCombatDeathSave() {
        try {
          const roll = Math.floor(Math.random() * 20) + 1;
          let resultType = '';
          let resultMsg = '';

          // Get current counts
          let successCount = 0;
          let failureCount = 0;
          for (let i = 1; i <= 3; i++) {
            if (document.getElementById(`deathSaveSuccess${i}`)?.checked) successCount++;
            if (document.getElementById(`deathSaveFailure${i}`)?.checked) failureCount++;
          }

          if (roll === 20) {
            // Critical success: regain 1 HP and become conscious
            resultType = 'crit-success';
            resultMsg = `Natural 20! You regain 1 HP and become conscious!`;
            // Clear all death saves
            for (let i = 1; i <= 3; i++) {
              const successEl = document.getElementById(`deathSaveSuccess${i}`);
              const failureEl = document.getElementById(`deathSaveFailure${i}`);
              if (successEl) successEl.checked = false;
              if (failureEl) failureEl.checked = false;
            }
            // Set HP to 1
            const currentHPEl = document.getElementById('charCurrentHP');
            if (currentHPEl && (parseInt(currentHPEl.value) || 0) <= 0) {
              currentHPEl.value = 1;
              currentHPEl.dispatchEvent(new Event('input', { bubbles: true }));
            }
          } else if (roll === 1) {
            // Critical failure: 2 failures
            resultType = 'crit-fail';
            const newFailures = Math.min(failureCount + 2, 3);
            for (let i = 1; i <= newFailures; i++) {
              const el = document.getElementById(`deathSaveFailure${i}`);
              if (el) el.checked = true;
            }
            if (newFailures >= 3) {
              resultMsg = `Natural 1! Two failures - you have died!`;
            } else {
              resultMsg = `Natural 1! Two failures marked (${newFailures}/3)`;
            }
          } else if (roll >= 10) {
            // Success
            resultType = 'success';
            const newSuccesses = Math.min(successCount + 1, 3);
            for (let i = 1; i <= newSuccesses; i++) {
              const el = document.getElementById(`deathSaveSuccess${i}`);
              if (el) el.checked = true;
            }
            if (newSuccesses >= 3) {
              resultMsg = `Rolled ${roll} - Success! You are now stable!`;
              const stableEl = document.getElementById('deathSaveStable');
              if (stableEl) stableEl.checked = true;
            } else {
              resultMsg = `Rolled ${roll} - Success (${newSuccesses}/3)`;
            }
          } else {
            // Failure
            resultType = 'fail';
            const newFailures = Math.min(failureCount + 1, 3);
            for (let i = 1; i <= newFailures; i++) {
              const el = document.getElementById(`deathSaveFailure${i}`);
              if (el) el.checked = true;
            }
            if (newFailures >= 3) {
              resultMsg = `Rolled ${roll} - Failure. You have died!`;
            } else {
              resultMsg = `Rolled ${roll} - Failure (${newFailures}/3)`;
            }
          }

          // Show toast and add to history
          if (typeof window.addToRollHistory === 'function') {
            window.addToRollHistory({
              notation: '1d20',
              description: 'Death Save',
              rolls: [roll],
              modifier: 0,
              total: roll,
              timestamp: new Date().toISOString(),
              isCritical: roll === 20,
              isFumble: roll === 1
            });
          }
          if (typeof window.showRollToast === 'function') {
            window.showRollToast('Death Save', roll, resultMsg);
          }

          // Alert with result
          alert(`Death Saving Throw: ${roll}\n\n${resultMsg}`);

          // Trigger input events on checkboxes to ensure change is detected
          for (let i = 1; i <= 3; i++) {
            const successEl = document.getElementById(`deathSaveSuccess${i}`);
            const failureEl = document.getElementById(`deathSaveFailure${i}`);
            if (successEl) successEl.dispatchEvent(new Event('change', { bubbles: true }));
            if (failureEl) failureEl.dispatchEvent(new Event('change', { bubbles: true }));
          }

          // Update combat view display
          updateCombatCardView();

          // Save character
          if (typeof saveCurrentCharacter === 'function') {
            saveCurrentCharacter();
          }
        } catch (err) {
          console.error('Error rolling death save:', err);
          const roll = Math.floor(Math.random() * 20) + 1;
          alert(`Death Save: ${roll}\n${roll >= 10 ? 'Success!' : 'Failure!'}`);
        }
      }

      // Roll hit dice from combat view
      function rollCombatHitDice() {
        try {
          const hdRemaining = document.getElementById('charHitDiceRemaining')?.value.trim() || '0d0';
          const match = hdRemaining.match(/(\d+)d(\d+)/i);

          if (!match) {
            alert('No hit dice remaining information found.');
            return;
          }

          const availableCount = parseInt(match[1], 10);
          const dieSize = parseInt(match[2], 10);

          if (availableCount <= 0) {
            alert('No hit dice remaining! Take a long rest to recover hit dice.');
            return;
          }

          // Ask how many to roll
          const countStr = prompt(`You have ${availableCount}d${dieSize} hit dice remaining.\n\nHow many hit dice do you want to spend? (1-${availableCount})`, '1');
          if (countStr === null) return;

          const count = parseInt(countStr, 10);
          if (isNaN(count) || count < 1 || count > availableCount) {
            alert(`Please enter a number between 1 and ${availableCount}.`);
            return;
          }

          // Get CON modifier
          const conScore = parseInt(document.getElementById('statCon')?.value, 10) || 10;
          const conMod = Math.floor((conScore - 10) / 2);

          // Roll the dice
          let total = 0;
          const rolls = [];
          for (let i = 0; i < count; i++) {
            const roll = Math.floor(Math.random() * dieSize) + 1;
            rolls.push(roll);
            total += roll + conMod;
          }

          // Minimum 1 HP per hit die spent
          total = Math.max(total, count);

          // Apply healing
          const currentHPEl = document.getElementById('charCurrentHP');
          const maxHPEl = document.getElementById('charMaxHP');
          const curHP = parseInt(currentHPEl?.value, 10) || 0;
          const maxHP = parseInt(maxHPEl?.value, 10) || 1;

          const newHP = Math.min(curHP + total, maxHP);
          const actualHealing = newHP - curHP;

          if (currentHPEl) {
            currentHPEl.value = newHP;
            currentHPEl.dispatchEvent(new Event('input', { bubbles: true }));
          }

          // Reset death saves if HP is now above 0
          if (newHP > 0 && typeof window.resetDeathSaves === 'function') {
            window.resetDeathSaves();
          }

          // Update hit dice remaining
          const newRemaining = availableCount - count;
          const hdRemainingEl = document.getElementById('charHitDiceRemaining');
          if (hdRemainingEl) {
            hdRemainingEl.value = `${newRemaining}d${dieSize}`;
            hdRemainingEl.dispatchEvent(new Event('input', { bubbles: true }));
          }

          // Build result message
          const rollsStr = rolls.join(' + ');
          const conModStr = conMod >= 0 ? `+${conMod}` : conMod;
          const resultMsg = `Rolled ${count}d${dieSize}: [${rollsStr}] ${conModStr}/die = ${total} HP\nHealed ${actualHealing} HP (${curHP} → ${newHP})`;

          // Show toast and add to history
          if (typeof window.addToRollHistory === 'function') {
            window.addToRollHistory({
              notation: `${count}d${dieSize}+${conMod * count}`,
              description: `Hit Dice (Healed ${actualHealing} HP)`,
              rolls: rolls,
              modifier: conMod * count,
              total: total,
              timestamp: new Date().toISOString(),
              isCritical: false,
              isFumble: false
            });
          }
          if (typeof window.showRollToast === 'function') {
            window.showRollToast(`Hit Dice`, total, `+${actualHealing} HP`);
          }

          alert(`Hit Dice Roll:\n\n${resultMsg}\n\nHit dice remaining: ${newRemaining}d${dieSize}`);

          // Update combat view
          updateCombatCardView();

          // Save character
          if (typeof saveCurrentCharacter === 'function') {
            saveCurrentCharacter();
          }
        } catch (err) {
          console.error('Error rolling hit dice:', err);
          alert('Error rolling hit dice. Please try from the main character sheet.');
        }
      }

      // Event listeners for death save and hit dice buttons
      const deathSaveBtn = document.getElementById('combatDeathSaveBtn');
      if (deathSaveBtn) {
        deathSaveBtn.addEventListener('click', rollCombatDeathSave);
      }

      const hitDiceBtn = document.getElementById('combatHitDiceBtn');
      if (hitDiceBtn) {
        hitDiceBtn.addEventListener('click', rollCombatHitDice);
      }

      // Toggle combat mode
      function toggleCombatMode() {
        const isChecked = dmCombatModeToggle.checked;

        if (isChecked) {
          // Update the combat card with latest data before showing
          updateCombatCardView();
          document.body.classList.add('combat-mode');
          localStorage.setItem('dmCombatMode', 'true');
        } else {
          document.body.classList.remove('combat-mode');
          localStorage.setItem('dmCombatMode', 'false');
        }
      }

      // Event listener for toggle
      if (dmCombatModeToggle) {
        dmCombatModeToggle.addEventListener('change', toggleCombatMode);

        // Restore saved state on page load - but wait for character data to load first
        const savedMode = localStorage.getItem('dmCombatMode');
        if (savedMode === 'true') {
          dmCombatModeToggle.checked = true;
          // Add the combat-mode class immediately for visual state
          document.body.classList.add('combat-mode');
          // But delay the data update until character data is ready
          // Wait for DOMContentLoaded + a bit more for character.js to load data
          if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
              setTimeout(updateCombatCardView, 500);
            });
          } else {
            // DOM already loaded, just wait for character data
            setTimeout(updateCombatCardView, 500);
          }
        }
      }

      // Also update combat view when character is changed/loaded
      // We'll hook into the existing character select change event
      const characterSelect = document.getElementById('characterSelect');
      if (characterSelect) {
        characterSelect.addEventListener('change', function() {
          // Wait a bit for the character data to load
          setTimeout(function() {
            if (dmCombatModeToggle && dmCombatModeToggle.checked) {
              updateCombatCardView();
            }
          }, 200);
        });
      }

      // Listen for custom event from character.js when character is loaded
      document.addEventListener('characterLoaded', function() {
        if (dmCombatModeToggle && dmCombatModeToggle.checked) {
          updateCombatCardView();
        }
      });

      // Listen for concentration changes to update combat view conditions
      document.addEventListener('concentrationChanged', function() {
        if (dmCombatModeToggle && dmCombatModeToggle.checked) {
          updateCombatConditions();
        }
      });

      // Update combat view when any input changes (if in combat mode)
      document.addEventListener('input', function(e) {
        if (dmCombatModeToggle && dmCombatModeToggle.checked) {
          // Debounce updates
          clearTimeout(window.combatViewUpdateTimer);
          window.combatViewUpdateTimer = setTimeout(updateCombatCardView, 300);
        }
      });
    })();
  </script>
  <!-- XP Adjustment Modal -->
  <div class="modal fade" id="xpAdjustModal" tabindex="-1" aria-labelledby="xpAdjustModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content bg-dark border-secondary">
        <div class="modal-header border-secondary py-2">
          <h6 class="modal-title text-warning" id="xpAdjustModalLabel">
            <i class="bi bi-star-fill me-1"></i>Adjust XP
          </h6>
          <button type="button" class="btn-close btn-close-white btn-sm" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body py-2">
          <div class="text-center mb-2 small">
            <span class="text-muted">Current: </span>
            <span id="xpModalCurrent" class="text-warning fw-bold"></span>
            <br>
            <span id="xpModalNextLabel" class="text-muted"></span>
          </div>
          <input type="number"
                 id="xpAdjustAmount"
                 class="form-control form-control-sm bg-dark text-light border-secondary text-center"
                 placeholder="Amount"
                 min="0" />
        </div>
        <div class="modal-footer border-secondary py-1 d-flex gap-2">
          <button type="button" class="btn btn-sm btn-success flex-fill" id="xpAddBtn">
            <i class="bi bi-plus-circle me-1"></i>Add XP
          </button>
          <button type="button" class="btn btn-sm btn-danger flex-fill" id="xpSubtractBtn">
            <i class="bi bi-dash-circle me-1"></i>Subtract
          </button>
        </div>
      </div>
    </div>
  </div>

  <script data-goatcounter="https://maybeme1990.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>
