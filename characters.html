<!DOCTYPE html> 
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Characters</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <link href="/css/characters-mobile.css" rel="stylesheet" />
  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/site.js"></script>

  <style>
    .bgimage{
      background: url('images/BGMap.png') no-repeat center center fixed;
      background-size: cover;
    }
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn {
      border-left: 5px solid #1d9e6d !important;
      color: #f8f9fa !important;
      font-weight: bold;
    }
    #saveHistorySelect { min-width: 200px; }

    .backdrop {
      background: rgba(0, 0, 0, 0.65);
      border-radius: 0.5rem;
      padding: 1rem;
    }

    .portrait-frame {
      overflow: hidden;
      position: relative;
      border-radius: 0.5rem;
      border: 1px solid rgba(255,255,255,0.15);
      background-color: rgba(15,15,15,0.9);
    }

    .portrait-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      user-select: none;
      -webkit-user-drag: none;
      max-width: none;
      max-height: none;
      min-width: 100%;
      min-height: 100%;
    }

    .skill-table th,
    .skill-table td {
      padding: 0.25rem 0.4rem;
      vertical-align: middle;
    }

    .skill-table input[type="number"] {
      max-width: 3.5rem;
    }

    .save-pill {
      border-radius: 0.5rem;
      border: 1px solid rgba(255,255,255,0.2);
      padding: 0.5rem 0.6rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }

    .save-pill .save-pill-top {
      display: flex;
      align-items: center;
      gap: 0.4rem;
      width: 100%;
      justify-content: center;
    }

    .save-pill label {
      margin-bottom: 0;
      min-width: 35px;
      font-weight: bold;
    }

    .save-pill input[type="number"] {
      max-width: 3.5rem;
      min-width: 3.5rem;
    }

    .save-pill .btn-group {
      width: 100%;
    }

    .save-pill .btn-group button {
      flex: 1;
    }

    /* Combat/DM View Styles */
    .combat-card-view {
      max-width: 400px;
      margin: 0 auto;
      background: rgba(0, 0, 0, 0.85);
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }

    .combat-portrait-frame {
      width: 100%;
      aspect-ratio: 3 / 4;
      overflow: hidden;
      position: relative;
      border-radius: 0.75rem;
      border: 2px solid rgba(255, 255, 255, 0.2);
      background-color: rgba(15, 15, 15, 0.9);
      margin-bottom: 1rem;
    }

    .combat-portrait-image {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(1);
      transform-origin: center center;
      user-select: none;
      -webkit-user-drag: none;
      max-width: none;
      max-height: none;
      min-width: 100%;
      min-height: 100%;
    }

    .combat-info-line {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      font-size: 0.95rem;
    }

    .combat-info-line:last-child {
      border-bottom: none;
    }

    .combat-info-label {
      font-weight: bold;
      color: #adb5bd;
      min-width: 120px;
    }

    .combat-info-value {
      color: #f8f9fa;
      text-align: right;
      flex-grow: 1;
    }

    .combat-stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin: 1rem 0;
    }

    .combat-stat-box {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 0.5rem;
      padding: 0.75rem;
      text-align: center;
    }

    .combat-stat-label {
      font-size: 0.75rem;
      color: #adb5bd;
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .combat-stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: #f8f9fa;
    }

    .combat-section-title {
      font-size: 1rem;
      font-weight: bold;
      color: #f8f9fa;
      margin-top: 1rem;
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 2px solid rgba(255, 255, 255, 0.2);
    }

    .combat-action-item {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 0.5rem;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .combat-action-name {
      font-weight: bold;
      color: #f8f9fa;
      margin-bottom: 0.25rem;
    }

    .combat-action-detail {
      color: #adb5bd;
      font-size: 0.875rem;
      margin-bottom: 0.25rem;
    }

    .combat-spell-item {
      background: rgba(139, 92, 246, 0.1);
      border: 1px solid rgba(139, 92, 246, 0.3);
      border-radius: 0.5rem;
      padding: 0.5rem 0.75rem;
      margin-bottom: 0.5rem;
    }

    .combat-spell-name {
      font-weight: bold;
      color: #c4b5fd;
    }

    .combat-spell-meta {
      color: #adb5bd;
      font-size: 0.75rem;
    }

    /* Hide full sheet when in combat mode */
    body.combat-mode #fullCharacterSheet {
      display: none;
    }

    body.combat-mode #combatCardView {
      display: block;
    }

    body:not(.combat-mode) #combatCardView {
      display: none;
    }
  </style>
</head>
<body class="bgimage">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Combat
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="index.html">Initiative Tracker</a></li>
              <li><a class="dropdown-item" href="battlemap.html">Battle Map</a></li>
              <li><a class="dropdown-item" href="encounterbuilder.html">Encounter Builder</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Generators
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="name.html">Name Generator</a></li>
              <li><a class="dropdown-item" href="loot.html">Loot Generator</a></li>
              <li><a class="dropdown-item" href="shop.html">Shop Generator</a></li>
              <li><a class="dropdown-item" href="npc.html">NPC Generator</a></li>
              <li><a class="dropdown-item" href="tav.html">Tavern/Inn Generator</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Campaign
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item active" aria-current="page" href="characters.html">Characters</a></li>
              <li><a class="dropdown-item" href="journal.html">Journal</a></li>
            </ul>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="content pt-4">
    <div class="container-fluid mt-5 pt-3">
      <div class="container backdrop text-light">
        <!-- Header + Character Selector / Actions -->
        <div class="d-flex flex-column flex-md-row align-items-md-center mb-3 gap-3">
          <div>
            <h2 class="mb-0">Character Manager</h2>
            <small class="text-muted">DM-focused character sheets with portraits, saved locally in your browser.</small>
          </div>

          <div class="ms-md-auto w-100 w-md-auto d-flex flex-column flex-lg-row gap-2 align-items-stretch align-items-lg-center mt-3 mt-md-0">
            <div class="d-flex flex-column flex-lg-row gap-2 align-items-stretch align-items-lg-center flex-grow-1">
              <select id="characterSelect" class="form-select" aria-label="Select Character">
                <!-- Populated by JS -->
              </select>

              <div class="btn-group flex-wrap" role="group" aria-label="Character actions">
                <button type="button" class="btn btn-sm btn-outline-light" id="newCharacterBtn">
                  <i class="bi bi-person-plus me-1"></i>New
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="saveCharacterBtn">
                  <i class="bi bi-save me-1"></i>Save
                </button>
                <button type="button" class="btn btn-sm btn-outline-light" id="deleteCharacterBtn">
                  <i class="bi bi-trash me-1"></i>Delete
                </button>
              </div>
            </div>

            <div class="d-flex flex-wrap gap-2 justify-content-start justify-content-lg-end">
              <!-- Print/Export Character Sheet Dropdown -->
              <div class="btn-group" role="group">
                <button type="button" class="btn btn-sm btn-outline-light dropdown-toggle" id="printExportDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Print or export character sheet">
                  <i class="bi bi-printer me-1"></i>Print/Export Sheet
                </button>
                <ul class="dropdown-menu dropdown-menu-dark" aria-labelledby="printExportDropdown">
                  <li><a class="dropdown-item" href="#" id="printSheetBtn"><i class="bi bi-printer me-2"></i>Print Character Sheet</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item" href="#" id="exportPdfBtn"><i class="bi bi-file-pdf me-2"></i>Export as PDF</a></li>
                  <li><a class="dropdown-item" href="#" id="exportPngBtn"><i class="bi bi-file-image me-2"></i>Export as PNG Image</a></li>
                  <li><a class="dropdown-item" href="#" id="exportWordBtn"><i class="bi bi-file-word me-2"></i>Export as Word (.docx)</a></li>
                </ul>
              </div>

              <button type="button" class="btn btn-sm btn-outline-info" id="exportCharacterBtn" title="Export current character as JSON">
                <i class="bi bi-download me-1"></i>Export
              </button>
              <button type="button" class="btn btn-sm btn-outline-warning" id="sendToTrackerBtn" title="Send current character to the Initiative Tracker">
                <i class="bi bi-arrow-right-circle me-1"></i>Send to Initiative Tracker
              </button>
              <button type="button" class="btn btn-sm btn-outline-success" id="sendToBattleMapBtn" title="Send current character as a token to the Battle Map">
                <i class="bi bi-geo-alt-fill me-1"></i>Send to Battle Map
              </button>
              <button type="button" class="btn btn-sm btn-outline-info" id="exportAllCharactersBtn" title="Export all characters as JSON">
                <i class="bi bi-archive me-1"></i>Export All
              </button>
              <button type="button" class="btn btn-sm btn-primary" id="helpBtn" title="View help and guide" data-bs-toggle="modal" data-bs-target="#helpModal">
                <i class="bi bi-question-circle me-1"></i>Help
              </button>

              <div class="position-relative">
                <input type="file" id="importFileInput" accept="application/json" class="d-none" />
                <button type="button" class="btn btn-sm btn-outline-warning" id="importCharacterBtn" title="Import character JSON">
                  <i class="bi bi-upload me-1"></i>Import
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Last updated & Storage Info -->
        <div class="mb-3 d-flex justify-content-between align-items-center flex-wrap gap-2">
          <div class="d-flex align-items-center gap-3">
            <small id="lastUpdatedText" class="text-muted"></small>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" role="switch" id="dmCombatModeToggle" title="Toggle DM/Combat View">
              <label class="form-check-label text-light" for="dmCombatModeToggle">
                <i class="bi bi-lightning-charge me-1"></i>Combat View
              </label>
            </div>
          </div>
          <small id="storageUsageText" class="text-muted">
            <i class="bi bi-database me-1"></i>
            <span id="storageUsageValue">Calculating...</span>
          </small>
        </div>

        <!-- Main layout -->
        <div id="fullCharacterSheet" class="row g-3">
          <!-- LEFT COLUMN -->
          <div class="col-12 col-lg-8">
            <!-- Basic Identity -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseBasicInfo" aria-expanded="true" aria-controls="collapseBasicInfo" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Basic Information</strong>
              </div>
              <div class="collapse show" id="collapseBasicInfo">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="charName" class="form-label">Character Name</label>
                    <input type="text" id="charName" class="form-control form-control-sm" placeholder="Valen Khorath" />
                  </div>
                  <div class="col-md-6">
                    <label for="playerName" class="form-label">Player Name</label>
                    <input type="text" id="playerName" class="form-control form-control-sm" placeholder="Player / seat" />
                  </div>

                  <div class="col-md-3">
                    <label for="charRace" class="form-label">Race / Ancestry</label>
                    <input type="text" id="charRace" class="form-control form-control-sm" placeholder="Tiefling, Human, Owlin..." />
                  </div>
                  <div class="col-md-3">
                    <label for="charClass" class="form-label">
                      Class / Subclass
                      <button type="button" class="btn btn-sm btn-outline-info ms-2" id="manageMulticlassBtn" style="padding: 0 6px; font-size: 0.7rem;">
                        <i class="bi bi-diagram-3"></i> Multiclass
                      </button>
                    </label>
                    <input type="text" id="charClass" class="form-control form-control-sm" placeholder="Wizard (Evocation)..." />
                    <small class="text-muted">For multiclass: Wizard / Fighter</small>
                  </div>
                  <div class="col-md-3">
                    <label for="charBackground" class="form-label">Background</label>
                    <input type="text" id="charBackground" class="form-control form-control-sm" placeholder="Acolyte, Criminal, Sage..." />
                  </div>
                  <div class="col-md-2">
                    <label for="charLevel" class="form-label">Level</label>
                    <input type="number" min="1" max="20" id="charLevel" class="form-control form-control-sm" />
                  </div>
                  <div class="col-md-1">
                    <label for="charAlignment" class="form-label">Alignment</label>
                    <input type="text" id="charAlignment" class="form-control form-control-sm" placeholder="NG" />
                  </div>

                  <div class="col-md-12">
                    <label for="charRoleNotes" class="form-label">Party Role / DM Notes</label>
                    <textarea id="charRoleNotes" rows="2" class="form-control form-control-sm"
                              placeholder="Tank, face, skill monkey, spell slot battery, chaos gremlin... plus any quick reminders for you as DM."></textarea>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Resources & Rest -->
                         <!-- Combat Snapshot -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseCombat" aria-expanded="true" aria-controls="collapseCombat" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Combat Snapshot</strong>
              </div>
              <div class="collapse show" id="collapseCombat">
              <div class="card-body">
                <div class="row g-2 mb-2">
                  <div class="col-4 col-md-2">
                    <label for="charAC" class="form-label small">AC</label>
                    <input type="number"
                           id="charAC"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                  <div class="col-4 col-md-3">
                    <label for="charMaxHP" class="form-label small">Max HP</label>
                    <input type="number"
                           id="charMaxHP"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                  <div class="col-4 col-md-3">
                    <label for="charCurrentHP" class="form-label small">Current HP</label>
                    <input type="number"
                           id="charCurrentHP"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="charTempHP" class="form-label small">Temp HP</label>
                    <input type="number"
                           id="charTempHP"
                           class="form-control form-control-sm text-center"
                           min="0" />
                  </div>
                </div>

                <!-- HP Adjustment Buttons -->
                <div class="row g-2 mb-2">
                  <div class="col-12">
                    <div class="btn-group w-100" role="group" aria-label="HP adjustments">
                      <button type="button" class="btn btn-sm btn-success" data-hp-adjust="heal">
                        <i class="bi bi-plus-circle"></i> Heal
                      </button>
                      <button type="button" class="btn btn-sm btn-danger" data-hp-adjust="damage">
                        <i class="bi bi-dash-circle"></i> Damage
                      </button>
                      <button type="button" class="btn btn-sm btn-info" data-hp-adjust="temp">
                        <i class="bi bi-shield-plus"></i> Temp HP
                      </button>
                      <button type="button" class="btn btn-sm btn-warning" data-hp-adjust="max">
                        <i class="bi bi-arrow-up"></i> Max
                      </button>
                    </div>
                  </div>
                </div>

                <div class="row g-2 mb-2">
                  <div class="col-6 col-md-4">
                    <label for="charSpeed" class="form-label small">Speed</label>
                    <input type="text"
                           id="charSpeed"
                           class="form-control form-control-sm"
                           placeholder="30 ft, 40 ft fly..." />
                  </div>
                  <div class="col-6 col-md-4">
                    <label for="charInitMod" class="form-label small">Initiative Mod</label>
                    <div class="input-group input-group-sm">
                      <input type="number"
                             id="charInitMod"
                             class="form-control form-control-sm text-center"
                             placeholder="0" />
                      <button type="button"
                              class="btn btn-outline-light"
                              id="rollInitiativeBtn"
                              title="Roll Initiative">
                        <i class="bi bi-dice-5"></i>
                      </button>
                    </div>
                  </div>
                  <div class="col-12 col-md-4">
                    <label for="charConditions" class="form-label small">Active Conditions</label>
                    <input type="text"
                           id="charConditions"
                           class="form-control form-control-sm"
                           placeholder="Blessed, Hexed, etc." />
                  </div>
                </div>

                <!-- Inspiration & Concentration -->
                <div class="row g-2">
                  <div class="col-6 col-md-4">
                    <div class="form-check form-switch">
                      <input class="form-check-input" type="checkbox" id="charInspiration" />
                      <label class="form-check-label small" for="charInspiration">
                        <i class="bi bi-star-fill text-warning"></i> Inspiration
                      </label>
                    </div>
                  </div>
                  <div class="col-6 col-md-8">
                    <div class="d-flex align-items-center gap-2">
                      <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="charConcentrating" />
                        <label class="form-check-label small" for="charConcentrating">
                          <i class="bi bi-lightning-fill text-info"></i> Concentrating
                        </label>
                      </div>
                      <input type="text"
                             id="charConcentrationSpell"
                             class="form-control form-control-sm"
                             placeholder="Spell name"
                             style="max-width: 150px;" />
                    </div>
                  </div>
                </div>

                <!-- Condition Toggles -->
                <div class="mt-3">
                  <label class="form-label small">Quick Conditions</label>
                  <div class="d-flex flex-wrap gap-1" id="conditionToggles">
                    <!-- Common D&D 5e conditions -->
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Blinded">Blinded</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Charmed">Charmed</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Deafened">Deafened</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Frightened">Frightened</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Grappled">Grappled</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Incapacitated">Incapacitated</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Invisible">Invisible</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Paralyzed">Paralyzed</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Petrified">Petrified</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Poisoned">Poisoned</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Prone">Prone</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Restrained">Restrained</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Stunned">Stunned</button>
                    <button type="button" class="btn btn-sm btn-outline-secondary condition-btn" data-condition="Unconscious">Unconscious</button>
                    <button type="button" class="btn btn-sm btn-outline-info condition-btn" data-condition="Concentrating">Concentrating</button>
                    <button type="button" class="btn btn-sm btn-outline-success condition-btn" data-condition="Blessed">Blessed</button>
                    <button type="button" class="btn btn-sm btn-outline-warning condition-btn" data-condition="Hexed">Hexed</button>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Currency -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseCurrency" aria-expanded="true" aria-controls="collapseCurrency" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Currency</strong>
              </div>
              <div class="collapse show" id="collapseCurrency">
              <div class="card-body">
                <div class="row g-2">
                  <div class="col">
                    <label for="currencyCP" class="form-label small">CP</label>
                    <input type="number" id="currencyCP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencySP" class="form-label small">SP</label>
                    <input type="number" id="currencySP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencyEP" class="form-label small">EP</label>
                    <input type="number" id="currencyEP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencyGP" class="form-label small">GP</label>
                    <input type="number" id="currencyGP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                  <div class="col">
                    <label for="currencyPP" class="form-label small">PP</label>
                    <input type="number" id="currencyPP" class="form-control form-control-sm text-center" min="0" placeholder="0" />
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Death Saves & Exhaustion -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseDeathSaves" aria-expanded="false" aria-controls="collapseDeathSaves" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Death Saves & Exhaustion</strong>
              </div>
              <div class="collapse" id="collapseDeathSaves">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-12 col-md-6">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                      <label class="form-label small mb-0">Death Saves</label>
                      <button type="button" class="btn btn-sm btn-danger" id="rollDeathSaveBtn">
                        <i class="bi bi-dice-5"></i> Roll Death Save
                      </button>
                    </div>
                    <div class="d-flex flex-column gap-2">
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-success small" style="min-width: 70px;">Successes:</span>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveSuccess1" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveSuccess2" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveSuccess3" />
                        </div>
                      </div>
                      <div class="d-flex align-items-center gap-2">
                        <span class="text-danger small" style="min-width: 70px;">Failures:</span>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveFailure1" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveFailure2" />
                        </div>
                        <div class="form-check form-check-inline mb-0">
                          <input class="form-check-input" type="checkbox" id="deathSaveFailure3" />
                        </div>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="deathSaveStable" />
                        <label class="form-check-label small" for="deathSaveStable">Stable</label>
                      </div>
                    </div>
                  </div>
                  <div class="col-12 col-md-6">
                    <label for="exhaustionLevel" class="form-label small">Exhaustion Level</label>
                    <input type="number" id="exhaustionLevel" class="form-control form-control-sm" min="0" max="10" placeholder="0" />
                    <small class="text-muted d-block mt-1">
                      <span id="exhaustionDescription">0 = No exhaustion</span>
                    </small>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <div class="card bg-dark border-secondary mb-3" id="section-resources">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseResources" aria-expanded="true" aria-controls="collapseResources" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Resources &amp; Rests</strong>
              </div>
              <div class="collapse show" id="collapseResources">
              <div class="card-body">
                <!-- Rest Buttons -->
                <div class="d-flex justify-content-end gap-2 mb-3">
                  <button type="button" class="btn btn-sm btn-outline-light" id="shortRestBtn">
                    <i class="bi bi-moon"></i> Short Rest
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-success" id="longRestBtn">
                    <i class="bi bi-moon-stars"></i> Long Rest
                  </button>
                </div>
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label for="charHitDice" class="form-label small">Hit Dice</label>
                    <input type="text"
                           id="charHitDice"
                           class="form-control form-control-sm"
                           placeholder="e.g. 5d10" />
                  </div>
                  <div class="col-6">
                    <label for="charHitDiceRemaining" class="form-label small">Hit Dice Remaining</label>
                    <input type="text"
                           id="charHitDiceRemaining"
                           class="form-control form-control-sm"
                           placeholder="e.g. 3d10" />
                  </div>
                </div>
              
                <label class="form-label small">Tracked Resources</label>
                <div class="small text-muted mb-1">
                  Use for rages, ki points, superiority dice, Channel Divinity, etc.
                </div>
              
                <!-- Three generic resource rows -->
                <div class="mb-2">
                  <div class="row g-1 align-items-center mb-1">
                    <div class="col-6">
                      <input type="text"
                             id="res1Name"
                             class="form-control form-control-sm"
                             placeholder="Resource name" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res1Current"
                             class="form-control form-control-sm text-center"
                             placeholder="Now" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res1Max"
                             class="form-control form-control-sm text-center"
                             placeholder="Max" />
                    </div>
                  </div>
                </div>
              
                <div class="mb-2">
                  <div class="row g-1 align-items-center mb-1">
                    <div class="col-6">
                      <input type="text"
                             id="res2Name"
                             class="form-control form-control-sm"
                             placeholder="Resource name" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res2Current"
                             class="form-control form-control-sm text-center"
                             placeholder="Now" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res2Max"
                             class="form-control form-control-sm text-center"
                             placeholder="Max" />
                    </div>
                  </div>
                </div>
              
                <div class="mb-2">
                  <div class="row g-1 align-items-center mb-1">
                    <div class="col-6">
                      <input type="text"
                             id="res3Name"
                             class="form-control form-control-sm"
                             placeholder="Resource name" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res3Current"
                             class="form-control form-control-sm text-center"
                             placeholder="Now" />
                    </div>
                    <div class="col-3">
                      <input type="number"
                             id="res3Max"
                             class="form-control form-control-sm text-center"
                             placeholder="Max" />
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Ability Scores + Modifiers -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseAbilities" aria-expanded="true" aria-controls="collapseAbilities" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Ability Scores & Modifiers</strong>
              </div>
              <div class="collapse show" id="collapseAbilities">
              <div class="card-body">
                <div class="row g-3 text-center">
                  <!-- STR -->
                  <div class="col-6 col-md-2">
                    <label for="statStr" class="form-label">STR</label>
                    <input type="number"
                           id="statStr"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modStr"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <!-- DEX -->
                  <div class="col-6 col-md-2">
                    <label for="statDex" class="form-label">DEX</label>
                    <input type="number"
                           id="statDex"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modDex"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <!-- CON -->
                  <div class="col-6 col-md-2">
                    <label for="statCon" class="form-label">CON</label>
                    <input type="number"
                           id="statCon"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modCon"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <!-- INT -->
                  <div class="col-6 col-md-2">
                    <label for="statInt" class="form-label">INT</label>
                    <input type="number"
                           id="statInt"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modInt"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <!-- WIS -->
                  <div class="col-6 col-md-2">
                    <label for="statWis" class="form-label">WIS</label>
                    <input type="number"
                           id="statWis"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modWis"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <!-- CHA -->
                  <div class="col-6 col-md-2">
                    <label for="statCha" class="form-label">CHA</label>
                    <input type="number"
                           id="statCha"
                           class="form-control form-control-sm text-center mb-1"
                           placeholder="Score" />
                    <input type="number"
                           id="modCha"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Checks and Saves -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseSaves" aria-expanded="true" aria-controls="collapseSaves" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Checks and Saves</strong>
                <small class="text-muted">Shift+Click = Advantage, Ctrl+Click = Disadvantage</small>
              </div>
              <div class="collapse show" id="collapseSaves">
              <div class="card-body">
                <div class="row g-2">
                  <!-- STR save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveStrProf" />
                        </div>
                        <label for="saveStrBonus" class="fw-bold small">STR</label>
                        <input type="number" id="saveStrBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="str" data-roll-type="advantage" title="Roll STR save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="str" data-roll-type="normal" title="Roll STR save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="str" data-roll-type="disadvantage" title="Roll STR save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- DEX save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveDexProf" />
                        </div>
                        <label for="saveDexBonus" class="fw-bold small">DEX</label>
                        <input type="number" id="saveDexBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="dex" data-roll-type="advantage" title="Roll DEX save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="dex" data-roll-type="normal" title="Roll DEX save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="dex" data-roll-type="disadvantage" title="Roll DEX save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- CON save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveConProf" />
                        </div>
                        <label for="saveConBonus" class="fw-bold small">CON</label>
                        <input type="number" id="saveConBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="con" data-roll-type="advantage" title="Roll CON save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="con" data-roll-type="normal" title="Roll CON save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="con" data-roll-type="disadvantage" title="Roll CON save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- INT save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveIntProf" />
                        </div>
                        <label for="saveIntBonus" class="fw-bold small">INT</label>
                        <input type="number" id="saveIntBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="int" data-roll-type="advantage" title="Roll INT save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="int" data-roll-type="normal" title="Roll INT save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="int" data-roll-type="disadvantage" title="Roll INT save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- WIS save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveWisProf" />
                        </div>
                        <label for="saveWisBonus" class="fw-bold small">WIS</label>
                        <input type="number" id="saveWisBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="wis" data-roll-type="advantage" title="Roll WIS save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="wis" data-roll-type="normal" title="Roll WIS save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="wis" data-roll-type="disadvantage" title="Roll WIS save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                  <!-- CHA save -->
                  <div class="col-6 col-md-4 col-lg-2">
                    <div class="save-pill">
                      <div class="save-pill-top">
                        <div class="form-check mb-0">
                          <input class="form-check-input" type="checkbox" id="saveChaProf" />
                        </div>
                        <label for="saveChaBonus" class="fw-bold small">CHA</label>
                        <input type="number" id="saveChaBonus" class="form-control form-control-sm text-center" placeholder="0" />
                      </div>
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-success p-0 px-1" data-save-roll="cha" data-roll-type="advantage" title="Roll CHA save with Advantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-outline-light p-0 px-1" data-save-roll="cha" data-roll-type="normal" title="Roll CHA save">
                          <i class="bi bi-dice-5"></i>
                        </button>
                        <button type="button" class="btn btn-danger p-0 px-1" data-save-roll="cha" data-roll-type="disadvantage" title="Roll CHA save with Disadvantage">
                          <i class="bi bi-dice-5"></i>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="mt-3">
                  <label for="saveNotes" class="form-label">Saving Throw Notes</label>
                  <textarea id="saveNotes" rows="2" class="form-control form-control-sm"
                            placeholder="e.g. Advantage vs frightened, resistance to fire, etc."></textarea>
                </div>
              </div>
              </div>
            </div>

            <!-- Skills -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseSkills" aria-expanded="true" aria-controls="collapseSkills" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Skills</strong>
                <small class="text-muted">Exp = Expertise (2 Prof) | Shift/Ctrl for Adv/Dis</small>
              </div>
              <div class="collapse show" id="collapseSkills">
              <div class="card-body">
                <div class="table-responsive">
                  <table class="table table-sm table-dark table-striped align-middle mb-2 skill-table">
                    <thead>
                      <tr class="text-muted small">
                        <th scope="col" style="width:2rem;">Prof</th>
                        <th scope="col" style="width:2rem;">Exp</th>
                        <th scope="col" style="width:3rem;">Mod</th>
                        <th scope="col">Skill</th>
                        <th scope="col" style="width:4rem;" class="text-center">Bonus</th>
                        <th scope="col" style="width:3rem;"></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillAcrobaticsProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillAcrobaticsExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>DEX</td>
                        <td>Acr<span class="d-none d-md-inline">obatics</span></td>
                        <td class="text-center">
                          <input type="number" id="skillAcrobaticsBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="acrobatics" data-roll-type="advantage" title="Roll Acrobatics with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="acrobatics" data-roll-type="normal" title="Roll Acrobatics">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="acrobatics" data-roll-type="disadvantage" title="Roll Acrobatics with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillAnimalHandlingProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillAnimalHandlingExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Animal Handling</td>
                        <td class="text-center">
                          <input type="number" id="skillAnimalHandlingBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="animalHandling" data-roll-type="advantage" title="Roll Animal Handling with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="animalHandling" data-roll-type="normal" title="Roll Animal Handling">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="animalHandling" data-roll-type="disadvantage" title="Roll Animal Handling with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillArcanaProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillArcanaExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Arcana</td>
                        <td class="text-center">
                          <input type="number" id="skillArcanaBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="arcana" data-roll-type="advantage" title="Roll Arcana with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="arcana" data-roll-type="normal" title="Roll Arcana">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="arcana" data-roll-type="disadvantage" title="Roll Arcana with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillAthleticsProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillAthleticsExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>STR</td>
                        <td>Athletics</td>
                        <td class="text-center">
                          <input type="number" id="skillAthleticsBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="athletics" data-roll-type="advantage" title="Roll Athletics with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="athletics" data-roll-type="normal" title="Roll Athletics">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="athletics" data-roll-type="disadvantage" title="Roll Athletics with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillDeceptionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillDeceptionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Deception</td>
                        <td class="text-center">
                          <input type="number" id="skillDeceptionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="deception" data-roll-type="advantage" title="Roll Deception with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="deception" data-roll-type="normal" title="Roll Deception">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="deception" data-roll-type="disadvantage" title="Roll Deception with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillHistoryProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillHistoryExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>History</td>
                        <td class="text-center">
                          <input type="number" id="skillHistoryBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="history" data-roll-type="advantage" title="Roll History with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="history" data-roll-type="normal" title="Roll History">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="history" data-roll-type="disadvantage" title="Roll History with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillInsightProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillInsightExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Insight</td>
                        <td class="text-center">
                          <input type="number" id="skillInsightBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="insight" data-roll-type="advantage" title="Roll Insight with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="insight" data-roll-type="normal" title="Roll Insight">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="insight" data-roll-type="disadvantage" title="Roll Insight with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillIntimidationProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillIntimidationExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Intimidation</td>
                        <td class="text-center">
                          <input type="number" id="skillIntimidationBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="intimidation" data-roll-type="advantage" title="Roll Intimidation with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="intimidation" data-roll-type="normal" title="Roll Intimidation">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="intimidation" data-roll-type="disadvantage" title="Roll Intimidation with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillInvestigationProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillInvestigationExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Investigation</td>
                        <td class="text-center">
                          <input type="number" id="skillInvestigationBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="investigation" data-roll-type="advantage" title="Roll Investigation with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="investigation" data-roll-type="normal" title="Roll Investigation">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="investigation" data-roll-type="disadvantage" title="Roll Investigation with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillMedicineProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillMedicineExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Medicine</td>
                        <td class="text-center">
                          <input type="number" id="skillMedicineBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="medicine" data-roll-type="advantage" title="Roll Medicine with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="medicine" data-roll-type="normal" title="Roll Medicine">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="medicine" data-roll-type="disadvantage" title="Roll Medicine with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillNatureProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillNatureExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Nature</td>
                        <td class="text-center">
                          <input type="number" id="skillNatureBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="nature" data-roll-type="advantage" title="Roll Nature with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="nature" data-roll-type="normal" title="Roll Nature">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="nature" data-roll-type="disadvantage" title="Roll Nature with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerceptionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerceptionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Perception</td>
                        <td class="text-center">
                          <input type="number" id="skillPerceptionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="perception" data-roll-type="advantage" title="Roll Perception with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="perception" data-roll-type="normal" title="Roll Perception">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="perception" data-roll-type="disadvantage" title="Roll Perception with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerformanceProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillPerformanceExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Performance</td>
                        <td class="text-center">
                          <input type="number" id="skillPerformanceBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="performance" data-roll-type="advantage" title="Roll Performance with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="performance" data-roll-type="normal" title="Roll Performance">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="performance" data-roll-type="disadvantage" title="Roll Performance with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillPersuasionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillPersuasionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>CHA</td>
                        <td>Persuasion</td>
                        <td class="text-center">
                          <input type="number" id="skillPersuasionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="persuasion" data-roll-type="advantage" title="Roll Persuasion with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="persuasion" data-roll-type="normal" title="Roll Persuasion">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="persuasion" data-roll-type="disadvantage" title="Roll Persuasion with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillReligionProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillReligionExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>INT</td>
                        <td>Religion</td>
                        <td class="text-center">
                          <input type="number" id="skillReligionBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="religion" data-roll-type="advantage" title="Roll Religion with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="religion" data-roll-type="normal" title="Roll Religion">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="religion" data-roll-type="disadvantage" title="Roll Religion with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillSleightOfHandProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillSleightOfHandExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>DEX</td>
                        <td>Sleight of Hand</td>
                        <td class="text-center">
                          <input type="number" id="skillSleightOfHandBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="sleightOfHand" data-roll-type="advantage" title="Roll Sleight of Hand with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="sleightOfHand" data-roll-type="normal" title="Roll Sleight of Hand">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="sleightOfHand" data-roll-type="disadvantage" title="Roll Sleight of Hand with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillStealthProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillStealthExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>DEX</td>
                        <td>Stealth</td>
                        <td class="text-center">
                          <input type="number" id="skillStealthBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="stealth" data-roll-type="advantage" title="Roll Stealth with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="stealth" data-roll-type="normal" title="Roll Stealth">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="stealth" data-roll-type="disadvantage" title="Roll Stealth with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td class="text-center">
                          <input type="checkbox" id="skillSurvivalProf" class="form-check-input" />
                        </td>
                        <td class="text-center">
                          <input type="checkbox" id="skillSurvivalExp" class="form-check-input" title="Expertise (double proficiency)" />
                        </td>
                        <td>WIS</td>
                        <td>Survival</td>
                        <td class="text-center">
                          <input type="number" id="skillSurvivalBonus" class="form-control form-control-sm text-center" />
                        </td>
                        <td class="text-center">
                          <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-success" data-skill-roll="survival" data-roll-type="advantage" title="Roll Survival with Advantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" data-skill-roll="survival" data-roll-type="normal" title="Roll Survival">
                              <i class="bi bi-dice-5"></i>
                            </button>
                            <button type="button" class="btn btn-danger" data-skill-roll="survival" data-roll-type="disadvantage" title="Roll Survival with Disadvantage">
                              <i class="bi bi-dice-5"></i>
                            </button>
                          </div>
                        </td>
                      </tr>

                    </tbody>
                  </table>
                </div>
                <label for="skillsNotes" class="form-label">Additional Skills / Expertise Notes</label>
                <textarea id="skillsNotes" rows="2" class="form-control form-control-sm"
                          placeholder="Expertise, jack-of-all-trades, custom skills, etc."></textarea>
              </div>
              </div>
            </div>
          </div>

          <!-- RIGHT COLUMN -->
          <div class="col-12 col-lg-4">
            <!-- Roll History Panel (Sticky) -->
            <div class="card bg-dark border-secondary mb-3 sticky-top" id="rollHistoryPanel" style="top: 70px;">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center" id="rollHistoryHeader" style="cursor: pointer;">
                <strong><i class="bi bi-dice-5 me-1"></i>Roll History</strong>
                <div>
                  <button type="button" class="btn btn-sm btn-outline-danger" id="clearHistoryBtn">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
              <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                <div id="rollHistoryList">
                  <!-- Populated by JS -->
                </div>
              </div>
            </div>

            <!-- Portrait (preview only, edits via modal) -->
            <div class="card bg-dark border-secondary mb-3">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapsePortrait" aria-expanded="false" aria-controls="collapsePortrait" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Character Portrait</strong>
              </div>
              <div class="collapse" id="collapsePortrait">
              <div class="card-body">
                <div id="portraitContainer"
                     class="portrait-frame mb-3"
                     style="height: 320px;">
                  <img id="portraitPreview"
                       class="portrait-image d-none"
                       alt="Character portrait preview" />
                  <span id="portraitPlaceholderText" class="text-muted position-absolute top-50 start-50 translate-middle text-center">
                    No portrait selected
                  </span>
                </div>

                <div class="mb-2">
                  <label for="portraitFile" class="form-label">Upload Portrait Image</label>
                  <input type="file" id="portraitFile" class="form-control form-control-sm" accept="image/*" />
                  <small class="text-muted">Stored as base64 in your browsers local storage.</small>
                </div>

                <div class="mb-2">
                  <label for="portraitUrl" class="form-label">Or Use Image URL</label>
                  <div class="input-group input-group-sm">
                    <span class="input-group-text"><i class="bi bi-link-45deg"></i></span>
                    <input type="url" id="portraitUrl" class="form-control" placeholder="https://example.com/image.png" />
                    <button class="btn btn-outline-light" type="button" id="applyPortraitUrlBtn">Use URL</button>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button type="button" class="btn btn-sm btn-outline-light" id="editPortraitBtn">
                    <i class="bi bi-crop me-1"></i>Edit Portrait Framing
                  </button>
                  <button type="button" class="btn btn-sm btn-outline-danger ms-auto" id="clearPortraitBtn">
                    <i class="bi bi-x-circle me-1"></i>Clear Portrait
                  </button>
                </div>
              </div>
              </div>
            </div>

            <!-- Senses -->
            <div class="card bg-dark border-secondary mb-3" id="section-extras">
              <div class="card-header border-secondary d-flex justify-content-between align-items-center collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseSenses" aria-expanded="true" aria-controls="collapseSenses" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Senses</strong>
                <div class="small text-muted" onclick="event.stopPropagation();">
                  Prof. Bonus: <span id="charProficiencyBonusDisplay">+2</span>
                </div>
              </div>
              <div class="collapse show" id="collapseSenses">
              <div class="card-body">
                <div class="row g-3">
                  <div class="col-4">
                    <label for="charPassivePerception" class="form-label small">Passive Perception</label>
                    <input type="number"
                           id="charPassivePerception"
                           class="form-control form-control-sm text-center"
                           placeholder="Auto"
                           readonly />
                  </div>
                  <div class="col-4">
                    <label for="charPassiveInvestigation" class="form-label small">Passive Investigation</label>
                    <input type="number"
                           id="charPassiveInvestigation"
                           class="form-control form-control-sm text-center" />
                  </div>
                  <div class="col-4">
                    <label for="charPassiveInsight" class="form-label small">Passive Insight</label>
                    <input type="number"
                           id="charPassiveInsight"
                           class="form-control form-control-sm text-center" />
                  </div>
                
                  <div class="col-12">
                    <label for="sensesNotes" class="form-label">Additional Sense Types</label>
                    <textarea id="sensesNotes" rows="2" class="form-control form-control-sm"
                              placeholder="Darkvision, tremorsense, blindsight, truesight, special perception rules, etc."></textarea>
                  </div>
                </div>
              </div>
              </div>
            </div>

            <!-- Detailed Notes with DDB-style tabs -->
            <div class="card bg-dark border-secondary mb-3" id="section-notes">
              <div class="card-header border-secondary collapsible-header" data-bs-toggle="collapse" data-bs-target="#collapseNotes" aria-expanded="false" aria-controls="collapseNotes" style="cursor: pointer;">
                <strong><i class="bi bi-chevron-down me-1 collapse-icon"></i>Detailed Notes</strong>
              </div>
              <div class="collapse" id="collapseNotes">
              <div class="card-body">
                <!-- Tabs for this block -->
                <ul class="nav nav-tabs small mb-3" id="detailTabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active"
                            id="detail-actions-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-actions-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-actions-pane"
                            aria-selected="true">
                      Action Notes
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-spells-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-spells-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-spells-pane"
                            aria-selected="false">
                      Spells
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-inventory-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-inventory-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-inventory-pane"
                            aria-selected="false">
                      Inventory
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-features-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-features-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-features-pane"
                            aria-selected="false">
                      Features &amp; Traits
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-background-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-background-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-background-pane"
                            aria-selected="false">
                      Background
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link"
                            id="detail-notes-tab"
                            data-bs-toggle="tab"
                            data-bs-target="#detail-notes-pane"
                            type="button"
                            role="tab"
                            aria-controls="detail-notes-pane"
                            aria-selected="false">
                      Notes
                    </button>
                  </li>
                </ul>

                <div class="tab-content">
                  <!-- Action Notes -->
                  <div class="tab-pane fade show active"
                       id="detail-actions-pane"
                       role="tabpanel"
                       aria-labelledby="detail-actions-tab">

                    <!-- Attacks Section -->
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <div>
                          <label class="form-label mb-0 fw-bold">Attacks & Actions</label>
                          <div class="text-muted small">Green = Advantage/Crit  White = Normal  Red = Disadvantage/Half</div>
                        </div>
                        <button type="button" class="btn btn-sm btn-success" id="addAttackBtn">
                          <i class="bi bi-plus-circle me-1"></i>Add Attack
                        </button>
                      </div>
                      <div id="attacksList" class="list-group list-group-flush small">
                        <!-- Populated by JS -->
                      </div>
                    </div>

                    <hr class="border-secondary my-3" />

                    <label for="charTableNotes" class="form-label">At-the-Table Reminders</label>
                    <textarea id="charTableNotes" rows="10" class="form-control form-control-sm"
                              placeholder="Short, brutal notes: what they want right now, likely actions, roleplay voice, conflicts, etc."></textarea>
                  </div>

                  <!-- Spells -->
                  <div class="tab-pane fade"
                       id="detail-spells-pane"
                       role="tabpanel"
                       aria-labelledby="detail-spells-tab">
                    <div class="mb-2" id="section-spells">
                      <label class="form-label">Spells / Resources</label>

                      <!-- Inner Spells Tabs -->
                      <ul class="nav nav-tabs small" id="spellsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                          <button class="nav-link active"
                                  id="spells-notes-tab"
                                  data-bs-toggle="tab"
                                  data-bs-target="#spells-notes-pane"
                                  type="button"
                                  role="tab"
                                  aria-controls="spells-notes-pane"
                                  aria-selected="true">
                            Notes
                          </button>
                        </li>
                        <li class="nav-item" role="presentation">
                          <button class="nav-link"
                                  id="spells-list-tab"
                                  data-bs-toggle="tab"
                                  data-bs-target="#spells-list-pane"
                                  type="button"
                                  role="tab"
                                  aria-controls="spells-list-pane"
                                  aria-selected="false">
                            Spell List
                          </button>
                        </li>
                      </ul>
                  
                      <div class="tab-content border border-secondary border-top-0 rounded-bottom p-2 bg-black bg-opacity-25">
                        <!-- Notes tab (freeform field) -->
                        <div class="tab-pane fade show active"
                             id="spells-notes-pane"
                             role="tabpanel"
                             aria-labelledby="spells-notes-tab">
                          <textarea id="charSpells" rows="10" class="form-control form-control-sm"
                                    placeholder="Signature spells, pact slots, channel divinity, rage uses, ki, etc."></textarea>
                        </div>
                    
                        <!-- Spell List tab -->
                        <div class="tab-pane fade"
                           id="spells-list-pane"
                           role="tabpanel"
                           aria-labelledby="spells-list-tab">

                        <!-- Spellcasting Ability & Derived Stats -->
                        <div class="mb-3 p-2 border border-secondary rounded bg-dark bg-opacity-50">
                          <div class="row g-2 align-items-end">
                            <div class="col-12 col-md-4">
                              <label for="spellcastingAbility" class="form-label small mb-1">Spellcasting Ability</label>
                              <select id="spellcastingAbility" class="form-select form-select-sm">
                                <option value="">None</option>
                                <option value="int">Intelligence</option>
                                <option value="wis">Wisdom</option>
                                <option value="cha">Charisma</option>
                              </select>
                            </div>
                            <div class="col-6 col-md-4">
                              <label class="form-label small mb-1">Spell Save DC</label>
                              <div class="form-control form-control-sm text-center bg-secondary bg-opacity-25" id="spellSaveDC"></div>
                            </div>
                            <div class="col-6 col-md-4">
                              <label class="form-label small mb-1">Spell Attack Bonus</label>
                              <div class="form-control form-control-sm text-center bg-secondary bg-opacity-25" id="spellAttackBonus"></div>
                            </div>
                          </div>
                        </div>

                        <!-- NEW: Spell Slots + Pact Slots -->
                        <div class="mb-3">
                          <label class="form-label small">Spell Slots</label>
                          <div class="table-responsive">
                            <table class="table table-sm table-dark align-middle mb-2">
                              <thead class="small text-muted">
                                <tr>
                                  <th style="width:4rem;">Level</th>
                                  <th style="width:5rem;">Max</th>
                                  <th style="width:5rem;">Used</th>
                                  <th style="width:auto">Actions</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td>1st</td>
                                  <td><input id="slots1Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots1Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td> <!-- NEW CELL -->
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="1">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="1">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="1">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>2nd</td>
                                  <td><input id="slots2Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots2Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td> 
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="2">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="2">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="2">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>3rd</td>
                                  <td><input id="slots3Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots3Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="3">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="3">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="3">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>4th</td>
                                  <td><input id="slots4Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots4Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="4">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="4">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="4">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>5th</td>
                                  <td><input id="slots5Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots5Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="5">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="5">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="5">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>6th</td>
                                  <td><input id="slots6Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots6Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="6">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="6">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="6">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>7th</td>
                                  <td><input id="slots7Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots7Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="7">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="7">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="7">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>8th</td>
                                  <td><input id="slots8Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots8Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="8">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="8">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="8">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                                <tr>
                                  <td>9th</td>
                                  <td><input id="slots9Max"  type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td><input id="slots9Used" type="number" class="form-control form-control-sm text-center" min="0" /></td>
                                  <td>
                                    <div class="btn-group btn-group-sm">
                                      <button class="btn btn-outline-success btn-sm" data-action="use-slot" data-level="9">
                                        <i class="bi bi-dash-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-info btn-sm" data-action="regain-slot" data-level="9">
                                        <i class="bi bi-plus-circle"></i>
                                      </button>
                                      <button class="btn btn-outline-secondary btn-sm" data-action="reset-slot" data-level="9">
                                        <i class="bi bi-arrow-clockwise"></i>
                                      </button>
                                    </div>
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        
                          <div class="row g-2 align-items-end small">
                            <div class="col-4">
                              <label for="pactLevel" class="form-label mb-1">Pact Slot Level</label>
                              <input id="pactLevel" type="number" min="1" max="9"
                                     class="form-control form-control-sm text-center" />
                            </div>
                            <div class="col-4">
                              <label for="pactMax" class="form-label mb-1">Pact Slots</label>
                              <input id="pactMax" type="number" min="0"
                                     class="form-control form-control-sm text-center" />
                            </div>
                            <div class="col-4">
                              <label for="pactUsed" class="form-label mb-1">Used</label>
                              <input id="pactUsed" type="number" min="0"
                                     class="form-control form-control-sm text-center" />
                            </div>
                          </div>
                        </div>
                      
                        <!-- Existing search + results stay unchanged below this -->
                        <div class="mb-2">
                          <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text"
                                   class="form-control"
                                   id="spellSearchInput"
                                   placeholder="Search spell name, tag, or class..."
                                   autocomplete="off" />
                          </div>
                          <div id="spellSearchResults" class="list-group list-group-flush small"></div>
                        </div>

                          <!-- Custom / homebrew spell entry -->
                          <div class="mb-3">
                            <button class="btn btn-sm btn-outline-success mb-2"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#customSpellCollapse"
                                    aria-expanded="false"
                                    aria-controls="customSpellCollapse">
                              <i class="bi bi-magic me-1"></i>Add Custom / Homebrew Spell
                            </button>

                            <div class="collapse" id="customSpellCollapse">
                              <div class="border border-secondary rounded p-2 bg-black bg-opacity-25">
                                <div class="row g-2 mb-2">
                                  <div class="col-12">
                                    <label for="customSpellNameInput" class="form-label small mb-1">Name / Title</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellNameInput"
                                           placeholder="Spell name (required)" />
                                  </div>
                                  <div class="col-4">
                                    <label for="customSpellLevelInput" class="form-label small mb-1">Level</label>
                                    <input type="number"
                                           min="0"
                                           max="9"
                                           class="form-control form-control-sm"
                                           id="customSpellLevelInput" />
                                  </div>
                                  <div class="col-8">
                                    <label for="customSpellSchoolInput" class="form-label small mb-1">School</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellSchoolInput"
                                           placeholder="Evocation, Illusion..." />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellCastingInput" class="form-label small mb-1">Casting Time</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellCastingInput"
                                           placeholder="1 action, bonus action..." />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellRangeInput" class="form-label small mb-1">Range</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellRangeInput"
                                           placeholder="60 ft, Self (30-ft cone)..." />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellComponentsInput" class="form-label small mb-1">Components</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellComponentsInput"
                                           placeholder="V,S,M (a pearl worth 100 gp)" />
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellDurationInput" class="form-label small mb-1">Duration</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellDurationInput"
                                           placeholder="Instantaneous, 1 minute, up to 1 hour..." />
                                  </div>
                                  <div class="col-6 d-flex align-items-center">
                                    <div class="form-check mt-3">
                                      <input class="form-check-input"
                                             type="checkbox"
                                             id="customSpellConcentrationInput" />
                                      <label class="form-check-label small" for="customSpellConcentrationInput">
                                        Concentration
                                      </label>
                                    </div>
                                  </div>
                                  <div class="col-6">
                                    <label for="customSpellClassesInput" class="form-label small mb-1">Classes</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellClassesInput"
                                           placeholder="Wizard, Cleric (comma-separated)" />
                                  </div>
                                  <div class="col-12">
                                    <label for="customSpellTagsInput" class="form-label small mb-1">Tags</label>
                                    <input type="text"
                                           class="form-control form-control-sm"
                                           id="customSpellTagsInput"
                                           placeholder="damage, control, fire (comma-separated)" />
                                  </div>
                                  <div class="col-12">
                                    <label for="customSpellBodyInput" class="form-label small mb-1">Description</label>
                                    <textarea class="form-control form-control-sm"
                                              id="customSpellBodyInput"
                                              rows="3"
                                              placeholder="Full spell rules text / summary."></textarea>
                                  </div>
                                </div>

                                <div class="d-flex justify-content-end">
                                  <button class="btn btn-sm btn-success"
                                          type="button"
                                          id="saveCustomSpellBtn">
                                    <i class="bi bi-plus-circle me-1"></i>Add to Known Spells
                                  </button>
                                </div>

                                <small class="text-muted d-block mt-1">
                                  Custom spells are stored only on this characters spell list.
                                </small>
                              </div>
                            </div>
                          </div>
                      
                          <!-- Prepared Spells Counter (for preparing casters) -->
                          <div class="alert alert-info small mt-3 d-none" id="preparedSpellsAlert">
                            <div class="d-flex justify-content-between align-items-center">
                              <span>
                                <i class="bi bi-book me-1"></i>
                                <strong>Prepared Spells:</strong>
                                <span id="preparedSpellCount">0</span> / <span id="maxPreparedSpells">0</span>
                              </span>
                              <span class="badge bg-secondary" id="preparedSpellStatus">OK</span>
                            </div>
                            <small class="text-muted d-block mt-1">
                              Subclass spells are always prepared and don't count toward this limit.
                            </small>
                          </div>

                          <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                              <span class="fw-bold small">Known Spells</span>
                              <button type="button"
                                      class="btn btn-sm btn-outline-danger"
                                      id="clearSpellListBtn">
                                Clear All
                              </button>
                            </div>
                            <ul class="list-group list-group-flush small" id="characterSpellList">
                              <!-- Populated by JS -->
                            </ul>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Inventory -->
                  <div class="tab-pane fade"
                       id="detail-inventory-pane"
                       role="tabpanel"
                       aria-labelledby="detail-inventory-tab">
                    <div class="mt-2" id="section-inventory">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Inventory</h6>
                        <button type="button" class="btn btn-sm btn-success" id="addInventoryItemBtn">
                          <i class="bi bi-plus-circle me-1"></i>Add Item
                        </button>
                      </div>

                      <!-- Encumbrance Display -->
                      <div class="card bg-secondary border-secondary mb-3">
                        <div class="card-body p-2">
                          <div class="row g-2 text-center small">
                            <div class="col-4">
                              <div class="fw-bold">Total Weight</div>
                              <div id="totalWeight">0 lb</div>
                            </div>
                            <div class="col-4">
                              <div class="fw-bold">Carrying Capacity</div>
                              <div id="carryingCapacity">-- lb</div>
                            </div>
                            <div class="col-4">
                              <div class="fw-bold">Encumbrance</div>
                              <div id="encumbranceStatus">
                                <span class="badge bg-success">Normal</span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      <!-- Inventory Table -->
                      <div class="table-responsive">
                        <table class="table table-sm table-dark table-bordered" id="inventoryTable">
                          <thead>
                            <tr>
                              <th style="width: 35%;">Item Name</th>
                              <th style="width: 10%;" class="text-center">Qty</th>
                              <th style="width: 12%;" class="text-center">Weight (lb)</th>
                              <th style="width: 10%;" class="text-center">Equipped</th>
                              <th style="width: 10%;" class="text-center">Attuned</th>
                              <th style="width: 13%;" class="text-center">Total</th>
                              <th style="width: 10%;" class="text-center">Actions</th>
                            </tr>
                          </thead>
                          <tbody id="inventoryTableBody">
                            <tr class="text-muted">
                              <td colspan="7" class="text-center py-3">
                                <small>No items yet. Click "Add Item" to start building your inventory.</small>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>

                  <!-- Features & Traits -->
                  <div class="tab-pane fade"
                       id="detail-features-pane"
                       role="tabpanel"
                       aria-labelledby="detail-features-tab">
                    <div class="mt-2" id="section-features">
                      <label for="charFeatures" class="form-label">Features & Feats</label>
                      <textarea id="charFeatures" rows="10" class="form-control form-control-sm"
                                placeholder="Key class features, feats, reactions, bonus actions, etc. Focus on what matters for you behind the screen."></textarea>
                    </div>
                  </div>

                  <!-- Background -->
                  <div class="tab-pane fade"
                       id="detail-background-pane"
                       role="tabpanel"
                       aria-labelledby="detail-background-tab">
                    <div class="mt-2" id="section-background">
                      <label for="charNotes" class="form-label">Story, Hooks &amp; Secrets</label>
                      <textarea id="charNotes" rows="10" class="form-control form-control-sm"
                                placeholder="Backstory beats, faction ties, secrets, upcoming reveals, relationship notes, etc."></textarea>
                    </div>
                  </div>

                  <!-- Generic Notes -->
                  <div class="tab-pane fade"
                       id="detail-notes-pane"
                       role="tabpanel"
                       aria-labelledby="detail-notes-tab">
                    <div class="mt-2">
                      <label for="charExtraNotes" class="form-label">Miscellaneous Notes</label>
                      <textarea id="charExtraNotes" rows="10" class="form-control form-control-sm"
                                placeholder="Scratch space, prep notes, anything that doesnt fit the other tabs."></textarea>
                    </div>
                  </div>
                </div>
              </div>
              </div>
            </div>

          </div>
        </div> <!-- /row -->

        <!-- Combat Card View (Hidden by default, shown when combat mode is toggled) -->
        <div id="combatCardView" class="combat-card-view">
          <!-- Portrait -->
          <div class="combat-portrait-frame" id="combatPortraitFrame">
            <img id="combatPortraitImage" class="combat-portrait-image d-none" alt="Character portrait" />
            <span id="combatPortraitPlaceholder" class="text-muted position-absolute top-50 start-50 translate-middle text-center">
              No portrait
            </span>
          </div>

          <!-- Character Name -->
          <h3 class="text-center mb-3" id="combatCharName">Character Name</h3>

          <!-- Quick Stats Grid -->
          <div class="combat-stat-grid">
            <div class="combat-stat-box">
              <div class="combat-stat-label">AC</div>
              <div class="combat-stat-value" id="combatAC">10</div>
            </div>
            <div class="combat-stat-box">
              <div class="combat-stat-label">HP</div>
              <div class="combat-stat-value" id="combatHP">10</div>
            </div>
            <div class="combat-stat-box">
              <div class="combat-stat-label">Speed</div>
              <div class="combat-stat-value" id="combatSpeed">30</div>
            </div>
          </div>

          <!-- Basic Info -->
          <div class="combat-section-title">Character Info</div>
          <div class="combat-info-line">
            <span class="combat-info-label">Class</span>
            <span class="combat-info-value" id="combatClass">-</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">Race</span>
            <span class="combat-info-value" id="combatRace">-</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">Level</span>
            <span class="combat-info-value" id="combatLevel">1</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">Initiative</span>
            <span class="combat-info-value" id="combatInitiative">+0</span>
          </div>

          <!-- Combat Stats -->
          <div class="combat-section-title">Combat Stats</div>
          <div class="combat-info-line">
            <span class="combat-info-label">Hit Dice</span>
            <span class="combat-info-value" id="combatHitDice">1d8</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">Proficiency Bonus</span>
            <span class="combat-info-value" id="combatProfBonus">+2</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">Passive Perception</span>
            <span class="combat-info-value" id="combatPassivePerception">10</span>
          </div>

          <!-- Checks and Saves -->
          <div class="combat-section-title">Checks and Saves</div>
          <div class="combat-info-line">
            <span class="combat-info-label">STR</span>
            <span class="combat-info-value" id="combatSaveStr">+0</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">DEX</span>
            <span class="combat-info-value" id="combatSaveDex">+0</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">CON</span>
            <span class="combat-info-value" id="combatSaveCon">+0</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">INT</span>
            <span class="combat-info-value" id="combatSaveInt">+0</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">WIS</span>
            <span class="combat-info-value" id="combatSaveWis">+0</span>
          </div>
          <div class="combat-info-line">
            <span class="combat-info-label">CHA</span>
            <span class="combat-info-value" id="combatSaveCha">+0</span>
          </div>

          <!-- Conditions & Notes -->
          <div class="combat-section-title">Conditions</div>
          <div id="combatConditions" class="text-muted fst-italic">None</div>

          <!-- Actions & Attacks -->
          <div class="combat-section-title">Actions & Attacks</div>
          <div id="combatActions" class="small">
            <!-- Populated by JS -->
          </div>

          <!-- Spells -->
          <div id="combatSpellsSection" class="d-none">
            <div class="combat-section-title">Spells</div>
            <div id="combatSpells" class="small">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>

      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="footer-main py-3">
      <div class="container">
        <div class="row align-items-center text-center text-md-start">
          <!-- Left: Copyright -->
          <div class="col-12 col-md-4 mb-2 mb-md-0 text-md-start text-center">
            <small class="text-muted">&copy; 2025 Maybeme | The DMs Toolbox</small>
          </div>

          <!-- Center: Logo -->
          <div class="col-12 col-md-4 text-center mb-2 mb-md-0">
            <img src="/images/White logo - no background.png" height="40" alt="Logo" class="footer-logo">
          </div>

          <!-- Right: Social Links -->
          <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end align-items-center gap-2">
            <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener" aria-label="LinkedIn">
              <i class="bi bi-linkedin"></i>
            </a>
            <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener" aria-label="GitHub">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://ko-fi.com/maybemestoolbox" class="socialicons d-flex align-items-center" target="_blank" rel="noopener" title="Support The DMs Toolbox on Ko-fi">
              <i class="bi bi-cup-hot"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Attack Editor Modal -->
  <div class="modal fade" id="attackModal" tabindex="-1" aria-labelledby="attackModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="attackModalLabel">Add/Edit Attack</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="attackEditIndex" value="" />

          <div class="mb-3">
            <label for="attackName" class="form-label">Attack Name</label>
            <input type="text" class="form-control form-control-sm" id="attackName" placeholder="Longsword, Fire Bolt, Unarmed Strike..." />
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="attackType" class="form-label">Attack Type</label>
              <select class="form-select form-select-sm" id="attackType">
                <option value="melee-weapon">Melee Weapon Attack</option>
                <option value="ranged-weapon">Ranged Weapon Attack</option>
                <option value="melee-spell">Melee Spell Attack</option>
                <option value="ranged-spell">Ranged Spell Attack</option>
                <option value="save">Saving Throw</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="col-6">
              <label for="attackRange" class="form-label">Range</label>
              <input type="text" class="form-control form-control-sm" id="attackRange" placeholder="5 ft, 30/120 ft..." />
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="attackBonus" class="form-label">Attack Bonus</label>
              <input type="text" class="form-control form-control-sm" id="attackBonus" placeholder="+5, +8..." />
            </div>
            <div class="col-6">
              <label for="attackSaveDC" class="form-label">Save DC (if applicable)</label>
              <input type="text" class="form-control form-control-sm" id="attackSaveDC" placeholder="DC 15, DC 18..." />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Primary Damage</label>
            <div class="row g-2">
              <div class="col-7">
                <input type="text" class="form-control form-control-sm" id="attackDamage" placeholder="1d8+3" />
                <div class="form-text small">Dice notation (e.g., 1d8+3)</div>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="attackDamageType" placeholder="slashing" />
                <div class="form-text small">Damage type</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Additional Damage (optional)</label>
            <div class="row g-2">
              <div class="col-7">
                <input type="text" class="form-control form-control-sm" id="attackDamage2" placeholder="2d6" />
                <div class="form-text small">Dice notation (e.g., 2d6)</div>
              </div>
              <div class="col-5">
                <input type="text" class="form-control form-control-sm" id="attackDamageType2" placeholder="radiant" />
                <div class="form-text small">Damage type</div>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="attackProperties" class="form-label">Properties / Notes</label>
            <textarea class="form-control form-control-sm" id="attackProperties" rows="2" placeholder="Versatile (1d10), reach, finesse, magical..."></textarea>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="saveAttackBtn">
            <i class="bi bi-check2-circle me-1"></i>Save Attack
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Portrait Editing Modal -->
  <div class="modal fade" id="portraitModal" tabindex="-1" aria-labelledby="portraitModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="portraitModalLabel">Adjust Portrait Framing</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3 portrait-frame" style="height: 420px; cursor: grab;" id="portraitContainerModal">
            <img id="portraitPreviewModal"
                 class="portrait-image d-none"
                 alt="Portrait being edited" />
            <span id="portraitPlaceholderModal"
                  class="text-muted position-absolute top-50 start-50 translate-middle text-center">
              No image loaded
            </span>
          </div>

          <div class="mb-3">
            <label for="portraitZoomModal" class="form-label mb-1">Zoom</label>
            <input type="range" id="portraitZoomModal" min="1" max="3" step="0.05" class="form-range" />
            <small class="text-muted">Drag inside the frame to reposition the portrait.</small>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="savePortraitModalBtn">
            <i class="bi bi-check2-circle me-1"></i>Save Portrait
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Inventory Item Editor Modal -->
  <div class="modal fade" id="inventoryItemModal" tabindex="-1" aria-labelledby="inventoryItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="inventoryItemModalLabel">Add/Edit Item</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="inventoryItemEditIndex" value="" />

          <div class="mb-3">
            <label for="inventoryItemName" class="form-label">Item Name <span class="text-danger">*</span></label>
            <input type="text" class="form-control form-control-sm" id="inventoryItemName" placeholder="Longsword, Potion of Healing, Backpack..." required />
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <label for="inventoryItemQuantity" class="form-label">Quantity <span class="text-danger">*</span></label>
              <input type="number" class="form-control form-control-sm" id="inventoryItemQuantity" min="1" value="1" required />
            </div>
            <div class="col-6">
              <label for="inventoryItemWeight" class="form-label">Weight per Item (lb)</label>
              <input type="number" class="form-control form-control-sm" id="inventoryItemWeight" min="0" step="0.1" value="0" placeholder="0" />
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="inventoryItemEquipped" />
                <label class="form-check-label" for="inventoryItemEquipped">
                  Equipped
                </label>
              </div>
            </div>
            <div class="col-6">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="inventoryItemAttuned" />
                <label class="form-check-label" for="inventoryItemAttuned">
                  Attuned
                </label>
              </div>
            </div>
          </div>

          <div class="mb-3">
            <label for="inventoryItemNotes" class="form-label">Notes (optional)</label>
            <textarea class="form-control form-control-sm" id="inventoryItemNotes" rows="2" placeholder="Item description, properties, or other notes..."></textarea>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="saveInventoryItemBtn">
            <i class="bi bi-check2-circle me-1"></i>Save Item
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Token Preview Modal -->
  <div class="modal fade" id="tokenPreviewModal" tabindex="-1" aria-labelledby="tokenPreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="tokenPreviewModalLabel">Adjust Battle Map Token</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Position and zoom your character portrait to fit in the circular token.</p>

          <!-- Circular token preview -->
          <div class="d-flex justify-content-center mb-3">
            <div style="width: 250px; height: 250px; position: relative; border-radius: 50%; overflow: hidden; background: #1a1a1a; border: 3px solid #495057;">
              <canvas id="tokenPreviewCanvas" width="250" height="250" style="cursor: grab; display: block;"></canvas>
            </div>
          </div>

          <!-- Zoom control -->
          <div class="mb-3">
            <label for="tokenZoom" class="form-label mb-1">Zoom</label>
            <input type="range" id="tokenZoom" min="0.5" max="3" step="0.05" value="1" class="form-range" />
            <small class="text-muted">Drag the preview image to reposition. Use zoom to fit your portrait in the circle.</small>
          </div>

          <!-- Reset button -->
          <div class="text-center">
            <button type="button" class="btn btn-sm btn-outline-secondary" id="resetTokenPosition">
              <i class="bi bi-arrow-counterclockwise me-1"></i>Reset Position
            </button>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="confirmSendToMapBtn">
            <i class="bi bi-geo-alt-fill me-1"></i>Send to Battle Map
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Character Creation Wizard Modal -->
  <div class="modal fade" id="characterCreationModal" tabindex="-1" aria-labelledby="characterCreationModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="wizardTitle">Character Creation Wizard</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="wizardBody">
          <!-- Wizard content populated by JS -->
        </div>
        <div class="modal-footer border-secondary d-flex justify-content-between" id="wizardFooter">
          <!-- Wizard buttons populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Hit Dice Healing Modal -->
  <div class="modal fade" id="hitDiceModal" tabindex="-1" aria-labelledby="hitDiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="hitDiceModalLabel">
            <i class="bi bi-heart-pulse me-2"></i>Spend Hit Dice to Heal
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info text-light mb-3">
            <strong>Short Rest Healing:</strong> Spend hit dice to regain HP. Roll the die and add your Constitution modifier to the result.
          </div>

          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <label class="form-label mb-0"><strong>Current HP:</strong></label>
              <span id="hdModalCurrentHP" class="badge bg-danger fs-6">0 / 0</span>
            </div>
            <div class="d-flex justify-content-between align-items-center">
              <label class="form-label mb-0"><strong>Available Hit Dice:</strong></label>
              <span id="hdModalAvailable" class="badge bg-secondary fs-6">0d0</span>
            </div>
          </div>

          <div class="mb-3">
            <label for="hdSpendCount" class="form-label">How many hit dice to spend?</label>
            <div class="input-group">
              <button class="btn btn-outline-secondary" type="button" id="hdDecrement">-</button>
              <input type="number" class="form-control text-center" id="hdSpendCount" value="1" min="0" max="0" />
              <button class="btn btn-outline-secondary" type="button" id="hdIncrement">+</button>
            </div>
            <div class="form-text">Constitution modifier: <span id="hdConMod">+0</span></div>
          </div>

          <div id="hdRollResults" class="mb-3" style="display: none;">
            <div class="alert alert-success text-light">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>Rolls:</strong>
                <span id="hdRollDetails" class="font-monospace"></span>
              </div>
              <div class="d-flex justify-content-between align-items-center">
                <strong>Total Healing:</strong>
                <span id="hdTotalHealing" class="fs-5 text-success fw-bold"></span>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning" id="hdRollBtn">
            <i class="bi bi-dice-5 me-1"></i>Roll Hit Dice
          </button>
          <button type="button" class="btn btn-success" id="hdApplyBtn" style="display: none;">
            <i class="bi bi-check2-circle me-1"></i>Apply Healing
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container for Mobile Roll Notifications -->
  <div class="toast-container position-fixed top-0 start-50 translate-middle-x p-3" style="z-index: 9999;">
    <div id="rollToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="rollToastBody">
          <!-- Roll result content -->
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
    </div>
  </div>

  <!-- Multiclass Management Modal -->
  <div class="modal fade" id="multiclassModal" tabindex="-1" aria-labelledby="multiclassModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content bg-dark text-light border-secondary">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="multiclassModalLabel">
            <i class="bi bi-diagram-3 me-2"></i>Manage Multiclass Levels
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">
            <i class="bi bi-info-circle me-1"></i>
            Allocate your character's total level across multiple classes. The system will automatically calculate spell slots using multiclass rules.
          </p>

          <div class="mb-3">
            <label class="form-label">Total Character Level: <strong id="multiclassTotalLevel">1</strong></label>
            <div class="progress" style="height: 25px;">
              <div id="multiclassLevelBar" class="progress-bar" role="progressbar" style="width: 0%">
                <span id="multiclassLevelText">0 / 1</span>
              </div>
            </div>
          </div>

          <div id="multiclassClassList" class="mb-3">
            <!-- Class entries will be dynamically added here -->
          </div>

          <button type="button" class="btn btn-sm btn-outline-success" id="addMulticlassBtn">
            <i class="bi bi-plus-circle me-1"></i>Add Class
          </button>

          <hr class="border-secondary my-3">

          <div id="multiclassPrereqWarnings" class="alert alert-warning d-none">
            <i class="bi bi-exclamation-triangle me-1"></i>
            <strong>Prerequisites not met:</strong>
            <ul id="multiclassPrereqList" class="mb-0 mt-2"></ul>
          </div>

          <div id="multiclassSpellSlotPreview" class="d-none">
            <h6 class="mb-2">Spell Slots Preview:</h6>
            <div class="row g-2">
              <div class="col">
                <small class="text-muted d-block">Shared Slots</small>
                <div id="multiclassSharedSlots" class="small"></div>
              </div>
              <div class="col" id="multiclassPactSlotSection" style="display: none;">
                <small class="text-muted d-block">Pact Magic</small>
                <div id="multiclassPactSlots" class="small"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-success" id="applyMulticlassBtn">
            <i class="bi bi-check2-circle me-1"></i>Apply Multiclass
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Help Modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content bg-dark text-light">
        <div class="modal-header border-secondary">
          <h5 class="modal-title" id="helpModalLabel">
            <i class="bi bi-question-circle-fill me-2 text-primary"></i>
            Character Sheet Help & Guide
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Tab Navigation -->
          <ul class="nav nav-tabs mb-3" id="helpTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="getting-started-tab" data-bs-toggle="tab" data-bs-target="#getting-started" type="button" role="tab">
                <i class="bi bi-play-circle me-1"></i>Getting Started
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="character-info-tab" data-bs-toggle="tab" data-bs-target="#character-info" type="button" role="tab">
                <i class="bi bi-person-badge me-1"></i>Character Info
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="stats-combat-tab" data-bs-toggle="tab" data-bs-target="#stats-combat" type="button" role="tab">
                <i class="bi bi-shield-shaded me-1"></i>Stats & Combat
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="spells-tab" data-bs-toggle="tab" data-bs-target="#spells" type="button" role="tab">
                <i class="bi bi-stars me-1"></i>Spells
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="level-up-tab" data-bs-toggle="tab" data-bs-target="#level-up" type="button" role="tab">
                <i class="bi bi-arrow-up-circle me-1"></i>Leveling Up
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="features-tab" data-bs-toggle="tab" data-bs-target="#features" type="button" role="tab">
                <i class="bi bi-lightning-charge me-1"></i>Features
              </button>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content" id="helpTabContent">
            <!-- Getting Started Tab -->
            <div class="tab-pane fade show active" id="getting-started" role="tabpanel">
              <h5 class="text-primary mb-3">Welcome to the Character Manager!</h5>
              <p class="lead">This tool helps you create, manage, and level up D&D 5e characters with ease.</p>

              <div class="accordion accordion-flush" id="gettingStartedAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#create-character">
                      <i class="bi bi-person-plus me-2 text-success"></i>Creating Your First Character
                    </button>
                  </h2>
                  <div id="create-character" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <ol>
                        <li><strong>Click the "New" button</strong> at the top of the page</li>
                        <li><strong>Follow the wizard:</strong>
                          <ul>
                            <li>Enter character name and basic info</li>
                            <li>Choose race (see scaling features if applicable)</li>
                            <li>Select class and subclass (if level 1-3)</li>
                            <li>Roll or assign ability scores</li>
                            <li>Pick skills and equipment</li>
                          </ul>
                        </li>
                        <li><strong>Click "Create Character"</strong> to finish</li>
                        <li>Your character is automatically saved to browser storage</li>
                      </ol>
                      <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Characters are stored locally in your browser. Use "Export" to create backup files!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#saving-loading">
                      <i class="bi bi-save me-2 text-warning"></i>Saving & Loading Characters
                    </button>
                  </h2>
                  <div id="saving-loading" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <h6>Auto-Save</h6>
                      <p>Characters automatically save when you click the <strong>"Save" button</strong> or after certain actions like leveling up.</p>

                      <h6>Loading</h6>
                      <p>Use the <strong>character dropdown</strong> at the top to switch between saved characters.</p>

                      <h6>Export/Import</h6>
                      <ul>
                        <li><strong>Export:</strong> Downloads character as JSON file (backup)</li>
                        <li><strong>Export All:</strong> Downloads all characters as one file</li>
                        <li><strong>Import:</strong> Loads character from a JSON file</li>
                      </ul>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#combat-view">
                      <i class="bi bi-lightning-charge me-2 text-warning"></i>Combat View Toggle
                    </button>
                  </h2>
                  <div id="combat-view" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <h6>What is Combat View?</h6>
                      <p>Combat View transforms the full character sheet into a compact combat card that shows only the information needed during battle.</p>

                      <h6>How to Use</h6>
                      <ol>
                        <li>Toggle the <strong>"Combat View"</strong> switch in the header (next to "Last Updated")</li>
                        <li>The page transforms into a compact card showing:
                          <ul>
                            <li>Character portrait (if available)</li>
                            <li>Essential stats: AC, HP, Speed</li>
                            <li>Combat info: Initiative, Proficiency Bonus, Passive Perception</li>
                            <li>All saving throws</li>
                            <li>Active conditions</li>
                            <li>All attacks with to-hit bonuses and damage</li>
                            <li>All spells organized by level</li>
                          </ul>
                        </li>
                        <li>Toggle back to access the full sheet for editing</li>
                      </ol>

                      <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Perfect for DMs who need quick combat reference, or players who want a cleaner battle interface!
                      </div>

                      <div class="alert alert-success">
                        <i class="bi bi-check-circle me-1"></i>
                        <strong>Auto-Updates:</strong> Combat view automatically refreshes when you switch characters or make changes to attacks/spells!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#page-layout">
                      <i class="bi bi-layout-text-window me-2 text-info"></i>Understanding the Page Layout
                    </button>
                  </h2>
                  <div id="page-layout" class="accordion-collapse collapse" data-bs-parent="#gettingStartedAccordion">
                    <div class="accordion-body">
                      <p>The character sheet is organized into sections:</p>
                      <ul>
                        <li><strong>Top Bar:</strong> Character selection, New/Save/Delete, Export, Level Up, Help, Combat View toggle</li>
                        <li><strong>Left Column:</strong> Character info (name, race, class, level, backstory, portrait)</li>
                        <li><strong>Center Column:</strong> Stats (abilities, skills, proficiency, senses)</li>
                        <li><strong>Right Column:</strong> Combat info (HP, AC, attacks, death saves)</li>
                        <li><strong>Bottom Tabs:</strong> Inventory, Spells, Features & Traits</li>
                      </ul>
                      <div class="alert alert-success">
                        <i class="bi bi-phone me-1"></i>
                        <strong>Mobile Friendly:</strong> On smaller screens, columns stack vertically for easy scrolling!
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Character Info Tab -->
            <div class="tab-pane fade" id="character-info" role="tabpanel">
              <h5 class="text-primary mb-3">Character Information</h5>
              <p>The left side of the sheet contains your character's identity and story.</p>

              <div class="accordion accordion-flush" id="characterInfoAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#basic-info">
                      <i class="bi bi-card-text me-2"></i>Basic Information
                    </button>
                  </h2>
                  <div id="basic-info" class="accordion-collapse collapse" data-bs-parent="#characterInfoAccordion">
                    <div class="accordion-body">
                      <table class="table table-sm table-dark">
                        <tr>
                          <td><strong>Character Name</strong></td>
                          <td>Your character's name (editable field)</td>
                        </tr>
                        <tr>
                          <td><strong>Class / Subclass</strong></td>
                          <td>e.g., "Fighter (Champion)" or "Wizard / Rogue" for multiclass</td>
                        </tr>
                        <tr>
                          <td><strong>Level</strong></td>
                          <td>Current character level (1-20)</td>
                        </tr>
                        <tr>
                          <td><strong>Race</strong></td>
                          <td>Your character's race (e.g., Human, Elf, Dragonborn)</td>
                        </tr>
                        <tr>
                          <td><strong>Background</strong></td>
                          <td>Story background (e.g., Soldier, Noble, Acolyte)</td>
                        </tr>
                        <tr>
                          <td><strong>Alignment</strong></td>
                          <td>Moral compass (e.g., Lawful Good, Chaotic Neutral)</td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#backstory-portrait">
                      <i class="bi bi-book me-2"></i>Backstory & Portrait
                    </button>
                  </h2>
                  <div id="backstory-portrait" class="accordion-collapse collapse" data-bs-parent="#characterInfoAccordion">
                    <div class="accordion-body">
                      <h6>Backstory</h6>
                      <p>Click <strong>"Backstory"</strong> to expand a text area where you can write your character's history, personality traits, bonds, flaws, and ideals.</p>

                      <h6>Portrait</h6>
                      <p>Click <strong>"Character Portrait"</strong> to:</p>
                      <ul>
                        <li>Upload an image from your computer</li>
                        <li>Use a URL from the web</li>
                        <li>Adjust position/zoom with the preview tool</li>
                      </ul>
                      <p class="text-muted small">Portrait is saved with your character and displayed in the frame.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#multiclass-btn">
                      <i class="bi bi-diagram-3 me-2"></i>Multiclass Button
                    </button>
                  </h2>
                  <div id="multiclass-btn" class="accordion-collapse collapse" data-bs-parent="#characterInfoAccordion">
                    <div class="accordion-body">
                      <p>The <strong>"Multiclass" button</strong> next to the Class field lets you:</p>
                      <ul>
                        <li>Add multiple classes (e.g., Paladin 3 / Fighter 2)</li>
                        <li>See spell slot calculations for multiclass casters</li>
                        <li>Manage level distribution across classes</li>
                      </ul>
                      <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        <strong>Prerequisites:</strong> Multiclassing requires meeting ability score minimums (checked automatically).
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Stats & Combat Tab -->
            <div class="tab-pane fade" id="stats-combat" role="tabpanel">
              <h5 class="text-primary mb-3">Stats, Skills & Combat</h5>

              <div class="accordion accordion-flush" id="statsCombatAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ability-scores">
                      <i class="bi bi-graph-up me-2"></i>Ability Scores
                    </button>
                  </h2>
                  <div id="ability-scores" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <p>The six core abilities (STR, DEX, CON, INT, WIS, CHA) are shown in the center column.</p>
                      <ul>
                        <li><strong>Score:</strong> The ability score value (8-20)</li>
                        <li><strong>Modifier:</strong> Auto-calculated bonus/penalty</li>
                        <li><strong>Save:</strong> Checkbox for proficiency + calculated bonus</li>
                      </ul>
                      <p class="text-muted">Modifiers are used for skills, saves, and attacks. They update automatically when you change scores.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#skills-section">
                      <i class="bi bi-gear me-2"></i>Skills & Proficiencies
                    </button>
                  </h2>
                  <div id="skills-section" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <p>Skills are listed below ability scores. Each skill has:</p>
                      <ul>
                        <li><strong>Checkbox:</strong> Check if proficient</li>
                        <li><strong>Expertise ():</strong> Click star icon for double proficiency</li>
                        <li><strong>Bonus:</strong> Auto-calculated total</li>
                      </ul>
                      <p><strong>Proficiency Bonus:</strong> Shown at the top, increases at levels 5, 9, 13, 17.</p>
                      <p><strong>Initiative:</strong> Uses DEX modifier + any bonuses (like Alert feat).</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#hp-ac">
                      <i class="bi bi-heart-fill me-2"></i>HP, AC & Combat Stats
                    </button>
                  </h2>
                  <div id="hp-ac" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <h6>Hit Points</h6>
                      <ul>
                        <li><strong>Current HP:</strong> Your current hit points</li>
                        <li><strong>Max HP:</strong> Maximum hit points</li>
                        <li><strong>Temp HP:</strong> Temporary hit points (absorbed first)</li>
                        <li><strong>Hit Dice:</strong> Click to roll for recovery during short rest</li>
                      </ul>

                      <h6>Armor Class (AC)</h6>
                      <p>Your defense value. Higher = harder to hit.</p>

                      <h6>Speed</h6>
                      <p>Movement speed in feet per turn.</p>

                      <h6>Death Saves</h6>
                      <p>When at 0 HP, track successes and failures. 3 successes = stabilized, 3 failures = death.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#attacks-section">
                      <i class="bi bi-lightning-fill me-2"></i>Attacks & Actions
                    </button>
                  </h2>
                  <div id="attacks-section" class="accordion-collapse collapse" data-bs-parent="#statsCombatAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Attacks</strong> section lets you track your weapons and actions:</p>
                      <ul>
                        <li><strong>Add Attack:</strong> Click "+" to create a new attack entry</li>
                        <li>Enter attack name, bonus, damage, and type</li>
                        <li><strong>Delete:</strong> Click trash icon to remove</li>
                      </ul>
                      <p>Common attacks: Longsword, Shortbow, Fire Bolt, Eldritch Blast, etc.</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Spells Tab -->
            <div class="tab-pane fade" id="spells" role="tabpanel">
              <h5 class="text-primary mb-3">Spellcasting</h5>

              <div class="accordion accordion-flush" id="spellsAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#spell-slots">
                      <i class="bi bi-circle me-2"></i>Spell Slots
                    </button>
                  </h2>
                  <div id="spell-slots" class="accordion-collapse collapse" data-bs-parent="#spellsAccordion">
                    <div class="accordion-body">
                      <p>Spell slots appear automatically for spellcasting classes:</p>
                      <ul>
                        <li><strong>Max:</strong> Total slots available</li>
                        <li><strong>Used:</strong> Slots you've expended</li>
                        <li><strong>+/- buttons:</strong> Quickly adjust used slots</li>
                        <li><strong>Reset:</strong> Set used slots back to 0 (after long rest)</li>
                      </ul>
                      <p><strong>Pact Magic (Warlock):</strong> Shown separately with different recovery rules.</p>
                      <p class="text-muted">Multiclass spell slots are calculated automatically using PHB rules!</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#known-spells">
                      <i class="bi bi-stars me-2"></i>Known Spells List
                    </button>
                  </h2>
                  <div id="known-spells" class="accordion-collapse collapse" data-bs-parent="#spellsAccordion">
                    <div class="accordion-body">
                      <p>In the <strong>Spells tab</strong> at the bottom of the page:</p>
                      <ul>
                        <li>Spells are organized by level (Cantrips, 1st, 2nd, etc.)</li>
                        <li><strong>Add Spell:</strong> Type name and press Enter</li>
                        <li><strong>Remove:</strong> Click X next to spell name</li>
                        <li>Spells learned during level-up are added automatically</li>
                      </ul>
                      <div class="alert alert-info">
                        <i class="bi bi-lightbulb me-1"></i>
                        <strong>Tip:</strong> Spells are automatically suggested during level-up based on your class!
                      </div>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#spell-dc">
                      <i class="bi bi-crosshair me-2"></i>Spell Save DC & Attack Bonus
                    </button>
                  </h2>
                  <div id="spell-dc" class="accordion-collapse collapse" data-bs-parent="#spellsAccordion">
                    <div class="accordion-body">
                      <p>These are calculated automatically based on your spellcasting ability:</p>
                      <ul>
                        <li><strong>Spell Save DC:</strong> 8 + proficiency + ability modifier</li>
                        <li><strong>Spell Attack Bonus:</strong> proficiency + ability modifier</li>
                      </ul>
                      <p>The spellcasting ability depends on your class (INT for Wizard, WIS for Cleric, CHA for Sorcerer, etc.)</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Level Up Tab -->
            <div class="tab-pane fade" id="level-up" role="tabpanel">
              <h5 class="text-primary mb-3">Leveling Up Your Character</h5>

              <div class="accordion accordion-flush" id="levelUpAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#level-up-process">
                      <i class="bi bi-arrow-up-circle me-2"></i>Level-Up Process
                    </button>
                  </h2>
                  <div id="level-up-process" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <ol>
                        <li>Click the <strong>"Level Up" button</strong> at the top</li>
                        <li>Follow the step-by-step wizard:
                          <ul>
                            <li><strong>Step 1:</strong> Choose to continue in current class or multiclass</li>
                            <li><strong>Step 2:</strong> Select subclass (if reaching selection level)</li>
                            <li><strong>Step 3:</strong> Choose HP increase (roll or take average)</li>
                            <li><strong>Step 4:</strong> Racial features (if unlocked at this level)</li>
                            <li><strong>Step 5:</strong> Learn new spells (for spellcasters)</li>
                            <li><strong>Step 6:</strong> Choose ASI or feat (at levels 4, 8, 12, 16, 19)</li>
                            <li><strong>Step 7:</strong> Review new class features</li>
                            <li><strong>Step 8:</strong> Confirm changes</li>
                          </ul>
                        </li>
                        <li>Character automatically saves after level-up</li>
                      </ol>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#multiclass-levelup">
                      <i class="bi bi-diagram-3 me-2"></i>Multiclassing
                    </button>
                  </h2>
                  <div id="multiclass-levelup" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <p>At Step 1 of level-up, you can choose to multiclass into a new class:</p>
                      <ul>
                        <li>Prerequisites are checked automatically (ability scores)</li>
                        <li>You gain level 1 features of the new class</li>
                        <li>Your character becomes "Paladin / Fighter" format</li>
                        <li>Spell slots are calculated using multiclass rules</li>
                      </ul>
                      <p>Use the <strong>Multiclass button</strong> on the character sheet to manage level distribution later.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#asi-feats">
                      <i class="bi bi-plus-square me-2"></i>ASI & Feats
                    </button>
                  </h2>
                  <div id="asi-feats" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <p>At certain levels (usually 4, 8, 12, 16, 19), you can choose:</p>

                      <h6>Ability Score Improvement (ASI)</h6>
                      <ul>
                        <li>Increase one score by +2</li>
                        <li>OR increase two scores by +1 each</li>
                        <li>Maximum ability score is 20</li>
                      </ul>

                      <h6>Feat</h6>
                      <p>Choose from 60+ feats including:</p>
                      <ul>
                        <li><strong>PHB:</strong> Alert, Lucky, War Caster, Great Weapon Master, etc.</li>
                        <li><strong>Tasha's:</strong> Fey Touched, Shadow Touched, Crusher, Slasher, etc.</li>
                        <li><strong>Xanathar's:</strong> Elven Accuracy, Orcish Fury, racial feats, etc.</li>
                      </ul>
                      <p class="text-muted">Many feats also grant +1 to an ability score!</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#racial-features-levelup">
                      <i class="bi bi-star me-2"></i>Racial Features
                    </button>
                  </h2>
                  <div id="racial-features-levelup" class="accordion-collapse collapse" data-bs-parent="#levelUpAccordion">
                    <div class="accordion-body">
                      <p>Some races unlock features at specific levels:</p>
                      <ul>
                        <li><strong>Aasimar (Level 3):</strong> Choose celestial transformation</li>
                        <li><strong>Tiefling (Levels 3 & 5):</strong> Gain Hellish Rebuke and Darkness spells</li>
                        <li><strong>Genasi (Levels 3 or 5):</strong> Unlock elemental spells</li>
                        <li><strong>Githyanki/Githzerai (Levels 3 & 5):</strong> Psionic spells</li>
                      </ul>
                      <p>These appear automatically during level-up when you reach the appropriate level!</p>

                      <div class="alert alert-success">
                        <i class="bi bi-graph-up me-1"></i>
                        <strong>Scaling Features:</strong> Some racial features (Dragonborn Breath Weapon, Goliath Stone's Endurance) scale with level. Reference tables are shown during character creation!
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Features Tab -->
            <div class="tab-pane fade" id="features" role="tabpanel">
              <h5 class="text-primary mb-3">Features & Other Tools</h5>

              <div class="accordion accordion-flush" id="featuresAccordion">
                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#inventory-tab">
                      <i class="bi bi-backpack me-2"></i>Inventory Management
                    </button>
                  </h2>
                  <div id="inventory-tab" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Inventory tab</strong> at the bottom lets you track:</p>
                      <ul>
                        <li><strong>Equipment:</strong> Armor, weapons, tools</li>
                        <li><strong>Items:</strong> Potions, scrolls, misc items</li>
                        <li><strong>Currency:</strong> CP, SP, EP, GP, PP</li>
                      </ul>
                      <p>Click <strong>"Add Item"</strong> to open the item modal with name, quantity, weight, and description fields.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#features-traits-tab">
                      <i class="bi bi-lightning-charge me-2"></i>Features & Traits
                    </button>
                  </h2>
                  <div id="features-traits-tab" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>The <strong>Features & Traits tab</strong> shows:</p>
                      <ul>
                        <li>Class features gained from leveling up</li>
                        <li>Racial traits</li>
                        <li>Feats you've chosen</li>
                        <li>Special abilities</li>
                      </ul>
                      <p>This is automatically populated as you level up. You can also add custom features manually.</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#send-to-tools">
                      <i class="bi bi-send me-2"></i>Send to Other Tools
                    </button>
                  </h2>
                  <div id="send-to-tools" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <p>Integrate with other DM Toolbox features:</p>

                      <h6>Send to Initiative Tracker</h6>
                      <p>Adds your character to the combat tracker with HP, AC, and initiative.</p>

                      <h6>Send to Battle Map</h6>
                      <p>Creates a token on the battle map using your portrait image.</p>

                      <p class="text-muted">These buttons are at the top of the page!</p>
                    </div>
                  </div>
                </div>

                <div class="accordion-item bg-dark">
                  <h2 class="accordion-header">
                    <button class="accordion-button bg-dark text-light collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#tips-tricks">
                      <i class="bi bi-lightbulb me-2"></i>Tips & Tricks
                    </button>
                  </h2>
                  <div id="tips-tricks" class="accordion-collapse collapse" data-bs-parent="#featuresAccordion">
                    <div class="accordion-body">
                      <ul>
                        <li><strong>Always Save:</strong> Click Save after making changes to ensure they persist</li>
                        <li><strong>Export Regularly:</strong> Create backup JSON files of important characters</li>
                        <li><strong>Use Multiclass Manager:</strong> Better control over level distribution than manual editing</li>
                        <li><strong>Spell Slots:</strong> Use +/- buttons for quick tracking during sessions</li>
                        <li><strong>Death Saves:</strong> Reset these after a long rest!</li>
                        <li><strong>Hit Dice:</strong> Track what you've used and recover half on long rest</li>
                        <li><strong>Portrait Zoom:</strong> Adjust your portrait position in the modal for perfect framing</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer border-secondary">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/indexed-db-storage.js"></script>
  <script src="/js/spells-data.js"></script>
  <script src="/js/level-up-data.js"></script>
  <script src="/js/character-creation-wizard.js"></script>
  <script src="/js/level-up-system.js"></script>
  <script src="/js/character.js"></script>
  <script src="/js/multiclass-ui.js"></script>
  <script src="/js/character-sheet-export.js"></script>

  <!-- Combat/DM Mode Toggle Functionality -->
  <script>
    (function() {
      const dmCombatModeToggle = document.getElementById('dmCombatModeToggle');

      // Function to update combat card view with current character data
      function updateCombatCardView() {
        // Get character data from the form fields
        const charName = document.getElementById('charName')?.value || 'Character Name';
        const charRace = document.getElementById('charRace')?.value || '-';
        const charClass = document.getElementById('charClass')?.value || '-';
        const charLevel = document.getElementById('charLevel')?.value || '1';

        // Basic stats (using correct field IDs)
        const ac = document.getElementById('charAC')?.value || '10';
        const currentHp = document.getElementById('charCurrentHP')?.value || '10';
        const maxHp = document.getElementById('charMaxHP')?.value || '10';
        const speed = document.getElementById('charSpeed')?.value || '30';
        const profBonus = document.getElementById('proficiencyBonus')?.value || '+2';
        const passivePerception = document.getElementById('passivePerception')?.value || '10';

        // Initiative (DEX modifier)
        const dexMod = document.getElementById('dexMod')?.value || '+0';

        // Hit dice
        const hitDice = document.getElementById('totalHitDice')?.value || '1d8';

        // Saving throws - read from the correct input IDs (saveStrBonus, saveDexBonus, etc.)
        const strSaveVal = document.getElementById('saveStrBonus')?.value;
        const dexSaveVal = document.getElementById('saveDexBonus')?.value;
        const conSaveVal = document.getElementById('saveConBonus')?.value;
        const intSaveVal = document.getElementById('saveIntBonus')?.value;
        const wisSaveVal = document.getElementById('saveWisBonus')?.value;
        const chaSaveVal = document.getElementById('saveChaBonus')?.value;

        // Format with + sign for positive values
        const formatMod = (val) => {
          const num = parseInt(val, 10);
          if (isNaN(num)) return '+0';
          return num >= 0 ? `+${num}` : `${num}`;
        };

        const strSave = formatMod(strSaveVal);
        const dexSave = formatMod(dexSaveVal);
        const conSave = formatMod(conSaveVal);
        const intSave = formatMod(intSaveVal);
        const wisSave = formatMod(wisSaveVal);
        const chaSave = formatMod(chaSaveVal);

        // Get portrait data
        const portraitPreview = document.getElementById('portraitPreview');
        const combatPortraitImage = document.getElementById('combatPortraitImage');
        const combatPortraitPlaceholder = document.getElementById('combatPortraitPlaceholder');

        // Update portrait
        if (portraitPreview && !portraitPreview.classList.contains('d-none')) {
          combatPortraitImage.src = portraitPreview.src;
          combatPortraitImage.style.transform = portraitPreview.style.transform || 'translate(-50%, -50%) scale(1)';
          combatPortraitImage.classList.remove('d-none');
          combatPortraitPlaceholder.classList.add('d-none');
        } else {
          combatPortraitImage.classList.add('d-none');
          combatPortraitPlaceholder.classList.remove('d-none');
        }

        // Update all combat card fields
        document.getElementById('combatCharName').textContent = charName;
        document.getElementById('combatClass').textContent = charClass;
        document.getElementById('combatRace').textContent = charRace;
        document.getElementById('combatLevel').textContent = charLevel;
        document.getElementById('combatAC').textContent = ac;
        document.getElementById('combatHP').textContent = `${currentHp}/${maxHp}`;
        document.getElementById('combatSpeed').textContent = `${speed} ft`;
        document.getElementById('combatInitiative').textContent = dexMod;
        document.getElementById('combatHitDice').textContent = hitDice;
        document.getElementById('combatProfBonus').textContent = profBonus;
        document.getElementById('combatPassivePerception').textContent = passivePerception;

        // Update saving throws
        document.getElementById('combatSaveStr').textContent = strSave;
        document.getElementById('combatSaveDex').textContent = dexSave;
        document.getElementById('combatSaveCon').textContent = conSave;
        document.getElementById('combatSaveInt').textContent = intSave;
        document.getElementById('combatSaveWis').textContent = wisSave;
        document.getElementById('combatSaveCha').textContent = chaSave;

        // Get conditions/notes if they exist
        const conditions = document.getElementById('conditions')?.value || 'None';
        document.getElementById('combatConditions').textContent = conditions || 'None';

        // Update Actions/Attacks
        updateCombatActions();

        // Update Spells
        updateCombatSpells();
      }

      // Function to render actions/attacks in combat view
      function updateCombatActions() {
        const combatActionsEl = document.getElementById('combatActions');
        if (!combatActionsEl) return;

        // Access the global currentAttackList from character.js
        const attackList = window.currentAttackList || [];

        if (!attackList.length) {
          combatActionsEl.innerHTML = '<div class="text-muted fst-italic">No attacks or actions added.</div>';
          return;
        }

        let html = '';
        attackList.forEach(attack => {
          const attackTypeLabel = {
            'melee-weapon': 'Melee Weapon',
            'ranged-weapon': 'Ranged Weapon',
            'melee-spell': 'Melee Spell',
            'ranged-spell': 'Ranged Spell',
            'save': 'Save DC',
            'other': 'Other'
          }[attack.type] || attack.type;

          html += '<div class="combat-action-item">';
          html += `<div class="combat-action-name">${attack.name || 'Unnamed Attack'}</div>`;
          html += `<div class="combat-action-detail">${attackTypeLabel}`;

          if (attack.range) {
            html += `  ${attack.range}`;
          }

          if (attack.bonus) {
            html += `  <span class="badge bg-primary bg-opacity-75">${attack.bonus} to hit</span>`;
          }

          if (attack.saveDC) {
            html += `  <span class="badge bg-warning bg-opacity-75 text-dark">DC ${attack.saveDC}</span>`;
          }

          html += '</div>';

          if (attack.damage) {
            const dmgType = attack.damageType ? ` ${attack.damageType}` : '';
            html += `<div class="combat-action-detail"><strong>Damage:</strong> ${attack.damage}${dmgType}`;

            if (attack.damage2) {
              const dmgType2 = attack.damageType2 ? ` ${attack.damageType2}` : '';
              html += ` + ${attack.damage2}${dmgType2}`;
            }

            html += '</div>';
          }

          if (attack.notes) {
            html += `<div class="combat-action-detail small"><em>${attack.notes}</em></div>`;
          }

          html += '</div>';
        });

        combatActionsEl.innerHTML = html;
      }

      // Function to render spells in combat view
      function updateCombatSpells() {
        const combatSpellsEl = document.getElementById('combatSpells');
        const combatSpellsSection = document.getElementById('combatSpellsSection');
        if (!combatSpellsEl || !combatSpellsSection) return;

        // Access the global currentSpellList from character.js
        const spellList = window.currentSpellList || [];

        if (!spellList.length) {
          combatSpellsSection.classList.add('d-none');
          return;
        }

        combatSpellsSection.classList.remove('d-none');

        // Group spells by level
        const spellsByLevel = {};
        spellList.forEach(spell => {
          const level = spell.level ?? 0;
          if (!spellsByLevel[level]) {
            spellsByLevel[level] = [];
          }
          spellsByLevel[level].push(spell);
        });

        let html = '';

        // Sort levels (cantrips first, then 1-9)
        const levels = Object.keys(spellsByLevel).map(Number).sort((a, b) => a - b);

        levels.forEach(level => {
          const levelLabel = level === 0 ? 'Cantrips' : `Level ${level}`;
          const spells = spellsByLevel[level];

          html += `<div class="mb-2"><strong class="text-light">${levelLabel}</strong></div>`;

          spells.forEach(spell => {
            const title = spell.title || spell.name || 'Unknown';
            const prepared = spell.prepared ? '<span class="badge bg-success bg-opacity-75 ms-1" style="font-size: 0.7rem;">Prep</span>' : '';

            html += '<div class="combat-spell-item">';
            html += `<div class="combat-spell-name">${title} ${prepared}</div>`;

            const meta = [];
            if (spell.school) meta.push(spell.school);
            if (spell.casting_time) meta.push(`Cast: ${spell.casting_time}`);
            if (spell.range) meta.push(`Range: ${spell.range}`);
            if (spell.concentration) meta.push('Concentration');

            if (meta.length) {
              html += `<div class="combat-spell-meta">${meta.join('  ')}</div>`;
            }

            html += '</div>';
          });
        });

        combatSpellsEl.innerHTML = html;
      }

      // Toggle combat mode
      function toggleCombatMode() {
        const isChecked = dmCombatModeToggle.checked;

        if (isChecked) {
          // Update the combat card with latest data before showing
          updateCombatCardView();
          document.body.classList.add('combat-mode');
          localStorage.setItem('dmCombatMode', 'true');
        } else {
          document.body.classList.remove('combat-mode');
          localStorage.setItem('dmCombatMode', 'false');
        }
      }

      // Event listener for toggle
      if (dmCombatModeToggle) {
        dmCombatModeToggle.addEventListener('change', toggleCombatMode);

        // Restore saved state on page load
        const savedMode = localStorage.getItem('dmCombatMode');
        if (savedMode === 'true') {
          dmCombatModeToggle.checked = true;
          toggleCombatMode();
        }
      }

      // Also update combat view when character is changed/loaded
      // We'll hook into the existing character select change event
      const characterSelect = document.getElementById('characterSelect');
      if (characterSelect) {
        characterSelect.addEventListener('change', function() {
          // Wait a bit for the character data to load
          setTimeout(function() {
            if (dmCombatModeToggle && dmCombatModeToggle.checked) {
              updateCombatCardView();
            }
          }, 100);
        });
      }

      // Update combat view when any input changes (if in combat mode)
      document.addEventListener('input', function(e) {
        if (dmCombatModeToggle && dmCombatModeToggle.checked) {
          // Debounce updates
          clearTimeout(window.combatViewUpdateTimer);
          window.combatViewUpdateTimer = setTimeout(updateCombatCardView, 300);
        }
      });
    })();
  </script>
</body>
</html>
