<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Encounter Builder</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/site.js"></script>
  <script src="/js/generated/srd-allowlist.js"></script>
  <script src="/js/modules/srd-content-filter.js"></script>
  <style>
    .bgimage{
      background: url('images/BGMap.png') no-repeat center center fixed;
      background-size: cover;
    }
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn {
      border-left: 5px solid #1d9e6d !important;
      color: #f8f9fa !important;
      font-weight: bold;
    }
    #saveHistorySelect { min-width: 200px; }

    /* Stat Block Tooltips */
    .monster-preview-trigger:hover {
      background-color: #495057 !important;
      transition: background-color 0.2s;
    }

    .stat-block-preview {
      position: absolute;
      z-index: 9999;
      background: #2d3748;
      border: 2px solid #4a5568;
      border-radius: 8px;
      padding: 12px;
      min-width: 350px;
      max-width: 500px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.5);
      font-size: 0.9rem;
      line-height: 1.4;
      pointer-events: none;
    }

    .stat-block-preview .preview-header {
      font-weight: bold;
      font-size: 1.1rem;
      margin-bottom: 8px;
      color: #f7fafc;
      border-bottom: 2px solid #e53e3e;
      padding-bottom: 4px;
    }

    .stat-block-preview .preview-subtitle {
      font-style: italic;
      color: #cbd5e0;
      margin-bottom: 8px;
    }

    .stat-block-preview .stat-line {
      margin: 4px 0;
      color: #e2e8f0;
    }

    .stat-block-preview .stat-label {
      font-weight: 600;
      color: #fc8181;
    }

    .stat-block-preview .action-block {
      margin: 8px 0;
      padding: 6px;
      background: #1a202c;
      border-radius: 4px;
      border-left: 3px solid #e53e3e;
    }

    .stat-block-preview .action-name {
      font-weight: bold;
      color: #fc8181;
      margin-bottom: 2px;
    }

    .stat-block-preview .action-desc {
      color: #cbd5e0;
      font-size: 0.85rem;
      margin-left: 8px;
    }

    .stat-block-preview .section-header {
      font-weight: bold;
      color: #fc8181;
      margin-top: 10px;
      margin-bottom: 4px;
      text-transform: uppercase;
      font-size: 0.85rem;
      letter-spacing: 0.5px;
    }

    /* Expandable roster details */
    .roster-expanded {
      margin-top: 8px;
      padding: 8px;
      background: #1a202c;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .roster-actions {
      display: grid;
      gap: 6px;
    }

    .roster-action-item {
      padding: 6px;
      background: #2d3748;
      border-radius: 3px;
      border-left: 2px solid #e53e3e;
    }
  </style>
</head>
<body class="bgimage">
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/DMsToolboxLogo.png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Combat
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="initiative.html">Initiative Tracker</a></li>
              <li><a class="dropdown-item" href="battlemap.html">Battle Map</a></li>
              <li><a class="dropdown-item active" aria-current="page" href="encounterbuilder.html">Encounter Builder</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Generators
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="name.html">Name Generator</a></li>
              <li><a class="dropdown-item" href="loot.html">Loot Generator</a></li>
              <li><a class="dropdown-item" href="shop.html">Shop Generator</a></li>
              <li><a class="dropdown-item" href="npc.html">NPC Generator</a></li>
              <li><a class="dropdown-item" href="tav.html">Tavern/Inn Generator</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Campaign
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="characters.html">Characters</a></li>
              <li><a class="dropdown-item" href="journal.html">Journal</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="content pt-3">
    <div class="container-fluid text-center backdrop">
      <section class="container py-4">
        <h1 class="display-5 fw-bold mb-1">Encounter Builder</h1>
        <p class="text-secondary mb-4">Search SRD monsters, add homebrew, auto-calc CR/XP, and export to your Initiative Tracker.</p>

        <!-- Party Setup -->
        <div class="card bg-dark border-secondary mb-3">
          <div class="card-body">
            <div class="row g-2 align-items-end">
              <div class="col-12 col-lg-3">
                <label class="form-label">Party Levels (comma or space-separated)</label>
                <input id="eb-party-levels" class="form-control" placeholder="e.g. 3 3 3 3">
              </div>
              <div class="col-6 col-lg-2">
                <label class="form-label">Adv. Resist?</label>
                <select id="eb-resist-mode" class="form-select">
                  <option value="none" selected>None</option>
                  <option value="resist">Some</option>
                  <option value="heavy">Heavy</option>
                </select>
              </div>
              <div class="col-6 col-lg-2">
                <label class="form-label">Export Mode</label>
                <select id="eb-export-mode" class="form-select">
                  <option value="session" selected>Full Session JSON</option>
                  <option value="append">Append (addCharacters)</option>
                  <option value="roster">Roster (Full Monster Data)</option>
                </select>
              </div>
              <div class="col-12 col-lg-5 text-lg-end">
                <button id="eb-export" class="btn btn-outline-warning me-2"><i class="bi bi-download me-1"></i>Export</button>
                <button id="eb-import-roster" class="btn btn-outline-info me-2"><i class="bi bi-upload me-1"></i>Import Roster</button>
                <input type="file" id="eb-import-roster-file" accept=".json" class="d-none">
                <button id="eb-clear" class="btn btn-outline-light me-2"><i class="bi bi-trash me-1"></i>Clear</button>
                <button id="eb-send-to-tracker" class="btn btn-warning"><i class="bi bi-box-arrow-in-right me-1"></i>Send to Tracker</button>
              </div>
            </div>
            <div class="mt-3 small text-secondary" id="eb-party-summary">No party set.</div>
          </div>
        </div>

        <div class="row g-3">
          <!-- Left: Monster Search -->
          <div class="col-12 col-lg-4">
            <div class="card bg-dark border-secondary h-100">
              <div class="card-header d-flex align-items-center justify-content-between">
                <span class="fw-semibold"><i class="bi bi-search me-1"></i>SRD Monsters</span>
                <button id="eb-refresh" class="btn btn-sm btn-outline-info"><i class="bi bi-arrow-repeat"></i></button>
              </div>
              <div class="card-body">
                <input id="eb-search" class="form-control form-control-sm mb-2" placeholder="Search name/type/CR…">
                <div class="d-flex gap-2 mb-2">
                  <select id="eb-cr-filter" class="form-select form-select-sm">
                    <option value="">CR: Any</option>
                    <option value="0">0</option><option value="0.125">1/8</option><option value="0.25">1/4</option><option value="0.5">1/2</option>
                    <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option>
                    <option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option>
                    <option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option>
                    <option value="13">13</option><option value="14">14</option><option value="15">15</option>
                  </select>
                  <select id="eb-type-filter" class="form-select form-select-sm">
                    <option value="">Type: Any</option>
                    <option>Beast</option><option>Humanoid</option><option>Undead</option><option>Dragon</option>
                    <option>Fiend</option><option>Celestial</option><option>Construct</option><option>Giant</option>
                    <option>Elemental</option><option>Monstrosity</option><option>Ooze</option><option>Plant</option><option>Fey</option>
                  </select>
                </div>
                <div id="eb-results" class="list-group small" style="max-height: 420px; overflow:auto;"></div>
              </div>
            </div>
          </div>

          <!-- Middle: Custom Monster Creator (Full Stat Block) -->
          <div class="col-12 col-lg-4">
            <div class="card bg-dark border-secondary h-100">
              <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
                <span><i class="bi bi-plus-circle me-1"></i>Custom Monster</span>
                <div class="btn-group btn-group-sm">
                  <button id="cm-mode-simple" class="btn btn-outline-info active" title="Simple mode">Simple</button>
                  <button id="cm-mode-full" class="btn btn-outline-info" title="Full stat block mode">Full</button>
                </div>
              </div>
              <div class="card-body" style="max-height: 600px; overflow-y: auto;">

                <!-- ========== SIMPLE MODE (default) ========== -->
                <div id="cm-simple-mode">
                  <div class="row g-2">
                    <div class="col-12"><input id="cm-name" class="form-control" placeholder="Monster Name *"></div>
                    <div class="col-6">
                      <select id="cm-size" class="form-select">
                        <option value="Tiny">Tiny</option>
                        <option value="Small">Small</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Large">Large</option>
                        <option value="Huge">Huge</option>
                        <option value="Gargantuan">Gargantuan</option>
                      </select>
                    </div>
                    <div class="col-6"><input id="cm-type" class="form-control" placeholder="Type (e.g., Undead) *"></div>
                    <div class="col-4"><input id="cm-ac" class="form-control" type="number" placeholder="AC *"></div>
                    <div class="col-4"><input id="cm-hp" class="form-control" type="number" placeholder="HP *"></div>
                    <div class="col-4"><input id="cm-speed" class="form-control" placeholder="Speed"></div>
                  </div>
                  <hr class="my-2">
                  <div class="mb-2">
                    <label class="form-label mb-1 small fw-semibold">Actions (one per line)</label>
                    <textarea id="cm-actions" rows="3" class="form-control form-control-sm" placeholder="Longsword; toHit:+5; damage:1d8+3&#10;Fire Breath; saveDC:15; damage:6d6"></textarea>
                    <div class="form-text small">Format: <code>Name; toHit:+X; damage:XdX+X</code> or <code>Name; saveDC:X; damage:XdX</code></div>
                  </div>
                  <div class="small text-info mb-2">
                    <i class="bi bi-info-circle"></i> CR auto-calculated. Use <strong>Full</strong> mode for complete stat blocks.
                  </div>
                </div>

                <!-- ========== FULL MODE (comprehensive stat block) ========== -->
                <div id="cm-full-mode" style="display:none;">

                  <!-- Collapsible Example Monster Help -->
                  <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100 d-flex align-items-center justify-content-between" type="button" data-bs-toggle="collapse" data-bs-target="#cmExampleHelp" aria-expanded="false">
                      <span><i class="bi bi-lightbulb me-2"></i>Example: Full Homebrew Monster</span>
                      <i class="bi bi-chevron-down"></i>
                    </button>
                    <div class="collapse mt-2" id="cmExampleHelp">
                      <div class="card card-body bg-secondary bg-opacity-25 border-info small" style="max-height: 300px; overflow-y: auto;">
                        <h6 class="text-info mb-2"><i class="bi bi-bookmark-star me-1"></i>Crystalwing Marauder</h6>
                        <p class="text-light mb-2">Here's an example homebrew monster using all available fields:</p>

                        <div class="mb-2">
                          <strong class="text-warning">Basic Info:</strong><br>
                          <span class="text-light">Name:</span> Crystalwing Marauder<br>
                          <span class="text-light">Size:</span> Large | <span class="text-light">Type:</span> Monstrosity | <span class="text-light">Subtype:</span> crystalline<br>
                          <span class="text-light">Alignment:</span> Chaotic Evil | <span class="text-light">CR:</span> 8 | <span class="text-light">Prof Bonus:</span> +3
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Combat Stats:</strong><br>
                          <span class="text-light">AC:</span> 17 (natural armor) | <span class="text-light">HP:</span> 136 (13d10+65)<br>
                          <span class="text-light">Speed:</span> 40 ft. walk, 60 ft. fly, 20 ft. climb
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Ability Scores:</strong><br>
                          STR 20 (+5) | DEX 14 (+2) | CON 20 (+5) | INT 8 (-1) | WIS 12 (+1) | CHA 16 (+3)
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Defenses:</strong><br>
                          <span class="text-light">Saves:</span> STR, CON, CHA<br>
                          <span class="text-light">Damage Resistances:</span> cold, lightning<br>
                          <span class="text-light">Damage Immunities:</span> radiant, poison<br>
                          <span class="text-light">Condition Immunities:</span> poisoned, frightened
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Skills & Senses:</strong><br>
                          <span class="text-light">Skills:</span> Perception, Intimidation<br>
                          <span class="text-light">Senses:</span> darkvision 120 ft., tremorsense 30 ft.<br>
                          <span class="text-light">Languages:</span> Primordial, understands Common but can't speak
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Special Abilities:</strong><br>
                          <em>Crystalline Body:</em> The marauder sheds bright light in a 10-foot radius and dim light for an additional 10 feet. When it takes damage, creatures within 5 feet must make a DC 15 DEX save or take 7 (2d6) piercing damage from crystal shards.<br>
                          <em>Magic Resistance:</em> The marauder has advantage on saving throws against spells and other magical effects.
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Spellcasting (Innate):</strong><br>
                          <span class="text-light">Ability:</span> Charisma | <span class="text-light">Spell DC:</span> 14 | <span class="text-light">Attack:</span> +6<br>
                          <span class="text-light">At will:</span> dancing lights, light<br>
                          <span class="text-light">3/day:</span> chromatic orb, color spray<br>
                          <span class="text-light">1/day:</span> prismatic spray
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Actions:</strong><br>
                          <em>Multiattack:</em> The marauder makes two claw attacks and one bite attack.<br>
                          <em>Bite:</em> +8 to hit, 2d10+5 piercing plus 2d6 radiant<br>
                          <em>Claw:</em> +8 to hit, 2d6+5 slashing<br>
                          <em>Crystal Breath (Recharge 5-6):</em> DC 16 DEX save, 8d6 radiant in 30-ft cone
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Bonus Actions:</strong><br>
                          <em>Refract:</em> The marauder bends light around itself, becoming invisible until the start of its next turn or until it attacks.
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Reactions:</strong><br>
                          <em>Shatter Shield:</em> When hit by an attack, the marauder can use its reaction to reduce damage by 1d10+5 and force the attacker to make a DC 15 DEX save or be blinded until the end of their next turn.
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Legendary Actions (3/round):</strong><br>
                          <em>Detect:</em> (1 action) The marauder makes a Perception check.<br>
                          <em>Wing Attack:</em> (2 actions) Each creature within 10 feet must succeed on a DC 16 DEX save or take 2d6+5 bludgeoning and be knocked prone. The marauder can then fly up to half its speed.<br>
                          <em>Blinding Flash:</em> (2 actions) The marauder emits a blinding pulse. Each creature within 30 feet must succeed on a DC 14 CON save or be blinded for 1 minute.
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Lair Actions (Initiative 20):</strong><br>
                          • Crystal spikes erupt from the ground. Each creature of the marauder's choice in contact with the ground must succeed on a DC 15 DEX save or take 3d6 piercing damage.<br>
                          • Light refracts through the lair's crystals. One creature the marauder can see must succeed on a DC 15 WIS save or be charmed until initiative count 20 of the next round.<br>
                          • The marauder causes a 20-foot-radius area to fill with dazzling prismatic light. Creatures in the area have disadvantage on attack rolls until initiative count 20 of the next round.
                        </div>

                        <div class="mb-2">
                          <strong class="text-warning">Regional Effects (1 mile radius):</strong><br>
                          • Crystal formations sprout from the ground within 1 mile. Moving through these areas costs 2 feet of movement for every 1 foot traveled.<br>
                          • Light within the region is intensified. Bright light extends 50% further from all sources, and darkness spells require a DC 15 check to cast successfully.<br>
                          • Creatures that finish a long rest within the region dream of glittering, labyrinthine caves and must succeed on a DC 12 WIS save or gain no benefit from the rest.
                        </div>

                        <div class="mt-2 pt-2 border-top border-secondary">
                          <span class="text-info"><i class="bi bi-info-circle me-1"></i>Tip:</span>
                          <span class="text-light">Not all fields are required! Use only what your monster needs. Simple enemies might just need AC, HP, and a few actions.</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="accordion accordion-flush" id="cmAccordion">

                    <!-- 1. Basic Info -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmBasic">
                          <i class="bi bi-card-heading me-2"></i>Basic Info
                        </button>
                      </h2>
                      <div id="cmBasic" class="accordion-collapse collapse show" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-2">
                            <div class="col-12"><input id="cm-name-full" class="form-control form-control-sm" placeholder="Monster Name *"></div>
                            <div class="col-6">
                              <select id="cm-size-full" class="form-select form-select-sm">
                                <option value="Tiny">Tiny</option>
                                <option value="Small">Small</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="Large">Large</option>
                                <option value="Huge">Huge</option>
                                <option value="Gargantuan">Gargantuan</option>
                              </select>
                            </div>
                            <div class="col-6"><input id="cm-type-full" class="form-control form-control-sm" placeholder="Type (e.g., Fiend)"></div>
                            <div class="col-6"><input id="cm-subtype" class="form-control form-control-sm" placeholder="Subtype (e.g., devil)"></div>
                            <div class="col-6">
                              <select id="cm-alignment" class="form-select form-select-sm">
                                <option value="">Alignment</option>
                                <option value="lawful good">Lawful Good</option>
                                <option value="neutral good">Neutral Good</option>
                                <option value="chaotic good">Chaotic Good</option>
                                <option value="lawful neutral">Lawful Neutral</option>
                                <option value="neutral">Neutral</option>
                                <option value="chaotic neutral">Chaotic Neutral</option>
                                <option value="lawful evil">Lawful Evil</option>
                                <option value="neutral evil">Neutral Evil</option>
                                <option value="chaotic evil">Chaotic Evil</option>
                                <option value="unaligned">Unaligned</option>
                                <option value="any alignment">Any Alignment</option>
                              </select>
                            </div>
                            <div class="col-6">
                              <select id="cm-cr-override" class="form-select form-select-sm">
                                <option value="">CR (auto-calc)</option>
                                <option value="0">CR 0</option>
                                <option value="0.125">CR 1/8</option>
                                <option value="0.25">CR 1/4</option>
                                <option value="0.5">CR 1/2</option>
                                <option value="1">CR 1</option>
                                <option value="2">CR 2</option>
                                <option value="3">CR 3</option>
                                <option value="4">CR 4</option>
                                <option value="5">CR 5</option>
                                <option value="6">CR 6</option>
                                <option value="7">CR 7</option>
                                <option value="8">CR 8</option>
                                <option value="9">CR 9</option>
                                <option value="10">CR 10</option>
                                <option value="11">CR 11</option>
                                <option value="12">CR 12</option>
                                <option value="13">CR 13</option>
                                <option value="14">CR 14</option>
                                <option value="15">CR 15</option>
                                <option value="16">CR 16</option>
                                <option value="17">CR 17</option>
                                <option value="18">CR 18</option>
                                <option value="19">CR 19</option>
                                <option value="20">CR 20</option>
                                <option value="21">CR 21</option>
                                <option value="22">CR 22</option>
                                <option value="23">CR 23</option>
                                <option value="24">CR 24</option>
                                <option value="25">CR 25</option>
                                <option value="26">CR 26</option>
                                <option value="27">CR 27</option>
                                <option value="28">CR 28</option>
                                <option value="29">CR 29</option>
                                <option value="30">CR 30</option>
                              </select>
                            </div>
                            <div class="col-6"><input id="cm-prof-bonus" class="form-control form-control-sm" type="number" placeholder="Prof Bonus (+2)"></div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 2. Combat Stats -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmCombat">
                          <i class="bi bi-shield-fill me-2"></i>Combat Stats
                        </button>
                      </h2>
                      <div id="cmCombat" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-2">
                            <div class="col-6"><input id="cm-ac-full" class="form-control form-control-sm" type="number" placeholder="AC *"></div>
                            <div class="col-6"><input id="cm-ac-type" class="form-control form-control-sm" placeholder="AC Type (natural armor)"></div>
                            <div class="col-6"><input id="cm-hp-full" class="form-control form-control-sm" type="number" placeholder="HP *"></div>
                            <div class="col-6"><input id="cm-hit-dice" class="form-control form-control-sm" placeholder="Hit Dice (8d10+24)"></div>
                          </div>
                          <div class="small text-secondary mt-2 mb-1">Speed</div>
                          <div class="row g-1">
                            <div class="col-4"><input id="cm-speed-walk" class="form-control form-control-sm" placeholder="Walk (30)"></div>
                            <div class="col-4"><input id="cm-speed-fly" class="form-control form-control-sm" placeholder="Fly"></div>
                            <div class="col-4"><input id="cm-speed-swim" class="form-control form-control-sm" placeholder="Swim"></div>
                            <div class="col-4"><input id="cm-speed-climb" class="form-control form-control-sm" placeholder="Climb"></div>
                            <div class="col-4"><input id="cm-speed-burrow" class="form-control form-control-sm" placeholder="Burrow"></div>
                            <div class="col-4">
                              <div class="form-check form-check-inline mt-1">
                                <input class="form-check-input" type="checkbox" id="cm-speed-hover">
                                <label class="form-check-label small" for="cm-speed-hover">Hover</label>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 3. Ability Scores -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmAbilities">
                          <i class="bi bi-bar-chart-fill me-2"></i>Ability Scores
                        </button>
                      </h2>
                      <div id="cmAbilities" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-1 text-center">
                            <div class="col-2">
                              <div class="small text-secondary">STR</div>
                              <input id="cm-str" class="form-control form-control-sm text-center" type="number" placeholder="10">
                              <div class="small text-muted" id="cm-str-mod">(+0)</div>
                            </div>
                            <div class="col-2">
                              <div class="small text-secondary">DEX</div>
                              <input id="cm-dex" class="form-control form-control-sm text-center" type="number" placeholder="10">
                              <div class="small text-muted" id="cm-dex-mod">(+0)</div>
                            </div>
                            <div class="col-2">
                              <div class="small text-secondary">CON</div>
                              <input id="cm-con" class="form-control form-control-sm text-center" type="number" placeholder="10">
                              <div class="small text-muted" id="cm-con-mod">(+0)</div>
                            </div>
                            <div class="col-2">
                              <div class="small text-secondary">INT</div>
                              <input id="cm-int" class="form-control form-control-sm text-center" type="number" placeholder="10">
                              <div class="small text-muted" id="cm-int-mod">(+0)</div>
                            </div>
                            <div class="col-2">
                              <div class="small text-secondary">WIS</div>
                              <input id="cm-wis" class="form-control form-control-sm text-center" type="number" placeholder="10">
                              <div class="small text-muted" id="cm-wis-mod">(+0)</div>
                            </div>
                            <div class="col-2">
                              <div class="small text-secondary">CHA</div>
                              <input id="cm-cha" class="form-control form-control-sm text-center" type="number" placeholder="10">
                              <div class="small text-muted" id="cm-cha-mod">(+0)</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 4. Proficiencies -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmProficiencies">
                          <i class="bi bi-award-fill me-2"></i>Saves & Skills
                        </button>
                      </h2>
                      <div id="cmProficiencies" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="small text-secondary mb-1">Saving Throws</div>
                          <input id="cm-saves" class="form-control form-control-sm mb-2" placeholder="Dex +5, Con +8, Wis +6">
                          <div class="small text-secondary mb-1">Skills</div>
                          <input id="cm-skills" class="form-control form-control-sm" placeholder="Perception +6, Stealth +5">
                        </div>
                      </div>
                    </div>

                    <!-- 5. Defenses -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmDefenses">
                          <i class="bi bi-shield-check me-2"></i>Defenses
                        </button>
                      </h2>
                      <div id="cmDefenses" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-2">
                            <div class="col-12">
                              <label class="small text-secondary">Damage Vulnerabilities</label>
                              <input id="cm-vulnerabilities" class="form-control form-control-sm" placeholder="radiant">
                            </div>
                            <div class="col-12">
                              <label class="small text-secondary">Damage Resistances</label>
                              <input id="cm-resistances" class="form-control form-control-sm" placeholder="cold, lightning; bludgeoning from nonmagical attacks">
                            </div>
                            <div class="col-12">
                              <label class="small text-secondary">Damage Immunities</label>
                              <input id="cm-damage-immunities" class="form-control form-control-sm" placeholder="fire, poison">
                            </div>
                            <div class="col-12">
                              <label class="small text-secondary">Condition Immunities</label>
                              <input id="cm-condition-immunities" class="form-control form-control-sm" placeholder="charmed, frightened, poisoned">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 6. Senses & Languages -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmSenses">
                          <i class="bi bi-eye-fill me-2"></i>Senses & Languages
                        </button>
                      </h2>
                      <div id="cmSenses" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-2">
                            <div class="col-12"><input id="cm-senses" class="form-control form-control-sm" placeholder="darkvision 120 ft., blindsight 30 ft., passive Perception 16"></div>
                            <div class="col-12"><input id="cm-languages" class="form-control form-control-sm" placeholder="Common, Infernal, telepathy 120 ft."></div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 7. Spellcasting -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmSpellcasting">
                          <i class="bi bi-stars me-2"></i>Spellcasting
                        </button>
                      </h2>
                      <div id="cmSpellcasting" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-2">
                            <div class="col-6">
                              <select id="cm-spell-ability" class="form-select form-select-sm">
                                <option value="">Spellcasting Ability</option>
                                <option value="int">Intelligence</option>
                                <option value="wis">Wisdom</option>
                                <option value="cha">Charisma</option>
                              </select>
                            </div>
                            <div class="col-3"><input id="cm-spell-dc" class="form-control form-control-sm" type="number" placeholder="DC"></div>
                            <div class="col-3"><input id="cm-spell-atk" class="form-control form-control-sm" placeholder="+Atk"></div>
                            <div class="col-12">
                              <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="cm-innate-spellcasting">
                                <label class="form-check-label small" for="cm-innate-spellcasting">Innate Spellcasting (no slots/components)</label>
                              </div>
                            </div>
                            <div class="col-12">
                              <label class="small text-secondary">Cantrips (at will)</label>
                              <input id="cm-cantrips" class="form-control form-control-sm" placeholder="fire bolt, mage hand, minor illusion">
                            </div>
                            <div class="col-12">
                              <label class="small text-secondary">Spells (one level per line: "1st (4 slots): spell, spell")</label>
                              <textarea id="cm-spells" rows="4" class="form-control form-control-sm" placeholder="1st (4 slots): burning hands, shield&#10;2nd (3 slots): hold person, misty step&#10;3rd (2 slots): counterspell, fireball"></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 8. Special Abilities / Traits -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmTraits">
                          <i class="bi bi-gem me-2"></i>Traits / Special Abilities
                        </button>
                      </h2>
                      <div id="cmTraits" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-special" rows="4" class="form-control form-control-sm" placeholder="Magic Resistance: Advantage on saving throws against spells.&#10;&#10;Pack Tactics: Advantage on attack rolls if an ally is within 5 ft."></textarea>
                          <div class="form-text small">Format: <code>Name: Description</code> (one per paragraph, blank line between)</div>
                        </div>
                      </div>
                    </div>

                    <!-- 9. Actions -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmActions">
                          <i class="bi bi-lightning-charge-fill me-2"></i>Actions
                        </button>
                      </h2>
                      <div id="cmActions" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-actions-full" rows="5" class="form-control form-control-sm" placeholder="Multiattack: The dragon makes three attacks: one bite and two claws.&#10;&#10;Bite; toHit:+11; damage:2d10+6; type:piercing&#10;&#10;Fire Breath (Recharge 5-6); saveDC:18; damage:12d6; type:fire; area:60 ft. cone"></textarea>
                          <div class="form-text small">
                            Attack format: <code>Name; toHit:+X; damage:XdX+X; type:slashing</code><br>
                            Save format: <code>Name; saveDC:X; damage:XdX; type:fire</code><br>
                            Optional: <code>range:X ft.</code>, <code>reach:X ft.</code>, <code>area:X</code>, <code>attacks:X</code>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 10. Bonus Actions -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmBonusActions">
                          <i class="bi bi-plus-circle-fill me-2"></i>Bonus Actions
                        </button>
                      </h2>
                      <div id="cmBonusActions" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-bonus-actions" rows="2" class="form-control form-control-sm" placeholder="Nimble Escape: The goblin can Disengage or Hide as a bonus action."></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 11. Reactions -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmReactions">
                          <i class="bi bi-arrow-repeat me-2"></i>Reactions
                        </button>
                      </h2>
                      <div id="cmReactions" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-reactions" rows="2" class="form-control form-control-sm" placeholder="Parry: The gladiator adds 3 to its AC against one melee attack."></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 12. Legendary Actions -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmLegendary">
                          <i class="bi bi-trophy-fill me-2"></i>Legendary Actions
                        </button>
                      </h2>
                      <div id="cmLegendary" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <div class="row g-2">
                            <div class="col-12">
                              <input id="cm-legendary-count" class="form-control form-control-sm" type="number" placeholder="Legendary Actions per Round (3)" value="3">
                            </div>
                            <div class="col-12">
                              <textarea id="cm-legendary" rows="3" class="form-control form-control-sm" placeholder="Detect: The dragon makes a Wisdom (Perception) check.&#10;&#10;Tail Attack (Costs 2 Actions): The dragon makes a tail attack.&#10;&#10;Wing Attack (Costs 2 Actions): Each creature within 10 ft. must succeed on a DC 19 DEX save or take 2d6+6 bludgeoning damage."></textarea>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- 13. Mythic Actions -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmMythic">
                          <i class="bi bi-star-fill me-2"></i>Mythic Actions
                        </button>
                      </h2>
                      <div id="cmMythic" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-mythic-trait" rows="2" class="form-control form-control-sm mb-2" placeholder="Mythic Trait Name: When reduced to 0 HP, the creature regains 200 HP and its mythic trait activates."></textarea>
                          <label class="small text-secondary">Mythic Actions (available when mythic trait is active)</label>
                          <textarea id="cm-mythic-actions" rows="2" class="form-control form-control-sm" placeholder="Mythic Slam (Costs 2 Actions): The creature makes a devastating slam attack."></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 14. Lair Actions -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmLair">
                          <i class="bi bi-house-fill me-2"></i>Lair Actions
                        </button>
                      </h2>
                      <div id="cmLair" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-lair-actions" rows="3" class="form-control form-control-sm" placeholder="On initiative count 20 (losing ties), the dragon takes a lair action:&#10;• Magma erupts from a point the dragon can see within 120 feet.&#10;• Volcanic gases form a cloud in a 20-foot radius sphere."></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 15. Regional Effects -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmRegional">
                          <i class="bi bi-globe-americas me-2"></i>Regional Effects
                        </button>
                      </h2>
                      <div id="cmRegional" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-regional-effects" rows="3" class="form-control form-control-sm" placeholder="The region containing the dragon's lair is warped by its presence:&#10;• Small earthquakes are common within 6 miles.&#10;• Water sources within 1 mile are supernaturally warm."></textarea>
                        </div>
                      </div>
                    </div>

                    <!-- 16. Description & Notes -->
                    <div class="accordion-item bg-dark border-secondary">
                      <h2 class="accordion-header">
                        <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#cmNotes">
                          <i class="bi bi-journal-text me-2"></i>Description & Notes
                        </button>
                      </h2>
                      <div id="cmNotes" class="accordion-collapse collapse" data-bs-parent="#cmAccordion">
                        <div class="accordion-body py-2">
                          <textarea id="cm-description" rows="2" class="form-control form-control-sm mb-2" placeholder="Physical description, lore, personality..."></textarea>
                          <textarea id="cm-notes" rows="2" class="form-control form-control-sm" placeholder="DM notes, tactics, encounter ideas..."></textarea>
                        </div>
                      </div>
                    </div>

                  </div><!-- /accordion -->
                </div><!-- /full-mode -->

                <hr class="my-2">

                <!-- Add/Clear Buttons -->
                <div class="d-flex justify-content-between gap-2">
                  <button id="cm-add" class="btn btn-sm btn-success flex-grow-1"><i class="bi bi-cart-plus me-1"></i>Add to Encounter</button>
                  <button id="cm-clear" class="btn btn-sm btn-outline-secondary">Clear</button>
                </div>

                <hr class="my-2">

                <!-- JSON Import (collapsed) -->
                <div class="accordion accordion-flush" id="jsonAccordion">
                  <div class="accordion-item bg-dark border-secondary">
                    <h2 class="accordion-header">
                      <button class="accordion-button collapsed bg-dark text-light small py-2" type="button" data-bs-toggle="collapse" data-bs-target="#jsonCollapse">
                        <i class="bi bi-code-slash me-2"></i>Import from JSON
                      </button>
                    </h2>
                    <div id="jsonCollapse" class="accordion-collapse collapse" data-bs-parent="#jsonAccordion">
                      <div class="accordion-body py-2">
                        <textarea id="cm-json" rows="4" class="form-control form-control-sm" placeholder='Single monster or array: {"name":"Shadow","type":"Undead","ac":12,"hp":16} or [{"name":"Wolf","ac":13,"hp":11}, ...]'></textarea>
                        <button id="cm-json-add" class="btn btn-sm btn-outline-info mt-2">Add JSON</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Right: Roster & Totals -->
          <div class="col-12 col-lg-4">
            <div class="card bg-dark border-secondary h-100">
              <div class="card-header d-flex align-items-center justify-content-between">
                <span class="fw-semibold"><i class="bi bi-list-ul me-1"></i>Encounter Roster</span>
                <span class="small text-secondary">Drag to reorder</span>
              </div>
              <div class="card-body">
                <ul id="eb-roster" class="list-group list-group-flush" style="max-height: 390px; overflow:auto;"></ul>
                <hr>
                <div id="eb-summary" class="small"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="footer-main py-3">
      <div class="container">
        <div class="row align-items-center text-center text-md-start">
          <!-- Left: Copyright -->
          <div class="col-12 col-md-4 mb-2 mb-md-0 text-md-start text-center">
            <small class="text-muted">&copy; 2025 Maybeme | The DM’s Toolbox</small>
          </div>

          <!-- Center: Logo -->
          <div class="col-12 col-md-4 text-center mb-2 mb-md-0">
            <img src="/images/White logo MM- no background.png" height="40" alt="Logo" class="footer-logo">
          </div>

          <!-- Right: Social Links + Settings -->
          <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end align-items-center gap-2">
            <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener" aria-label="LinkedIn">
              <i class="bi bi-linkedin"></i>
            </a>
            <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener" aria-label="GitHub">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://ko-fi.com/maybemestoolbox" class="socialicons d-flex align-items-center" target="_blank" rel="noopener" title="Support The DM's Toolbox on Ko-fi">
              <i class="bi bi-cup-hot"></i>
            </a>
            <button type="button" class="socialicons" onclick="window.toggleDiagnosticsPanel?.()"
                    title="Open Settings &amp; Diagnostics" aria-label="Open Settings and Diagnostics panel">
              <i class="bi bi-gear"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <script>
  (() => {
    // -------------------- Utilities --------------------
    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    // -------------------- Minimal CR/XP Tables --------------------
    const HP_BANDS = [
      { cr:0, min:1, max:6, expAC:13 }, { cr:0.125, min:7, max:35, expAC:13 }, { cr:0.25, min:36, max:49, expAC:13 }, { cr:0.5, min:50, max:70, expAC:13 },
      { cr:1, min:71, max:85, expAC:13 }, { cr:2, min:86, max:100, expAC:13 }, { cr:3, min:101, max:115, expAC:13 }, { cr:4, min:116, max:130, expAC:14 },
      { cr:5, min:131, max:145, expAC:15 }, { cr:6, min:146, max:160, expAC:15 }, { cr:7, min:161, max:175, expAC:15 }, { cr:8, min:176, max:190, expAC:16 },
      { cr:9, min:191, max:205, expAC:16 }, { cr:10, min:206, max:220, expAC:17 }, { cr:11, min:221, max:235, expAC:17 }, { cr:12, min:236, max:250, expAC:17 },
      { cr:13, min:251, max:265, expAC:18 }, { cr:14, min:266, max:280, expAC:18 }, { cr:15, min:281, max:295, expAC:18 }, { cr:16, min:296, max:310, expAC:19 },
      { cr:17, min:311, max:325, expAC:19 }, { cr:18, min:326, max:340, expAC:19 }, { cr:19, min:341, max:355, expAC:19 }, { cr:20, min:356, max:400, expAC:19 },
      { cr:21, min:401, max:445, expAC:19 }, { cr:22, min:446, max:490, expAC:19 }, { cr:23, min:491, max:535, expAC:19 }, { cr:24, min:536, max:580, expAC:19 },
      { cr:25, min:581, max:625, expAC:19 }, { cr:26, min:626, max:670, expAC:19 }, { cr:27, min:671, max:715, expAC:19 }, { cr:28, min:716, max:760, expAC:19 },
      { cr:29, min:761, max:805, expAC:19 }, { cr:30, min:806, max:850, expAC:19 }
    ];
    const DPR_BANDS = [
      { cr:0, min:0, max:1, expAtk:3, expDC:13 }, { cr:0.125, min:2, max:3, expAtk:3, expDC:13 }, { cr:0.25, min:4, max:5, expAtk:3, expDC:13 },
      { cr:0.5, min:6, max:8, expAtk:3, expDC:13 }, { cr:1, min:9, max:14, expAtk:3, expDC:13 }, { cr:2, min:15, max:20, expAtk:3, expDC:13 },
      { cr:3, min:21, max:26, expAtk:4, expDC:13 }, { cr:4, min:27, max:32, expAtk:5, expDC:14 }, { cr:5, min:33, max:38, expAtk:6, expDC:15 },
      { cr:6, min:39, max:44, expAtk:6, expDC:15 }, { cr:7, min:45, max:50, expAtk:6, expDC:15 }, { cr:8, min:51, max:56, expAtk:7, expDC:16 },
      { cr:9, min:57, max:62, expAtk:7, expDC:16 }, { cr:10, min:63, max:68, expAtk:7, expDC:16 }, { cr:11, min:69, max:74, expAtk:8, expDC:17 },
      { cr:12, min:75, max:80, expAtk:8, expDC:17 }, { cr:13, min:81, max:86, expAtk:8, expDC:18 }, { cr:14, min:87, max:92, expAtk:8, expDC:18 },
      { cr:15, min:93, max:98, expAtk:8, expDC:18 }, { cr:16, min:99, max:104, expAtk:9, expDC:18 }, { cr:17, min:105, max:110, expAtk:10, expDC:19 },
      { cr:18, min:111, max:116, expAtk:10, expDC:19 }, { cr:19, min:117, max:122, expAtk:10, expDC:19 }, { cr:20, min:123, max:140, expAtk:10, expDC:19 },
      { cr:21, min:141, max:158, expAtk:11, expDC:20 }, { cr:22, min:159, max:176, expAtk:11, expDC:20 }, { cr:23, min:177, max:194, expAtk:11, expDC:20 },
      { cr:24, min:195, max:212, expAtk:12, expDC:21 }, { cr:25, min:213, max:230, expAtk:12, expDC:21 }, { cr:26, min:231, max:248, expAtk:12, expDC:21 },
      { cr:27, min:249, max:266, expAtk:13, expDC:22 }, { cr:28, min:267, max:284, expAtk:13, expDC:22 }, { cr:29, min:285, max:302, expAtk:13, expDC:22 },
      { cr:30, min:303, max:320, expAtk:14, expDC:23 }
    ];
    const CR_XP = { "0":10,"0.125":25,"0.25":50,"0.5":100,"1":200,"2":450,"3":700,"4":1100,"5":1800,"6":2300,"7":2900,"8":3900,"9":5000,"10":5900,"11":7200,"12":8400,"13":10000,"14":11500,"15":13000,"16":15000,"17":18000,"18":20000,"19":22000,"20":25000 };
    const PARTY_THRESH = {
      1:{ easy:25,  med:50,   hard:75,   dead:100 },
      2:{ easy:50,  med:100,  hard:150,  dead:200 },
      3:{ easy:75,  med:150,  hard:225,  dead:400 },
      4:{ easy:125, med:250,  hard:375,  dead:500 },
      5:{ easy:250, med:500,  hard:750,  dead:1100 },
      6:{ easy:300, med:600,  hard:900,  dead:1400 },
      7:{ easy:350, med:750,  hard:1100, dead:1700 },
      8:{ easy:450, med:900,  hard:1400, dead:2100 },
      9:{ easy:550, med:1100, hard:1600, dead:2400 },
      10:{ easy:600, med:1200, hard:1900, dead:2800 },
      11:{ easy:800, med:1600, hard:2400, dead:3600 },
      12:{ easy:1000,med:2000, hard:3000, dead:4500 },
      13:{ easy:1100,med:2200, hard:3400, dead:5100 },
      14:{ easy:1250,med:2500, hard:3800, dead:5700 },
      15:{ easy:1400,med:2800, hard:4300, dead:6400 },
      16:{ easy:1600,med:3200, hard:4800, dead:7200 },
      17:{ easy:2000,med:3900, hard:5900, dead:8800 },
      18:{ easy:2100,med:4200, hard:6300, dead:9500 },
      19:{ easy:2400,med:4900, hard:7300, dead:10900 },
      20:{ easy:2800,med:5700, hard:8500, dead:12700 }
    };

    const STEPS = [0,0.125,0.25,0.5,...Array.from({length:30},(_,i)=>i+1)];

    function findBand(v, bands){
      for(const b of bands){ if(v>=b.min && v<=b.max) return b; }
      return v<bands[0].min?bands[0]:bands[bands.length-1];
    }

    // ---------- Dice & DPR helpers (improved) ----------
    function avgDice(expr){
      if(!expr) return 0; // supports "2d6+3 + 1d4"
      return expr.split('+').map(t=>t.trim()).reduce((s,term)=>{
        const m = term.match(/^(\d*)d(\d+)([+-]\d+)?$/i);
        if(!m){
          const n = Number(term);
          return s + (isNaN(n)?0:n);
        }
        const c = Number(m[1]||'1'), sides = Number(m[2]), mod = Number(m[3]||'0');
        return s + c*((sides+1)/2) + mod;
      },0);
    }

    const BASE_EXPECTED_AC = 15;   // simple baseline for hit chance
    const BASE_EXPECTED_DC = 15;   // simple baseline for save chance

    function hitChance(toHit, expAC = BASE_EXPECTED_AC){
      // P(hit) with nat 1 fail, nat 20 success
      const need = expAC - toHit;       // roll >= need
      const raw  = (21 - need) / 20;    // linear from d20
      return Math.max(0.05, Math.min(0.95, raw));
    }

    function failChance(dc, expDC = BASE_EXPECTED_DC){
      // baseline 60% fail at parity, ±5% per DC step
      const delta = (dc - expDC);
      const p = 0.60 + 0.05 * delta;
      return Math.max(0.05, Math.min(0.95, p));
    }

    function usageFrequencyFromText(name = "", desc = ""){
      const text = `${name} ${desc}`.toLowerCase();
      // recharge
      if (/recharge\s*6/.test(text)) return 1/6;
      if (/recharge\s*5[-–—]?\s*6/.test(text)) return 1/3;
      // per-day style
      const mPerDay = text.match(/(\d)\s*\/\s*day/);
      if (mPerDay) {
        const n = Number(mPerDay[1]||'1');
        return Math.max(1/10, Math.min(1, n/10)); // rough: assume 10 rounds budget
      }
      if (/once\s+per\s+day/.test(text)) return 1/10;
      return 1; // at-will or default
    }

    function estimateDPR(mon){
      if(!mon.actions || !mon.actions.length) return 0;
      let d = 0;

      for(const a of mon.actions){
        const base = (typeof a.avgDamage === 'number' ? a.avgDamage : avgDice(a.damage||'')) || 0;
        if (!base) continue; // ignore non-damaging (e.g., pure Multiattack text)

        const swings  = Math.max(1, Number(a.attacksPerAction||1));
        const targets = Math.max(1, Number(a.targetCount||1));
        const freq    = usageFrequencyFromText(a.name, a.desc || "");

        // Prefer to-hit math if present; else use save math if present; else raw
        let effectiveEach = base;
        if (typeof a.toHit === 'number') {
          const p = hitChance(a.toHit, BASE_EXPECTED_AC);
          effectiveEach = base * p;
        } else if (typeof a.saveDC === 'number') {
          const pFail = failChance(a.saveDC, BASE_EXPECTED_DC);
          effectiveEach = base * pFail;
        }

        d += effectiveEach * swings * targets * freq;
      }
      return Math.round(d);
    }

    function defensiveCR(mon, resistMode){
      let effHP = mon.hp||1;
      if(resistMode==='resist'){
        const mult = mon.cr && mon.cr<=4 ? 1.5 : 1.25;
        effHP = Math.round(effHP*mult);
      } else if(resistMode==='heavy'){
        const mult = mon.cr && mon.cr<=4 ? 2.0 : 1.5;
        effHP = Math.round(effHP*mult);
      }
      const band = findBand(effHP, HP_BANDS);
      let cr = band.cr;
      const acDiff = (mon.ac??10) - (band.expAC??13);
      cr += (acDiff/2);
      return Math.max(0, cr);
    }

    function offensiveCR(mon){
      const dpr = estimateDPR(mon);
      const band = findBand(dpr, DPR_BANDS);
      let cr = band.cr;

      // fine-tune for listed attack bonus / save DC vs expected
      const atkList = (mon.actions||[]).filter(a=>typeof a.toHit==='number').map(a=>a.toHit);
      const dcList  = (mon.actions||[]).filter(a=>typeof a.saveDC==='number').map(a=>a.saveDC);

      if(atkList.length){
        const atk = Math.max(...atkList);
        cr += ((atk - (band.expAtk??3))/2);
      } else if(dcList.length){
        const dc = Math.max(...dcList);
        cr += ((dc - (band.expDC??13))/2);
      }
      return Math.max(0, cr);
    }

    function roundCR(x){
      let best=STEPS[0], diff=Infinity;
      for(const s of STEPS){ const d=Math.abs(s-x); if(d<diff){best=s; diff=d;} }
      return best;
    }

    // XP / multipliers
    function crToXp(cr){ return CR_XP[String(cr)] ?? 0; }

    // === Monster count bucket + party size adjustment (DMG-style) ===
    function monsterCountBucket(n){
      if (n <= 1) return 0;       // ×1
      if (n === 2) return 1;      // ×1.5
      if (n <= 6) return 2;       // ×2
      if (n <= 10) return 3;      // ×2.5
      if (n <= 14) return 4;      // ×3
      return 5;                   // ×4
    }
    const MULTIPLIERS = [1, 1.5, 2, 2.5, 3, 4];

    function partySizeAdjBucket(partySize){
      if (partySize <= 3) return +1;  // harder
      if (partySize >= 6) return -1;  // easier
      return 0;                       // 4–5 PCs
    }
    function adjustedMultiplier(monsterCount, partySize){
      const baseIdx = monsterCountBucket(monsterCount);
      const adj     = partySizeAdjBucket(partySize);
      const idx     = Math.max(0, Math.min(MULTIPLIERS.length - 1, baseIdx + adj));
      return MULTIPLIERS[idx];
    }

    function thresholdsForParty(levels){
      const sums = {easy:0,med:0,hard:0,dead:0};
      for(const lv of levels){
        const t = PARTY_THRESH[lv];
        if(!t) continue;
        sums.easy+=t.easy; sums.med+=t.med; sums.hard+=t.hard; sums.dead+=t.dead;
      }
      return sums;
    }

    // -------------------- State --------------------
    let SRD_INDEX = [];      // [{index,name,url}]
    const SRD_META = new Map(); // index -> {cr, type}
    const roster = [];       // [{...monsterCore, qty, calc:{offCR,defCR,cr}}]
    let partyLevels = [];
    let resistMode = 'none';

    // -------------------- SRD fetch & search --------------------
    async function loadSrdList(){
      const res = await fetch('https://www.dnd5eapi.co/api/monsters');
      if(!res.ok) throw new Error('Failed to load SRD monster index');
      const data = await res.json();
      SRD_INDEX = (data.results || []);
    }
    async function fetchSrdMonster(index){
      const res = await fetch(`https://www.dnd5eapi.co/api/monsters/${index}`);
      if(!res.ok) throw new Error('SRD monster fetch failed');
      const m = await res.json();
      // normalize
      const ac = Array.isArray(m.armor_class) ? (m.armor_class[0]?.value ?? 10) : (m.armor_class ?? 10);
      const speed = (typeof m.speed === 'object') ? Object.entries(m.speed).map(([k,v]) => `${k} ${v}`).join(', ') : (m.speed||'');
      const actions = (m.actions||[]).map(a=>({
        name:a.name,
        desc:a.desc || "",
        toHit: (typeof a.attack_bonus==='number' ? a.attack_bonus : undefined),
        saveDC: (a.dc?.dc_value ?? undefined),
        damage: (a.damage && a.damage.length) ? a.damage.map(d=>d.damage_dice).filter(Boolean).join(' + ') : undefined,
        avgDamage: undefined,
        // keep Multiattack from falsely inflating swings (it has no damage dice)
        attacksPerAction: /multiattack/i.test(a.name) ? undefined : 1
      }));
      const special_abilities = (m.special_abilities||[]).map(sa=>({
        name: sa.name,
        desc: sa.desc || ""
      }));
      const legendary_actions = (m.legendary_actions||[]).map(la=>({
        name: la.name,
        desc: la.desc || ""
      }));
      const reactions = (m.reactions||[]).map(r=>({
        name: r.name,
        desc: r.desc || ""
      }));
      const cr = (typeof m.challenge_rating === 'number') ? m.challenge_rating : Number(m.challenge_rating);
      return {
        name:m.name, type:m.type, size:m.size, cr: isNaN(cr)?undefined:cr, ac, hp:m.hit_points||1, speed,
        actions, special_abilities, legendary_actions, reactions, notes:''
      };
    }

    // meta cache + concurrency-limited enrichment
    async function getMeta(index){
      if (SRD_META.has(index)) return SRD_META.get(index);
      const metaFull = await fetchSrdMonster(index);
      const slim = { cr: metaFull.cr, type: (metaFull.type || '') };
      SRD_META.set(index, slim);
      return slim;
    }

    // -------------------- Stat Block Preview Tooltip --------------------
    let currentPreview = null;
    let previewTimeout = null;

    function createStatBlockPreview(monster) {
      const div = document.createElement('div');
      div.className = 'stat-block-preview';

      let html = `
        <div class="preview-header">${monster.name}</div>
        <div class="preview-subtitle">${monster.size || ''} ${monster.type || ''}, CR ${monster.cr ?? '—'}</div>
        <div class="stat-line"><span class="stat-label">AC:</span> ${monster.ac ?? '—'}</div>
        <div class="stat-line"><span class="stat-label">HP:</span> ${monster.hp ?? '—'}</div>
        <div class="stat-line"><span class="stat-label">Speed:</span> ${monster.speed || '—'}</div>
      `;

      // Special Abilities
      if (monster.special_abilities && monster.special_abilities.length > 0) {
        html += '<div class="section-header">Special Abilities</div>';
        monster.special_abilities.forEach(sa => {
          html += `<div class="action-block">
            <div class="action-name">${sa.name}</div>
            <div class="action-desc">${sa.desc}</div>
          </div>`;
        });
      }

      // Actions
      if (monster.actions && monster.actions.length > 0) {
        html += '<div class="section-header">Actions</div>';
        monster.actions.forEach(action => {
          const attackInfo = [];
          if (action.toHit !== undefined) attackInfo.push(`+${action.toHit} to hit`);
          if (action.saveDC !== undefined) attackInfo.push(`DC ${action.saveDC}`);
          if (action.damage) attackInfo.push(`${action.damage} damage`);

          const attackLine = attackInfo.length > 0 ? ` (${attackInfo.join(', ')})` : '';

          html += `<div class="action-block">
            <div class="action-name">${action.name}${attackLine}</div>
            <div class="action-desc">${action.desc}</div>
          </div>`;
        });
      }

      // Reactions
      if (monster.reactions && monster.reactions.length > 0) {
        html += '<div class="section-header">Reactions</div>';
        monster.reactions.forEach(r => {
          html += `<div class="action-block">
            <div class="action-name">${r.name}</div>
            <div class="action-desc">${r.desc}</div>
          </div>`;
        });
      }

      // Legendary Actions
      if (monster.legendary_actions && monster.legendary_actions.length > 0) {
        html += '<div class="section-header">Legendary Actions</div>';
        monster.legendary_actions.forEach(la => {
          html += `<div class="action-block">
            <div class="action-name">${la.name}</div>
            <div class="action-desc">${la.desc}</div>
          </div>`;
        });
      }

      div.innerHTML = html;
      return div;
    }

    function showPreview(element, monster) {
      clearTimeout(previewTimeout);
      hidePreview();

      currentPreview = createStatBlockPreview(monster);
      document.body.appendChild(currentPreview);

      // Position the preview
      const rect = element.getBoundingClientRect();
      const previewRect = currentPreview.getBoundingClientRect();

      let left = rect.right + 10;
      let top = rect.top;

      // Adjust if goes off right side
      if (left + previewRect.width > window.innerWidth) {
        left = rect.left - previewRect.width - 10;
      }

      // Adjust if goes off bottom
      if (top + previewRect.height > window.innerHeight) {
        top = window.innerHeight - previewRect.height - 10;
      }

      // Adjust if goes off top
      if (top < 0) {
        top = 10;
      }

      currentPreview.style.left = `${left}px`;
      currentPreview.style.top = `${top}px`;
    }

    function hidePreview() {
      if (currentPreview) {
        currentPreview.remove();
        currentPreview = null;
      }
    }

    function scheduleHidePreview() {
      previewTimeout = setTimeout(hidePreview, 200);
    }
    async function mapLimit(items, limit, fn) {
      const ret = new Array(items.length);
      let i = 0;
      async function worker() {
        while (i < items.length) {
          const cur = i++;
          ret[cur] = await fn(items[cur], cur);
        }
      }
      const workers = Array.from({ length: Math.min(limit, items.length) }, worker);
      await Promise.all(workers);
      return ret;
    }

    async function renderResults(){
      const q   = ($('#eb-search')?.value||'').toLowerCase().trim();
      const crf = $('#eb-cr-filter')?.value || '';
      const tf  = $('#eb-type-filter')?.value || '';
      const wrap = $('#eb-results'); if(!wrap) return;

      wrap.innerHTML = '<div class="text-secondary p-2">Loading…</div>';

      // 1) name search against index (fast)
      let list = SRD_INDEX.slice();
      if (q) {
        list = list.filter(x =>
          x.name.toLowerCase().includes(q) ||
          x.index.toLowerCase().includes(q)
        );
      }

      // 2) no filters -> render first 200 quickly
      if (!crf && !tf) {
        wrap.innerHTML = '';
        list.slice(0,200).forEach(it=>{
          const a = document.createElement('a');
          a.href="#"; a.className='list-group-item list-group-item-action bg-dark text-light monster-preview-trigger';
          a.textContent = it.name;
          a.dataset.index = it.index;
          a.onclick = async (e)=>{ e.preventDefault(); addToRoster(await fetchSrdMonster(it.index)); };

          // Add hover preview
          let hoverMonster = null;
          a.addEventListener('mouseenter', async function() {
            if (!hoverMonster) {
              hoverMonster = await fetchSrdMonster(it.index);
            }
            showPreview(this, hoverMonster);
          });
          a.addEventListener('mouseleave', scheduleHidePreview);

          wrap.appendChild(a);
        });
        if (!wrap.children.length) {
          wrap.innerHTML = '<div class="text-secondary p-2">No results.</div>';
        }
        return;
      }

      // 3) pre-enrich with meta (concurrency-limited)
      const cap = 400; // keep snappy
      const slice = list.slice(0, cap);
      try {
        await mapLimit(slice, 12, async (it) => {
          const meta = await getMeta(it.index);
          it._cr   = meta.cr;
          it._type = (meta.type || '');
        });
      } catch (err) {
        console.warn('Meta prefetch failed:', err);
      }

      // 4) filter by CR / Type
      let filtered = slice;
      if (crf) filtered = filtered.filter(it => String(it._cr) === crf);
      if (tf)  filtered = filtered.filter(it => it._type.toLowerCase() === tf.toLowerCase());

      // 5) render
      wrap.innerHTML = '';
      filtered.slice(0,200).forEach(it=>{
        const a = document.createElement('a');
        a.href="#"; a.className='list-group-item list-group-item-action bg-dark text-light monster-preview-trigger';
        a.textContent = it.name;
        a.dataset.index = it.index;
        a.onclick = async (e)=>{ e.preventDefault(); addToRoster(await fetchSrdMonster(it.index)); };

        // Add hover preview
        let hoverMonster = null;
        a.addEventListener('mouseenter', async function() {
          if (!hoverMonster) {
            hoverMonster = await fetchSrdMonster(it.index);
          }
          showPreview(this, hoverMonster);
        });
        a.addEventListener('mouseleave', scheduleHidePreview);

        wrap.appendChild(a);
      });
      if (!wrap.children.length) {
        const msgParts = [];
        if (q)   msgParts.push(`query "${q}"`);
        if (crf) msgParts.push(`CR ${crf}`);
        if (tf)  msgParts.push(`type ${tf}`);
        const msg = msgParts.length ? msgParts.join(', ') : 'your filters';
        wrap.innerHTML = `<div class="text-secondary p-2">No monsters match ${msg}. Try clearing a filter.</div>`;
      }
    }

    // -------------------- Roster --------------------
    function addToRoster(mon){
      const calc = computeCR(mon);
      roster.push({...mon, qty:1, calc});
      renderRoster();
    }
    function computeCR(mon){
      const off = offensiveCR(mon);
      const def = defensiveCR(mon, resistMode);
      const raw = (off+def)/2;
      const cr = roundCR(raw);
      return { cr, offCR: Math.round(off*100)/100, defCR: Math.round(def*100)/100, raw: Math.round(raw*100)/100 };
    }
    function parseActionsQuick(text){
      // Lines like: "Claw; toHit:+5; damage:2d6+3; attacks:2; targets:1"
      return text.split('\n').map(l=>l.trim()).filter(Boolean).map(line=>{
        const [namePart, ...rest] = line.split(';').map(s=>s.trim());
        const obj = { name:namePart || 'Action' };
        for(const part of rest){
          const [k,v] = part.split(':').map(s=>s.trim());
          if(!k) continue;
          if(k==='toHit') obj.toHit = Number(v);
          else if(k==='saveDC') obj.saveDC = Number(v);
          else if(k==='damage') obj.damage = v;
          else if(k==='attacks') obj.attacksPerAction = Number(v);
          else if(k==='targets') obj.targetCount = Number(v);
          else if(k==='avg') obj.avgDamage = Number(v);
        }
        return obj;
      });
    }

    function renderRoster(){
      const ul = $('#eb-roster'); if(!ul) return;
      ul.innerHTML='';
      roster.forEach((m, idx)=>{
        const li = document.createElement('li');
        li.className='list-group-item bg-dark text-light border-secondary';

        // Build action summary
        let actionSummary = '';
        if (m.actions && m.actions.length > 0) {
          const actionNames = m.actions.slice(0, 3).map(a => a.name).join(', ');
          const remaining = m.actions.length > 3 ? ` +${m.actions.length - 3} more` : '';
          actionSummary = `<div class="small text-info mt-1"><i class="bi bi-lightning-charge"></i> ${actionNames}${remaining}</div>`;
        }

        li.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex: 1;">
              <div class="fw-semibold">${m.name} <span class="text-secondary">(${m.type||'—'}${m.size?`, ${m.size}`:''})</span></div>
              <div class="small text-secondary">AC ${m.ac ?? '—'} • HP ${m.hp ?? '—'} • CR ${m.calc?.cr ?? (m.cr ?? '—')}
                <span class="ms-2">[off ${m.calc?.offCR ?? '—'} / def ${m.calc?.defCR ?? '—'}]</span>
              </div>
              ${actionSummary}
              <button class="btn btn-sm btn-link text-warning p-0 mt-1" data-role="toggle" data-i="${idx}">
                <i class="bi bi-chevron-down"></i> Show Details
              </button>
              <div class="roster-expanded" style="display:none;" data-i="${idx}"></div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <input class="form-control form-control-sm" type="number" min="1" value="${m.qty}" style="width:70px" data-role="qty" data-i="${idx}">
              <button class="btn btn-sm btn-outline-info" title="Recalc" data-role="recalc" data-i="${idx}"><i class="bi bi-arrow-clockwise"></i></button>
              <button class="btn btn-sm btn-outline-danger" title="Remove" data-role="del" data-i="${idx}"><i class="bi bi-x-lg"></i></button>
            </div>
          </div>`;
        ul.appendChild(li);
      });
      // Wire buttons
      ul.querySelectorAll('button[data-role="del"]').forEach(b=> b.onclick = e=>{
        const i = Number(e.currentTarget.dataset.i);
        roster.splice(i,1); renderRoster();
      });
      ul.querySelectorAll('button[data-role="recalc"]').forEach(b=> b.onclick = e=>{
        const i = Number(e.currentTarget.dataset.i);
        roster[i].calc = computeCR(roster[i]); renderRoster();
      });
      ul.querySelectorAll('input[data-role="qty"]').forEach(inp => inp.oninput = e=>{
        const i = Number(e.currentTarget.dataset.i);
        const v = Math.max(1, Number(e.currentTarget.value||1));
        roster[i].qty = v; renderSummary();
      });

      // Wire toggle details buttons
      ul.querySelectorAll('button[data-role="toggle"]').forEach(btn => btn.onclick = e => {
        const i = Number(e.currentTarget.dataset.i);
        const expanded = ul.querySelector(`.roster-expanded[data-i="${i}"]`);
        const icon = e.currentTarget.querySelector('i');

        if (expanded.style.display === 'none') {
          // Show details
          expanded.style.display = 'block';
          e.currentTarget.innerHTML = '<i class="bi bi-chevron-up"></i> Hide Details';

          // Build detailed view
          const m = roster[i];
          let html = '';

          // Ability scores (if available)
          if (m.str || m.dex || m.con || m.int || m.wis || m.cha) {
            html += '<div class="mt-2 mb-2"><div class="fw-bold text-warning mb-1">Ability Scores</div>';
            html += '<div class="small">';
            if (m.str) html += `STR ${m.str} `;
            if (m.dex) html += `DEX ${m.dex} `;
            if (m.con) html += `CON ${m.con} `;
            if (m.int) html += `INT ${m.int} `;
            if (m.wis) html += `WIS ${m.wis} `;
            if (m.cha) html += `CHA ${m.cha}`;
            html += '</div></div>';
          }

          // Saves, skills, senses
          if (m.saves) html += `<div class="small mt-1"><span class="fw-bold text-warning">Saving Throws:</span> ${m.saves}</div>`;
          if (m.skills) html += `<div class="small mt-1"><span class="fw-bold text-warning">Skills:</span> ${m.skills}</div>`;
          if (m.senses) html += `<div class="small mt-1"><span class="fw-bold text-warning">Senses:</span> ${m.senses}</div>`;
          if (m.speed) html += `<div class="small mt-1"><span class="fw-bold text-warning">Speed:</span> ${m.speed}</div>`;

          // Special Abilities
          if (m.special_abilities && m.special_abilities.length > 0) {
            html += '<div class="fw-bold text-warning mt-2 mb-1">Special Abilities</div>';
            html += '<div class="roster-actions">';
            m.special_abilities.forEach(sa => {
              html += `<div class="roster-action-item">
                <div class="fw-semibold">${sa.name}</div>
                <div class="small text-secondary">${sa.desc || ''}</div>
              </div>`;
            });
            html += '</div>';
          }

          // Actions
          if (m.actions && m.actions.length > 0) {
            html += '<div class="fw-bold text-warning mt-2 mb-1">Actions</div>';
            html += '<div class="roster-actions">';
            m.actions.forEach(action => {
              const attackInfo = [];
              if (action.toHit !== undefined) attackInfo.push(`+${action.toHit} to hit`);
              if (action.saveDC !== undefined) attackInfo.push(`DC ${action.saveDC}`);
              if (action.damage) attackInfo.push(`${action.damage} damage`);
              const attackLine = attackInfo.length > 0 ? ` <span class="text-info">(${attackInfo.join(', ')})</span>` : '';

              html += `<div class="roster-action-item">
                <div class="fw-semibold">${action.name}${attackLine}</div>
                <div class="small text-secondary">${action.desc || ''}</div>
              </div>`;
            });
            html += '</div>';
          }

          // Reactions
          if (m.reactions && m.reactions.length > 0) {
            html += '<div class="fw-bold text-warning mt-2 mb-1">Reactions</div>';
            html += '<div class="roster-actions">';
            m.reactions.forEach(r => {
              html += `<div class="roster-action-item">
                <div class="fw-semibold">${r.name}</div>
                <div class="small text-secondary">${r.desc || ''}</div>
              </div>`;
            });
            html += '</div>';
          }

          // Legendary Actions
          if (m.legendary_actions && m.legendary_actions.length > 0) {
            html += '<div class="fw-bold text-warning mt-2 mb-1">Legendary Actions</div>';
            html += '<div class="roster-actions">';
            m.legendary_actions.forEach(la => {
              html += `<div class="roster-action-item">
                <div class="fw-semibold">${la.name}</div>
                <div class="small text-secondary">${la.desc || ''}</div>
              </div>`;
            });
            html += '</div>';
          }

          expanded.innerHTML = html || '<div class="text-secondary">No additional details available.</div>';
        } else {
          // Hide details
          expanded.style.display = 'none';
          e.currentTarget.innerHTML = '<i class="bi bi-chevron-down"></i> Show Details';
        }
      });
      renderSummary();
      // Drag sort
      if(window.Sortable && !ul._sortable){
        ul._sortable = Sortable.create(ul, {
          animation: 150,
          onEnd: evt => {
            const [m] = roster.splice(evt.oldIndex,1);
            roster.splice(evt.newIndex,0,m);
            renderRoster();
          }
        });
      }
    }

    function renderSummary(){
      const party = parsePartyLevels();
      const t = thresholdsForParty(party);
      // XP calc with multiplier
      let baseXP=0, count=0;
      roster.forEach(m=>{
        const xpEach = crToXp(m.calc?.cr ?? m.cr ?? 0);
        baseXP += xpEach * (m.qty||1);
        count  += (m.qty||1);
      });
      const mult  = adjustedMultiplier(count, party.length || 0);
      const adjXP = Math.round(baseXP * mult);
      const diff = (!party.length) ? '—' :
        (adjXP < t.easy ? 'Trivial' :
         adjXP < t.med  ? 'Easy'    :
         adjXP < t.hard ? 'Medium'  :
         adjXP < t.dead ? 'Hard'    : 'Deadly');
      const partyAdjNote = (party.length && (party.length <= 3 || party.length >= 6))
        ? ` <span class="text-secondary">(party-size adjusted)</span>` : '';
      $('#eb-summary').innerHTML = `
        <div><strong>Monsters:</strong> ${count} • <strong>Base XP:</strong> ${baseXP} • <strong>Multiplier:</strong> ×${mult}${partyAdjNote}</div>
        <div><strong>Adjusted XP:</strong> ${adjXP} • <strong>Difficulty:</strong> ${diff}</div>`;
    }

    // -------------------- Party --------------------
    function parsePartyLevels(){
      const raw = ($('#eb-party-levels')?.value||'')
        .replace(/[,]/g,' ')
        .split(/\s+/).map(x=>x.trim()).filter(Boolean).map(Number).filter(n=>n>0&&n<=20);
      partyLevels = raw;
      return raw;
    }
    function renderPartySummary(){
      const lv = parsePartyLevels();
      const t = thresholdsForParty(lv);
      $('#eb-party-summary').textContent =
        lv.length ? `Party: [${lv.join(', ')}] • Thresholds → Easy ${t.easy}, Medium ${t.med}, Hard ${t.hard}, Deadly ${t.dead}` :
                    'No party set.';
    }

    // -------------------- Custom Monster --------------------
    function parseSpecialAbilities(text){
      // Parse "Name: Description" format
      return text.split('\n').map(l=>l.trim()).filter(Boolean).map(line=>{
        const idx = line.indexOf(':');
        if(idx === -1) return { name: line, desc: '' };
        return {
          name: line.substring(0, idx).trim(),
          desc: line.substring(idx + 1).trim()
        };
      });
    }

    // Check which mode is active (Simple or Full)
    function isFullMode() {
      return $('#cm-full-mode').style.display !== 'none';
    }

    // Build speed string from individual fields
    function buildSpeedString() {
      const parts = [];
      const walk = $('#cm-speed-walk')?.value?.trim();
      const fly = $('#cm-speed-fly')?.value?.trim();
      const swim = $('#cm-speed-swim')?.value?.trim();
      const climb = $('#cm-speed-climb')?.value?.trim();
      const burrow = $('#cm-speed-burrow')?.value?.trim();
      const hover = $('#cm-speed-hover')?.checked;

      if (walk) parts.push(`${walk} ft.`);
      if (fly) parts.push(`fly ${fly} ft.${hover ? ' (hover)' : ''}`);
      if (swim) parts.push(`swim ${swim} ft.`);
      if (climb) parts.push(`climb ${climb} ft.`);
      if (burrow) parts.push(`burrow ${burrow} ft.`);

      return parts.join(', ') || '30 ft.';
    }

    // Build spellcasting object from form fields
    function buildSpellcasting() {
      const ability = $('#cm-spell-ability')?.value;
      const dc = $('#cm-spell-dc')?.value?.trim();
      const atk = $('#cm-spell-atk')?.value?.trim();
      const innate = $('#cm-innate-spellcasting')?.checked;
      const cantrips = $('#cm-cantrips')?.value?.trim();
      const spells = $('#cm-spells')?.value?.trim();

      if (!ability && !dc && !cantrips && !spells) return null;

      return {
        ability: ability || undefined,
        dc: dc ? Number(dc) : undefined,
        attack: atk ? Number(atk) : undefined,
        innate: innate || undefined,
        cantrips: cantrips || undefined,
        spells: spells || undefined
      };
    }

    function readCustomForm(){
      // Determine which mode we're in
      const fullMode = isFullMode();

      // Basic fields - read from appropriate source based on mode
      const name = fullMode
        ? ($('#cm-name-full')?.value?.trim() || '')
        : ($('#cm-name')?.value?.trim() || '');
      const type = fullMode
        ? ($('#cm-type-full')?.value?.trim() || '—')
        : ($('#cm-type')?.value?.trim() || '—');
      const size = fullMode
        ? ($('#cm-size-full')?.value || 'Medium')
        : ($('#cm-size')?.value || 'Medium');
      const ac = fullMode
        ? Number($('#cm-ac-full')?.value || '0')
        : Number($('#cm-ac')?.value || '0');
      const hp = fullMode
        ? Number($('#cm-hp-full')?.value || '1')
        : Number($('#cm-hp')?.value || '1');
      const speed = fullMode
        ? buildSpeedString()
        : ($('#cm-speed')?.value?.trim() || '30 ft.');

      // Actions - read from appropriate textarea
      const actionsText = fullMode
        ? ($('#cm-actions-full')?.value || '')
        : ($('#cm-actions')?.value || '');
      const actions = parseActionsQuick(actionsText);

      // Other action types
      const special_abilities = parseSpecialAbilities($('#cm-special')?.value || '');
      const bonus_actions = parseSpecialAbilities($('#cm-bonus-actions')?.value || '');
      const reactions = parseSpecialAbilities($('#cm-reactions')?.value || '');
      const legendary_actions = parseSpecialAbilities($('#cm-legendary')?.value || '');
      const notes = $('#cm-notes')?.value?.trim() || '';

      // Build the base monster object
      const mon = {
        name, type, size, ac, hp, speed, actions,
        special_abilities, reactions, legendary_actions, notes
      };

      // Add bonus actions if present
      if (bonus_actions.length > 0) mon.bonus_actions = bonus_actions;

      // Full mode exclusive fields
      if (fullMode) {
        // Subtype and alignment
        const subtype = $('#cm-subtype')?.value?.trim();
        const alignment = $('#cm-alignment')?.value;
        if (subtype) mon.subtype = subtype;
        if (alignment) mon.alignment = alignment;

        // CR override
        const crOverride = $('#cm-cr-override')?.value;
        if (crOverride) mon.cr_override = Number(crOverride);

        // Proficiency bonus
        const profBonus = $('#cm-prof-bonus')?.value?.trim();
        if (profBonus) mon.proficiency_bonus = Number(profBonus);

        // AC type and hit dice
        const acType = $('#cm-ac-type')?.value?.trim();
        const hitDice = $('#cm-hit-dice')?.value?.trim();
        if (acType) mon.ac_type = acType;
        if (hitDice) mon.hit_dice = hitDice;

        // Defenses
        const vulnerabilities = $('#cm-vulnerabilities')?.value?.trim();
        const resistances = $('#cm-resistances')?.value?.trim();
        const damageImmunities = $('#cm-damage-immunities')?.value?.trim();
        const conditionImmunities = $('#cm-condition-immunities')?.value?.trim();
        if (vulnerabilities) mon.damage_vulnerabilities = vulnerabilities;
        if (resistances) mon.damage_resistances = resistances;
        if (damageImmunities) mon.damage_immunities = damageImmunities;
        if (conditionImmunities) mon.condition_immunities = conditionImmunities;

        // Languages
        const languages = $('#cm-languages')?.value?.trim();
        if (languages) mon.languages = languages;

        // Spellcasting
        const spellcasting = buildSpellcasting();
        if (spellcasting) mon.spellcasting = spellcasting;

        // Legendary action count
        const legendaryCount = $('#cm-legendary-count')?.value?.trim();
        if (legendaryCount) mon.legendary_action_count = Number(legendaryCount);

        // Mythic trait and actions
        const mythicTrait = $('#cm-mythic-trait')?.value?.trim();
        const mythicActions = parseSpecialAbilities($('#cm-mythic-actions')?.value || '');
        if (mythicTrait) mon.mythic_trait = mythicTrait;
        if (mythicActions.length > 0) mon.mythic_actions = mythicActions;

        // Lair actions and regional effects
        const lairActions = $('#cm-lair-actions')?.value?.trim();
        const regionalEffects = $('#cm-regional-effects')?.value?.trim();
        if (lairActions) mon.lair_actions = lairActions;
        if (regionalEffects) mon.regional_effects = regionalEffects;

        // Description
        const description = $('#cm-description')?.value?.trim();
        if (description) mon.description = description;
      }

      // Ability scores (shared between modes, but only in full mode accordion)
      const str = $('#cm-str')?.value ? Number($('#cm-str').value) : undefined;
      const dex = $('#cm-dex')?.value ? Number($('#cm-dex').value) : undefined;
      const con = $('#cm-con')?.value ? Number($('#cm-con').value) : undefined;
      const int = $('#cm-int')?.value ? Number($('#cm-int').value) : undefined;
      const wis = $('#cm-wis')?.value ? Number($('#cm-wis').value) : undefined;
      const cha = $('#cm-cha')?.value ? Number($('#cm-cha').value) : undefined;

      if (str !== undefined) mon.str = str;
      if (dex !== undefined) mon.dex = dex;
      if (con !== undefined) mon.con = con;
      if (int !== undefined) mon.int = int;
      if (wis !== undefined) mon.wis = wis;
      if (cha !== undefined) mon.cha = cha;

      // Saves, skills, senses (always available)
      const saves = $('#cm-saves')?.value?.trim();
      const skills = $('#cm-skills')?.value?.trim();
      const senses = $('#cm-senses')?.value?.trim();
      if (saves) mon.saves = saves;
      if (skills) mon.skills = skills;
      if (senses) mon.senses = senses;

      return mon;
    }

    function clearCustomForm(){
      // Simple mode fields
      const simpleFields = [
        '#cm-name', '#cm-type', '#cm-ac', '#cm-hp', '#cm-speed', '#cm-actions'
      ];

      // Full mode fields
      const fullFields = [
        '#cm-name-full', '#cm-type-full', '#cm-subtype', '#cm-ac-full', '#cm-hp-full',
        '#cm-ac-type', '#cm-hit-dice', '#cm-prof-bonus',
        '#cm-speed-walk', '#cm-speed-fly', '#cm-speed-swim', '#cm-speed-climb', '#cm-speed-burrow',
        '#cm-str', '#cm-dex', '#cm-con', '#cm-int', '#cm-wis', '#cm-cha',
        '#cm-saves', '#cm-skills', '#cm-senses', '#cm-languages',
        '#cm-vulnerabilities', '#cm-resistances', '#cm-damage-immunities', '#cm-condition-immunities',
        '#cm-spell-dc', '#cm-spell-atk', '#cm-cantrips', '#cm-spells',
        '#cm-special', '#cm-actions-full', '#cm-bonus-actions', '#cm-reactions', '#cm-legendary',
        '#cm-legendary-count', '#cm-mythic-trait', '#cm-mythic-actions',
        '#cm-lair-actions', '#cm-regional-effects', '#cm-description', '#cm-notes', '#cm-json'
      ];

      [...simpleFields, ...fullFields].forEach(sel => {
        const elem = $(sel);
        if (elem) elem.value = '';
      });

      // Reset selects
      const selectResets = {
        '#cm-size': 'Medium',
        '#cm-size-full': 'Medium',
        '#cm-alignment': '',
        '#cm-cr-override': '',
        '#cm-spell-ability': ''
      };
      Object.entries(selectResets).forEach(([sel, val]) => {
        const elem = $(sel);
        if (elem) elem.value = val;
      });

      // Reset checkboxes
      ['#cm-speed-hover', '#cm-innate-spellcasting'].forEach(sel => {
        const elem = $(sel);
        if (elem) elem.checked = false;
      });

      // Reset legendary count to default
      const legCount = $('#cm-legendary-count');
      if (legCount) legCount.value = '3';

      // Reset ability modifier displays
      ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
        const modEl = $(`#cm-${stat}-mod`);
        if (modEl) modEl.textContent = '(+0)';
      });
    }

    // Calculate ability modifier from score
    function calcAbilityMod(score) {
      return Math.floor((score - 10) / 2);
    }

    // Format modifier string
    function formatMod(mod) {
      return mod >= 0 ? `(+${mod})` : `(${mod})`;
    }

    // Update ability modifier display when score changes
    function setupAbilityModUpdates() {
      ['str', 'dex', 'con', 'int', 'wis', 'cha'].forEach(stat => {
        const input = $(`#cm-${stat}`);
        const modDisplay = $(`#cm-${stat}-mod`);
        if (input && modDisplay) {
          input.addEventListener('input', () => {
            const score = Number(input.value) || 10;
            const mod = calcAbilityMod(score);
            modDisplay.textContent = formatMod(mod);
          });
        }
      });
    }

    // -------------------- Export --------------------
    function buildTrackerNotes(m) {
      const parts = [];
      parts.push(`CR ${m.calc?.cr ?? (m.cr ?? '—')} • ${m.type || '—'}${m.size ? `, ${m.size}` : ''}`);

      // Speed
      if (m.speed) parts.push(`Speed: ${m.speed}`);

      // Ability scores
      const abilities = ['str','dex','con','int','wis','cha'].filter(a => m[a]);
      if (abilities.length > 0) {
        parts.push(abilities.map(a => `${a.toUpperCase()} ${m[a]}`).join(' | '));
      }

      // Saves, skills, senses
      if (m.saves) parts.push(`Saves: ${m.saves}`);
      if (m.skills) parts.push(`Skills: ${m.skills}`);
      if (m.senses) parts.push(`Senses: ${m.senses}`);
      if (m.languages) parts.push(`Languages: ${m.languages}`);

      // Defenses
      const dmgVuln = m.damage_vulnerabilities || m.damageVulnerabilities;
      const dmgRes = m.damage_resistances || m.damageResistances;
      const dmgImm = m.damage_immunities || m.damageImmunities;
      const condImm = m.condition_immunities || m.conditionImmunities;
      if (dmgVuln) parts.push(`Vuln: ${dmgVuln}`);
      if (dmgRes) parts.push(`Resist: ${dmgRes}`);
      if (dmgImm) parts.push(`Immune: ${dmgImm}`);
      if (condImm) parts.push(`Cond Immune: ${condImm}`);

      // Special abilities
      if (m.special_abilities?.length > 0) {
        parts.push('--- Special ---');
        m.special_abilities.forEach(sa => {
          parts.push(`${sa.name}${sa.desc ? ': ' + sa.desc : ''}`);
        });
      }

      // Spellcasting
      if (m.spellcasting) {
        const sc = m.spellcasting;
        let scLine = sc.innate ? 'Innate Spellcasting' : 'Spellcasting';
        const spellDC = sc.dc || sc.spellSaveDC;
        const spellAtk = sc.attack || sc.spellAttackBonus;
        if (spellDC) scLine += `, DC ${spellDC}`;
        if (spellAtk) scLine += `, +${spellAtk} to hit`;
        parts.push(scLine);
        if (sc.cantrips) parts.push(`Cantrips: ${sc.cantrips}`);
        if (sc.spells && !sc.level1) parts.push(`Spells: ${sc.spells}`);
      }

      // Actions
      if (m.actions?.length > 0) {
        parts.push('--- Actions ---');
        m.actions.forEach(a => {
          let line = a.name;
          const info = [];
          if (a.toHit !== undefined) info.push(`+${a.toHit}`);
          if (a.saveDC !== undefined) info.push(`DC ${a.saveDC}`);
          if (a.damage) info.push(a.damage);
          if (info.length) line += ` (${info.join(', ')})`;
          if (a.desc) line += `: ${a.desc}`;
          parts.push(line);
        });
      }

      // Bonus actions
      if (m.bonus_actions?.length > 0) {
        parts.push('--- Bonus Actions ---');
        m.bonus_actions.forEach(ba => {
          parts.push(`${ba.name}${ba.desc ? ': ' + ba.desc : ''}`);
        });
      }

      // Reactions
      if (m.reactions?.length > 0) {
        parts.push('--- Reactions ---');
        m.reactions.forEach(r => {
          parts.push(`${r.name}${r.desc ? ': ' + r.desc : ''}`);
        });
      }

      // Legendary actions
      if (m.legendary_actions?.length > 0) {
        const legCount = m.legendary_action_count || m.legendaryCount;
        parts.push(`--- Legendary Actions${legCount ? ` (${legCount}/round)` : ''} ---`);
        m.legendary_actions.forEach(la => {
          parts.push(`${la.name}${la.desc ? ': ' + la.desc : ''}`);
        });
      }

      // Notes
      if (m.notes) parts.push(`Notes: ${m.notes}`);

      return parts.join('\n');
    }

    function monstersToTrackerCharacters(){
      const out = [];
      roster.forEach(m=>{
        const qty = m.qty||1;
        const notes = buildTrackerNotes(m);
        for(let i=0;i<qty;i++){
          out.push({
            name: qty>1 ? `${m.name} #${i+1}` : m.name,
            type: "Enemy",
            initiative: 0,
            currentHP: m.hp ?? 1,
            maxHP: m.hp ?? 1,
            tempHP: 0,
            ac: m.ac ?? null,
            notes: notes,
            concentration: false,
            deathSaves: { s:0, f:0, stable:false },
            status: []
          });
        }
      });
      return out;
    }
    function downloadJSON(obj, name){
      const safe = name.replace(/[:.]/g, '-');
      const blob = new Blob([JSON.stringify(obj,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=safe;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }

    // -------------------- Text File Export --------------------
    function generateEnemyStatBlockText(){
      if(!roster.length) return '';

      let text = '═══════════════════════════════════════════════════════\n';
      text += '           ENCOUNTER BUILDER - ENEMY ROSTER\n';
      text += '═══════════════════════════════════════════════════════\n\n';

      roster.forEach((m, idx) => {
        const qty = m.qty || 1;
        text += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n`;
        text += `${m.name.toUpperCase()}`;
        if (qty > 1) text += ` (x${qty})`;
        text += `\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n`;

        // Basic Info
        let typeStr = `${m.size || 'Medium'} ${m.type || 'creature'}`;
        if (m.subtype) typeStr += ` (${m.subtype})`;
        if (m.alignment) typeStr += `, ${m.alignment}`;
        text += `${typeStr}\n`;
        const profBonus = m.proficiency_bonus || m.profBonus;
        text += `CR ${m.calc?.cr ?? (m.cr ?? '—')}${profBonus ? ` (Proficiency Bonus +${profBonus})` : ''}\n\n`;

        // Core Stats
        let acStr = `Armor Class: ${m.ac ?? '—'}`;
        const acType = m.ac_type || m.acType;
        if (acType) acStr += ` (${acType})`;
        text += `${acStr}\n`;
        let hpStr = `Hit Points: ${m.hp ?? '—'}`;
        const hitDice = m.hit_dice || m.hitDice;
        if (hitDice) hpStr += ` (${hitDice})`;
        text += `${hpStr}\n`;
        if (m.speed) text += `Speed: ${m.speed}\n`;
        text += `\n`;

        // Ability Scores (if available)
        if (m.str || m.dex || m.con || m.int || m.wis || m.cha) {
          text += `Ability Scores:\n`;
          if (m.str) text += `  STR ${m.str}\n`;
          if (m.dex) text += `  DEX ${m.dex}\n`;
          if (m.con) text += `  CON ${m.con}\n`;
          if (m.int) text += `  INT ${m.int}\n`;
          if (m.wis) text += `  WIS ${m.wis}\n`;
          if (m.cha) text += `  CHA ${m.cha}\n`;
          text += `\n`;
        }

        // Saves, skills, senses, languages
        if (m.saves) text += `Saving Throws: ${m.saves}\n`;
        if (m.skills) text += `Skills: ${m.skills}\n`;
        if (m.senses) text += `Senses: ${m.senses}\n`;
        if (m.languages) text += `Languages: ${m.languages}\n`;
        if (m.saves || m.skills || m.senses || m.languages) text += `\n`;

        // Damage/condition modifiers (handle both snake_case from form and camelCase from API)
        const dmgVuln = m.damage_vulnerabilities || m.damageVulnerabilities;
        const dmgRes = m.damage_resistances || m.damageResistances;
        const dmgImm = m.damage_immunities || m.damageImmunities;
        const condImm = m.condition_immunities || m.conditionImmunities;
        if (dmgVuln) text += `Damage Vulnerabilities: ${dmgVuln}\n`;
        if (dmgRes) text += `Damage Resistances: ${dmgRes}\n`;
        if (dmgImm) text += `Damage Immunities: ${dmgImm}\n`;
        if (condImm) text += `Condition Immunities: ${condImm}\n`;
        if (dmgVuln || dmgRes || dmgImm || condImm) text += `\n`;

        // Calculated CR breakdown
        if (m.calc) {
          text += `CR Breakdown: Off ${m.calc.offCR} / Def ${m.calc.defCR} = ${m.calc.cr}\n\n`;
        }

        // Special Abilities
        if (m.special_abilities && m.special_abilities.length > 0) {
          text += `─── SPECIAL ABILITIES ───\n\n`;
          m.special_abilities.forEach(sa => {
            text += `• ${sa.name}\n`;
            if (sa.desc) text += `  ${sa.desc}\n`;
            text += `\n`;
          });
        }

        // Spellcasting
        if (m.spellcasting) {
          text += `─── SPELLCASTING ───\n\n`;
          const sc = m.spellcasting;
          text += `${sc.innate ? 'Innate Spellcasting' : 'Spellcasting'}`;
          if (sc.ability) text += ` (${sc.ability})`;
          text += `\n`;
          const spellDC = sc.dc || sc.spellSaveDC;
          const spellAtk = sc.attack || sc.spellAttackBonus;
          if (spellDC) text += `Spell Save DC: ${spellDC}\n`;
          if (spellAtk) text += `Spell Attack Bonus: +${spellAtk}\n`;
          if (sc.atWill) text += `At will: ${sc.atWill}\n`;
          if (sc.perDay3) text += `3/day each: ${sc.perDay3}\n`;
          if (sc.perDay2) text += `2/day each: ${sc.perDay2}\n`;
          if (sc.perDay1) text += `1/day each: ${sc.perDay1}\n`;
          if (sc.cantrips) text += `Cantrips: ${sc.cantrips}\n`;
          // Structured spell levels (from API imports)
          if (sc.level1) text += `1st level (${sc.level1Slots || '—'} slots): ${sc.level1}\n`;
          if (sc.level2) text += `2nd level (${sc.level2Slots || '—'} slots): ${sc.level2}\n`;
          if (sc.level3) text += `3rd level (${sc.level3Slots || '—'} slots): ${sc.level3}\n`;
          if (sc.level4) text += `4th level (${sc.level4Slots || '—'} slots): ${sc.level4}\n`;
          if (sc.level5) text += `5th level (${sc.level5Slots || '—'} slots): ${sc.level5}\n`;
          if (sc.level6) text += `6th level (${sc.level6Slots || '—'} slots): ${sc.level6}\n`;
          if (sc.level7) text += `7th level (${sc.level7Slots || '—'} slots): ${sc.level7}\n`;
          if (sc.level8) text += `8th level (${sc.level8Slots || '—'} slots): ${sc.level8}\n`;
          if (sc.level9) text += `9th level (${sc.level9Slots || '—'} slots): ${sc.level9}\n`;
          // Free-text spells (from custom form)
          if (sc.spells && !sc.level1) text += `Spells: ${sc.spells}\n`;
          text += `\n`;
        }

        // Actions
        if (m.actions && m.actions.length > 0) {
          text += `─── ACTIONS ───\n\n`;
          m.actions.forEach(action => {
            text += `• ${action.name}`;

            // Attack info
            const attackInfo = [];
            if (action.toHit !== undefined) attackInfo.push(`+${action.toHit} to hit`);
            if (action.saveDC !== undefined) attackInfo.push(`DC ${action.saveDC}`);
            if (action.damage) attackInfo.push(`${action.damage} damage`);

            if (attackInfo.length > 0) {
              text += ` (${attackInfo.join(', ')})`;
            }
            text += `\n`;

            if (action.desc) text += `  ${action.desc}\n`;
            text += `\n`;
          });
        }

        // Bonus Actions
        if (m.bonus_actions && m.bonus_actions.length > 0) {
          text += `─── BONUS ACTIONS ───\n\n`;
          m.bonus_actions.forEach(ba => {
            text += `• ${ba.name}\n`;
            if (ba.desc) text += `  ${ba.desc}\n`;
            text += `\n`;
          });
        }

        // Reactions
        if (m.reactions && m.reactions.length > 0) {
          text += `─── REACTIONS ───\n\n`;
          m.reactions.forEach(r => {
            text += `• ${r.name}\n`;
            if (r.desc) text += `  ${r.desc}\n`;
            text += `\n`;
          });
        }

        // Legendary Actions
        if (m.legendary_actions && m.legendary_actions.length > 0) {
          text += `─── LEGENDARY ACTIONS ───\n\n`;
          const legCount = m.legendary_action_count || m.legendaryCount;
          if (legCount) text += `(${legCount} legendary actions per round)\n\n`;
          m.legendary_actions.forEach(la => {
            text += `• ${la.name}\n`;
            if (la.desc) text += `  ${la.desc}\n`;
            text += `\n`;
          });
        }

        // Mythic Actions
        if (m.mythic_actions && m.mythic_actions.length > 0) {
          text += `─── MYTHIC ACTIONS ───\n\n`;
          const mythicDesc = m.mythic_trait || m.mythicDescription;
          if (mythicDesc) text += `${mythicDesc}\n\n`;
          m.mythic_actions.forEach(ma => {
            text += `• ${ma.name}\n`;
            if (ma.desc) text += `  ${ma.desc}\n`;
            text += `\n`;
          });
        }

        // Lair Actions (handle both text string from form and array from API)
        if (m.lair_actions) {
          text += `─── LAIR ACTIONS ───\n\n`;
          if (typeof m.lair_actions === 'string') {
            text += `${m.lair_actions}\n\n`;
          } else if (Array.isArray(m.lair_actions) && m.lair_actions.length > 0) {
            m.lair_actions.forEach(la => {
              text += `• ${la.name || la.desc}\n`;
              if (la.name && la.desc) text += `  ${la.desc}\n`;
              text += `\n`;
            });
          }
        }

        // Regional Effects (handle both text string from form and array from API)
        if (m.regional_effects) {
          text += `─── REGIONAL EFFECTS ───\n\n`;
          if (typeof m.regional_effects === 'string') {
            text += `${m.regional_effects}\n\n`;
          } else if (Array.isArray(m.regional_effects) && m.regional_effects.length > 0) {
            m.regional_effects.forEach(re => {
              text += `• ${re.name || re.desc}\n`;
              if (re.name && re.desc) text += `  ${re.desc}\n`;
              text += `\n`;
            });
          }
        }

        // Description
        if (m.description) {
          text += `─── DESCRIPTION ───\n${m.description}\n\n`;
        }

        // Notes
        if (m.notes) {
          text += `─── NOTES ───\n${m.notes}\n\n`;
        }

        text += `\n`;
      });

      // Summary at the end
      const party = parsePartyLevels();
      const t = thresholdsForParty(party);
      let baseXP=0, count=0;
      roster.forEach(m=>{
        const xpEach = crToXp(m.calc?.cr ?? m.cr ?? 0);
        baseXP += xpEach * (m.qty||1);
        count  += (m.qty||1);
      });
      const mult  = adjustedMultiplier(count, party.length || 0);
      const adjXP = Math.round(baseXP * mult);
      const diff = (!party.length) ? '—' :
        (adjXP < t.easy ? 'Trivial' :
         adjXP < t.med  ? 'Easy'    :
         adjXP < t.hard ? 'Medium'  :
         adjXP < t.dead ? 'Hard'    : 'Deadly');

      text += `═══════════════════════════════════════════════════════\n`;
      text += `                  ENCOUNTER SUMMARY\n`;
      text += `═══════════════════════════════════════════════════════\n\n`;
      text += `Total Monsters: ${count}\n`;
      text += `Base XP: ${baseXP}\n`;
      text += `Multiplier: ×${mult}\n`;
      text += `Adjusted XP: ${adjXP}\n`;
      text += `Difficulty: ${diff}\n`;
      if (party.length) {
        text += `\nParty: [${party.join(', ')}]\n`;
        text += `Thresholds → Easy: ${t.easy}, Medium: ${t.med}, Hard: ${t.hard}, Deadly: ${t.dead}\n`;
      }
      text += `\n`;
      text += `Generated by The DM's Toolbox - Encounter Builder\n`;
      text += `${new Date().toLocaleString()}\n`;

      return text;
    }

    function downloadTextFile(content, filename){
      const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // -------------------- Wire UI --------------------
    $('#eb-refresh').onclick = async ()=>{ await loadSrdList(); renderResults(); };
    $('#eb-search').oninput = renderResults;
    $('#eb-cr-filter').onchange = renderResults;
    $('#eb-type-filter').onchange = renderResults;

    // Simple/Full mode toggle for custom monster creator
    $('#cm-mode-simple').onclick = () => {
      $('#cm-simple-mode').style.display = 'block';
      $('#cm-full-mode').style.display = 'none';
      $('#cm-mode-simple').classList.add('active');
      $('#cm-mode-full').classList.remove('active');
    };
    $('#cm-mode-full').onclick = () => {
      $('#cm-simple-mode').style.display = 'none';
      $('#cm-full-mode').style.display = 'block';
      $('#cm-mode-simple').classList.remove('active');
      $('#cm-mode-full').classList.add('active');
    };

    // Initialize ability modifier auto-updates for full mode
    setupAbilityModUpdates();

    $('#eb-party-levels').oninput = ()=>{ renderPartySummary(); renderSummary(); };
    $('#eb-resist-mode').onchange = e=>{ resistMode = e.target.value; // recalc all
      roster.forEach((m,i)=>{ roster[i].calc = computeCR(m); }); renderRoster();
    };

    $('#cm-add').onclick = ()=>{
      const mon = readCustomForm();
      if(!mon.name || !mon.ac || !mon.hp) { alert('Name, AC, and HP are required.'); return; }
      addToRoster(mon);
      clearCustomForm();
    };
    // Extract an array of monster-like objects from any JSON format the page produces
    function extractMonsters(parsed) {
      if (Array.isArray(parsed)) return parsed;
      if (parsed.roster) return parsed.roster;               // Roster (Full Monster Data) export
      if (parsed.characters) return parsed.characters;       // Full Session JSON export
      if (parsed.addCharacters) return parsed.addCharacters; // Append export
      if (parsed.name) return [parsed];                      // Single monster object
      return null;
    }

    // Normalize a tracker-format character back into a roster monster
    function normalizeImportedMonster(obj) {
      const mon = {...obj};
      // Session/tracker exports use currentHP/maxHP instead of hp
      if (mon.hp == null && (mon.currentHP != null || mon.maxHP != null)) {
        mon.hp = Number(mon.maxHP ?? mon.currentHP ?? 1);
      }
      // Clean up tracker-only fields
      delete mon.initiative;
      delete mon.currentHP;
      delete mon.maxHP;
      delete mon.tempHP;
      delete mon.concentration;
      delete mon.deathSaves;
      delete mon.status;
      // Tracker sets type to "Enemy"/"PC"/etc — don't overwrite real creature type
      if (['Enemy','PC','NPC','Companion'].includes(mon.type)) {
        delete mon.type;
      }
      return mon;
    }

    $('#cm-json-add').onclick = ()=>{
      try{
        const parsed = JSON.parse($('#cm-json').value||'{}');
        const monsters = extractMonsters(parsed);
        if (!monsters || !monsters.length) { alert('No monsters found in JSON.'); return; }
        let added = 0;
        for (const raw of monsters) {
          const mon = normalizeImportedMonster(raw);
          if(!mon.name || !mon.ac || !mon.hp) continue;
          addToRoster({...mon, qty: mon.qty || 1});
          added++;
        }
        if (added === 0) { alert('No valid monsters found. Each needs at least name, ac, hp.'); return; }
        $('#cm-json').value = '';
      }catch{ alert('Invalid JSON.'); }
    };
    $('#cm-clear').onclick = clearCustomForm;

    // Import Roster from file
    $('#eb-import-roster').onclick = ()=> $('#eb-import-roster-file').click();
    $('#eb-import-roster-file').onchange = (e)=>{
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (evt)=>{
        try {
          const parsed = JSON.parse(evt.target.result);
          const monsters = extractMonsters(parsed);
          if (!monsters || !monsters.length) {
            alert('No monsters found in file. Accepts roster exports, session exports, or an array of monster objects.');
            return;
          }
          let added = 0, skipped = 0;
          for (const raw of monsters) {
            const mon = normalizeImportedMonster(raw);
            if (!mon.name || !mon.ac || !mon.hp) { skipped++; continue; }
            addToRoster({...mon, qty: mon.qty || 1});
            added++;
          }
          let msg = `Imported ${added} monster${added !== 1 ? 's' : ''} to roster.`;
          if (skipped) msg += ` (${skipped} skipped - missing name/ac/hp)`;
          alert(msg);
        } catch { alert('Invalid JSON file.'); }
      };
      reader.readAsText(file);
      e.target.value = ''; // reset so same file can be re-imported
    };

    $('#eb-clear').onclick = ()=>{ roster.splice(0,roster.length); renderRoster(); };
    $('#eb-export').onclick = ()=>{
      const mode = $('#eb-export-mode').value;
      if(!roster.length){ alert('No monsters in roster.'); return; }
      if(mode==='roster'){
        // Export full monster data (preserves all fields for re-import)
        const rosterData = roster.map(m => {
          const exported = {...m};
          delete exported.calc; // CR calc is regenerated on import
          return exported;
        });
        downloadJSON({ roster: rosterData }, `encounter_roster_${new Date().toISOString()}.json`);
      }else{
        const chars = monstersToTrackerCharacters();
        if(mode==='append'){
          downloadJSON({ addCharacters: chars }, `initiative_add_${new Date().toISOString()}.json`);
        }else{
          downloadJSON({ characters: chars, currentTurn:0, combatRound:1, diceHistory:[] }, `initiative_session_${new Date().toISOString()}.json`);
        }
      }
    };

  function normalizeForTracker(c) {
    return {
      name: c.name ?? "Unknown",
      type: "Enemy",
      initiative: 1,
      currentHP: Number(c.hp ?? c.currentHP ?? 1),
      maxHP:     Number(c.hp ?? c.maxHP     ?? 1),
      tempHP: 0,
      ac: (c.ac ?? null),
      notes: buildTrackerNotes(c),
      concentration: false,
      deathSaves: { s:0, f:0, stable:false },
      status: []
    };
  }
  
  // Build a flat list of characters from the roster,
  // numbering duplicates as "Name", "Name 2", "Name 3", ...
  function buildCharactersFromRoster(roster) {
    const counts = Object.create(null);
    const out = [];
  
    for (const m of roster) {
      const qty = Math.max(1, Number(m.qty || 1));
      const baseName = (m.name || "Unknown").trim();
    
      for (let i = 0; i < qty; i++) {
        counts[baseName] = (counts[baseName] || 0) + 1;
        const idx = counts[baseName];
      
        const ch = normalizeForTracker(m);
        ch.name = idx === 1 ? baseName : `${baseName} ${idx}`;
        out.push(ch);
      }
    }
    return out;
  }
  
  function monstersToTrackerSession() {
    const characters = buildCharactersFromRoster(roster);
    return {
      __dmtoolsVersion: 1,
      mode: "append",      // <- do not wipe existing tracker state
      characters,
      currentTurn: 0,
      combatRound: 1,
      diceHistory: []
    };
  }

    document.getElementById("eb-send-to-tracker").addEventListener("click", () => {
    const session = monstersToTrackerSession();

    if (!session.characters.length) {
      alert("No monsters in the roster.");
      return;
    }

    // Prompt user to download stat block text file
    if (confirm("Would you like to download a text file with all enemy stat blocks for DM reference?\n\n(This will include all actions, reactions, special abilities, and stats from the API)")) {
      const textContent = generateEnemyStatBlockText();
      const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, 19);
      downloadTextFile(textContent, `encounter_statblocks_${timestamp}.txt`);
    }

    try {
      localStorage.setItem("dmtools.pendingImport", JSON.stringify(session));
    } catch (e) {
      console.error("localStorage error:", e);
      alert("Could not stage data for the tracker (localStorage error).");
      return;
    }
    location.href = "initiative.html#autoinput";
  });

    // Initial boot
    (async function init(){
      resistMode = $('#eb-resist-mode').value;
      renderPartySummary();
      try{ await loadSrdList(); }catch(e){ console.warn(e); }
      renderResults();
    })();
  })();
  </script>
  <script data-goatcounter="https://maybeme1990.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>