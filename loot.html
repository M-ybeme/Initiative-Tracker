<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Loot Generator</title>

  <!-- Bootstrap CSS + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css" />

  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

  <!-- Sortable (optional) + Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/site.js"></script>

  <style>
    .bgimage{ background: url('images/BGMap.png') no-repeat center center fixed; background-size: cover; }
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn { border-left: 5px solid #1d9e6d !important; color: #f8f9fa !important; font-weight: bold; }
    #saveHistorySelect { min-width: 200px; }

    /* Loot UI */
    .loot-tile{border:1px solid rgba(255,255,255,.15);border-radius:.6rem;padding:.6rem;background:rgba(0,0,0,.2)}
    .loot-title{font-weight:600}
    .loot-sub{font-size:.9rem;color:#9aa0a6}
    .loot-meta{font-size:.8rem;color:#8b93a1}
    .pill{border:1px solid rgba(255,255,255,.15);border-radius:50rem;padding:.15rem .5rem}
    .range-label{display:flex;justify-content:space-between;font-size:.85rem;color:#9aa0a6;margin-top:.25rem}
    .form-hint{font-size:.85rem;color:#9aa0a6}

    /* Simple/Advanced mode toggle */
    .advanced-setting { display: none; }
    .advanced-mode .advanced-setting { display: block; }
    .advanced-setting.row { display: none; }
    .advanced-mode .advanced-setting.row { display: flex; }
  </style>
</head>
<body class="bgimage">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Combat
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="initiative.html">Initiative Tracker</a></li>
              <li><a class="dropdown-item" href="battlemap.html">Battle Map</a></li>
              <li><a class="dropdown-item" href="encounterbuilder.html">Encounter Builder</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Generators
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="name.html">Name Generator</a></li>
              <li><a class="dropdown-item active" aria-current="page" href="loot.html">Loot Generator</a></li>
              <li><a class="dropdown-item" href="shop.html">Shop Generator</a></li>
              <li><a class="dropdown-item" href="npc.html">NPC Generator</a></li>
              <li><a class="dropdown-item" href="tav.html">Tavern/Inn Generator</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Campaign
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="characters.html">Characters</a></li>
              <li><a class="dropdown-item" href="journal.html">Journal</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Main -->
  <main class="content pt-3">
    <h1 class="d-flex justify-content-center mt-2">Loot Generator</h1>
    <div class="container-fluid text-center backdrop">
      <div class="row g-3">
        <!-- Settings -->
        <div class="col-12 col-lg-4">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Loot Settings</h5>
              <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="advancedModeToggle" role="switch">
                <label class="form-check-label small" for="advancedModeToggle">Advanced</label>
              </div>
            </div>
            <div class="card-body" id="lootSettingsBody">

              <!-- Presets -->
              <div class="mb-2">
                <label for="lg-preset" class="form-label">Tier / CR Preset</label>
                <select id="lg-preset" class="form-select">
                  <option value="custom">Custom (no preset)</option>
                  <option value="t1">Tier I (Lv 1–4 / CR 1–4)</option>
                  <option value="t2">Tier II (Lv 5–10 / CR 5–10)</option>
                  <option value="t3">Tier III (Lv 11–16 / CR 11–16)</option>
                  <option value="t4">Tier IV (Lv 17–20 / CR 17+)</option>
                </select>
                <div class="form-hint mt-1">Presets adjust budget/caps/usefulness. You can still tweak below.</div>
              </div>

              <!-- Quick Bundle Presets -->
              <div class="mb-3">
                <label class="form-label fw-semibold">
                  <i class="bi bi-lightning-charge me-1"></i>Quick Bundles
                </label>
                <div class="d-grid gap-2">
                  <div class="row g-2">
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-light w-100 quick-bundle-btn" data-bundle="pocket">
                        <i class="bi bi-coin me-1"></i>Pocket Loot
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">~50 gp</small>
                      </button>
                    </div>
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-secondary w-100 quick-bundle-btn" data-bundle="coinpouch">
                        <i class="bi bi-cash-stack me-1"></i>Coin Pouch
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">200-500 gp</small>
                      </button>
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-success w-100 quick-bundle-btn" data-bundle="gems">
                        <i class="bi bi-gem me-1"></i>5 Gems
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">~500 gp</small>
                      </button>
                    </div>
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-info w-100 quick-bundle-btn" data-bundle="potions">
                        <i class="bi bi-droplet-fill me-1"></i>Potion Bundle
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">3 potions</small>
                      </button>
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-info w-100 quick-bundle-btn" data-bundle="scrolls">
                        <i class="bi bi-file-text me-1"></i>Scroll Bundle
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">3 scrolls</small>
                      </button>
                    </div>
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-warning w-100 quick-bundle-btn" data-bundle="boss">
                        <i class="bi bi-trophy me-1"></i>Boss Hoard
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">~2000 gp</small>
                      </button>
                    </div>
                  </div>
                  <div class="row g-2">
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-light w-100 quick-bundle-btn" data-bundle="magicitems">
                        <i class="bi bi-stars me-1"></i>Magic Items
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">8 items</small>
                      </button>
                    </div>
                    <div class="col-6">
                      <button class="btn btn-sm btn-outline-danger w-100 quick-bundle-btn" data-bundle="curseditems">
                        <i class="bi bi-exclamation-triangle me-1"></i>Cursed Items
                        <small class="d-block text-secondary" style="font-size: 0.7rem;">6 items</small>
                      </button>
                    </div>
                  </div>
                </div>
                <div class="form-hint mt-1">One-click common loot scenarios. Bypasses settings below.</div>
              </div>

              <!-- Monster Type -->
              <div class="mb-2 advanced-setting">
                <label for="lg-monster" class="form-label">Monster Type (Optional)</label>
                <select id="lg-monster" class="form-select">
                  <option value="none">None (use hoard template below)</option>
                  <option value="dragon">Dragon</option>
                  <option value="lich">Lich</option>
                  <option value="vampire">Vampire</option>
                  <option value="beholder">Beholder</option>
                  <option value="giant">Giant</option>
                  <option value="demon">Demon/Devil</option>
                  <option value="fey">Fey Noble</option>
                  <option value="aberration">Aberration</option>
                  <option value="undead">Undead Horde</option>
                </select>
                <div class="form-hint mt-1">Overrides hoard template with monster-specific loot.</div>
              </div>

              <!-- Hoard Template -->
              <div class="mb-2 advanced-setting">
                <label for="lg-template" class="form-label">Hoard Template</label>
                <select id="lg-template" class="form-select">
                  <option value="none">None (generic mix)</option>
                  <option value="bandit">Bandit cache</option>
                  <option value="cult">Cult sanctum</option>
                  <option value="noble">Noble vault</option>
                  <option value="goblin">Goblin den</option>
                  <option value="ship">Ship cargo</option>
                  <option value="wizard">Wizard's study</option>
                </select>
                <div class="form-hint mt-1">Biases categories, bundles, and flavor.</div>
              </div>

              <!-- Loot Type -->
              <div class="mb-2 advanced-setting">
                <label class="form-label d-block">Loot Type</label>
                <div class="btn-group w-100" role="group" aria-label="Loot Type">
                  <input type="radio" class="btn-check" name="lg-loot-type" id="lg-loot-hoard" value="hoard" checked>
                  <label class="btn btn-outline-light" for="lg-loot-hoard">Hoard</label>
                  <input type="radio" class="btn-check" name="lg-loot-type" id="lg-loot-individual" value="individual">
                  <label class="btn btn-outline-light" for="lg-loot-individual">Individual</label>
                </div>
                <div class="form-hint mt-1">Hoard: large treasure piles. Individual: pocket loot from single creatures.</div>
              </div>

              <!-- Mode -->
              <div class="mb-2 advanced-setting">
                <label class="form-label d-block">Generation Mode</label>
                <div class="btn-group w-100" role="group" aria-label="Mode">
                  <input type="radio" class="btn-check" name="lg-mode" id="lg-mode-count" value="count" checked>
                  <label class="btn btn-outline-light" for="lg-mode-count">Count</label>
                  <input type="radio" class="btn-check" name="lg-mode" id="lg-mode-budget" value="budget">
                  <label class="btn btn-outline-light" for="lg-mode-budget">Budget</label>
                </div>
              </div>

              <!-- Common controls -->
              <div class="row g-2 advanced-setting">
                <div class="col-6">
                  <label for="lg-count" class="form-label">Count</label>
                  <input id="lg-count" class="form-control" type="number" inputmode="numeric" min="1" max="5000" value="50">
                  <div class="form-hint">Ignored in Budget mode (used as soft cap).</div>
                </div>
                <div class="col-6">
                  <label for="lg-seed" class="form-label">Seed (optional)</label>
                  <input id="lg-seed" class="form-control" type="text" placeholder="e.g. session-12">
                </div>
              </div>

              <div class="row g-2 mt-1 advanced-setting">
                <div class="col-6">
                  <label for="lg-min" class="form-label">Min value (sp)</label>
                  <input id="lg-min" class="form-control" type="number" inputmode="numeric" min="0" max="500" value="1">
                </div>
                <div class="col-6">
                  <label for="lg-max" class="form-label">Max value (gp)</label>
                  <input id="lg-max" class="form-control" type="number" inputmode="numeric" min="1" max="500" value="25">
                </div>
              </div>

              <!-- Budget -->
              <div class="mt-2 advanced-setting">
                <label for="lg-budget" class="form-label">Target Budget (gp)</label>
                <input id="lg-budget" class="form-control" type="number" inputmode="numeric" min="1" max="100000" value="150">
                <div class="form-hint">Used when Mode = Budget (aims ±10%).</div>
              </div>

              <!-- Usefulness slider -->
              <div class="mt-2 advanced-setting">
                <label for="lg-use" class="form-label">Usefulness Bias</label>
                <input id="lg-use" class="form-range" type="range" min="0" max="100" value="50">
                <div class="range-label"><span>Flavor-heavy</span><span>Balanced</span><span>Valuable/usable</span></div>
              </div>

              <!-- Minor magic toggle -->
              <div class="form-check mt-2 advanced-setting">
                <input class="form-check-input" type="checkbox" id="lg-magic">
                <label class="form-check-label" for="lg-magic">Allow minor magic (consumables & situational gear)</label>
              </div>

              <!-- Cursed items toggle -->
              <div class="form-check mt-2 advanced-setting">
                <input class="form-check-input" type="checkbox" id="lg-cursed">
                <label class="form-check-label" for="lg-cursed">Include cursed items (risk & reward)</label>
              </div>

              <!-- Curse severity slider (only visible when cursed items enabled) -->
              <div class="mt-2 advanced-setting" id="lg-curse-severity-wrap" style="display:none;">
                <label for="lg-curse-severity" class="form-label">Curse Severity</label>
                <input id="lg-curse-severity" class="form-range" type="range" min="1" max="5" value="3">
                <div class="range-label"><span>Flavor only</span><span>Balanced</span><span>Dangerous</span></div>
                <div class="form-hint mt-1">Lower values: mostly harmless. Higher values: serious mechanical penalties.</div>
              </div>

              <!-- Categories -->
              <div class="mt-2 advanced-setting">
                <label class="form-label">Categories</label>
                <div class="row row-cols-2 g-1" id="lg-cats"></div>
                <div class="form-hint mt-1">"Minor Magic" and "Cursed Items" are auto-included only when their toggles are on.</div>
              </div>

              <div class="form-check mt-2 advanced-setting">
                <input class="form-check-input" type="checkbox" id="lg-weight" checked>
                <label class="form-check-label" for="lg-weight">Show weight estimate</label>
              </div>
              <div class="form-check advanced-setting">
                <input class="form-check-input" type="checkbox" id="lg-tags" checked>
                <label class="form-check-label" for="lg-tags">Show tags</label>
              </div>

              <!-- Custom Loot Table -->
              <div class="mt-2 advanced-setting">
                <label class="form-label d-flex justify-content-between align-items-center">
                  Custom Loot Tables
                  <button class="btn btn-sm btn-outline-light" id="lg-import-custom"><i class="bi bi-upload me-1"></i>Import JSON</button>
                </label>
                <select id="lg-custom-table" class="form-select">
                  <option value="">None (use standard tables)</option>
                </select>
                <div class="form-hint mt-1">Import custom loot tables in JSON format.</div>
              </div>

              <!-- Save/Load Presets -->
              <div class="mt-2 advanced-setting">
                <label class="form-label">Save/Load Preset</label>
                <div class="input-group">
                  <input type="text" id="lg-preset-name" class="form-control" placeholder="Preset name...">
                  <button class="btn btn-outline-success" id="lg-save-preset"><i class="bi bi-save me-1"></i>Save</button>
                  <button class="btn btn-outline-info" id="lg-load-preset"><i class="bi bi-folder-open me-1"></i>Load</button>
                </div>
                <select id="lg-saved-presets" class="form-select mt-1">
                  <option value="">-- Select a saved preset --</option>
                </select>
              </div>

              <div class="d-grid d-sm-flex gap-2 mt-3">
                <button class="btn btn-success" id="lg-generate"><i class="bi bi-stars me-1"></i>Generate</button>
                <button class="btn btn-outline-light" id="lg-copy"><i class="bi bi-clipboard me-1"></i>Copy</button>
                <button class="btn btn-warning" id="lg-download"><i class="bi bi-download me-1"></i>Download .txt</button>
                <button class="btn btn-danger" id="lg-clear"><i class="bi bi-trash me-1"></i>Clear</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Results -->
        <div class="col-12 col-lg-8">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary">
              <h5 class="mb-0">Results</h5>
            </div>
            <div class="card-body">
              <div id="lg-meta" class="d-flex flex-wrap gap-2 small text-secondary mb-2"></div>
              <div id="lg-out" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-2" aria-live="polite"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="footer-main py-3">
      <div class="container">
        <div class="row align-items-center text-center text-md-start">
          <!-- Left: Copyright -->
          <div class="col-12 col-md-4 mb-2 mb-md-0 text-md-start text-center">
            <small class="text-muted">&copy; 2025 Maybeme | The DM’s Toolbox</small>
          </div>

          <!-- Center: Logo -->
          <div class="col-12 col-md-4 text-center mb-2 mb-md-0">
            <img src="/images/White logo - no background.png" height="40" alt="Logo" class="footer-logo">
          </div>

          <!-- Right: Social Links -->
          <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end align-items-center gap-2">
            <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener" aria-label="LinkedIn">
              <i class="bi bi-linkedin"></i>
            </a>
            <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener" aria-label="GitHub">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://ko-fi.com/maybemestoolbox" class="socialicons d-flex align-items-center" target="_blank" rel="noopener" title="Support The DM’s Toolbox on Ko-fi">
              <i class="bi bi-cup-hot"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Generator Script -->
  <script>
  (()=>{
// ---------- Seeded RNG ----------
function hashString(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return (h>>>0)>>>0}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function prand(seedStr){const s=seedStr?hashString(seedStr):Math.floor(Math.random()*2**32);return mulberry32(s)}
const $=id=>document.getElementById(id);

// ---------- Flavor Pools ----------
const COLORS=["umber","sable","ash","ivory","verdant","ochre","crimson","indigo","cobalt","pearl","smoke","rust","teal","brass"];
const ADJS=["plain","neatly made","well-used","serviceable","careworn","sturdy","dainty","homespun","faded","scuffed","polished","patched","clean","oiled","balanced"];
const COND=["mint","good","used","worn","weathered","patched","chipped","tarnished","dented","frayed","scuffed","stained"];
const PATTERNS=["herringbone","chevron","crosshatch","spiral","flecked","ringed","braided","stitched","knotted","grooved"];
const MARKS=["simple maker’s mark","initials (illegible)","tiny circle stamp","plain triangle stamp","short tally mark","simple hash","basic starburst","three dots"];
const MATERIALS={ cloth:["linen","wool","cotton","canvas","burlap","felt","silk"], leather:["leather","boiled leather","suede","rawhide"], wood:["oak","ashwood","birch","maple","yew","pine","walnut"], metal:["iron","bronze","copper","pewter","brass","tin","steel","silver"], stone:["riverstone","slate","granite","marble chip","soapstone","basalt"], clay:["terracotta","earthenware","stoneware"], glass:["clear glass","green glass","smoked glass"], paper:["rag paper","vellum","parchment"] };
const SIZES=["miniature","small","hand-sized","broad","long","wide","narrow","compact","thin","thick"];
const SCENTS=["oiled","soap-scented","smoky","spice-dusted","fresh","musty","earthy","herbal","neutral"];
const ANIMALS=["stag","fox","herring","sparrow","boar","ram","hare","owl","wolf","bee"];
const SIMPLE_ICONS=["leaf","sun","moon","key","wheel","hammer","anvil","cup","sheaf","river"];

// ---------- Utils ----------
function pick(rng,arr){return arr[Math.floor(rng()*arr.length)]}
function clamp(v,min,max){return Math.max(min,Math.min(max,v))}
function tags(...xs){return xs}
function toTitle(s){return s.charAt(0).toUpperCase()+s.slice(1)}
function spToGp(sp){return +(sp/10).toFixed(2)}
function gpToSp(gp){return Math.round(gp*10)}

// Mixed coin bundle
function coinBundle(rng,minSp,maxSp){
  let total=Math.max(minSp,Math.floor(minSp+rng()*(maxSp-minSp+1)));
  let gp=0,sp=0,cp=0;
  if(total>=100){gp=Math.floor((total/10)*(0.15+rng()*0.35)); total-=gp*10;}
  sp=Math.floor(total*(0.5+rng()*0.4)); total-=sp;
  cp=total*10;
  const tokens=rng()<0.12?Math.max(1,Math.floor(rng()*6)):0;
  return {gp,sp,cp,tokens};
}
function formatCoinBundle(b){
  const parts=[]; if(b.gp) parts.push(`${b.gp} gold`); if(b.sp) parts.push(`${b.sp} silver`); if(b.cp) parts.push(`${b.cp} copper`); if(b.tokens) parts.push(`${b.tokens} brass trade tokens`);
  return parts.join(", ");
}

// ---------- Catalog (including Minor Magic, gated by toggle later) ----------
const CATS={
  "Coins & Purses":{
    base:[
      {n:"small coin purse",mat:"leather",w:0.2,sp:[15,240]},
      {n:"drawstring pouch",mat:"cloth",w:0.2,sp:[10,180]},
      {n:"wrapped roll of coin",mat:"paper",w:0.1,sp:[20,320]},
      {n:"stacked trade tokens",mat:"metal",w:0.1,sp:[10,200]}
    ],
    make:(rng,b)=>{
      const c=coinBundle(rng,b.sp[0],b.sp[1]);
      const note=rng()<0.4?`, ${pick(rng,ADJS)}`:"";
      const spVal=c.gp*10 + c.sp + Math.floor(c.cp/10) + (c.tokens*5);
      return [`Pouch of ${formatCoinBundle(c)}${note}`, tags("currency","common"), spVal>=50]
    }
  },
  "Trade Goods":{
    base:[
      {n:"bolt of fine cloth",mat:"cloth",w:2.0,sp:[300,1200],valuable:true},
      {n:"small keg of dyed thread",mat:"cloth",w:6.0,sp:[200,800],valuable:true},
      {n:"crate of dried spices",mat:"paper",w:8.0,sp:[400,1500],valuable:true},
      {n:"bundle of cured furs",mat:"leather",w:5.0,sp:[250,900],valuable:true},
      {n:"ingot of refined copper",mat:"metal",w:10.0,sp:[300,900],valuable:true},
      {n:"ingot of worked silver",mat:"metal",w:5.0,sp:[1200,2600],valuable:true},
      {n:"barrel of aged wine",mat:"wood",w:40.0,sp:[500,1800],valuable:true},
      {n:"crate of exotic tea leaves",mat:"paper",w:4.0,sp:[350,1400],valuable:true},
      {n:"bundle of rare herbs",mat:"cloth",w:2.0,sp:[300,1100],valuable:true},
      {n:"sack of quality coffee beans",mat:"cloth",w:8.0,sp:[250,900],valuable:true},
      {n:"case of fine tobacco",mat:"wood",w:3.0,sp:[400,1300],valuable:true},
      {n:"bolt of spider silk",mat:"cloth",w:1.0,sp:[800,2400],valuable:true},
      {n:"jar of rare pigments",mat:"glass",w:2.0,sp:[600,1800],valuable:true},
      {n:"bundle of exotic incense",mat:"paper",w:1.0,sp:[300,1000],valuable:true}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const detail=rng()<0.4?` (${pick(rng,PATTERNS)} marks)`:``;
      return [`${toTitle(m)} ${b.n}${detail}`, tags("trade","valuable"), true]
    }
  },
  "Gems & Art":{
    base:[
      {n:"small carved gemstone",mat:"stone",w:0.02,sp:[800,4000],valuable:true},
      {n:"silvered hand mirror",mat:"metal",w:0.6,sp:[900,2400],valuable:true},
      {n:"miniature marble statuette",mat:"stone",w:1.2,sp:[1200,3600],valuable:true},
      {n:"string of river pearls",mat:"stone",w:0.05,sp:[700,2600],valuable:true},
      {n:"framed vellum calligraphy",mat:"paper",w:0.4,sp:[600,2200],valuable:true},
      {n:"ornate music box",mat:"metal",w:1.5,sp:[1000,3200],valuable:true},
      {n:"jeweled hair comb",mat:"metal",w:0.1,sp:[900,2800],valuable:true},
      {n:"crystal prism",mat:"glass",w:0.3,sp:[700,2400],valuable:true},
      {n:"carved ivory cameo",mat:"stone",w:0.05,sp:[1100,3400],valuable:true},
      {n:"gilded portrait frame",mat:"metal",w:2.0,sp:[800,2600],valuable:true},
      {n:"polished jade figurine",mat:"stone",w:0.4,sp:[1300,3800],valuable:true},
      {n:"silver filigree locket",mat:"metal",w:0.1,sp:[850,2700],valuable:true},
      {n:"painted porcelain vase",mat:"clay",w:1.8,sp:[900,3000],valuable:true}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const col=rng()<0.4?`, ${pick(rng,COLORS)}`:""; const icon=rng()<0.35?` bearing a ${pick(rng,SIMPLE_ICONS)}`:"";
      return [`${toTitle(m)} ${b.n}${col}${icon}`, tags("art","gem","valuable"), true]
    }
  },
  "Adventuring Gear of Note":{
    base:[
      {n:"50′ silk rope (tested)",mat:"cloth",w:5.0,sp:[500,1200],valuable:true},
      {n:"climber’s piton set (10)",mat:"metal",w:5.0,sp:[300,900],valuable:true},
      {n:"healer’s kit (complete)",mat:"cloth",w:3.0,sp:[500,1400],valuable:true},
      {n:"hidden-sheath dagger (well-balanced)",mat:"metal",w:0.7,sp:[600,1600],valuable:true},
      {n:"lamp with spare oil (3 flasks)",mat:"metal",w:3.0,sp:[200,700],valuable:true},
      {n:"waterskin (double-stitched)",mat:"leather",w:2.0,sp:[150,450],valuable:false}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const q=rng()<0.5?pick(rng,["good","excellent","serviceable"]):null; const note=q?` (${q})`:"";
      return [`${toTitle(m)} ${b.n}${note}`, tags("gear","useful"), !!b.valuable]
    }
  },
  "Toolkits & Supplies":{
    base:[
      {n:"artisan’s tool roll",mat:"cloth",w:3.0,sp:[600,1800],valuable:true},
      {n:"forger’s ink & stamps set",mat:"metal",w:1.5,sp:[800,2200],valuable:true},
      {n:"lockpicks (quality set)",mat:"metal",w:0.2,sp:[900,2400],valuable:true},
      {n:"maps & charts (regional)",mat:"paper",w:0.6,sp:[700,2600],valuable:true},
      {n:"sextant (brass)",mat:"metal",w:2.4,sp:[1400,3600],valuable:true}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const mark=rng()<0.35?`, ${pick(rng,MARKS)}`:"";
      return [`${toTitle(m)} ${b.n}${mark}`, tags("tools","specialty","valuable"), true]
    }
  },
  "Clothing & Wearables":{
    base:[
      {n:"wool cap",mat:"cloth",w:0.2,sp:[5,120]},
      {n:"linen scarf",mat:"cloth",w:0.2,sp:[8,160]},
      {n:"leather belt",mat:"leather",w:0.3,sp:[10,180]},
      {n:"simple brooch",mat:"metal",w:0.05,sp:[50,600]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const pat=rng()<0.35?`, ${pick(rng,PATTERNS)} pattern`:""; const col=rng()<0.45?`, ${pick(rng,COLORS)}`:"";
      return [`${pick(rng,ADJS)} ${m} ${b.n}${pat}${col}`, tags("apparel","civilian"), false]
    }
  },
  "Tools & Utensils":{
    base:[
      {n:"folding knife",mat:"metal",w:0.2,sp:[60,300]},
      {n:"small hammer",mat:"metal",w:0.8,sp:[40,260]},
      {n:"awl",mat:"metal",w:0.1,sp:[10,120]},
      {n:"whetstone",mat:"stone",w:0.7,sp:[12,90]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const cond=pick(rng,COND); const scent=rng()<0.2?`, ${pick(rng,SCENTS)}`:"";
      return [`${cond} ${m} ${b.n}${scent}`, tags("tool","common"), false]
    }
  },
  "Household & Table":{
    base:[
      {n:"clay cup",mat:"clay",w:0.4,sp:[3,60]},
      {n:"wooden bowl",mat:"wood",w:0.4,sp:[3,60]},
      {n:"glass vial (empty)",mat:"glass",w:0.1,sp:[40,300]},
      {n:"tin plate",mat:"metal",w:0.5,sp:[10,160]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const pat=rng()<0.35?` with ${pick(rng,PATTERNS)} motif`:""; const mark=rng()<0.3?`, ${pick(rng,MARKS)}`:"";
      return [`${m} ${b.n}${pat}${mark}`, tags("household","mundane"), false]
    }
  },
  "Writing & Games":{
    base:[
      {n:"rag-paper booklet (blank)",mat:"paper",w:0.2,sp:[40,240]},
      {n:"graphite stick",mat:"stone",w:0.05,sp:[6,80]},
      {n:"dice pair (bone)",mat:"stone",w:0.1,sp:[40,280]},
      {n:"simple playing cards",mat:"paper",w:0.1,sp:[50,250]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const add=rng()<0.45?`, edged in ${pick(rng,COLORS)}`:"";
      return [`${m} ${b.n}${add}`, tags("leisure","stationery"), false]
    }
  },
  "Food & Provisions":{
    base:[
      {n:"dried fruit packet",mat:"cloth",w:0.2,sp:[8,120]},
      {n:"hardtack stack",mat:"paper",w:0.3,sp:[6,80]},
      {n:"smoked nuts pouch",mat:"cloth",w:0.2,sp:[10,140]},
      {n:"small cheese wedge (wrapped)",mat:"paper",w:0.3,sp:[10,160]}
    ],
    make:(rng,b)=>{
      const scent=rng()<0.6?`, ${pick(rng,SCENTS)}`:"";
      return [`${pick(rng,ADJS)} ${b.n}${scent}`, tags("provisions","edible"), false]
    }
  },
  "Curios & Charms":{
    base:[
      {n:"carved token",mat:"wood",w:0.05,sp:[20,240]},
      {n:"braided cord bracelet",mat:"cloth",w:0.02,sp:[10,140]},
      {n:"pressed flower in paper",mat:"paper",w:0.01,sp:[10,120]},
      {n:"simple pendant",mat:"metal",w:0.04,sp:[30,300]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const icon=rng()<0.6?` bearing a ${pick(rng,SIMPLE_ICONS)}`:""; const animal=rng()<0.25?` and a tiny ${pick(rng,ANIMALS)}`:"";
      return [`${pick(rng,ADJS)} ${m} ${b.n}${icon}${animal}`, tags("curio","keepsake"), false]
    }
  },
  "Bags & Containers":{
    base:[
      {n:"small sack",mat:"cloth",w:0.2,sp:[10,140]},
      {n:"roll-up tool wrap",mat:"cloth",w:0.25,sp:[20,200]},
      {n:"tin box",mat:"metal",w:0.3,sp:[25,240]},
      {n:"wooden case",mat:"wood",w:0.6,sp:[30,300]},
      {n:"glass jar (stoppered)",mat:"glass",w:0.4,sp:[40,260]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const size=rng()<0.35?` (${pick(rng,SIZES)})`:""; const col=rng()<0.3?`, ${pick(rng,COLORS)}`:"";
      return [`${m} ${b.n}${size}${col}`, tags("container","storage"), false]
    }
  },

  "Mundane Adventuring Items":{
    base:[
      {n:"50 ft. hempen rope",mat:"cloth",w:10.0,sp:[10,30]},
      {n:"torches (bundle of 5)",mat:"wood",w:5.0,sp:[5,15]},
      {n:"bedroll",mat:"cloth",w:7.0,sp:[10,30]},
      {n:"rations (1 week)",mat:"cloth",w:10.0,sp:[35,70]},
      {n:"candles (10)",mat:"cloth",w:0.5,sp:[1,5]},
      {n:"tinderbox",mat:"metal",w:1.0,sp:[5,15]},
      {n:"grappling hook",mat:"metal",w:4.0,sp:[20,60]},
      {n:"crowbar",mat:"metal",w:5.0,sp:[20,60]},
      {n:"10 ft. pole",mat:"wood",w:7.0,sp:[5,15]},
      {n:"chalk (10 pieces)",mat:"stone",w:0.2,sp:[1,5]},
      {n:"iron spikes (10)",mat:"metal",w:5.0,sp:[10,30]},
      {n:"lantern (hooded)",mat:"metal",w:2.0,sp:[50,150]},
      {n:"oil flask",mat:"glass",w:1.0,sp:[1,10]},
      {n:"shovel",mat:"metal",w:5.0,sp:[20,60]},
      {n:"tent (2-person)",mat:"cloth",w:20.0,sp:[20,60]},
      {n:"backpack",mat:"cloth",w:5.0,sp:[20,60]},
      {n:"caltrops (bag of 20)",mat:"metal",w:2.0,sp:[10,30]},
      {n:"chain (10 feet)",mat:"metal",w:10.0,sp:[50,150]},
      {n:"fishing tackle",mat:"cloth",w:4.0,sp:[10,30]},
      {n:"signal whistle",mat:"metal",w:0.1,sp:[5,15]}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]); const cond=rng()<0.5?pick(rng,COND):"standard";
      return [`${cond} ${m} ${b.n}`, tags("mundane","gear","common"), false]
    }
  },

  // --- Cursed Items (gated by toggle) ---
  "Cursed Items":{
    base:[
      // Severity 1: Minor trade-offs (appealing benefit, subtle drawback)
      {n:"lucky coin (+1 to initiative, but you sneeze loudly at the start of combat)",mat:"metal",w:0.05,sp:[150,350],severity:1},
      {n:"charming brooch (+1 to Charisma checks, but you compulsively compliment strangers)",mat:"metal",w:0.1,sp:[180,380],severity:1},
      {n:"keen quill (advantage on Investigation to decipher text, but it occasionally writes your secrets)",mat:"wood",w:0.02,sp:[160,340],severity:1},
      {n:"flask of warmth (keeps drinks perfect temperature, but you become mildly chatty when drinking)",mat:"metal",w:0.5,sp:[140,320],severity:1},
      {n:"weatherproof cloak (advantage vs rain/wind discomfort, but always smells faintly of wet dog)",mat:"cloth",w:1.5,sp:[200,400],severity:1},
      {n:"gloves of grip (+1 to climbing checks, but your hands feel uncomfortably warm)",mat:"leather",w:0.2,sp:[170,360],severity:1},
      {n:"mirror of confidence (+1 to Performance checks, but shows you slightly more attractive than reality)",mat:"glass",w:0.5,sp:[190,390],severity:1},
      {n:"dice of fortune (reroll 1s once per day, but must make DC 10 wisdom save to stop gambling when desired)",mat:"stone",w:0.1,sp:[220,420],severity:1},
      {n:"bag of organization (find items 50% faster, but they occasionally rearrange themselves noisily)",mat:"cloth",w:0.5,sp:[210,410],severity:1},
      {n:"hat of shade (advantage vs sun glare, but your hair is always messy when removed)",mat:"cloth",w:0.3,sp:[150,350],severity:1},

      // Severity 2: Noticeable trade-offs (good benefit, annoying drawback)
      {n:"boots of sure footing (+1 AC vs being knocked prone, but squeak when sneaking - disadvantage on Stealth)",mat:"leather",w:2.0,sp:[300,600],severity:2},
      {n:"ring of arcane memory (recall one forgotten spell slot 1/day, but finger itches intensely for 1 hour after)",mat:"metal",w:0.05,sp:[350,650],severity:2},
      {n:"cloak of many pockets (+10 lbs carry capacity, but attracts small insects that crawl out occasionally)",mat:"cloth",w:1.5,sp:[320,620],severity:2},
      {n:"honest pendant (+2 to Insight checks, but you sneeze when you lie)",mat:"metal",w:0.1,sp:[280,580],severity:2},
      {n:"bracelet of dexterity (+1 to Sleight of Hand, but causes harmless static shocks to allies)",mat:"metal",w:0.1,sp:[340,640],severity:2},
      {n:"belt of strength (carry +15 lbs, but loosens during strenuous activity - DC 10 DEX save or drop items)",mat:"leather",w:0.5,sp:[310,610],severity:2},
      {n:"spoon of sustenance (food is 25% more filling, but tastes completely bland)",mat:"metal",w:0.2,sp:[260,560],severity:2},
      {n:"lantern of clarity (bright light radius +5 ft, but goes out in the face of danger)",mat:"metal",w:2.0,sp:[380,680],severity:2},
      {n:"scarf of comfort (advantage vs cold weather, but occasionally tightens causing brief discomfort)",mat:"cloth",w:0.3,sp:[290,590],severity:2},
      {n:"coin pouch of plenty (holds 50 extra coins, but 1d4 copper falls out per hour, pc might notice or not)",mat:"leather",w:0.3,sp:[270,570],severity:2},

      // Severity 3: Meaningful trade-offs (strong benefit, notable drawback)
      {n:"keen dagger (+1 to hit and damage, but on killing blow deal 1d4 damage to self and victim's name scrawls on your skin)",mat:"metal",w:1.0,sp:[500,900],severity:3},
      {n:"amulet of preservation (food lasts twice as long, but fresh food tastes 'off' to you, causing mild nausea on 1d4 you throw up)",mat:"metal",w:0.2,sp:[450,850],severity:3},
      {n:"rope of escape (advantage on escape artist checks, but 10%(1d10) chance to untie itself during use)",mat:"cloth",w:5.0,sp:[520,920],severity:3},
      {n:"endless waterskin (refills with clean water at dawn, but water is always lukewarm and slightly metallic)",mat:"leather",w:2.0,sp:[480,880],severity:3},
      {n:"torch of revealing (bright light reveals invisible creatures within 10 ft, but casts disturbing shadow-faces 5% chance(1d20) to gain fear)",mat:"wood",w:1.0,sp:[540,940],severity:3},
      {n:"pack of holding (capacity +20 lbs, but feels 10 lbs heavier than contents)",mat:"cloth",w:6.0,sp:[600,1000],severity:3},
      {n:"resonant shield (+1 AC, but hums audibly in combat - disadvantage on Stealth during fights)",mat:"metal",w:6.0,sp:[650,1050],severity:3},
      {n:"helm of awareness (+2 to Perception, but causes mild headaches after 1 hour - disadvantage on CON saves)",mat:"metal",w:3.0,sp:[580,980],severity:3},
      {n:"beast pendant (advantage on Animal Handling, but wild animals detect you from 2x distance)",mat:"metal",w:0.1,sp:[530,930],severity:3},
      {n:"gloves of precision (+1 to ranged attacks, but everything you touch becomes slightly sticky)",mat:"leather",w:0.3,sp:[560,960],severity:3},

      // Severity 4: Strong benefit with risky drawback
      {n:"boots of haste (+10 ft movement, but on full speed movement roll 1d4: on 1 you slip and fall prone)",mat:"leather",w:3.0,sp:[800,1300],severity:4},
      {n:"ring of vigor (ignore first level of exhaustion, but disadvantage on first ability check each day)",mat:"metal",w:0.05,sp:[750,1250],severity:4},
      {n:"shadow cloak (+2 to Stealth in dim light, but you're more visible in shadows to darkvision)",mat:"cloth",w:2.0,sp:[850,1350],severity:4},
      {n:"gauntlets of power (+2 to Athletics, but roll 1d20 daily: on 1 you fumble and drop held items)",mat:"metal",w:2.0,sp:[900,1400],severity:4},
      {n:"adaptive armor (+1 AC and resist 3 cold OR fire damage, but constantly uncomfortable opposite temperature)",mat:"metal",w:20.0,sp:[1000,1500],severity:4},
      {n:"earring of keen hearing (+3 to Perception for sounds, but disadvantage on saves vs thunder damage)",mat:"metal",w:0.05,sp:[780,1280],severity:4},
      {n:"lucky brooch (reroll one failed save per day, but attract minor misfortune - DM adds 1 random complication)",mat:"metal",w:0.1,sp:[820,1320],severity:4},
      {n:"bag of retrieval (retrieve specific item as bonus action, but 5% chance it swaps with random item)",mat:"cloth",w:1.0,sp:[770,1270],severity:4},
      {n:"quenching canteen (water restores +2 HP once per day, but you require 50% more water to avoid dehydration)",mat:"metal",w:1.5,sp:[740,1240],severity:4},
      {n:"bracers of the grave (+2 to hit vs undead, but undead sense you from 2x distance)",mat:"leather",w:1.0,sp:[810,1310],severity:4},

      // Severity 5: Powerful benefit with serious consequence
      {n:"bloodthirsty blade (+2 to hit and damage, but if not used to damage a creature daily take 2d4 psychic damage at dawn)",mat:"metal",w:3.0,sp:[1400,2000],severity:5},
      {n:"armor of false security (+2 AC, but critical hits against you occur on 19-20)",mat:"metal",w:25.0,sp:[1600,2200],severity:5},
      {n:"ring of triumph (turn two failed saves into success per day, but natural 20s reroll - if lower use lower result)",mat:"metal",w:0.05,sp:[1300,1900],severity:5},
      {n:"cloak of shadows (+3 to Stealth checks, but disadvantage on all Stealth in bright light)",mat:"cloth",w:2.5,sp:[1450,2050],severity:5},
      {n:"boots of the endless road (+15 ft movement, but must walk 5+ miles daily or gain 1 exhaustion at dawn)",mat:"leather",w:3.0,sp:[1550,2150],severity:5},
      {n:"helm of iron mind (+2 to WIS saves, but 1/week suffer nightmares - no long rest benefits that night)",mat:"metal",w:4.0,sp:[1700,2300],severity:5},
      {n:"amulet of destiny (advantage on death saves, but divination magic and scrying vs you has advantage)",mat:"metal",w:0.3,sp:[1500,2100],severity:5},
      {n:"gloves of the duelist (+1 to attack rolls, but on natural 1 you fumble and fling your weapon 1d20 feet)",mat:"leather",w:0.4,sp:[1400,2000],severity:5},
      {n:"belt of the titan (carry capacity +100 lbs, but base capacity reduced by 50 lbs - net +50)",mat:"leather",w:1.0,sp:[1350,1950],severity:5},
      {n:"pendant of primal fury (+2 damage vs beasts and monstrosities, but they detect and prioritize you from 3x distance)",mat:"metal",w:0.2,sp:[1600,2200],severity:5}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]);
      const allure=pick(rng,["beautifully crafted","masterwork quality","elegantly designed","finely made","exquisitely detailed"]);
      const severityTag = `curse-${b.severity}`;
      return [`${toTitle(m)} ${b.n}, ${allure}`, tags("cursed",severityTag,"magical"), true]
    }
  },

  // --- Minor Magic (gated by toggle) ---
  "Minor Magic":{
    base:[
      // Consumables - Healing & Recovery
      {n:"tonic of vigor (one use)",mat:"glass",w:0.3,sp:[400,900],kind:"consumable"},
      {n:"salve of mending (heals minor wounds)",mat:"glass",w:0.2,sp:[350,850],kind:"consumable"},
      {n:"restorative tea (removes fatigue)",mat:"paper",w:0.1,sp:[300,750],kind:"consumable"},
      {n:"vial of clarity (advantage on next save vs mind effects)",mat:"glass",w:0.2,sp:[450,950],kind:"consumable"},

      // Consumables - Combat & Defense
      {n:"smoke charm (one stealth test advantage)",mat:"cloth",w:0.1,sp:[350,800],kind:"consumable"},
      {n:"oil of edge (sharpen once, +1 damage one attack)",mat:"glass",w:0.2,sp:[450,1000],kind:"consumable"},
      {n:"warding ribbon (one save bolster)",mat:"cloth",w:0.05,sp:[350,900],kind:"consumable"},
      {n:"shield charm (one automatic hit becomes miss)",mat:"metal",w:0.1,sp:[550,1100],kind:"consumable"},
      {n:"thunderstone (thrown, loud bang, disorient)",mat:"stone",w:0.5,sp:[400,900],kind:"consumable"},
      {n:"flash powder (thrown, bright light, blind)",mat:"paper",w:0.1,sp:[400,900],kind:"consumable"},
      {n:"tanglefoot bag (thrown, restrain briefly)",mat:"cloth",w:1.0,sp:[450,950],kind:"consumable"},

      // Consumables - Movement & Utility
      {n:"feather token (negate a short fall once)",mat:"paper",w:0.05,sp:[500,1100],kind:"consumable"},
      {n:"boots of springing (one enhanced jump)",mat:"leather",w:0.5,sp:[500,1100],kind:"consumable"},
      {n:"potion of water breathing (10 minutes)",mat:"glass",w:0.3,sp:[600,1200],kind:"consumable"},
      {n:"dust of tracelessness (erase tracks for 1 hour)",mat:"paper",w:0.1,sp:[450,1000],kind:"consumable"},
      {n:"feather fall token (slow fall for 1 minute)",mat:"paper",w:0.05,sp:[550,1150],kind:"consumable"},

      // Consumables - Social & Luck
      {n:"lucky coin (one d20 reroll, once)",mat:"metal",w:0.05,sp:[600,1200],kind:"consumable"},
      {n:"charm of persuasion (advantage on one charisma check)",mat:"metal",w:0.05,sp:[400,900],kind:"consumable"},
      {n:"vial of courage (advantage vs one fear effect)",mat:"glass",w:0.2,sp:[350,850],kind:"consumable"},
      {n:"token of truth (know if next statement is lie)",mat:"metal",w:0.05,sp:[500,1000],kind:"consumable"},

      // Situational Gear - Exploration
      {n:"guide's pin (advantage on one navigation check)",mat:"metal",w:0.05,sp:[500,1200],kind:"gear"},
      {n:"wayfinder's compass (points to nearest settlement)",mat:"metal",w:0.3,sp:[700,1400],kind:"gear"},
      {n:"lens of detection (advantage on one search check)",mat:"glass",w:0.1,sp:[550,1150],kind:"gear"},
      {n:"ear trumpet of listening (advantage on one perception check)",mat:"metal",w:0.4,sp:[500,1100],kind:"gear"},
      {n:"dowsing rod (detect water within 100 ft)",mat:"wood",w:0.5,sp:[450,1000],kind:"gear"},

      // Situational Gear - Knowledge & Magic
      {n:"scribe's quill (advantage on one recall/decipher check)",mat:"wood",w:0.02,sp:[500,1200],kind:"gear"},
      {n:"scholar's monocle (read one language you don't know)",mat:"glass",w:0.1,sp:[650,1300],kind:"gear"},
      {n:"candle of revealing (detect invisible within 10 ft)",mat:"cloth",w:0.2,sp:[700,1400],kind:"gear"},
      {n:"chalk of warding (draw protective circle, 1 hour)",mat:"stone",w:0.1,sp:[550,1150],kind:"gear"},
      {n:"crystal of light (bright light 30 ft, 1 hour)",mat:"stone",w:0.3,sp:[400,900],kind:"gear"},

      // Situational Gear - Tools & Craft
      {n:"hammer of mending (repair one broken mundane item)",mat:"metal",w:1.0,sp:[600,1250],kind:"gear"},
      {n:"rope of climbing (advantage on climbing with this rope)",mat:"cloth",w:5.0,sp:[800,1600],kind:"gear"},
      {n:"thieves' gloves (advantage on one lockpicking attempt)",mat:"leather",w:0.2,sp:[650,1300],kind:"gear"},
      {n:"bag of endless knots (never runs out of rope, 50ft max)",mat:"cloth",w:0.5,sp:[750,1500],kind:"gear"},

      // Situational Gear - Nature & Animals
      {n:"beast whistle (calm one animal)",mat:"wood",w:0.1,sp:[450,950],kind:"gear"},
      {n:"druid's seed (grow edible fruit instantly, once)",mat:"wood",w:0.05,sp:[400,900],kind:"gear"},
      {n:"weatherglass (predict weather 24 hours ahead)",mat:"glass",w:0.4,sp:[550,1150],kind:"gear"},

      // Ongoing Minor Items (very limited power)
      {n:"everburning torch (sheds light, never consumed)",mat:"wood",w:1.0,sp:[1200,2400],kind:"ongoing"},
      {n:"self-heating mug (keeps beverages warm)",mat:"metal",w:0.5,sp:[500,1100],kind:"ongoing"},
      {n:"cleaning cloth (removes dirt/stains with a wipe)",mat:"cloth",w:0.1,sp:[400,900],kind:"ongoing"},
      {n:"compass of true north (always points north)",mat:"metal",w:0.2,sp:[600,1200],kind:"ongoing"},
      {n:"tankard of purity (detects poison in drink)",mat:"metal",w:0.6,sp:[750,1500],kind:"ongoing"},
      {n:"prestidigitation ring (create minor sensory effects)",mat:"metal",w:0.05,sp:[800,1600],kind:"ongoing"},
      {n:"warming cloak clasp (wearer comfortable in cold)",mat:"metal",w:0.1,sp:[700,1400],kind:"ongoing"},
      {n:"cooling hat pin (wearer comfortable in heat)",mat:"metal",w:0.05,sp:[700,1400],kind:"ongoing"}
    ],
    make:(rng,b)=>{
      const m=pick(rng,MATERIALS[b.mat]);
      const glimmer=rng()<0.6?` faintly glimmering`:"";
      const note=b.kind==="consumable"?"consumable":(b.kind==="ongoing"?"ongoing":"situational");
      return [`${toTitle(m)} ${b.n}${glimmer}`, tags("minor-magic",note), true]
    }
  }
};

// ---------- Hoard Template biases ----------
const TEMPLATE = {
  none:{ catMult:{}, bundleBias:{}, flavor:[] },
  bandit:{
    catMult:{ "Coins & Purses":1.2,"Trade Goods":1.1,"Toolkits & Supplies":1.0,"Adventuring Gear of Note":1.0,"Curios & Charms":0.9,"Gems & Art":0.8 },
    bundleBias:{ smuggler:0.35, hunter:0.15, merchant:0.2 },
    flavor:["smoke-stained","hastily wrapped","mud-spattered","with crude tally marks"]
  },
  cult:{
    catMult:{ "Writing & Games":1.15,"Toolkits & Supplies":1.1,"Gems & Art":1.1,"Household & Table":0.9,"Trade Goods":0.9 },
    bundleBias:{ smuggler:0.15, hunter:0.05, merchant:0.1 },
    flavor:["daubed with chalk sigils","faint incense scent","bound in dark ribbon","scribed margins"]
  },
  noble:{
    catMult:{ "Gems & Art":1.4,"Trade Goods":1.2,"Coins & Purses":1.1,"Clothing & Wearables":1.1,"Curios & Charms":0.8 },
    bundleBias:{ merchant:0.35, smuggler:0.1, hunter:0.05 },
    flavor:["wax seal stamped","finely chased","embroidered crest","wrapped in silk"]
  },
  goblin:{
    catMult:{ "Food & Provisions":1.2,"Bags & Containers":1.1,"Tools & Utensils":1.1,"Coins & Purses":0.9,"Gems & Art":0.7 },
    bundleBias:{ hunter:0.4, smuggler:0.1, merchant:0.05 },
    flavor:["sticky resin smell","crudely knotted","patchwork repairs","scratched with tally cuts"]
  },
  ship:{
    catMult:{ "Trade Goods":1.3,"Toolkits & Supplies":1.2,"Bags & Containers":1.1,"Coins & Purses":1.0 },
    bundleBias:{ merchant:0.45, smuggler:0.3, hunter:0.05 },
    flavor:["tarred twine","salt-stained","stenciled crate marks","sealed with pitch"]
  },
  wizard:{
    catMult:{ "Writing & Games":1.25,"Toolkits & Supplies":1.2,"Adventuring Gear of Note":1.1,"Gems & Art":1.05 },
    bundleBias:{ smuggler:0.15, merchant:0.2, hunter:0.05 },
    flavor:["ink-splattered","annotated margin","arcane diagram stamps","scent of ozone"]
  }
};

// ---------- Monster-specific loot templates ----------
const MONSTER_TEMPLATES = {
  dragon:{
    catMult:{ "Gems & Art":2.0,"Coins & Purses":1.8,"Trade Goods":1.3,"Adventuring Gear of Note":1.2,"Minor Magic":1.5 },
    bundleBias:{ merchant:0.3, smuggler:0.05, hunter:0.05 },
    flavor:["scorched edges","melted slightly","gleaming","ancient","partially fused"]
  },
  lich:{
    catMult:{ "Writing & Games":1.8,"Toolkits & Supplies":1.5,"Gems & Art":1.4,"Minor Magic":1.6,"Curios & Charms":1.3 },
    bundleBias:{ smuggler:0.2, merchant:0.15, hunter:0.05 },
    flavor:["necromantic runes","bone-white","desiccated","ancient parchment","death-touched"]
  },
  vampire:{
    catMult:{ "Gems & Art":1.6,"Clothing & Wearables":1.5,"Coins & Purses":1.4,"Trade Goods":1.3,"Minor Magic":1.2 },
    bundleBias:{ merchant:0.35, smuggler:0.15, hunter:0.05 },
    flavor:["blood-stained","velvet-lined","aristocratic","night-black","crimson accents"]
  },
  beholder:{
    catMult:{ "Gems & Art":1.7,"Curios & Charms":1.5,"Minor Magic":1.8,"Writing & Games":1.2,"Toolkits & Supplies":1.3 },
    bundleBias:{ smuggler:0.25, merchant:0.2, hunter:0.1 },
    flavor:["alien geometry","faintly humming","prismatic","eye-shaped motif","arcane resonance"]
  },
  giant:{
    catMult:{ "Food & Provisions":1.5,"Bags & Containers":1.3,"Trade Goods":1.4,"Coins & Purses":1.2,"Mundane Adventuring Items":1.3 },
    bundleBias:{ hunter:0.4, merchant:0.25, smuggler:0.1 },
    flavor:["oversized","crudely fashioned","massive scale","boulder-sized","primitive"]
  },
  demon:{
    catMult:{ "Gems & Art":1.5,"Minor Magic":1.7,"Curios & Charms":1.4,"Coins & Purses":1.3 },
    bundleBias:{ smuggler:0.3, merchant:0.15, hunter:0.1 },
    flavor:["sulfurous","infernal script","smoldering","cursed-looking","abyssal"]
  },
  fey:{
    catMult:{ "Curios & Charms":1.8,"Gems & Art":1.5,"Clothing & Wearables":1.4,"Minor Magic":1.6,"Food & Provisions":1.3 },
    bundleBias:{ merchant:0.2, smuggler:0.15, hunter:0.2 },
    flavor:["rainbow-hued","gossamer","moonlit","star-kissed","enchanted shimmer"]
  },
  aberration:{
    catMult:{ "Curios & Charms":1.6,"Writing & Games":1.4,"Minor Magic":1.5,"Gems & Art":1.2 },
    bundleBias:{ smuggler:0.3, merchant:0.1, hunter:0.15 },
    flavor:["otherworldly","non-euclidean","pulsating","mind-bending","eldritch"]
  },
  undead:{
    catMult:{ "Coins & Purses":1.3,"Gems & Art":1.2,"Clothing & Wearables":1.2,"Mundane Adventuring Items":1.1 },
    bundleBias:{ merchant:0.2, hunter:0.15, smuggler:0.15 },
    flavor:["grave-touched","musty","decayed","tomb-sealed","centuries-old"]
  }
};

// ---------- Value & Weight ----------
function estimateValue(rng,b){const baseSp=b.sp[0]+Math.floor(rng()*(b.sp[1]-b.sp[0]+1));return Math.max(1,baseSp)}
function estimateWeight(rng,b){const jitter=(rng()-0.5)*0.1*b.w;return Math.max(0.01, +(b.w + jitter).toFixed(2))}

// Masterwork upgrade
function tryUpgrade(rng,item){
  if(rng()<0.08){
    item.title=item.title.replace(/^(?:plain|used|well-used|sturdy|serviceable)\s/i,"");
    item.title=item.title.replace(/^(.*)$/i,"masterwork $1");
    item.value=Math.floor(item.value*(1.5+rng()*0.8));
  }
}

// Themed bundles (return an item already bundled)
function themedBundle(rng, templateKey){
  const mkContainer=(titleBase)=>({cat:"Bags & Containers",title:titleBase,value:0,weight:0.4,tags:["bundle","container"],isValuable:true});
  const coin=(sp)=>({cat:"Coins & Purses",title:`Pouch of ${spToGp(sp)} gp (${sp} sp)`,value:sp,weight:0.05,tags:["currency"],isValuable:true});

  const choice = (()=> {
    const bias = TEMPLATE[templateKey]?.bundleBias || {};
    const r = rng();
    const pS = bias.smuggler||0, pH = (pS + (bias.hunter||0)), pM = (pH + (bias.merchant||0));
    if(r < pS) return "smuggler";
    if(r < pH) return "hunter";
    if(r < pM) return "merchant";
    return pick(rng,["smuggler","hunter","merchant"]);
  })();

  if(choice==="smuggler"){
    const base = mkContainer("Smuggler’s tin");
    const picks = [
      {cat:"Toolkits & Supplies",title:"Lockpicks (quality set)",value:estimateValue(rng,{sp:[900,2400]}),weight:0.2,tags:["tools","specialty"],isValuable:true},
      {cat:"Toolkits & Supplies",title:"Forged papers (traveler’s marks)",value:estimateValue(rng,{sp:[700,1500]}),weight:0.1,tags:["tools","paper"],isValuable:true},
      coin(70)
    ];
    base.title += ` containing ${picks.map(p=>p.title).join("; ")}`;
    base.value = picks.reduce((t,p)=>t+p.value,0);
    base.weight = +(base.weight + picks.reduce((t,p)=>t+p.weight,0)).toFixed(2);
    return base;
  }
  if(choice==="hunter"){
    const base = mkContainer("Hunter’s roll");
    const picks = [
      {cat:"Adventuring Gear of Note",title:"Snares (3)",value:estimateValue(rng,{sp:[120,300]}),weight:0.6,tags:["gear"],isValuable:false},
      {cat:"Adventuring Gear of Note",title:"Pitons (10)",value:estimateValue(rng,{sp:[300,900]}),weight:5.0,tags:["gear"],isValuable:true},
      {cat:"Adventuring Gear of Note",title:"Rope, hempen 50′",value:estimateValue(rng,{sp:[100,300]}),weight:10.0,tags:["gear"],isValuable:false}
    ];
    base.title += ` containing ${picks.map(p=>p.title).join("; ")}`;
    base.value = picks.reduce((t,p)=>t+p.value,0);
    base.weight = +(base.weight + picks.reduce((t,p)=>t+p.weight,0)).toFixed(2);
    return base;
  }
  // merchant
  const base = mkContainer("Merchant parcel");
  const picks = [
    {cat:"Trade Goods",title:"Spices (sealed pouch)",value:estimateValue(rng,{sp:[400,1200]}),weight:1.0,tags:["trade"],isValuable:true},
    {cat:"Trade Goods",title:"Fine cloth (rolled)",value:estimateValue(rng,{sp:[300,1000]}),weight:2.0,tags:["trade"],isValuable:true},
    {cat:"Writing & Games",title:"Tally slate with chalk",value:estimateValue(rng,{sp:[80,220]}),weight:0.6,tags:["stationery"],isValuable:false}
  ];
  base.title += ` containing ${picks.map(p=>p.title).join("; ")}`;
  base.value = picks.reduce((t,p)=>t+p.value,0);
  base.weight = +(base.weight + picks.reduce((t,p)=>t+p.weight,0)).toFixed(2);
  return base;
}

// Maybe bundle contents inside containers; inject themed bundles sometimes
function maybeBundle(rng,item,templateKey){
  // Occasionally replace a normal container with a themed bundle
  if(item.cat==="Bags & Containers" && rng()<0.18){
    return themedBundle(rng, templateKey||"none");
  }
  if(item.cat!=="Bags & Containers"||rng()>=0.18) return item;

  const howMany=1+Math.floor(rng()*3);
  // Fill categories are template-aware
  let catsForFill=["Coins & Purses","Writing & Games","Tools & Utensils","Adventuring Gear of Note","Gems & Art"];
  if(templateKey==="wizard") catsForFill=["Writing & Games","Toolkits & Supplies","Adventuring Gear of Note","Coins & Purses"];
  if(templateKey==="ship") catsForFill=["Trade Goods","Bags & Containers","Coins & Purses","Toolkits & Supplies"];
  if(templateKey==="goblin") catsForFill=["Food & Provisions","Tools & Utensils","Coins & Purses","Bags & Containers"];

  const picks=[];
  for(let i=0;i<howMany;i++){
    const c=pick(rng,catsForFill);
    const inner=makeOne(rng,c,true,templateKey);
    picks.push(inner);
  }
  const innerText=picks.map(p=>p.title).join("; ");
  item.title+=` containing ${innerText}`;
  item.value+=picks.reduce((t,p)=>t+p.value,0);
  item.weight=+(item.weight+picks.reduce((t,p)=>t+p.weight,0)).toFixed(2);
  item.tags=Array.from(new Set([...item.tags,"bundle","container"]));
  item.isValuable=item.isValuable||picks.some(p=>p.isValuable);
  return item;
}

// Compose one
function makeOne(rng,catKey,noBundle=false,templateKey="none",magicOn=false,cursedOn=false,curseSeverity=3){
  const cat=CATS[catKey];

  // For cursed items, filter by severity
  let basePool = cat.base;
  if(catKey === "Cursed Items" && cursedOn){
    basePool = cat.base.filter(b => b.severity <= curseSeverity);
    if(basePool.length === 0) basePool = cat.base; // fallback if no items match
  }

  const base=pick(rng,basePool);
  let [desc,taglist,forceVal]=cat.make(rng,base);

  // Template flavor injections (light touch)
  const fl=TEMPLATE[templateKey]?.flavor||[];
  if(fl.length && rng()<0.35) desc += `, ${pick(rng,fl)}`;

  let sp=estimateValue(rng,base), wt=estimateWeight(rng,base);
  let title=toTitle(desc);
  const item={k:`${catKey}:${title}`,cat:catKey,title,value:sp,weight:wt,tags:taglist,isValuable:!!forceVal};

  // Minor magic items and cursed items stay low-impact; skip masterwork for special items
  if(catKey!=="Minor Magic" && catKey!=="Cursed Items") tryUpgrade(rng,item);

  return noBundle?item:maybeBundle(rng,item,templateKey);
}

// Weighted category pick from usefulness slider + template multipliers; include Minor Magic and Cursed Items if allowed
function categoryWeights(selectedCats,usefulness01,templateKey,magicOn,cursedOn){
  const base = {
    "Trade Goods": 0.8, "Gems & Art": 0.9, "Adventuring Gear of Note": 0.85, "Toolkits & Supplies": 0.8,
    "Coins & Purses": 0.6,
    "Clothing & Wearables": 0.4, "Tools & Utensils": 0.5, "Household & Table": 0.35,
    "Writing & Games": 0.45, "Food & Provisions": 0.35, "Curios & Charms": 0.3, "Bags & Containers": 0.5,
    "Mundane Adventuring Items": 0.6,
    "Minor Magic": magicOn ? 0.35 : 0.0,
    "Cursed Items": cursedOn ? 0.25 : 0.0
  };
  const flavorBoost = 1 - usefulness01;
  const usefulBoost = usefulness01;
  const mult = TEMPLATE[templateKey]?.catMult || {};

  const weights = {};
  for(const c of selectedCats){
    let w = base[c] ?? 0.5;
    if(["Curios & Charms","Household & Table","Food & Provisions","Clothing & Wearables","Writing & Games"].includes(c)) {
      w = w*(0.6 + 0.8*flavorBoost);
    } else {
      w = w*(0.6 + 0.8*usefulBoost);
    }
    if(mult[c]) w *= mult[c];
    weights[c]=Math.max(0.0001,w);
  }
  // If magic on, add Minor Magic implicitly (not in checkboxes)
  if(magicOn){
    let w = base["Minor Magic"];
    if(templateKey==="wizard") w *= 1.35;
    weights["Minor Magic"] = (weights["Minor Magic"]||0) + w;
  }

  // If cursed on, add Cursed Items implicitly (not in checkboxes)
  if(cursedOn){
    let w = base["Cursed Items"];
    if(templateKey==="lich") w *= 1.5;
    if(templateKey==="demon") w *= 1.4;
    if(templateKey==="undead") w *= 1.3;
    weights["Cursed Items"] = (weights["Cursed Items"]||0) + w;
  }

  // normalize
  const sum = Object.values(weights).reduce((a,b)=>a+b,0) || 1;
  for(const k in weights) weights[k]/=sum;
  return weights;
}
function weightedPick(rng, cats, weights){
  const r=rng(); let acc=0;
  for(const c of cats){ acc+=weights[c]??0; if(r<=acc) return c; }
  return cats[cats.length-1];
}

// ---------- UI bootstrap: categories ----------
(function buildCategoryCheckboxes(){
  const wrap=$("lg-cats"); wrap.innerHTML="";
  const order = Object.keys(CATS).filter(k=>k!=="Minor Magic"); // magic is gated
  for(const k of order){
    const id="cat-"+k.replace(/[^a-z0-9]/gi,'');
    const checked = !["Curios & Charms","Household & Table"].includes(k);
    const div=document.createElement("div");div.className="col";
    div.innerHTML=`<div class="form-check">
      <input class="form-check-input" type="checkbox" id="${id}" data-cat="${k}" ${checked?"checked":""}>
      <label class="form-check-label" for="${id}">${k}</label>
    </div>`;
    wrap.appendChild(div);
  }
})();

// ---------- Generation core (Count mode) ----------
function generateCount(rng, selectedCats, opts){
  const {count,minSp,maxSp,usefulness01,templateKey,magicOn,cursedOn,curseSeverity} = opts;
  const weights=categoryWeights(selectedCats,usefulness01,templateKey,magicOn,cursedOn);
  const seen=new Set(), list=[];
  let guard=0, maxGuard=count*100;

  // include Minor Magic and Cursed Items implicitly in selection list when enabled
  let pickableCats = [...selectedCats];
  if(magicOn) pickableCats.push("Minor Magic");
  if(cursedOn) pickableCats.push("Cursed Items");

  while(list.length<count && guard++<maxGuard){
    const cat=weightedPick(rng,pickableCats,weights);
    const item=makeOne(rng,cat,false,templateKey,magicOn,cursedOn,curseSeverity);
    if(item.value<minSp || item.value>maxSp) continue;
    if(seen.has(item.k)) continue;
    seen.add(item.k);
    list.push(item);
  }
  return list;
}

// ---------- Generation to budget (Budget mode) ----------
function generateToBudget(rng, selectedCats, opts){
  const {targetSp, softCount, minSp, maxSp, usefulness01, templateKey, magicOn, cursedOn, curseSeverity} = opts;
  const weights=categoryWeights(selectedCats,usefulness01,templateKey,magicOn,cursedOn);
  let pickableCats = [...selectedCats];
  if(magicOn) pickableCats.push("Minor Magic");
  if(cursedOn) pickableCats.push("Cursed Items");
  const list=[]; let total=0; let guard=0;

  // Greedy fill
  while(total<targetSp*0.9 && guard++<6000){
    const cat=weightedPick(rng,pickableCats,weights);
    const it=makeOne(rng,cat,false,templateKey,magicOn,cursedOn,curseSeverity);
    if(it.value>maxSp || it.value<minSp) continue;
    if(softCount && list.length>=softCount && total+it.value>targetSp*1.1) break;
    if(total+it.value>targetSp*1.15 && rng()<0.7) continue;
    list.push(it); total+=it.value;
  }

  // Improvement pass to aim ±10%
  let tries=250;
  while(tries-- && (total<targetSp*0.9 || total>targetSp*1.1) && list.length){
    const i=Math.floor(rng()*list.length);
    const old=list[i];
    const cat=weightedPick(rng,pickableCats,weights);
    const cand=makeOne(rng,cat,false,templateKey,magicOn,cursedOn,curseSeverity);
    if(cand.value>maxSp || cand.value<minSp) continue;
    const newTotal=total-old.value+cand.value;
    if(Math.abs(newTotal-targetSp) < Math.abs(total-targetSp)){
      list[i]=cand; total=newTotal;
    }
  }
  return list;
}

// ---------- Render & meta ----------
function renderList(list, wantWeight, wantTags){
  const out=$("lg-out"); out.innerHTML="";
  let totalSp=0, totalWt=0, valCount=0, cursedCount=0;
  for(const it of list){
    totalSp+=it.value; totalWt+=it.weight; if(it.isValuable) valCount++;
    const isCursed = it.cat === "Cursed Items";
    if(isCursed) cursedCount++;
    const col=document.createElement("div"); col.className="col";
    const div=document.createElement("div"); div.className="loot-tile";

    // Add special styling for cursed items
    if(isCursed){
      div.style.borderColor = "#dc3545";
      div.style.backgroundColor = "rgba(220, 53, 69, 0.1)";
    }

    const gp=spToGp(it.value);
    const cursedMarker = isCursed ? ' • <span class="text-danger"><i class="bi bi-exclamation-triangle-fill"></i> CURSED</span>' : '';
    div.innerHTML=`
      <div class="loot-title">${it.title}</div>
      <div class="loot-sub">${it.cat}${it.isValuable?' • <span class="text-warning">valuable</span>':''}${cursedMarker}</div>
      <div class="loot-meta">${(gp%1?gp.toFixed(2):gp)} gp (${it.value} sp)${wantWeight?` • ${it.weight} lb`:``}${wantTags?` • ${it.tags.join(", ")}`:``}</div>
    `;
    col.appendChild(div); out.appendChild(col);
  }
  const meta=$("lg-meta"); meta.innerHTML="";
  const pills = [
    ["Items", list.length],
    ["Total value", `${spToGp(totalSp)} gp (${totalSp} sp)`],
    ["Total weight", `${totalWt.toFixed(2)} lb`],
    ["Valuable", `${valCount} (${Math.round((valCount/(list.length||1))*100)}%)`]
  ];
  if(cursedCount > 0){
    pills.push(["Cursed", `${cursedCount} (${Math.round((cursedCount/(list.length||1))*100)}%)`]);
  }
  for(const [k,v] of pills){ const s=document.createElement("span"); s.className="pill"; s.textContent=`${k}: ${v}`; meta.appendChild(s); }
}

// ---------- Clipboard / download ----------
function copyOut(){
  const rows=[...document.querySelectorAll("#lg-out .loot-tile")].map(tile=>{
    const t=tile.querySelector(".loot-title").textContent;
    const m=tile.querySelector(".loot-meta").textContent;
    return `${t} — ${m}`;
  });
  if(!rows.length) return;
  navigator.clipboard.writeText(rows.join("\n"));
}
function downloadOut(){
  const rows=[...document.querySelectorAll("#lg-out .loot-tile")].map(tile=>{
    const t=tile.querySelector(".loot-title").textContent;
    const s=tile.querySelector(".loot-sub").textContent;
    const m=tile.querySelector(".loot-meta").textContent;
    return `${t}\n${s}\n${m}\n`;
  });
  if(!rows.length) return;
  const blob=new Blob([rows.join("\n")],{type:"text/plain"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a"); a.href=url; a.download="loot.txt"; a.click(); URL.revokeObjectURL(url);
}

// ---------- Presets ----------
const PRESETS = {
  custom: ()=>{},
  t1: ()=>{
    $("lg-mode-count").checked=true;
    $("lg-min").value=1; $("lg-max").value=30;
    $("lg-budget").value=120; $("lg-use").value=45; $("lg-count").value=30;
  },
  t2: ()=>{
    $("lg-mode-budget").checked=true;
    $("lg-min").value=5; $("lg-max").value=120;
    $("lg-budget").value=450; $("lg-use").value=60; $("lg-count").value=40;
  },
  t3: ()=>{
    $("lg-mode-budget").checked=true;
    $("lg-min").value=10; $("lg-max").value=300;
    $("lg-budget").value=1200; $("lg-use").value=70; $("lg-count").value=50;
  },
  t4: ()=>{
    $("lg-mode-budget").checked=true;
    $("lg-min").value=20; $("lg-max").value=600;
    $("lg-budget").value=3000; $("lg-use").value=75; $("lg-count").value=60;
  }
};

// ---------- Wire up ----------
function currentSelectedCats(){
  return [...document.querySelectorAll("#lg-cats input:checked")].map(x=>x.dataset.cat);
}

// Custom loot tables storage
let customLootTables = {};

// Quick Bundle configurations
const QUICK_BUNDLES = {
  pocket: {
    name: "Pocket Loot",
    mode: "count",
    lootType: "individual",
    count: 5,
    min: 1,
    max: 15,
    budget: 50,
    usefulness: 50,
    template: "none",
    monster: "none",
    magic: false,
    categories: ["Coins & Purses", "Food & Provisions", "Tools & Utensils", "Mundane Adventuring Items"]
  },
  coinpouch: {
    name: "Coin Pouch",
    mode: "budget",
    lootType: "individual",
    count: 3,
    min: 50,
    max: 200,
    budget: 350,
    usefulness: 10,
    template: "none",
    monster: "none",
    magic: false,
    categories: ["Coins & Purses"]
  },
  gems: {
    name: "5 Gems",
    mode: "count",
    lootType: "hoard",
    count: 5,
    min: 50,
    max: 200,
    budget: 500,
    usefulness: 80,
    template: "none",
    monster: "none",
    magic: false,
    categories: ["Gems & Art"]
  },
  potions: {
    name: "Potion Bundle (3)",
    mode: "count",
    lootType: "hoard",
    count: 3,
    min: 20,
    max: 100,
    budget: 150,
    usefulness: 100,
    template: "none",
    monster: "none",
    magic: true,
    categories: ["Adventuring Gear of Note"]
  },
  scrolls: {
    name: "Scroll Bundle (3)",
    mode: "count",
    lootType: "hoard",
    count: 3,
    min: 20,
    max: 150,
    budget: 200,
    usefulness: 100,
    template: "none",
    monster: "none",
    magic: true,
    categories: ["Toolkits & Supplies"]
  },
  boss: {
    name: "Boss Hoard",
    mode: "budget",
    lootType: "hoard",
    count: 50,
    min: 10,
    max: 300,
    budget: 2000,
    usefulness: 75,
    template: "none",
    monster: "none",
    magic: true,
    categories: ["Coins & Purses", "Gems & Art", "Trade Goods", "Adventuring Gear of Note"]
  },
  magicitems: {
    name: "Magic Items",
    mode: "count",
    lootType: "hoard",
    count: 8,
    min: 30,
    max: 200,
    budget: 800,
    usefulness: 90,
    template: "none",
    monster: "none",
    magic: true,
    cursed: false,
    curseSeverity: 3,
    categories: ["Adventuring Gear of Note", "Toolkits & Supplies", "Gems & Art", "Trade Goods", "Bags & Containers"]
  },
  curseditems: {
    name: "Cursed Items",
    mode: "count",
    lootType: "hoard",
    count: 6,
    min: 40,
    max: 250,
    budget: 900,
    usefulness: 80,
    template: "none",
    monster: "none",
    magic: false,
    cursed: true,
    curseSeverity: 3,
    categories: ["Adventuring Gear of Note", "Toolkits & Supplies", "Clothing & Wearables", "Gems & Art", "Bags & Containers"]
  }
};

function applyQuickBundle(bundleKey) {
  const bundle = QUICK_BUNDLES[bundleKey];
  if (!bundle) return;

  // Set all form values
  if (bundle.mode === "budget") {
    $("lg-mode-budget").checked = true;
  } else {
    $("lg-mode-count").checked = true;
  }

  if (bundle.lootType === "individual") {
    $("lg-loot-individual").checked = true;
  } else {
    $("lg-loot-hoard").checked = true;
  }

  $("lg-count").value = bundle.count;
  $("lg-min").value = bundle.min;
  $("lg-max").value = bundle.max;
  $("lg-budget").value = bundle.budget;
  $("lg-use").value = bundle.usefulness;
  $("lg-template").value = bundle.template;
  $("lg-monster").value = bundle.monster;
  $("lg-magic").checked = bundle.magic;
  $("lg-cursed").checked = bundle.cursed || false;
  $("lg-curse-severity").value = bundle.curseSeverity || 3;

  // Show/hide curse severity based on cursed toggle
  $("lg-curse-severity-wrap").style.display = bundle.cursed ? "block" : "none";

  // Set categories - uncheck all first, then check only bundle categories
  document.querySelectorAll("#lg-cats input[type='checkbox']").forEach(cb => {
    cb.checked = bundle.categories.includes(cb.dataset.cat);
  });

  // Auto-generate
  doGenerate();
}

function doGenerate(){
  const seed=$("lg-seed").value.trim(); const rng=prand(seed);
  const mode=document.querySelector('input[name="lg-mode"]:checked').value;
  const lootType=document.querySelector('input[name="lg-loot-type"]:checked').value;
  const count=clamp(+$("lg-count").value||50,1,5000);
  const minSp=Math.max(0,+$("lg-min").value||0);
  const maxGp=Math.max(1,+$("lg-max").value||25); const maxSp=maxGp*10;
  const targetGp=Math.max(1,+$("lg-budget").value||150); const targetSp=gpToSp(targetGp);
  const usefulness01 = Math.max(0,Math.min(1,(+$("lg-use").value||50)/100));
  const monsterType = $("lg-monster").value || "none";
  let templateKey = $("lg-template").value || "none";
  const customTableKey = $("lg-custom-table").value || "";
  const magicOn = $("lg-magic").checked;
  const cursedOn = $("lg-cursed").checked;
  const curseSeverity = cursedOn ? (+$("lg-curse-severity").value || 3) : 3;

  // Monster type overrides template
  if(monsterType !== "none"){
    templateKey = monsterType;
    // Merge MONSTER_TEMPLATES with TEMPLATE for compatibility
    if(MONSTER_TEMPLATES[monsterType] && !TEMPLATE[monsterType]){
      TEMPLATE[monsterType] = MONSTER_TEMPLATES[monsterType];
    }
  }

  // Apply individual loot type adjustments
  let adjustedCount = count;
  let adjustedBudget = targetSp;
  if(lootType === "individual"){
    adjustedCount = Math.max(1, Math.floor(count / 10));
    adjustedBudget = Math.floor(targetSp / 10);
  }

  let selectedCats=currentSelectedCats();

  // Use custom loot table if selected
  if(customTableKey && customLootTables[customTableKey]){
    const customTable = customLootTables[customTableKey];
    if(customTable.categories){
      selectedCats = customTable.categories;
    }
    if(customTable.template){
      TEMPLATE[customTableKey] = customTable.template;
      templateKey = customTableKey;
    }
  }

  if(!selectedCats.length){ alert("Select at least one category."); return; }

  const wantWeight=$("lg-weight").checked, wantTags=$("lg-tags").checked;

  let list=[];
  if(mode==="budget"){
    list=generateToBudget(rng,selectedCats,{
      targetSp: adjustedBudget, softCount: adjustedCount, minSp, maxSp, usefulness01, templateKey, magicOn, cursedOn, curseSeverity
    });
  }else{
    list=generateCount(rng,selectedCats,{
      count: adjustedCount, minSp, maxSp, usefulness01, templateKey, magicOn, cursedOn, curseSeverity
    });
  }
  renderList(list,wantWeight,wantTags);
}

// Save/Load Preset functionality
function savePreset(){
  const name = $("lg-preset-name").value.trim();
  if(!name){ alert("Enter a preset name."); return; }

  const preset = {
    mode: document.querySelector('input[name="lg-mode"]:checked').value,
    lootType: document.querySelector('input[name="lg-loot-type"]:checked').value,
    count: $("lg-count").value,
    seed: $("lg-seed").value,
    min: $("lg-min").value,
    max: $("lg-max").value,
    budget: $("lg-budget").value,
    usefulness: $("lg-use").value,
    monster: $("lg-monster").value,
    template: $("lg-template").value,
    magic: $("lg-magic").checked,
    cursed: $("lg-cursed").checked,
    curseSeverity: $("lg-curse-severity").value,
    weight: $("lg-weight").checked,
    tags: $("lg-tags").checked,
    categories: currentSelectedCats()
  };

  const presets = JSON.parse(localStorage.getItem("lootPresets") || "{}");
  presets[name] = preset;
  localStorage.setItem("lootPresets", JSON.stringify(presets));
  loadPresetList();
  alert(`Preset "${name}" saved!`);
}

function loadPreset(){
  const name = $("lg-saved-presets").value;
  if(!name){ alert("Select a preset to load."); return; }

  const presets = JSON.parse(localStorage.getItem("lootPresets") || "{}");
  const preset = presets[name];
  if(!preset){ alert("Preset not found."); return; }

  // Apply preset values
  if(preset.mode === "count") $("lg-mode-count").checked = true;
  else $("lg-mode-budget").checked = true;

  if(preset.lootType === "hoard") $("lg-loot-hoard").checked = true;
  else $("lg-loot-individual").checked = true;

  $("lg-count").value = preset.count || 50;
  $("lg-seed").value = preset.seed || "";
  $("lg-min").value = preset.min || 1;
  $("lg-max").value = preset.max || 25;
  $("lg-budget").value = preset.budget || 150;
  $("lg-use").value = preset.usefulness || 50;
  $("lg-monster").value = preset.monster || "none";
  $("lg-template").value = preset.template || "none";
  $("lg-magic").checked = preset.magic || false;
  $("lg-cursed").checked = preset.cursed || false;
  $("lg-curse-severity").value = preset.curseSeverity || 3;
  $("lg-weight").checked = preset.weight !== false;
  $("lg-tags").checked = preset.tags !== false;

  // Show/hide curse severity based on cursed toggle
  $("lg-curse-severity-wrap").style.display = preset.cursed ? "block" : "none";

  // Restore categories
  document.querySelectorAll("#lg-cats input").forEach(cb => {
    cb.checked = preset.categories?.includes(cb.dataset.cat) || false;
  });

  alert(`Preset "${name}" loaded!`);
}

function loadPresetList(){
  const presets = JSON.parse(localStorage.getItem("lootPresets") || "{}");
  const select = $("lg-saved-presets");
  select.innerHTML = '<option value="">-- Select a saved preset --</option>';
  for(const name in presets){
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  }
}

// Import custom loot table
function importCustomTable(){
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".json";
  input.onchange = (e) => {
    const file = e.target.files[0];
    if(!file) return;

    const reader = new FileReader();
    reader.onload = (evt) => {
      try{
        const data = JSON.parse(evt.target.result);
        if(!data.name){ alert("Custom loot table must have a 'name' field."); return; }

        customLootTables[data.name] = data;

        const select = $("lg-custom-table");
        const opt = document.createElement("option");
        opt.value = data.name;
        opt.textContent = data.name;
        select.appendChild(opt);
        select.value = data.name;

        alert(`Custom loot table "${data.name}" imported!`);
      }catch(err){
        alert("Invalid JSON file: " + err.message);
      }
    };
    reader.readAsText(file);
  };
  input.click();
}

document.addEventListener("DOMContentLoaded",()=>{
  // Simple/Advanced mode toggle
  const advancedKey = 'dmtools.advancedMode.loot';
  const advancedToggle = $('advancedModeToggle');
  const settingsBody = $('lootSettingsBody');

  const isAdvanced = localStorage.getItem(advancedKey) === 'true';
  advancedToggle.checked = isAdvanced;
  if (isAdvanced) settingsBody.classList.add('advanced-mode');

  advancedToggle.addEventListener('change', () => {
    if (advancedToggle.checked) {
      settingsBody.classList.add('advanced-mode');
      localStorage.setItem(advancedKey, 'true');
    } else {
      settingsBody.classList.remove('advanced-mode');
      localStorage.setItem(advancedKey, 'false');
    }
  });

  $("lg-generate").addEventListener("click",doGenerate);
  $("lg-copy").addEventListener("click",copyOut);
  $("lg-download").addEventListener("click",downloadOut);
  $("lg-clear").addEventListener("click",()=>{ $("lg-out").innerHTML=""; $("lg-meta").innerHTML=""; });

  $("lg-preset").addEventListener("change",(e)=>{
    const v=e.target.value; (PRESETS[v]||PRESETS.custom)();
  });

  // Cursed items toggle - show/hide severity slider
  $("lg-cursed").addEventListener("change",(e)=>{
    const wrap = $("lg-curse-severity-wrap");
    wrap.style.display = e.target.checked ? "block" : "none";
  });

  // Quick Bundle event listeners
  document.querySelectorAll(".quick-bundle-btn").forEach(btn => {
    btn.addEventListener("click", (e) => {
      e.preventDefault();
      const bundleKey = btn.dataset.bundle;
      applyQuickBundle(bundleKey);
    });
  });

  // New event handlers
  $("lg-save-preset").addEventListener("click",savePreset);
  $("lg-load-preset").addEventListener("click",loadPreset);
  $("lg-import-custom").addEventListener("click",importCustomTable);

  // Load saved presets on startup
  loadPresetList();

  // First run
  doGenerate();
});
})();
  </script>
</body>
</html>
