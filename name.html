<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Name Generator</title>

  <!-- Bootstrap CSS + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css" />

  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />

  <!-- Dev Icons (unused here but kept for parity) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

  <style>
    .bgimage{
      background: url('images/BGMap.png') no-repeat center center fixed;
      background-size: cover;
    }
    @media (max-width: 576px){
      .bgimage{ background-attachment: scroll; }
    }
    .ng-pill { border: 1px solid rgba(255,255,255,.15); border-radius: 50rem; padding: .15rem .5rem; }
    .ng-tile {
                display: flex;
                flex-direction: column;  
                align-items: stretch;
                justify-content: center;
                gap: .4rem;
                border: 1px solid rgba(255,255,255,.15);
                border-radius: .6rem;
                padding: .6rem .75rem;
                background: rgba(0,0,0,.25);
                min-height: 64px;
          }

    .ng-name {
                text-align: center;
                font-weight: 500;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
              }

    .ng-actions {
                  display: flex;
                  justify-content: center;
                  gap: .4rem;
                }
    .ng-actions .btn {
                        padding: .25rem .4rem;
                        font-size: .9rem;
                      }
    .help-badge { font-size: .8rem; vertical-align: middle; cursor: help; }
    .code-block { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.1); border-radius: .5rem; padding: .75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: .9rem; overflow:auto;}
    #ng-out .col { display: flex; }
    #ng-out .ng-tile {width: 100%; height: 100%;}
  </style>
</head>
<body class="bgimage">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Initiative</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="name.html">Name Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="loot.html">Loot Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="npc.html">NPC Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="tav.html">Tavern/Inn Gen</a></li>
        </ul>
        <div class="d-none d-lg-flex gap-2">
          <button class="btn btn-outline-warning btn-sm" id="btnFavorites" data-bs-toggle="offcanvas" data-bs-target="#favoritesDrawer" aria-controls="favoritesDrawer">
            <i class="bi bi-star me-1"></i>Favorites
          </button>
          <button class="btn btn-outline-info btn-sm" id="btnShare"><i class="bi bi-link-45deg me-1"></i>Share</button>
        </div>
      </div>
    </div>
   </nav>

  <!-- Main -->
  <main class="content pt-5 mt-3">
    <div class="container py-3">
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="backdrop">
          <h1 class="h3 mb-0">Name Generator</h1>
        </div>
        <!-- Mobile: open settings offcanvas -->
        <div class="d-lg-none d-flex gap-2">
          <button class="btn btn-outline-warning btn-sm" data-bs-toggle="offcanvas" data-bs-target="#favoritesDrawer"><i class="bi bi-star"></i></button>
          <button class="btn btn-outline-info btn-sm" id="btnShareXS"><i class="bi bi-link-45deg"></i></button>
          <button class="btn btn-outline-light" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
            <i class="bi bi-sliders"></i> Settings
          </button>
        </div>
      </div>

      <!-- Helper blurb -->
      <div class="alert alert-info text-start shadow-sm mt-3">
        <h5 class="mb-2"><i class="bi bi-magic"></i> How to Use</h5>
        <p class="mb-2">
          Pick a <strong>Race Style</strong>, optionally <strong>Apply Race Preset</strong> for smart defaults, set
          <strong>syllables</strong>, <strong>gender leaning</strong>, and flavor (<em>Harshness</em>, <em>Exoticness</em>).
          Toggle <strong>Surname</strong> to generate two-part names. Click <strong>Generate</strong>.
        </p>
        <ul class="mb-2">
          <li>Per-tile: <span class="text-nowrap">‚≠ê favorite</span>, <span class="text-nowrap">üìã copy</span>, and <span class="text-nowrap">‚Üª re-roll</span> (or double-click the tile).</li>
          <li>Settings/results auto-save. Use <strong>Share</strong> to copy a link that reproduces your setup.</li>
        </ul>
      </div>

      <div class="row g-3 align-items-start">
        <!-- Desktop/LG+ Settings panel -->
        <div class="col-lg-4 d-none d-lg-block">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary"><h5 class="mb-0">Generator Settings</h5></div>
            <div class="card-body" id="settingsCardBody"><!-- settings form gets injected --></div>
          </div>
        </div>

        <!-- Results -->
        <div class="col-12 col-lg-8">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary d-flex align-items-center justify-content-between">
              <h5 class="mb-0">Results</h5>
              <!-- Quick actions on mobile -->
              <div class="d-flex gap-2 d-lg-none">
                <button class="btn btn-success btn-sm" id="ng-generate-xs"><i class="bi bi-stars"></i></button>
                <button class="btn btn-outline-light btn-sm" id="ng-copy-xs"><i class="bi bi-clipboard"></i></button>
              </div>
            </div>
            <div class="card-body d-flex flex-column">
              <div id="ng-meta" class="d-flex flex-wrap gap-2 small text-secondary mb-2"></div>
              <div id="ng-out" class="row row-cols-1 row-cols-sm-2 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-3" aria-live="polite"></div>
            </div>
          </div>

          <!-- Quick Help -->
          <div class="accordion mt-3" id="quickHelp">
            <div class="accordion-item bg-dark border-secondary">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#qh1">
                  What do Harshness & Exoticness do?
                </button>
              </h2>
              <div id="qh1" class="accordion-collapse collapse" data-bs-parent="#quickHelp">
                <div class="accordion-body">
                  <ul class="mb-0">
                    <li><strong>Harshness</strong> increases consonant clusters (kr, gr, zz).</li>
                    <li><strong>Exoticness</strong> increases apostrophes and diacritics (√°, √™, √º).</li>
                    <li>Race presets set sensible defaults; tweak as needed.</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div><!-- /results col -->
      </div><!-- /row -->
    </div>

    <!-- Offcanvas (mobile settings) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 id="settingsOffcanvasLabel" class="mb-0">Generator Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body" id="settingsOffcanvasBody"><!-- settings form gets injected --></div>
    </div>

    <!-- Favorites Drawer -->
    <div class="offcanvas offcanvas-start text-bg-dark" tabindex="-1" id="favoritesDrawer" aria-labelledby="favoritesDrawerLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="favoritesDrawerLabel"><i class="bi bi-star me-2"></i>Favorites</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <div id="favList" class="d-grid gap-2"></div>
        <div class="d-grid d-sm-flex gap-2 mt-3">
          <button class="btn btn-outline-light" id="favCopyAll"><i class="bi bi-clipboard me-1"></i>Copy all</button>
          <button class="btn btn-outline-danger" id="favClear"><i class="bi bi-trash me-1"></i>Clear</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo"> 
    <div class="row footer-main"> 
      <div class="col">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-12 col-md-4 text-md-start text-center order-last order-md-first">
              &copy; 2025 Marlo Mayberry 
            </div>
            <div class="col-12 col-md-4 text-center">
              <img src="/images/White logo - no background.png" height="50" alt="Logo">
            </div>
            <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end">
              <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons"  target="_blank" rel="noopener"><i class="bi bi-linkedin p-2"></i></a>
              <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener"><i class="bi bi-github p-2"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Generator script -->
  <script>
  (() => {
    // --- Seeded RNG (Mulberry32) ---
    function hashString(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return (h>>>0)>>>0}
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    function prand(seedStr){const s = seedStr? hashString(seedStr) : Math.floor(Math.random()*2**32); return mulberry32(s) }

    // --- Core tables (race styles) ---
    let TABLES = {
      Styles: {
        "Elf":        { start:["ae","e","i","lia","fae","sha","thi","yla","ari","ela"], mid:["ri","na","la","th","si","el","ia","lith","mir","vya"], end:["el","iel","ith","ien","a","ara","ielle","wyn","ion","ria"] },
        "Dwarf":      { start:["br","dr","gr","kr","th","kh","st","sk","dur","bal","kor"], mid:["a","o","u","an","or","un","grim","gar","dr","brom"], end:["ar","orn","dur","mir","grin","gar","rak","dun","rik","stone"] },
        "Human (Norse)": { start:["al","bir","ein","har","ing","jor","kar","leif","sig","thor","ulf"], mid:["a","e","i","ar","ir","or","un","vald","bjorn","frid"], end:["ar","en","ir","or","ulf","vald","son","hild","brand","rid"] },
        "Human (Latin)": { start:["mar","luc","val","cass","dom","jul","oct","aur","fel","max"], mid:["a","e","i","o","u","an","or","us","ian","ell"], end:["a","us","ius","ian","ella","ina","or","io","ius","um"] },
        "Goblin":     { start:["sk","sn","gr","kr","zik","rag","nib","skr","blit","krik"], mid:["a","e","i","o","u","ak","ik","ok","zz","g"], end:["it","ik","ak","ug","azz","nix","gob","git","grit","zag"] },
        "Orc":        { start:["gr","br","dr","kr","mok","gar","zug","tok","urk","rag"], mid:["a","o","u","ag","og","uk","ur","ar","ok","ug"], end:["th","g","k","z","gor","nak","ruk","dok","zug","tar"] },
        "Dragonborn": { start:["arj","bal","drax","fen","gal","kry","mor","rax","thal","vor"], mid:["a","e","i","o","u","ar","ir","or","ul","an"], end:["thor","rax","ion","ys","dor","drim","thas","var","mir","zor"] },
        "Tiefling":   { start:["az","bal","mal","xan","vor","zar","oth","vel","sama","bel"], mid:["a","e","i","o","u","az","ath","ir","or","ul","z"], end:["zor","oth","iel","ion","ius","ith","zel","rax","mon","eon"] },
        "Drow":       { start:["zae","xil","drae","vyr","zil","nyx","ssra","il","shi","ria"], mid:["ri","z","ss","yl","dra","vyr","il","ae","ith","yr"], end:["th","z","rin","thrae","ith","ria","zra","lyn","ithra","zz"] },
        "Halfling":   { start:["al","ben","cor","dav","eli","fil","jon","mer","pip","sam"], mid:["a","e","i","o","u","on","an","el","er","il"], end:["o","y","ie","in","er","o","an","wick","foot","hill"] },
        "Gnome":      { start:["bod","cor","dim","fiz","gar","ned","pil","quin","ros","tim"], mid:["a","e","i","o","u","al","el","il","on","um"], end:["bin","dle","wick","ock","bit","er","um","win","ick","bur"] },
        "Lizardfolk": { start:["sli","dra","kra","iss","thi","ska","tro","laz","ss","vrak"], mid:["s","ss","az","iz","or","ur","ar","ra","ri","ko"], end:["th","ss","k","zz","g","sith","gash","kriss","zith","gor"] },
        "Genasi":     { start:["aer","ign","ter","hyd","zel","cal","phyr","pyra","thal","lum"], mid:["a","e","i","o","u","ra","ri","el","or","um"], end:["os","on","ius","ara","eth","or","as","ion","ir","al"] },
        "Fey":        { start:["ly","fae","tia","ari","elo","vio","nyx","syl","zea","aur"], mid:["li","ra","ri","si","na","ve","ya","ie","el","mi"], end:["wyn","elle","ria","ith","ara","ien","iel","is","ora","yse"] }
      },
      GenderSuffix: {
        feminine:["a","ia","elle","ine","yra","wyn","issa"],
        masculine:["ar","or","ric","dan","ion","mir","ath"],
        neutral:[]
      }
    };

    // Race presets (used for Apply Preset)
    const RACE_PRESETS = {
      "Elf":        { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.06, diaProb:0.10, harsh:10, exotic:25, raceSuffix:["ion","iel","ith","iel"], allowRaceSuffix:true },
      "Drow":       { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.15, diaProb:0.20, harsh:35, exotic:55, raceSuffix:["zr","ith","rae","lyn"], allowRaceSuffix:true },
      "Dwarf":      { minSyl:2,maxSyl:3, gender:"masculine", aposProb:0.02, diaProb:0.00, harsh:60, exotic:5,  raceSuffix:["gar","grim","dun","rik"], allowRaceSuffix:true },
      "Orc":        { minSyl:2,maxSyl:2, gender:"masculine", aposProb:0.04, diaProb:0.00, harsh:75, exotic:10, raceSuffix:["g","th","zug","nak"], allowRaceSuffix:true },
      "Dragonborn": { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.08, diaProb:0.08, harsh:55, exotic:35, raceSuffix:["thas","rax","dor","var"], allowRaceSuffix:true },
      "Tiefling":   { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.12, diaProb:0.15, harsh:40, exotic:45, raceSuffix:["iel","ius","eon","ith"], allowRaceSuffix:true },
      "Halfling":   { minSyl:2,maxSyl:2, gender:"neutral", aposProb:0.01, diaProb:0.00, harsh:5,  exotic:5,  raceSuffix:["o","y","ie"], allowRaceSuffix:true },
      "Gnome":      { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.02, diaProb:0.00, harsh:15, exotic:10, raceSuffix:["bin","dle","wick"], allowRaceSuffix:true },
      "Lizardfolk": { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.07, diaProb:0.00, harsh:65, exotic:20, raceSuffix:["ss","th","zz"], allowRaceSuffix:true },
      "Genasi":     { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.05, diaProb:0.10, harsh:30, exotic:35, raceSuffix:["eth","ion","ir"], allowRaceSuffix:true },
      "Fey":        { minSyl:2,maxSyl:3, gender:"feminine", aposProb:0.05, diaProb:0.18, harsh:10, exotic:40, raceSuffix:["wyn","elle","yse"], allowRaceSuffix:true },
      "Goblin":     { minSyl:2,maxSyl:2, gender:"neutral", aposProb:0.03, diaProb:0.00, harsh:55, exotic:10, raceSuffix:["gob","git","grit","zag"], allowRaceSuffix:true },
      "Human (Norse)": { minSyl:2,maxSyl:3, gender:"masculine", aposProb:0.00, diaProb:0.00, harsh:25, exotic:0, raceSuffix:["ulf","son","brand"], allowRaceSuffix:true },
      "Human (Latin)": { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.00, diaProb:0.02, harsh:15, exotic:5, raceSuffix:["us","ius","ian","a"], allowRaceSuffix:true }
    };

    // consonant clusters for "harshness"
    const HARSH_CLUSTERS = ["kr","gr","dr","br","zz","rk","sk","st","thr","zg"];

    // --- Utilities ---
    function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
    function maybe(rng, p){ return rng() < p }
    function injectApostrophe(rng, s){
      if(s.length<4) return s;
      const i = 1 + Math.floor(rng()*(s.length-2));
      return s.slice(0,i)+"'"+s.slice(i);
    }
    const DIA = { map: { a:['√°','√¢','√§','√†'], e:['√©','√™','√´','√®'], i:['√≠','√Æ','√Ø','√¨'], o:['√≥','√¥','√∂','√≤'], u:['√∫','√ª','√º','√π'], y:['√Ω','√ø'] } };
    function sprinkleDiacritics(rng, s, p){
      return s.split('').map(ch=>{
        const low = ch.toLowerCase();
        if(DIA.map[low] && maybe(rng, p)){
          const rep = pick(rng, DIA.map[low]);
          return ch===low?rep:rep.toUpperCase();
        }
        return ch;
      }).join('');
    }
    function applyAlliteration(letter, s){
      if(!letter) return s;
      const l = letter.toLowerCase();
      return s.replace(/^[a-zA-Z]/, l);
    }

    // --- Core generator (flavor knobs + race suffix + surname) ---
    function makeOne(styleKey, minSyl, maxSyl, gender, allit, opts, rng){
      const fallbackStyle = 'Elf';
      const style = TABLES.Styles[styleKey] || TABLES.Styles[fallbackStyle];
      const { aposProb, diaProb, harsh, exotic, useRaceSuffix, raceSuffixList } = opts;

      const lo = Math.max(1, Math.min(minSyl, maxSyl));
      const hi = Math.max(lo, maxSyl);
      const sylCount = lo + Math.floor(rng() * (hi - lo + 1));

      const parts = [];
      for(let i=0;i<sylCount;i++){
        if(i===0){
          parts.push(pick(rng, style.start));
        } else if(i===sylCount-1){
          parts.push(pick(rng, style.end));
        } else {
          const useHarsh = maybe(rng, Math.min(1, harsh/100));
          parts.push(useHarsh ? pick(rng, HARSH_CLUSTERS) : pick(rng, style.mid));
        }
      }
      let name = parts.join('');
      name = name.replace(/([aeiou])\1{2,}/gi,'$1$1').replace(/([^aeiou])\1{2,}/gi,'$1$1');

      const gset = TABLES.GenderSuffix[gender]||[];
      if(gset.length && maybe(rng, gender==='neutral'?0.10:0.55)) name += pick(rng,gset);

      if(useRaceSuffix && raceSuffixList && raceSuffixList.length && maybe(rng, 0.35)){
        name += pick(rng, raceSuffixList);
      }

      const effectiveApos = Math.min(1, aposProb + (exotic/100)*0.10);
      const effectiveDia  = Math.min(1, diaProb  + (exotic/100)*0.20);

      if(maybe(rng, effectiveApos)) name = injectApostrophe(rng, name);
      if(effectiveDia > 0) name = sprinkleDiacritics(rng, name, effectiveDia);
      name = applyAlliteration(allit, name);

      return name.charAt(0).toUpperCase()+name.slice(1);
    }

    function makeFullName(rng, cfg){
      const {
        style, minSyl, maxSyl, gender, allit,
        harsh, exotic, allowApos, allowDia,
        raceSuffixOn, raceSuffixList,
        withSurname, surnameStyle, joiner
      } = cfg;

      const opts = {
        aposProb: allowApos ? 0.12 : 0,
        diaProb:  allowDia  ? 0.08 : 0,
        harsh, exotic,
        useRaceSuffix: raceSuffixOn,
        raceSuffixList
      };

      const first = makeOne(style, minSyl, maxSyl, gender, allit, opts, rng);
      if(!withSurname) return first;

      const last = makeOne(surnameStyle || style, 2, 3, "neutral", "", opts, rng);
      const glue = (joiner || ' ').slice(0, 5);
      return (first + glue + last).replace(/\s{2,}/g,' ').trim();
    }

    function renderMeta(meta){
      const el = document.getElementById('ng-meta');
      el.innerHTML = '';
      const pills = [
        `Style: ${meta.style}`,
        `Count: ${meta.count}`,
        meta.seedStr ? `Seed: ${meta.seedStr}` : 'Seed: (random)',
        `Syllables: ${meta.minSyl}-${meta.maxSyl}`,
        `Gender: ${meta.gender}`,
        meta.allit ? `Alliteration: ${meta.allit.toUpperCase()}` : '',
        `Harsh: ${meta.harsh}`,
        `Exotic: ${meta.exotic}`,
        meta.raceSuffixOn ? `Race suffix: on` : `Race suffix: off`,
        meta.withSurname ? `Surname: ${meta.surnameStyle} (${meta.joiner||' '})` : ''
      ].filter(Boolean);
      for(const p of pills){
        const span = document.createElement('span');
        span.className = 'ng-pill';
        span.textContent = p;
        el.appendChild(span);
      }
    }

    // --- Favorites (localStorage) ---
    const FAV_KEY = 'ng-favs';
    function getFavs(){ try{ return JSON.parse(localStorage.getItem(FAV_KEY)||'[]'); }catch{ return []; } }
    function setFavs(arr){ localStorage.setItem(FAV_KEY, JSON.stringify(arr)); }
    function addFav(n){ const arr = getFavs(); if(!arr.includes(n)){ arr.push(n); setFavs(arr); } renderFavs(); }
    function removeFav(n){ const arr = getFavs().filter(x=>x!==n); setFavs(arr); renderFavs(); }
    function renderFavs(){
      const box = document.getElementById('favList');
      const favs = getFavs();
      box.innerHTML = '';
      if(!favs.length){
        box.innerHTML = '<div class="text-secondary">No favorites yet. Click ‚≠ê on a name.</div>';
        return;
      }
      favs.forEach(n=>{
        const row = document.createElement('div');
        row.className = 'd-flex align-items-center justify-content-between border rounded px-2 py-1';
        row.innerHTML = `
          <span class="me-2 text-truncate">${n}</span>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-light" title="Copy"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-sm btn-outline-danger" title="Remove"><i class="bi bi-x-lg"></i></button>
          </div>`;
        row.querySelector('.btn-outline-light').onclick = ()=> navigator.clipboard.writeText(n);
        row.querySelector('.btn-outline-danger').onclick = ()=> removeFav(n);
        box.appendChild(row);
      });
    }

    // --- URL state + session autosave ---
    function snapshot($d){
      return {
        style: $d('ng-style').value,
        count: +$d('ng-count').value || 20,
        seedStr: $d('ng-seed').value.trim(),
        minSyl: +$d('ng-minSyl').value || 2,
        maxSyl: +$d('ng-maxSyl').value || 3,
        gender: $d('ng-gender').value,
        allit: ($d('ng-allit').value||'').slice(0,1),
        harsh: +$d('ng-harsh').value || 0,
        exotic: +$d('ng-exotic').value || 0,
        allowApos: $d('ng-apos').checked,
        allowDia: $d('ng-diacritics').checked,
        raceSuffixOn: $d('ng-raceSuffix').checked,
        withSurname: $d('ng-surname').checked,
        surnameStyle: $d('ng-surnameStyle').value,
        joiner: $d('ng-joiner').value
      };
    }
    function applySnapshot($d, s){
      if(!s) return;
      const set = (id, val)=>{ const el=$d(id); if(!el) return; if(el.type==='checkbox') el.checked=!!val; else el.value=(val??el.value); };
      set('ng-style', s.style);
      set('ng-count', s.count);
      set('ng-seed', s.seedStr);
      set('ng-minSyl', s.minSyl);
      set('ng-maxSyl', s.maxSyl);
      set('ng-gender', s.gender);
      set('ng-allit', s.allit);
      set('ng-harsh', s.harsh); set('ng-exotic', s.exotic);
      set('ng-apos', s.allowApos); set('ng-diacritics', s.allowDia);
      set('ng-raceSuffix', s.raceSuffixOn);
      set('ng-surname', s.withSurname);
      set('ng-surnameStyle', s.surnameStyle || s.style);
      set('ng-joiner', s.joiner || ' ');
      const h=$d('ng-harsh-val'), x=$d('ng-exotic-val'); if(h) h.textContent=$d('ng-harsh').value; if(x) x.textContent=$d('ng-exotic').value;
      toggleSurnameRow($d('ng-surname').checked);
    }
    function settingsToQS(s){
      const p = new URLSearchParams({
        s: s.style, c: s.count, seed: s.seedStr, min: s.minSyl, max: s.maxSyl, g: s.gender, a: s.allit,
        h: s.harsh, x: s.exotic, apos: +s.allowApos, dia: +s.allowDia, rs: +s.raceSuffixOn,
        sn: +s.withSurname, ss: s.surnameStyle || '', j: s.joiner || ' '
      });
      history.replaceState(null, '', '?'+p.toString());
    }
    function qsToSettings(){
      const p = new URLSearchParams(location.search);
      if(!p.has('s')) return null;
      return {
        style: p.get('s') || 'Elf',
        count: +(p.get('c')||20),
        seedStr: p.get('seed')||'',
        minSyl: +(p.get('min')||2),
        maxSyl: +(p.get('max')||3),
        gender: p.get('g')||'neutral',
        allit: (p.get('a')||'').slice(0,1),
        harsh: +(p.get('h')||0),
        exotic: +(p.get('x')||0),
        allowApos: !!+p.get('apos'),
        allowDia: !!+p.get('dia'),
        raceSuffixOn: !!+p.get('rs'),
        withSurname: !!+p.get('sn'),
        surnameStyle: p.get('ss')||'',
        joiner: p.get('j')||' '
      };
    }
    const SESSION_SETTINGS_KEY = 'ng-settings';
    const SESSION_RESULTS_KEY  = 'ng-results';
    function saveSession(s, list){
      localStorage.setItem(SESSION_SETTINGS_KEY, JSON.stringify(s));
      if(list) localStorage.setItem(SESSION_RESULTS_KEY, JSON.stringify(list));
    }
    function loadSession(){
      try{
        const s = JSON.parse(localStorage.getItem(SESSION_SETTINGS_KEY)||'null');
        const r = JSON.parse(localStorage.getItem(SESSION_RESULTS_KEY)||'null');
        return { s, r };
      }catch{ return { s:null, r:null }; }
    }

    // --- Settings form (single source-of-truth) ---
    const settingsFormHTML = String.raw`
      <!-- Race & Preset -->
      <div class="mb-3">
        <label for="ng-style" class="form-label">Race Style
          <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Choose the race/culture flavor. Preset applies recommended defaults."></i>
        </label>
        <div class="input-group">
          <select id="ng-style" class="form-select"></select>
          <button class="btn btn-outline-info" id="ng-applyPreset" type="button" title="Apply race defaults">Apply Race Preset</button>
        </div>
        <div class="form-text text-secondary">Presets adjust syllables, suffixes, and flavor knobs to match the race.</div>
      </div>

      <!-- Counts & seed -->
      <div class="row g-2">
        <div class="col-6">
          <label for="ng-count" class="form-label">Count</label>
          <input id="ng-count" type="number" inputmode="numeric" min="1" max="200" value="20" class="form-control" />
        </div>
        <div class="col-6">
          <label for="ng-seed" class="form-label">Seed <span class="text-secondary small">(repeatable)</span></label>
          <input id="ng-seed" type="text" placeholder="optional" class="form-control" />
        </div>
      </div>

      <!-- Syllables -->
      <div class="row g-2 mt-1">
        <div class="col-6">
          <label for="ng-minSyl" class="form-label">Min syllables</label>
          <input id="ng-minSyl" type="number" inputmode="numeric" min="1" max="6" value="2" class="form-control" />
        </div>
        <div class="col-6">
          <label for="ng-maxSyl" class="form-label">Max syllables</label>
          <input id="ng-maxSyl" type="number" inputmode="numeric" min="1" max="8" value="3" class="form-control" />
        </div>
      </div>

      <!-- Gender & Alliteration -->
      <div class="row g-2 mt-1">
        <div class="col-6">
          <label for="ng-gender" class="form-label">Gender leaning</label>
          <select id="ng-gender" class="form-select">
            <option value="neutral" selected>Neutral</option>
            <option value="feminine">Feminine</option>
            <option value="masculine">Masculine</option>
          </select>
        </div>
        <div class="col-6">
          <label for="ng-allit" class="form-label">Alliteration</label>
          <input id="ng-allit" type="text" maxlength="1" placeholder="e.g. R" class="form-control" />
        </div>
      </div>

      <!-- Flavor knobs -->
      <div class="mt-2">
        <label class="form-label">Flavor knobs</label>
        <div class="row g-2">
          <div class="col-6">
            <label for="ng-harsh" class="form-label d-flex justify-content-between">
              <span>Harshness</span><span class="text-secondary"><span id="ng-harsh-val">25</span></span>
            </label>
            <input id="ng-harsh" type="range" class="form-range" min="0" max="100" value="25">
          </div>
          <div class="col-6">
            <label for="ng-exotic" class="form-label d-flex justify-content-between">
              <span>Exoticness</span><span class="text-secondary"><span id="ng-exotic-val">20</span></span>
            </label>
            <input id="ng-exotic" type="range" class="form-range" min="0" max="100" value="20">
          </div>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="ng-raceSuffix" checked />
          <label class="form-check-label" for="ng-raceSuffix">Enable race-flavored suffix</label>
        </div>
      </div>

      <!-- Special chars base toggles -->
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="ng-apos" checked />
        <label class="form-check-label" for="ng-apos">Allow apostrophes</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="ng-diacritics" />
        <label class="form-check-label" for="ng-diacritics">Allow diacritics</label>
      </div>

      <!-- Surname options -->
      <div class="form-check mt-3">
        <input class="form-check-input" type="checkbox" id="ng-surname" />
        <label class="form-check-label" for="ng-surname">Add surname (two-part names)</label>
      </div>
      <div id="surnameRow" class="row g-2 mt-1" style="display:none;">
        <div class="col-7">
          <label for="ng-surnameStyle" class="form-label">Surname style</label>
          <select id="ng-surnameStyle" class="form-select"></select>
        </div>
        <div class="col-5">
          <label for="ng-joiner" class="form-label">Joiner</label>
          <input id="ng-joiner" type="text" class="form-control" value=" " placeholder=" , -, &#39; , of ">
        </div>
      </div>

      <!-- Actions -->
      <div class="d-grid d-sm-flex gap-2 mt-3">
        <button class="btn btn-success w-100 w-sm-auto" id="ng-generate"><i class="bi bi-stars me-1"></i>Generate</button>
        <button class="btn btn-outline-light w-100 w-sm-auto" id="ng-copy"><i class="bi bi-clipboard me-1"></i>Copy</button>
        <button class="btn btn-warning w-100 w-sm-auto" id="ng-download"><i class="bi bi-download me-1"></i>Download .txt</button>
        <button class="btn btn-danger w-100 w-sm-auto" id="ng-clear"><i class="bi bi-trash me-1"></i>Clear</button>
      </div>

      <!-- Advanced tables -->
      <details class="mt-3">
        <summary class="text-secondary">Custom Tables (advanced)
          <span class="badge rounded-pill text-bg-secondary ms-2">JSON</span>
        </summary>
        <div class="mt-2">
          <div id="ng-adv-alert"></div>
          <div class="code-block mb-2"><pre id="advExample"></pre></div>
          <label class="form-label">Import JSON (styles)</label>
          <textarea id="ng-import" class="form-control form-control-sm font-monospace" rows="6"
            placeholder='{"Styles":{"Elf":{"start":["ae","lia"],"mid":["ri","na"],"end":["el","ith"]}}}'></textarea>
          <div class="d-flex flex-wrap gap-2 mt-2">
            <button class="btn btn-outline-light btn-sm" id="ng-validateBtn"><i class="bi bi-check2-circle me-1"></i>Validate</button>
            <button class="btn btn-outline-light btn-sm" id="ng-importBtn"><i class="bi bi-upload me-1"></i>Import</button>
            <button class="btn btn-outline-light btn-sm" id="ng-exportBtn"><i class="bi bi-download me-1"></i>Export current</button>
          </div>
        </div>
      </details>
    `;

    function populateStyles($, mobileRoot){
      const sel = $('ng-style');
      const cur = sel?.value;
      sel.innerHTML = '';
      Object.keys(TABLES.Styles).forEach(k=>{
        const opt = document.createElement('option'); opt.value=k; opt.textContent=k; sel.appendChild(opt);
      });
      sel.value = (cur && TABLES.Styles[cur]) ? cur : 'Elf';

      // Surname styles mirror same list
      const sSel = $('ng-surnameStyle');
      sSel.innerHTML = sel.innerHTML;
      sSel.value = sel.value;

      // desktop -> mobile mirror
      const mobileSel = mobileRoot.querySelector('#ng-style');
      if (mobileSel) { mobileSel.innerHTML = sel.innerHTML; mobileSel.value = sel.value; }
      const mobileSSel = mobileRoot.querySelector('#ng-surnameStyle');
      if (mobileSSel) { mobileSSel.innerHTML = sSel.innerHTML; mobileSSel.value = sSel.value; }
    }

    // Advanced tables validators
    function validateTablesObject(obj){
      const errors = [];
      if (!obj || typeof obj !== 'object') { errors.push('Root is not an object.'); return errors; }
      if (!obj.Styles || typeof obj.Styles !== 'object') errors.push('Missing "Styles" object.');
      const styles = obj.Styles || {};
      for (const [name, spec] of Object.entries(styles)){
        if (!spec || typeof spec !== 'object'){ errors.push(`Style "${name}" must be an object.`); continue; }
        ['start','mid','end'].forEach(k=>{
          if (!Array.isArray(spec[k]) || spec[k].length===0) errors.push(`Style "${name}" missing non-empty array "${k}".`);
          else if(!spec[k].every(x=>typeof x==='string')) errors.push(`Style "${name}" "${k}" must be strings only.`);
        });
      }
      return errors;
    }
    function importTables($, mobileRoot){
      const raw = $('ng-import').value.trim();
      const alertBox = $('ng-adv-alert'); alertBox.innerHTML='';
      if(!raw){ alertBox.innerHTML = `<div class="alert alert-warning py-2 mb-2">Paste JSON first.</div>`; return; }
      try{
        const data = JSON.parse(raw);
        const errs = validateTablesObject(data);
        if (errs.length){
          alertBox.innerHTML = `
            <div class="alert alert-danger mb-2">
              <strong>Invalid JSON:</strong>
              <ul class="mb-0">${errs.map(e => `<li>${e}</li>`).join('')}</ul>
            </div>`;
          return;
        }
        TABLES.Styles = { ...TABLES.Styles, ...data.Styles };
        populateStyles($, mobileRoot);
        alertBox.innerHTML = `<div class="alert alert-success py-2 mb-2">Imported. New styles are available.</div>`;
      }catch(e){
        alertBox.innerHTML = `<div class="alert alert-danger py-2 mb-2">Parse error: ${e.message}</div>`;
      }
    }
    function validateOnly($){
      const raw = $('ng-import').value.trim();
      const alertBox = $('ng-adv-alert'); alertBox.innerHTML='';
      if(!raw){ alertBox.innerHTML = `<div class="alert alert-warning py-2 mb-2">Paste JSON first.</div>`; return; }
      try{
        const data = JSON.parse(raw);
        const errs = validateTablesObject(data);
        alertBox.innerHTML = errs.length
          ? `<div class="alert alert-danger mb-2"><strong>Issues:</strong><ul class="mb-0">${errs.map(e => `<li>${e}</li>`).join('')}</ul></div>`
          : `<div class="alert alert-success py-2 mb-2">Looks good.</div>`;
      }catch(e){
        alertBox.innerHTML = `<div class="alert alert-danger py-2 mb-2">Parse error: ${e.message}</div>`;
      }
    }
    function exportCurrent(){
      const payload = JSON.stringify({Styles: TABLES.Styles}, null, 2);
      const blob = new Blob([payload], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='name-tables.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // --- Rendering ---
    function renderList(list){
      const out = document.getElementById('ng-out');
      out.innerHTML = '';
      list.forEach(n=>{
        const col = document.createElement('div');
        col.className = 'col';
        const tile = document.createElement('div');
        tile.className = 'ng-tile';
        tile.setAttribute('tabindex','0');
        tile.innerHTML = `
          <span class="ng-name">${n}</span>
          <div class="ng-actions d-flex gap-1">
            <button class="btn btn-sm btn-outline-light" title="Copy" aria-label="Copy name"><i class="bi bi-clipboard"></i></button>
            <button class="btn btn-sm btn-outline-warning" title="Favorite" aria-label="Favorite name"><i class="bi bi-star"></i></button>
            <button class="btn btn-sm btn-outline-info" title="Re-roll" aria-label="Reroll name"><i class="bi bi-arrow-repeat"></i></button>
          </div>
        `;
        const nameEl = tile.querySelector('.ng-name');
        const btnCopy = tile.querySelector('.btn-outline-light');
        const btnFav  = tile.querySelector('.btn-outline-warning');
        const btnRer  = tile.querySelector('.btn-outline-info');

        btnCopy.onclick = ()=> navigator.clipboard.writeText(nameEl.textContent);
        btnFav.onclick  = ()=> addFav(nameEl.textContent);
        tile.ondblclick = ()=> btnRer.click();

        col.appendChild(tile);
        out.appendChild(col);
      });
    }

    function attachRerollHandlers(cfg, rngSeed){
      document.querySelectorAll('#ng-out .ng-tile').forEach(tile=>{
        const nameEl = tile.querySelector('.ng-name');
        const btnRer = tile.querySelector('.btn-outline-info');
        btnRer.onclick = ()=>{
          const r = prand(String(rngSeed) + ':' + Math.random().toString(36).slice(2));
          const newName = makeFullName(r, cfg);
          nameEl.textContent = newName;
        };
      });
    }

    // Generate
    function generate($){
      const style = $('ng-style').value;
      const count = +$('ng-count').value || 20;
      const seedStr = $('ng-seed').value.trim();
      const minSyl = +$('ng-minSyl').value || 2;
      const maxSyl = +$('ng-maxSyl').value || 3;
      const gender = $('ng-gender').value;
      const allit = ($('ng-allit').value||'').slice(0,1);
      const harsh = +$('ng-harsh').value || 0;
      const exotic = +$('ng-exotic').value || 0;
      const allowApos = $('ng-apos').checked;
      const allowDia = $('ng-diacritics').checked;
      const raceSuffixOn = $('ng-raceSuffix').checked;
      const withSurname = $('ng-surname').checked;
      const surnameStyle = $('ng-surnameStyle').value || style;
      const joiner = $('ng-joiner').value || ' ';

      const preset = RACE_PRESETS[style] || null;
      const raceSuffixList = preset ? (preset.raceSuffix || []) : [];

      const rng = prand(seedStr);
      const list = [];
      const cfg = { style, minSyl, maxSyl, gender, allit, harsh, exotic, allowApos, allowDia, raceSuffixOn, raceSuffixList, withSurname, surnameStyle, joiner };
      for(let i=0;i<Math.min(count, 500);i++){
        list.push(makeFullName(rng, cfg));
      }

      renderList(list);
      renderMeta({style, count, seedStr, minSyl, maxSyl, gender, allit, harsh, exotic, raceSuffixOn, withSurname, surnameStyle, joiner});
      const snap = snapshot($);
      saveSession(snap, list); settingsToQS(snap);
      attachRerollHandlers(cfg, seedStr || 'random');
      return list;
    }

    // Copy/download helpers
    function copyNames(){
      const items = [...document.querySelectorAll('#ng-out .ng-name')].map(n=>n.textContent);
      if(!items.length) return;
      navigator.clipboard.writeText(items.join('\n'));
    }
    function downloadNames(){
      const items = [...document.querySelectorAll('#ng-out .ng-name')].map(n=>n.textContent);
      if(!items.length) return;
      const meta = new Date().toISOString();
      const blob = new Blob([items.join('\n') + '\n'], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`names-${meta}.txt`; a.click();
      URL.revokeObjectURL(url);
    }

    // Preset
    function applyRacePreset($){
      const style = $('ng-style').value;
      const preset = RACE_PRESETS[style];
      if(!preset) return;
      $('ng-minSyl').value = preset.minSyl;
      $('ng-maxSyl').value = preset.maxSyl;
      $('ng-gender').value = preset.gender;
      $('ng-harsh').value = preset.harsh; $('ng-harsh-val').textContent = preset.harsh;
      $('ng-exotic').value = preset.exotic; $('ng-exotic-val').textContent = preset.exotic;
      $('ng-apos').checked = preset.aposProb > 0;
      $('ng-diacritics').checked = preset.diaProb > 0;
      $('ng-raceSuffix').checked = !!preset.allowRaceSuffix;
      $('ng-surnameStyle').value = style;
    }

    // UI mount / wiring
    function toggleSurnameRow(show){
      const row = document.getElementById('surnameRow');
      row.style.display = show ? '' : 'none';
    }

    function mountSettingsForms(){
      const desktopRoot = document.getElementById('settingsCardBody');
      const mobileRoot  = document.getElementById('settingsOffcanvasBody');
      desktopRoot.innerHTML = settingsFormHTML;
      mobileRoot.innerHTML  = settingsFormHTML;

      // Fill JSON example safely (no backticks/quotes issues)
      const example = {
        "Styles": {
          "Wizard's Study": {
            "start": ["ar","el","io","ka","the","vor","xan","zea"],
            "mid":   ["ca","el","io","ith","or","ul","ym","ez"],
            "end":   ["ion","iel","oth","eus","ar","is","or","em"]
          }
        }
      };
      const ex1 = desktopRoot.querySelector('#advExample');
      if (ex1) ex1.textContent = JSON.stringify(example, null, 2);
      const ex2 = mobileRoot.querySelector('#advExample');
      if (ex2) ex2.textContent = JSON.stringify(example, null, 2);

      // Scoped helpers
      const q = (root, sel)=> root.querySelector(sel);
      const $d = (id)=> q(desktopRoot, '#' + id);
            const $m = (id)=> q(mobileRoot,  '#' + id);

      // Populate styles into both forms
      populateStyles($d, mobileRoot);

      // Mirror desktop ‚Üí mobile initially
      [
        'ng-style','ng-count','ng-seed','ng-minSyl','ng-maxSyl','ng-gender','ng-allit',
        'ng-harsh','ng-exotic','ng-apos','ng-diacritics','ng-raceSuffix',
        'ng-surname','ng-surnameStyle','ng-joiner'
      ].forEach(id=>{
        const d=$d(id), m=$m(id); if(!d||!m) return;
        if(d.type==='checkbox'){ m.checked=d.checked; } else { m.value=d.value; }
      });
      if ($d('ng-harsh-val')) $d('ng-harsh-val').textContent = $d('ng-harsh').value;
      if ($d('ng-exotic-val')) $d('ng-exotic-val').textContent = $d('ng-exotic').value;

      // Restore from URL or session (URL has priority)
      const urlState = qsToSettings();
      if (urlState) {
        applySnapshot($d, urlState);
      } else {
        const { s, r } = loadSession();
        if (s) applySnapshot($d, s);
        if (r && Array.isArray(r) && r.length) renderList(r);
      }

      // Sync FROM mobile ‚Üí desktop when user interacts in offcanvas
      function syncToDesktop(){
        [
          'ng-style','ng-count','ng-seed','ng-minSyl','ng-maxSyl','ng-gender','ng-allit',
          'ng-harsh','ng-exotic','ng-apos','ng-diacritics','ng-raceSuffix',
          'ng-surname','ng-surnameStyle','ng-joiner'
        ].forEach(id=>{
          const m=$m(id), d=$d(id); if(!m||!d) return;
          if(m.type==='checkbox'){ d.checked=m.checked; } else { d.value=m.value; }
        });
        if ($d('ng-harsh-val')) $d('ng-harsh-val').textContent = $d('ng-harsh').value;
        if ($d('ng-exotic-val')) $d('ng-exotic-val').textContent = $d('ng-exotic').value;
        toggleSurnameRow($d('ng-surname').checked);
      }

      // Wire a given root's controls
      function connect(root, isMobile){
        const $ = (id)=> q(root, '#'+id);

        // main actions
        $('ng-generate').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); generate($d); });
        $('ng-copy').addEventListener('click', (e)=>{ e.preventDefault(); copyNames(); });
        $('ng-download').addEventListener('click', (e)=>{ e.preventDefault(); downloadNames(); });
        $('ng-clear').addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('ng-out').innerHTML=''; document.getElementById('ng-meta').innerHTML=''; });

        // advanced: validate/import/export
        $('ng-validateBtn').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); validateOnly($d); });
        $('ng-importBtn').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); importTables($d, mobileRoot); settingsToQS(snapshot($d)); });
        $('ng-exportBtn').addEventListener('click', (e)=>{ e.preventDefault(); exportCurrent(); });

        // presets
        $('ng-applyPreset').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); applyRacePreset($d); settingsToQS(snapshot($d)); });

        // sliders live labels
        const harsh = $('ng-harsh'), exotic = $('ng-exotic');
        if (harsh) harsh.addEventListener('input', ()=> { const lab = q(desktopRoot, '#ng-harsh-val'); if(lab) lab.textContent = harsh.value; });
        if (exotic) exotic.addEventListener('input', ()=> { const lab = q(desktopRoot, '#ng-exotic-val'); if(lab) lab.textContent = exotic.value; });

        // surname toggle
        $('ng-surname').addEventListener('change', ()=> toggleSurnameRow($('ng-surname').checked));
      }

      connect(desktopRoot, false);
      connect(mobileRoot,  true);

      // XS quick buttons in Results header
      const genXs = document.getElementById('ng-generate-xs');
      const copyXs = document.getElementById('ng-copy-xs');
      if(genXs){ genXs.addEventListener('click', ()=> generate($d)); }
      if(copyXs){ copyXs.addEventListener('click', ()=> copyNames()); }

      // Keep mobile form mirrored just before showing the offcanvas
      const offcanvasEl = document.getElementById('settingsOffcanvas');
      if (offcanvasEl) {
        offcanvasEl.addEventListener('show.bs.offcanvas', () => {
          [
            'ng-style','ng-count','ng-seed','ng-minSyl','ng-maxSyl','ng-gender','ng-allit',
            'ng-harsh','ng-exotic','ng-apos','ng-diacritics','ng-raceSuffix',
            'ng-surname','ng-surnameStyle','ng-joiner'
          ].forEach(id=>{
            const d=$d(id), m=$m(id); if(!d||!m) return;
            if(d.type==='checkbox'){ m.checked=d.checked; } else { m.value=d.value; }
          });
          if ($m('ng-harsh-val')) $m('ng-harsh-val').textContent = $m('ng-harsh').value;
          if ($m('ng-exotic-val')) $m('ng-exotic-val').textContent = $m('ng-exotic').value;
          toggleSurnameRow($d('ng-surname').checked);
        });
      }

      // Enable tooltips
      [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')).forEach(el => new bootstrap.Tooltip(el));

      // Favorites drawer actions
      renderFavs();
      const favCopyAll = document.getElementById('favCopyAll');
      const favClear   = document.getElementById('favClear');
      if(favCopyAll) favCopyAll.onclick = ()=>{ const favs = getFavs(); if(favs.length) navigator.clipboard.writeText(favs.join('\n')); };
      if(favClear)   favClear.onclick   = ()=>{ setFavs([]); renderFavs(); };

      // Share buttons
      const doShare = ()=>{ const s = snapshot($d); settingsToQS(s); navigator.clipboard.writeText(location.href); };
      const btnShare = document.getElementById('btnShare');
      const btnShareXS = document.getElementById('btnShareXS');
      if(btnShare)   btnShare.onclick = doShare;
      if(btnShareXS) btnShareXS.onclick = doShare;

      // Initial generation if we only restored settings
      if(!document.querySelector('#ng-out .ng-name')) generate($d);
    }

    document.addEventListener('DOMContentLoaded', mountSettingsForms);
  })();
  </script>
</body>
</html>
