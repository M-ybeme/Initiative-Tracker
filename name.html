<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Name Generator</title>

  <!-- Bootstrap CSS + Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.3/font/bootstrap-icons.css" />

  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />

  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />

  <!-- Sortable (if needed elsewhere) -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <style>
    .bgimage{
      background: url('images/BGMap.png') no-repeat center center fixed;
      background-size: cover;
    }
    @media (max-width: 576px){
      .bgimage{ background-attachment: scroll; }
    }
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn { border-left: 5px solid #1d9e6d !important; color: #f8f9fa !important; font-weight: bold; }
    #saveHistorySelect { min-width: 200px; }
    .ng-pill { border: 1px solid rgba(255,255,255,.15); border-radius: 50rem; padding: .15rem .5rem; }
    .ng-tile { border: 1px solid rgba(255,255,255,.15); border-radius: .6rem; padding: .5rem .6rem; background: rgba(0,0,0,.2); }
    .help-badge { font-size: .8rem; vertical-align: middle; cursor: help; }
    .code-block { background: rgba(255,255,255,.05); border: 1px solid rgba(255,255,255,.1); border-radius: .5rem; padding: .75rem; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: .9rem; overflow:auto;}
  </style>
</head>
<body class="bgimage">
  <!-- Nav -->
  <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/dndFavicon (2).png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon">
          <i class="bi bi-list"></i>
        </span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="index.html">Initiative</a></li>
          <li class="nav-item"><a class="nav-link active" aria-current="page" href="name.html">Name Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="loot.html">Loot Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="shop.html">Shop Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="npc.html">NPC Gen</a></li>
          <li class="nav-item"><a class="nav-link" href="tav.html">Tavern/Inn Gen</a></li>
        </ul>
      </div>
    </div>
   </nav>

  <!-- Main -->
  <main class="content pt-5 mt-3">
    <div class="container py-3">
      <div class="d-flex align-items-center justify-content-between gap-2">
        <div class="backdrop">
          <h1 class="h3 mb-0">Name Generator</h1>
        </div>
        <!-- Mobile: open settings offcanvas -->
        <button class="btn btn-outline-light d-lg-none" data-bs-toggle="offcanvas" data-bs-target="#settingsOffcanvas" aria-controls="settingsOffcanvas">
          <i class="bi bi-sliders"></i> Open Settings
        </button>
      </div>

      <!-- Helper blurb -->
      <div class="alert alert-info text-start shadow-sm mt-3">
        <h5 class="mb-2"><i class="bi bi-magic"></i> How to Use</h5>
        <p class="mb-2">
          Pick a <strong>Race Style</strong>, optionally <strong>Apply Race Preset</strong> for smart defaults, adjust
          <strong>syllables</strong>, <strong>gender leaning</strong>, and the <strong>flavor knobs</strong>
          (<em>Harshness</em>, <em>Exoticness</em>), then click <strong>Generate</strong>.
        </p>
        <ul class="mb-2">
          <li><strong>Copy</strong> copies results. <strong>Download</strong> saves a <code>.txt</code>.</li>
          <li><strong>Seed</strong> makes results repeatable.</li>
          <li><strong>Custom Tables</strong> lets you add/override styles with JSON.</li>
        </ul>
      </div>

      <div class="row g-3 align-items-start">
        <!-- Desktop/LG+ Settings panel -->
        <div class="col-lg-4 d-none d-lg-block">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary"><h5 class="mb-0">Generator Settings</h5></div>
            <div class="card-body" id="settingsCardBody"><!-- settings form gets injected --></div>
          </div>
        </div>

        <!-- Results -->
        <div class="col-12 col-lg-8">
          <div class="card bg-dark border-secondary h-100">
            <div class="card-header border-secondary d-flex align-items-center justify-content-between">
              <h5 class="mb-0">Results</h5>
              <!-- Quick actions on mobile -->
              <div class="d-flex gap-2 d-lg-none">
                <button class="btn btn-success btn-sm" id="ng-generate-xs"><i class="bi bi-stars"></i></button>
                <button class="btn btn-outline-light btn-sm" id="ng-copy-xs"><i class="bi bi-clipboard"></i></button>
              </div>
            </div>
            <div class="card-body d-flex flex-column">
              <div id="ng-meta" class="d-flex flex-wrap gap-2 small text-secondary mb-2"></div>
              <!-- Responsive grid -->
              <div id="ng-out" class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 row-cols-xl-5 g-2" aria-live="polite"></div>
            </div>
          </div>

          <!-- Quick Help accordion for clarity -->
          <div class="accordion mt-3" id="quickHelp">
            <div class="accordion-item bg-dark border-secondary">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#qh1">
                  What do Harshness & Exoticness do?
                </button>
              </h2>
              <div id="qh1" class="accordion-collapse collapse" data-bs-parent="#quickHelp">
                <div class="accordion-body">
                  <ul class="mb-0">
                    <li><strong>Harshness</strong> increases consonant clusters (<em>kr, gr, zz</em>), good for Orcs/Dwarves.</li>
                    <li><strong>Exoticness</strong> increases apostrophes and diacritics (<em>á, ê, ü</em>), good for Drow/Draconic.</li>
                    <li>Race presets set sensible defaults, but you can tweak both for flavor.</li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="accordion-item bg-dark border-secondary mt-2">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#qh2">
                  Race Presets explained
                </button>
              </h2>
              <div id="qh2" class="accordion-collapse collapse">
                <div class="accordion-body">
                  Clicking <strong>Apply Race Preset</strong> adjusts <em>syllables, suffix tendencies, harshness, exoticness, apostrophes, diacritics</em> (and can add race-flavored suffixes) to match the chosen race. You can still tweak afterward.
                </div>
              </div>
            </div>
          </div>
        </div><!-- /results col -->
      </div><!-- /row -->
    </div>

    <!-- Offcanvas (mobile settings) -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="settingsOffcanvas" aria-labelledby="settingsOffcanvasLabel">
      <div class="offcanvas-header">
        <h5 id="settingsOffcanvasLabel" class="mb-0">Generator Settings</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body" id="settingsOffcanvasBody"><!-- settings form gets injected --></div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo"> 
    <div class="row footer-main"> 
      <div class="col">
        <div class="container">
          <div class="row align-items-center">
            <div class="col-12 col-md-4 text-md-start text-center order-last order-md-first">
              &copy; 2025 Marlo Mayberry 
            </div>
            <div class="col-12 col-md-4 text-center">
              <img src="/images/White logo - no background.png" height="50" alt="Logo">
            </div>
            <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end">
              <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons"  target="_blank" rel="noopener"><i class="bi bi-linkedin p-2"></i></a>
              <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener"><i class="bi bi-github p-2"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>

  <!-- Generator script -->
  <script>
  (() => {
    // --- Seeded RNG (Mulberry32) ---
    function hashString(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return (h>>>0)>>>0}
    function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
    function prand(seedStr){const s = seedStr? hashString(seedStr) : Math.floor(Math.random()*2**32); return mulberry32(s) }

    // --- Core tables (race styles aligned to D&D vibes; original + additions) ---
    let TABLES = {
      Styles: {
        "Elf":        { start:["ae","e","i","lia","fae","sha","thi","yla","ari","ela"], mid:["ri","na","la","th","si","el","ia","lith","mir","vya"], end:["el","iel","ith","ien","a","ara","ielle","wyn","ion","ria"] },
        "Dwarf":      { start:["br","dr","gr","kr","th","kh","st","sk","dur","bal","kor"], mid:["a","o","u","an","or","un","grim","gar","dr","brom"], end:["ar","orn","dur","mir","grin","gar","rak","dun","rik","stone"] },
        "Human (Norse)": { start:["al","bir","ein","har","ing","jor","kar","leif","sig","thor","ulf"], mid:["a","e","i","ar","ir","or","un","vald","bjorn","frid"], end:["ar","en","ir","or","ulf","vald","son","hild","brand","rid"] },
        "Human (Latin)": { start:["mar","luc","val","cass","dom","jul","oct","aur","fel","max"], mid:["a","e","i","o","u","an","or","us","ian","ell"], end:["a","us","ius","ian","ella","ina","or","io","ius","um"] },
        "Goblin":     { start:["sk","sn","gr","kr","zik","rag","nib","skr","blit","krik"], mid:["a","e","i","o","u","ak","ik","ok","zz","g"], end:["it","ik","ak","ug","azz","nix","gob","git","grit","zag"] },
        "Orc":        { start:["gr","br","dr","kr","mok","gar","zug","tok","urk","rag"], mid:["a","o","u","ag","og","uk","ur","ar","ok","ug"], end:["th","g","k","z","gor","nak","ruk","dok","zug","tar"] },
        "Dragonborn": { start:["arj","bal","drax","fen","gal","kry","mor","rax","thal","vor"], mid:["a","e","i","o","u","ar","ir","or","ul","an"], end:["thor","rax","ion","ys","dor","drim","thas","var","mir","zor"] },
        "Tiefling":   { start:["az","bal","mal","xan","vor","zar","oth","vel","sama","bel"], mid:["a","e","i","o","u","az","ath","ir","or","ul","z"], end:["zor","oth","iel","ion","ius","ith","zel","rax","mon","eon"] },
        "Drow":       { start:["zae","xil","drae","vyr","zil","nyx","ssra","il","shi","ria"], mid:["ri","z","ss","yl","dra","vyr","il","ae","ith","yr"], end:["th","z","rin","thrae","ith","ria","zra","lyn","ithra","zz"] },
        "Halfling":   { start:["al","ben","cor","dav","eli","fil","jon","mer","pip","sam"], mid:["a","e","i","o","u","on","an","el","er","il"], end:["o","y","ie","in","er","o","an","wick","foot","hill"] },
        "Gnome":      { start:["bod","cor","dim","fiz","gar","ned","pil","quin","ros","tim"], mid:["a","e","i","o","u","al","el","il","on","um"], end:["bin","dle","wick","ock","bit","er","um","win","ick","bur"] },
        "Lizardfolk": { start:["sli","dra","kra","iss","thi","ska","tro","laz","ss","vrak"], mid:["s","ss","az","iz","or","ur","ar","ra","ri","ko"], end:["th","ss","k","zz","g","sith","gash","kriss","zith","gor"] },
        "Genasi":     { start:["aer","ign","ter","hyd","zel","cal","phyr","pyra","thal","lum"], mid:["a","e","i","o","u","ra","ri","el","or","um"], end:["os","on","ius","ara","eth","or","as","ion","ir","al"] },
        "Fey":        { start:["ly","fae","tia","ari","elo","vio","nyx","syl","zea","aur"], mid:["li","ra","ri","si","na","ve","ya","ie","el","mi"], end:["wyn","elle","ria","ith","ara","ien","iel","is","ora","yse"] }
      },
      GenderSuffix: {
        feminine:["a","ia","elle","ine","yra","wyn","issa"],
        masculine:["ar","or","ric","dan","ion","mir","ath"],
        neutral:[]
      }
    };

    // --- Race presets (clear defaults + flavor) ---
    // Probabilities are 0..1; sliders for harsh/exotic are 0..100 (converted at use).
    const RACE_PRESETS = {
      "Elf":        { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.06, diaProb:0.10, harsh:10, exotic:25, raceSuffix:["ion","iel","ith","iel"], allowRaceSuffix:true },
      "Drow":       { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.15, diaProb:0.20, harsh:35, exotic:55, raceSuffix:["zr","ith","rae","lyn"], allowRaceSuffix:true },
      "Dwarf":      { minSyl:2,maxSyl:3, gender:"masculine", aposProb:0.02, diaProb:0.00, harsh:60, exotic:5,  raceSuffix:["gar","grim","dun","rik"], allowRaceSuffix:true },
      "Orc":        { minSyl:2,maxSyl:2, gender:"masculine", aposProb:0.04, diaProb:0.00, harsh:75, exotic:10, raceSuffix:["g","th","zug","nak"], allowRaceSuffix:true },
      "Dragonborn": { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.08, diaProb:0.08, harsh:55, exotic:35, raceSuffix:["thas","rax","dor","var"], allowRaceSuffix:true },
      "Tiefling":   { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.12, diaProb:0.15, harsh:40, exotic:45, raceSuffix:["iel","ius","eon","ith"], allowRaceSuffix:true },
      "Halfling":   { minSyl:2,maxSyl:2, gender:"neutral", aposProb:0.01, diaProb:0.00, harsh:5,  exotic:5,  raceSuffix:["o","y","ie"], allowRaceSuffix:true },
      "Gnome":      { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.02, diaProb:0.00, harsh:15, exotic:10, raceSuffix:["bin","dle","wick"], allowRaceSuffix:true },
      "Lizardfolk": { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.07, diaProb:0.00, harsh:65, exotic:20, raceSuffix:["ss","th","zz"], allowRaceSuffix:true },
      "Genasi":     { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.05, diaProb:0.10, harsh:30, exotic:35, raceSuffix:["eth","ion","ir"], allowRaceSuffix:true },
      "Fey":        { minSyl:2,maxSyl:3, gender:"feminine", aposProb:0.05, diaProb:0.18, harsh:10, exotic:40, raceSuffix:["wyn","elle","yse"], allowRaceSuffix:true },
      "Goblin":     { minSyl:2,maxSyl:2, gender:"neutral", aposProb:0.03, diaProb:0.00, harsh:55, exotic:10, raceSuffix:["gob","git","grit","zag"], allowRaceSuffix:true },
      "Human (Norse)": { minSyl:2,maxSyl:3, gender:"masculine", aposProb:0.00, diaProb:0.00, harsh:25, exotic:0, raceSuffix:["ulf","son","brand"], allowRaceSuffix:true },
      "Human (Latin)": { minSyl:2,maxSyl:3, gender:"neutral", aposProb:0.00, diaProb:0.02, harsh:15, exotic:5, raceSuffix:["us","ius","ian","a"], allowRaceSuffix:true }
    };

    // consonant cluster pool for "harshness" injections
    const HARSH_CLUSTERS = ["kr","gr","dr","br","zz","rk","sk","st","thr","kr","gr","zg"];

    // --- Utilities ---
    function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
    function maybe(rng, p){ return rng() < p }
    function injectApostrophe(rng, s){
      if(s.length<4) return s;
      const i = 1 + Math.floor(rng()*(s.length-2));
      return s.slice(0,i)+"'"+s.slice(i);
    }
    const DIA = { map: { a:['á','â','ä','à'], e:['é','ê','ë','è'], i:['í','î','ï','ì'], o:['ó','ô','ö','ò'], u:['ú','û','ü','ù'], y:['ý','ÿ'] } };
    function sprinkleDiacritics(rng, s, p){
      return s.split('').map(ch=>{
        const low = ch.toLowerCase();
        if(DIA.map[low] && maybe(rng, p)){
          const rep = pick(rng, DIA.map[low]);
          return ch===low?rep:rep.toUpperCase();
        }
        return ch;
      }).join('');
    }
    function applyAlliteration(letter, s){
      if(!letter) return s;
      const l = letter.toLowerCase();
      return s.replace(/^[a-zA-Z]/, l);
    }

    // --- Core generator (now parameterized with flavor knobs + race suffix option) ---
    function makeName(rng, styleKey, minSyl, maxSyl, gender, allit, opts){
      const fallbackStyle = 'Elf';
      const style = TABLES.Styles[styleKey] || TABLES.Styles[fallbackStyle];
      const { aposProb, diaProb, harsh, exotic, useRaceSuffix, raceSuffixList } = opts;

      const lo = Math.max(1, Math.min(minSyl, maxSyl));
      const hi = Math.max(lo, maxSyl);
      const sylCount = lo + Math.floor(rng() * (hi - lo + 1));

      const parts = [];
      for(let i=0;i<sylCount;i++){
        if(i===0){
          parts.push(pick(rng, style.start));
        } else if(i===sylCount-1){
          parts.push(pick(rng, style.end));
        } else {
          // harshness: with some probability, inject a consonant cluster instead of a typical mid chunk
          const useHarsh = maybe(rng, Math.min(1, harsh/100));
          parts.push(useHarsh ? pick(rng, HARSH_CLUSTERS) : pick(rng, style.mid));
        }
      }
      let name = parts.join('');
      // collapse long runs
      name = name.replace(/([aeiou])\1{2,}/gi,'$1$1').replace(/([^aeiou])\1{2,}/gi,'$1$1');

      // Gender suffix (existing behavior)
      const gset = TABLES.GenderSuffix[gender]||[];
      if(gset.length && maybe(rng, gender==='neutral'?0.10:0.55)) name += pick(rng,gset);

      // Optional race-flavored suffix
      if(useRaceSuffix && raceSuffixList && raceSuffixList.length && maybe(rng, 0.35)){
        name += pick(rng, raceSuffixList);
      }

      // Exoticness effects
      const effectiveApos = Math.min(1, aposProb + (exotic/100)*0.10);
      const effectiveDia  = Math.min(1, diaProb  + (exotic/100)*0.20);

      if(maybe(rng, effectiveApos)) name = injectApostrophe(rng, name);
      if(effectiveDia > 0) name = sprinkleDiacritics(rng, name, effectiveDia);
      name = applyAlliteration(allit, name);

      return name.charAt(0).toUpperCase()+name.slice(1);
    }

    function renderMeta({style, count, seedStr, minSyl, maxSyl, gender, allit, harsh, exotic, raceSuffixOn}){
      const meta = document.getElementById('ng-meta');
      meta.innerHTML = '';
      const pills = [
        `Style: ${style}`,
        `Count: ${count}`,
        seedStr ? `Seed: ${seedStr}` : 'Seed: (random)',
        `Syllables: ${minSyl}-${maxSyl}`,
        `Gender: ${gender}`,
        allit ? `Alliteration: ${allit.toUpperCase()}` : '',
        `Harsh: ${harsh}`,
        `Exotic: ${exotic}`,
        raceSuffixOn ? `Race suffix: on` : `Race suffix: off`
      ].filter(Boolean);
      for(const p of pills){
        const span = document.createElement('span');
        span.className = 'ng-pill';
        span.textContent = p;
        meta.appendChild(span);
      }
    }

    function generate($d){
      const style = $d('ng-style').value;
      const count = +$d('ng-count').value || 20;
      const seedStr = $d('ng-seed').value.trim();
      const minSyl = +$d('ng-minSyl').value || 2;
      const maxSyl = +$d('ng-maxSyl').value || 3;
      const gender = $d('ng-gender').value;
      const allit = ($d('ng-allit').value||'').slice(0,1);

      // new knobs
      const harsh = +$d('ng-harsh').value || 0;
      const exotic = +$d('ng-exotic').value || 0;
      const useRaceSuffix = $d('ng-raceSuffix').checked;

      // apostrophe/diacritics base (UI checkboxes control base prob presence)
      const allowApos = $d('ng-apos').checked;
      const withDia   = $d('ng-diacritics').checked;
      const baseAposProb = allowApos ? 0.12 : 0.0;
      const baseDiaProb  = withDia   ? 0.08 : 0.0;

      // pick race suffix list from presets if exists
      const preset = RACE_PRESETS[style] || null;
      const raceSuffixList = preset ? (preset.raceSuffix || []) : [];

      const rng = prand(seedStr);
      const out = document.getElementById('ng-out');
      out.innerHTML = '';
      const list = [];
      for(let i=0;i<Math.min(count, 500);i++){
        list.push(
          makeName(
            rng, style, minSyl, maxSyl, gender, allit,
            { aposProb: baseAposProb, diaProb: baseDiaProb, harsh, exotic, useRaceSuffix, raceSuffixList }
          )
        );
      }
      list.forEach(n=>{
        const col = document.createElement('div');
        col.className = 'col';
        const tile = document.createElement('div');
        tile.className = 'ng-tile';
        tile.textContent = n;
        col.appendChild(tile);
        out.appendChild(col);
      });

      renderMeta({style, count, seedStr, minSyl, maxSyl, gender, allit, harsh, exotic, raceSuffixOn: useRaceSuffix});
      return list;
    }

    function copyNames(){
      const items = [...document.querySelectorAll('#ng-out .ng-tile')].map(n=>n.textContent);
      if(!items.length) return;
      navigator.clipboard.writeText(items.join('\n'));
    }
    function downloadNames(){
      const items = [...document.querySelectorAll('#ng-out .ng-tile')].map(n=>n.textContent);
      if(!items.length) return;
      const blob = new Blob([items.join('\n')], {type:'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='names.txt'; a.click();
      URL.revokeObjectURL(url);
    }

    // --- Advanced tables helpers (unchanged except for IDs in markup) ---
    function validateTablesObject(obj){
      const errors = [];
      if (!obj || typeof obj !== 'object') { errors.push('Root is not an object.'); return errors; }
      if (!obj.Styles || typeof obj.Styles !== 'object') errors.push('Missing "Styles" object.');
      const styles = obj.Styles || {};
      for (const [name, spec] of Object.entries(styles)){
        if (!spec || typeof spec !== 'object'){ errors.push(`Style "${name}" must be an object.`); continue; }
        ['start','mid','end'].forEach(k=>{
          if (!Array.isArray(spec[k]) || spec[k].length===0) errors.push(`Style "${name}" missing non-empty array "${k}".`);
          else if(!spec[k].every(x=>typeof x==='string')) errors.push(`Style "${name}" "${k}" must be strings only.`);
        });
      }
      return errors;
    }

    function importTables($d, mobileRoot){
      const raw = $d('ng-import').value.trim();
      const alertBox = $d('ng-adv-alert');
      alertBox.innerHTML = '';
      if(!raw){
        alertBox.innerHTML = '<div class="alert alert-warning py-2 mb-2">Nothing to import. Paste JSON first.</div>';
        return;
      }
      try{
        const data = JSON.parse(raw);
        const errs = validateTablesObject(data);
        if (errs.length){
          alertBox.innerHTML = '<div class="alert alert-danger mb-2"><strong>Invalid JSON structure:</strong><ul class="mb-0">' + errs.map(e=>`<li>${e}</li>`).join('') + '</ul></div>';
          return;
        }
        TABLES.Styles = { ...TABLES.Styles, ...data.Styles };
        populateStyles($d, mobileRoot);
        alertBox.innerHTML = '<div class="alert alert-success py-2 mb-2">Imported successfully. New styles are now available in the Race Style dropdown.</div>';
      }catch(e){
        alertBox.innerHTML = '<div class="alert alert-danger py-2 mb-2">Parse error: ' + e.message + '</div>';
      }
    }

    function validateOnly($d){
      const raw = $d('ng-import').value.trim();
      const alertBox = $d('ng-adv-alert');
      alertBox.innerHTML = '';
      if(!raw){
        alertBox.innerHTML = '<div class="alert alert-warning py-2 mb-2">Nothing to validate. Paste JSON first.</div>';
        return;
      }
      try{
        const data = JSON.parse(raw);
        const errs = validateTablesObject(data);
        if (errs.length){
          alertBox.innerHTML = '<div class="alert alert-danger mb-2"><strong>Issues found:</strong><ul class="mb-0">' + errs.map(e=>`<li>${e}</li>`).join('') + '</ul></div>';
        } else {
          alertBox.innerHTML = '<div class="alert alert-success py-2 mb-2">Looks good. You can Import safely.</div>';
        }
      }catch(e){
        alertBox.innerHTML = '<div class="alert alert-danger py-2 mb-2">Parse error: ' + e.message + '</div>';
      }
    }

    const SAMPLE_ADVANCED = {
      "Styles": {
        "Wizard's Study": {
          "start": ["ar","el","io","ka","the","vor","xan","zea"],
          "mid":   ["ca","el","io","ith","or","ul","ym","ez"],
          "end":   ["ion","iel","oth","eus","ar","is","or","em"]
        },
        "Bandit Cant": {
          "start": ["sk","scr","br","kr","dag","cut","scar","shiv"],
          "mid":   ["a","e","i","ar","ir","ur","ash","rag","sliv"],
          "end":   ["er","en","ik","ash","in","o","ax","e"]
        }
      }
    };

    function loadExamplePack($d){
      const ta = $d('ng-import');
      ta.value = JSON.stringify(SAMPLE_ADVANCED, null, 2);
      const alertBox = $d('ng-adv-alert');
      alertBox.innerHTML = '<div class="alert alert-info py-2 mb-2">Example JSON loaded. Click <strong>Validate</strong> and then <strong>Import</strong> to add these styles.</div>';
      ta.focus();
    }

    function exportCurrent(){
      const payload = JSON.stringify({Styles: TABLES.Styles}, null, 2);
      const blob = new Blob([payload], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='name-tables.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // --- Settings form (one source of truth) ---
    const settingsFormHTML = `
      <!-- Race & Preset -->
      <div class="mb-3">
        <label for="ng-style" class="form-label">Race Style
          <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Choose the race/culture flavor. Presets below will tune options for this race."></i>
        </label>
        <div class="input-group">
          <select id="ng-style" class="form-select"></select>
          <button class="btn btn-outline-info" id="ng-applyPreset" type="button" title="Apply race defaults">Apply Race Preset</button>
        </div>
        <div class="form-text text-secondary">Presets adjust syllables, suffixes, and flavor knobs to match the race.</div>
      </div>

      <!-- Counts & seed -->
      <div class="row g-2">
        <div class="col-6">
          <label for="ng-count" class="form-label">Count
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="How many names to generate (1–200)."></i>
          </label>
          <input id="ng-count" type="number" inputmode="numeric" min="1" max="200" value="20" class="form-control" />
        </div>
        <div class="col-6">
          <label for="ng-seed" class="form-label">Seed <span class="text-secondary small">(repeatable)</span>
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Use any text. Re-using the same seed reproduces the same list with the same settings."></i>
          </label>
          <input id="ng-seed" type="text" placeholder="optional" class="form-control" />
        </div>
      </div>

      <!-- Syllables -->
      <div class="row g-2 mt-1">
        <div class="col-6">
          <label for="ng-minSyl" class="form-label">Min syllables
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Minimum syllable (chunk) count per name."></i>
          </label>
          <input id="ng-minSyl" type="number" inputmode="numeric" min="1" max="6" value="2" class="form-control" />
        </div>
        <div class="col-6">
          <label for="ng-maxSyl" class="form-label">Max syllables
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Maximum syllable (chunk) count per name."></i>
          </label>
          <input id="ng-maxSyl" type="number" inputmode="numeric" min="1" max="8" value="3" class="form-control" />
        </div>
      </div>

      <!-- Gender & Alliteration -->
      <div class="row g-2 mt-1">
        <div class="col-6">
          <label for="ng-gender" class="form-label">Gender leaning
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Optionally append common masculine/feminine endings. Neutral reduces suffix bias."></i>
          </label>
          <select id="ng-gender" class="form-select">
            <option value="neutral" selected>Neutral</option>
            <option value="feminine">Feminine</option>
            <option value="masculine">Masculine</option>
          </select>
        </div>
        <div class="col-6">
          <label for="ng-allit" class="form-label">Alliteration
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Force the first letter (e.g., R makes all names start with R). Leave blank for random."></i>
          </label>
          <input id="ng-allit" type="text" maxlength="1" placeholder="e.g. R" class="form-control" />
        </div>
      </div>

      <!-- Flavor knobs -->
      <div class="mt-2">
        <label class="form-label">Flavor knobs</label>
        <div class="row g-2">
          <div class="col-6">
            <label for="ng-harsh" class="form-label d-flex justify-content-between">
              <span>Harshness</span>
              <span class="text-secondary"><span id="ng-harsh-val">25</span></span>
            </label>
            <input id="ng-harsh" type="range" class="form-range" min="0" max="100" value="25"
              title="Higher = more consonant clusters (kr, gr, zz)">
          </div>
          <div class="col-6">
            <label for="ng-exotic" class="form-label d-flex justify-content-between">
              <span>Exoticness</span>
              <span class="text-secondary"><span id="ng-exotic-val">20</span></span>
            </label>
            <input id="ng-exotic" type="range" class="form-range" min="0" max="100" value="20"
              title="Higher = more apostrophes/diacritics">
          </div>
        </div>
        <div class="form-check mt-2">
          <input class="form-check-input" type="checkbox" id="ng-raceSuffix" checked />
          <label class="form-check-label" for="ng-raceSuffix">Enable race-flavored suffix
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Appends race-typical endings sometimes (e.g., -ion for elves, -gar for dwarves)."></i>
          </label>
        </div>
      </div>

      <!-- Special chars base toggles -->
      <div class="form-check mt-2">
        <input class="form-check-input" type="checkbox" id="ng-apos" checked />
        <label class="form-check-label" for="ng-apos">Allow apostrophes
          <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Base chance to add an apostrophe. Exoticness raises this further."></i>
        </label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="ng-diacritics" />
        <label class="form-check-label" for="ng-diacritics">Allow diacritics
          <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title="Base chance to add accented vowels. Exoticness raises this further."></i>
        </label>
      </div>

      <!-- Actions -->
      <div class="d-grid d-sm-flex gap-2 mt-3">
        <button class="btn btn-success w-100 w-sm-auto" id="ng-generate"><i class="bi bi-stars me-1"></i>Generate</button>
        <button class="btn btn-outline-light w-100 w-sm-auto" id="ng-copy"><i class="bi bi-clipboard me-1"></i>Copy</button>
        <button class="btn btn-warning w-100 w-sm-auto" id="ng-download"><i class="bi bi-download me-1"></i>Download .txt</button>
        <button class="btn btn-danger w-100 w-sm-auto" id="ng-clear"><i class="bi bi-trash me-1"></i>Clear</button>
      </div>

      <!-- Advanced tables -->
      <details class="mt-3">
        <summary class="text-secondary">Custom Tables (advanced)
          <span class="badge rounded-pill text-bg-secondary ms-2">JSON</span>
          <i class="bi bi-info-circle help-badge ms-1" data-bs-toggle="tooltip" title="Add/override Styles. Each Style needs start/mid/end arrays of strings."></i>
        </summary>
        <div class="mt-2">
          <div id="ng-adv-alert"></div>

          <div class="accordion mb-3" id="advGuide">
            <div class="accordion-item bg-dark border-secondary">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed bg-dark text-light" type="button" data-bs-toggle="collapse" data-bs-target="#advGuideBody">
                  Advanced Tables Guide
                </button>
              </h2>
              <div id="advGuideBody" class="accordion-collapse collapse" data-bs-parent="#advGuide">
                <div class="accordion-body">
                  <ol class="mb-3">
                    <li>Create a JSON object with a <code>Styles</code> property.</li>
                    <li>Each key under <code>Styles</code> is the visible race/style name.</li>
                    <li>Each entry must have non-empty <code>start</code>, <code>mid</code>, and <code>end</code> arrays of strings.</li>
                    <li>Click <strong>Validate</strong>, then <strong>Import</strong>. Select it in Race Style and generate.</li>
                  </ol>
                  <div class="code-block mb-2"><pre>{
  "Styles": {
    "Wizard's Study": {
      "start": ["ar","el","io","ka","the","vor","xan","zea"],
      "mid":   ["ca","el","io","ith","or","ul","ym","ez"],
      "end":   ["ion","iel","oth","eus","ar","is","or","em"]
    }
  }
}</pre></div>
                  <p class="mb-0 small text-secondary">Keep chunks short and phonetic; the generator stitches them together.</p>
                </div>
              </div>
            </div>
          </div>

          <label class="form-label">Import JSON (styles)
            <i class="bi bi-question-circle help-badge" data-bs-toggle="tooltip" title='Paste a JSON object containing {"Styles": {...}}. Use Validate before Import.'></i>
          </label>
          <textarea id="ng-import" class="form-control form-control-sm font-monospace" rows="8"
            placeholder='{"Styles":{"Elf":{"start":["ae","lia"],"mid":["ri","na"],"end":["el","ith"]}}}'></textarea>

          <div class="d-flex flex-wrap gap-2 mt-2">
            <button class="btn btn-outline-light btn-sm" id="ng-validateBtn"><i class="bi bi-check2-circle me-1"></i>Validate</button>
            <button class="btn btn-outline-light btn-sm" id="ng-importBtn"><i class="bi bi-upload me-1"></i>Import</button>
            <button class="btn btn-outline-light btn-sm" id="ng-exportBtn"><i class="bi bi-download me-1"></i>Export current</button>
            <button class="btn btn-outline-info btn-sm" id="ng-loadExample"><i class="bi bi-file-earmark-code me-1"></i>Load example</button>
          </div>
        </div>
      </details>
    `;

    function populateStyles($d, mobileRoot){
      const sel = $d('ng-style');
      const current = sel?.value;
      sel.innerHTML = '';
      Object.keys(TABLES.Styles).forEach(k=>{
        const opt = document.createElement('option');
        opt.value = k; opt.textContent = k; sel.appendChild(opt);
      });
      sel.value = (current && TABLES.Styles[current]) ? current : 'Elf';

      // Mirror desktop → mobile
      const mobileSel = mobileRoot.querySelector('#ng-style');
      if (mobileSel) {
        mobileSel.innerHTML = sel.innerHTML;
        mobileSel.value = sel.value;
      }
    }

    function applyRacePreset($d){
      const style = $d('ng-style').value;
      const preset = RACE_PRESETS[style];
      if(!preset) return;

      // set recommended core values
      $d('ng-minSyl').value = preset.minSyl;
      $d('ng-maxSyl').value = preset.maxSyl;
      $d('ng-gender').value = preset.gender;

      // flavor knobs
      $d('ng-harsh').value = preset.harsh;
      $d('ng-exotic').value = preset.exotic;
      $d('ng-harsh-val').textContent = preset.harsh;
      $d('ng-exotic-val').textContent = preset.exotic;

      // base toggles derived from preset intent
      $d('ng-apos').checked = preset.aposProb > 0;
      $d('ng-diacritics').checked = preset.diaProb > 0;
      $d('ng-raceSuffix').checked = !!preset.allowRaceSuffix;
    }

    function mountSettingsForms(){
      // Inject identical markup into both containers (desktop + mobile)
      const desktopRoot = document.getElementById('settingsCardBody');
      const mobileRoot  = document.getElementById('settingsOffcanvasBody');
      desktopRoot.innerHTML = settingsFormHTML;
      mobileRoot.innerHTML  = settingsFormHTML;

      // Scoped query helpers
      function q(root, sel){ return root.querySelector(sel); }
      const $d = (id) => q(desktopRoot, '#' + id);  // DESKTOP is source of truth
      const $m = (id) => q(mobileRoot,  '#' + id);

      // Populate styles initially (desktop only, then mirror)
      populateStyles($d, mobileRoot);

      // Mirror desktop → mobile for all fields initially
      ['ng-style','ng-count','ng-seed','ng-minSyl','ng-maxSyl','ng-gender','ng-allit','ng-harsh','ng-exotic','ng-apos','ng-diacritics','ng-raceSuffix'].forEach(id=>{
        const d = $d(id);
        const m = $m(id);
        if(!d || !m) return;
        if (d.type === 'checkbox') m.checked = d.checked;
        else m.value = d.value;
      });
      // init live labels for sliders
      $d('ng-harsh-val').textContent = $d('ng-harsh').value;
      $d('ng-exotic-val').textContent = $d('ng-exotic').value;

      // Sync FROM mobile TO desktop when user triggers actions in offcanvas
      function syncToDesktop(){
        ['ng-style','ng-count','ng-seed','ng-minSyl','ng-maxSyl','ng-gender','ng-allit','ng-harsh','ng-exotic','ng-apos','ng-diacritics','ng-raceSuffix'].forEach(id=>{
          const m = $m(id);
          const d = $d(id);
          if(!m || !d) return;
          if(m.type === 'checkbox'){ d.checked = m.checked; }
          else { d.value = m.value; }
        });
        $d('ng-harsh-val').textContent = $d('ng-harsh').value;
        $d('ng-exotic-val').textContent = $d('ng-exotic').value;
      }

      // Wire shared button handlers for a given root
      function connect(root){
        const isMobile = (root === mobileRoot);
        q(root,'#ng-generate') .addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); generate($d); });
        q(root,'#ng-copy')     .addEventListener('click', (e)=>{ e.preventDefault(); copyNames(); });
        q(root,'#ng-download') .addEventListener('click', (e)=>{ e.preventDefault(); downloadNames(); });
        q(root,'#ng-clear')    .addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('ng-out').innerHTML=''; document.getElementById('ng-meta').innerHTML=''; });

        q(root,'#ng-importBtn').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); importTables($d, mobileRoot); });
        q(root,'#ng-exportBtn').addEventListener('click', (e)=>{ e.preventDefault(); exportCurrent(); });
        q(root,'#ng-validateBtn').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); validateOnly($d); });
        q(root,'#ng-loadExample').addEventListener('click', (e)=>{ e.preventDefault(); loadExamplePack($d); });

        q(root,'#ng-applyPreset').addEventListener('click', (e)=>{ e.preventDefault(); if(isMobile) syncToDesktop(); applyRacePreset($d); });

        // sliders live label
        const harsh = q(root,'#ng-harsh');
        const exotic = q(root,'#ng-exotic');
        const harshVal = q(root,'#ng-harsh-val');
        const exoticVal = q(root,'#ng-exotic-val');
        harsh.addEventListener('input', ()=> harshVal.textContent = harsh.value);
        exotic.addEventListener('input', ()=> exoticVal.textContent = exotic.value);
      }

      connect(desktopRoot);
      connect(mobileRoot);

      // Extra quick buttons inside Results header for xs
      const genXs = document.getElementById('ng-generate-xs');
      const copyXs = document.getElementById('ng-copy-xs');
      if(genXs){ genXs.addEventListener('click', ()=> generate($d)); }
      if(copyXs){ copyXs.addEventListener('click', ()=> copyNames()); }

      // Keep mobile form mirrored right before showing the offcanvas
      const offcanvasEl = document.getElementById('settingsOffcanvas');
      if (offcanvasEl) {
        offcanvasEl.addEventListener('show.bs.offcanvas', () => {
          ['ng-style','ng-count','ng-seed','ng-minSyl','ng-maxSyl','ng-gender','ng-allit','ng-harsh','ng-exotic','ng-apos','ng-diacritics','ng-raceSuffix'].forEach(id=>{
            const d = $d(id);
            const m = $m(id);
            if(!d || !m) return;
            if (d.type === 'checkbox') m.checked = d.checked;
            else m.value = d.value;
          });
          $m('ng-harsh-val').textContent = $m('ng-harsh').value;
          $m('ng-exotic-val').textContent = $m('ng-exotic').value;
        });
      }

      // Activate tooltips globally (desktop + mobile)
      const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
      tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

      // Initial generation
      generate($d);
    }

    document.addEventListener('DOMContentLoaded', () => {
      mountSettingsForms();
    });
  })();
  </script>
</body>
</html>
