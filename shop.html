<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The DM's Toolbox: Shop Generator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Custom CSS -->
  <link href="/css/site.css" rel="stylesheet" />
  <!-- Dev Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/devicons/devicon@v2.15.1/devicon.min.css" />
  <!-- Favicon -->
  <link rel="icon" type="image/png" href="/images/dndFavicon (2).png" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <!-- Bootstrap JS (required for navbar collapse / hamburger) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
  <script src="/js/indexed-db-storage.js"></script>
  <script src="/js/site.js"></script>

  <style>
    .bgimage{
        background: url('images/BGMap.png') no-repeat center center fixed;
        background-size: cover;}
    .bg-orange { background-color: #fd7e14 !important; color: #212529 !important; }
    .drag-handle { cursor: move; }
    .active-turn {
      border-left: 5px solid #1d9e6d !important;
      color: #f8f9fa !important;
      font-weight: bold;
    }
    #saveHistorySelect { min-width: 200px; }

    /* Simple/Advanced mode toggle */
    .advanced-setting { display: none; }
    .advanced-mode .advanced-setting { display: block; }
    .advanced-setting.row { display: none; }
    .advanced-mode .advanced-setting.row { display: flex; }
  </style>
</head>
<body class="bgimage">
   <nav class="navbar navbar-expand-lg navbar-dark fixed-top text-light" id="mainNav">
    <div class="container-fluid">
      <a class="navbar-brand" href="index.html">
        <img src="/images/DMsToolboxLogo.png" height="40" width="40" alt="App Logo" class="d-inline-block" />
        The DM Toolbox
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
        aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Combat
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="initiative.html">Initiative Tracker</a></li>
              <li><a class="dropdown-item" href="battlemap.html">Battle Map</a></li>
              <li><a class="dropdown-item" href="encounterbuilder.html">Encounter Builder</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Generators
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="name.html">Name Generator</a></li>
              <li><a class="dropdown-item" href="loot.html">Loot Generator</a></li>
              <li><a class="dropdown-item active" aria-current="page" href="shop.html">Shop Generator</a></li>
              <li><a class="dropdown-item" href="npc.html">NPC Generator</a></li>
              <li><a class="dropdown-item" href="tav.html">Tavern/Inn Generator</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Campaign
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="characters.html">Characters</a></li>
              <li><a class="dropdown-item" href="journal.html">Journal</a></li>
              <li><a class="dropdown-item" href="reference.html">Compendium</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
   </nav>
  <main class="content pt-3">
    <div class="container-fluid text-center backdrop">
        <!-- ===== Shop Generator (drop-in) ===== -->
<div class="row g-3">
  <!-- Settings -->
  <div class="col-12 col-lg-4">
    <div class="card bg-dark border-secondary h-100">
      <div class="card-header border-secondary d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Shop Settings</h5>
        <div class="form-check form-switch mb-0">
          <input class="form-check-input" type="checkbox" id="advancedModeToggle" role="switch">
          <label class="form-check-label small" for="advancedModeToggle">Advanced</label>
        </div>
      </div>
      <div class="card-body" id="shopSettingsBody">
        <div class="mb-2">
          <label for="sg-settlement" class="form-label">Settlement</label>
          <select id="sg-settlement" class="form-select">
            <option value="village">Village (scarcer, pricier)</option>
            <option value="town" selected>Town (balanced)</option>
            <option value="capital">Capital (broader, cheaper)</option>
          </select>
        </div>

        <div class="row g-2 advanced-setting">
          <div class="col-6">
            <label for="sg-itemsPerShop" class="form-label">Items per shop</label>
            <input id="sg-itemsPerShop" class="form-control" type="number" inputmode="numeric" min="5" max="20" value="9">
          </div>
          <div class="col-6">
            <label for="sg-uniquePct" class="form-label">Unique chance %</label>
            <input id="sg-uniquePct" class="form-control" type="number" inputmode="numeric" min="0" max="100" value="25">
          </div>
        </div>

        <div class="row g-2 mt-1 advanced-setting">
          <div class="col-6">
            <label for="sg-seed" class="form-label">Seed (optional)</label>
            <input id="sg-seed" class="form-control" type="text" placeholder="e.g. session-13">
          </div>
          <div class="col-6">
            <label for="sg-allowRare" class="form-label">Allow rare items</label>
            <select id="sg-allowRare" class="form-select">
              <option value="auto" selected>Auto by settlement</option>
              <option value="no">No</option>
              <option value="yes">Yes</option>
            </select>
          </div>
        </div>

        <div class="mb-2">
          <label for="sg-preset" class="form-label">Preset</label>
          <select id="sg-preset" class="form-select">
            <!-- populated by JS -->
          </select>
          <div class="form-text">Presets select common shop mixes; you can still tweak anything after.</div>
        </div>


        <div class="mt-3 advanced-setting">
          <div class="d-flex justify-content-between align-items-center">
            <label class="form-label mb-0">Shop Types</label>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-light" id="sg-selectAll">All</button>
              <button class="btn btn-outline-light" id="sg-selectNone">None</button>
            </div>
          </div>
          <div id="sg-types" class="row row-cols-2 g-1 mt-1"></div>
        </div>

        <div class="d-grid d-sm-flex gap-2 mt-3">
          <button class="btn btn-success w-100 w-sm-auto" id="sg-generate"><i class="bi bi-shop me-1"></i>Generate</button>
          <button class="btn btn-outline-light w-100 w-sm-auto" id="sg-copy"><i class="bi bi-clipboard me-1"></i>Copy</button>
          <button class="btn btn-warning w-100 w-sm-auto" id="sg-download"><i class="bi bi-download me-1"></i>Download .txt</button>
          <button class="btn btn-danger w-100 w-sm-auto" id="sg-clear"><i class="bi bi-trash me-1"></i>Clear</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="col-12 col-lg-8">
    <div class="card bg-dark border-secondary h-100">
      <div class="card-header border-secondary">
        <h5 class="mb-0">Shops</h5>
      </div>
      <div class="card-body">
        <div id="sg-meta" class="d-flex flex-wrap gap-2 small text-secondary mb-2"></div>
        <div id="sg-out" class="d-flex flex-column gap-3" aria-live="polite"></div>
      </div>
    </div>
  </div>
</div>

<div id="sgNavPanel" class="shop-nav-panel d-none" role="region" aria-label="Shop navigator">
  <div class="d-flex justify-content-between align-items-center gap-2 mb-2">
    <div class="fw-semibold text-uppercase small text-secondary">Quick jump</div>
    <button id="sgNavDismiss" class="btn btn-sm btn-outline-light" type="button" aria-label="Hide shop navigator">
      <i class="bi bi-x-lg"></i>
    </button>
  </div>
  <p class="small text-muted mb-2">Tap a shop to scroll into view.</p>
  <div id="sgNavList" class="shop-nav-list"></div>
</div>

<button id="sgNavToggle" class="shop-nav-toggle btn btn-info btn-sm d-none" type="button" aria-label="Show shop navigator">
  <i class="bi bi-list"></i>
  Shops
</button>

<style>
  .sg-pill{
    border:1px solid rgba(255,255,255,.15);
    border-radius:50rem;
    padding:.25rem .65rem;
    font-size:.8rem;
    background:rgba(255,255,255,.03);
  }
  .sg-shopcard{
    border:1px solid rgba(255,255,255,.2);
    border-radius:.75rem;
    background:rgba(0,0,0,.2);
    box-shadow: 0 2px 8px rgba(0,0,0,.3);
    margin-bottom: 1.5rem;
  }
  .sg-shopcard:hover{
    border-color:rgba(255,255,255,.3);
  }
  .sg-uniq{
    font-size:.9rem;
    color:#8bd3ff;
    padding:.5rem;
    background:rgba(139,211,255,.05);
    border-radius:.5rem;
    border-left:3px solid #8bd3ff;
  }
  .sg-tbl{
    width:100%;
    font-size:.9rem;
  }
  .sg-tbl th,.sg-tbl td{
    padding:.6rem .75rem;
    border-bottom:1px solid rgba(255,255,255,.08);
    vertical-align:middle;
  }
  .sg-tbl th{
    color:#8bd3ff;
    font-weight:600;
    font-size:.85rem;
    text-transform:uppercase;
    letter-spacing:.5px;
    background:rgba(139,211,255,.05);
  }
  .sg-tbl tbody tr:hover{
    background:rgba(255,255,255,.03);
  }
  .sg-tbl tbody tr:last-child td{
    border-bottom:none;
  }
  .sg-tbl .btn{
    font-size:.75rem;
    padding:.35rem .6rem;
    white-space:nowrap;
  }
  .sg-tbl .btn i{
    font-size:.85rem;
  }
  .sg-tbl .badge{
    font-size:.75rem;
    padding:.35rem .5rem;
  }
  .sg-shopcard .border-bottom:last-of-type{
    border-bottom:none !important;
  }
  .shop-nav-panel{
    position:fixed;
    top:96px;
    right:24px;
    width:280px;
    max-height:65vh;
    overflow-y:auto;
    padding:.85rem;
    background:rgba(10,10,16,.92);
    border:1px solid rgba(255,255,255,.25);
    border-radius:.75rem;
    box-shadow:0 12px 28px rgba(0,0,0,.5);
    backdrop-filter:blur(6px);
    z-index:1250;
  }
  .shop-nav-list .shop-nav-link{
    border-color:rgba(255,255,255,.25);
    color:#f8f9fa;
    text-transform:none;
  }
  .shop-nav-list .shop-nav-link:hover{
    background:rgba(13,202,240,.12);
    border-color:rgba(13,202,240,.6);
    color:#8bd3ff;
  }
  .shop-nav-toggle{
    position:fixed;
    bottom:24px;
    right:24px;
    box-shadow:0 8px 18px rgba(0,0,0,.35);
    z-index:1250;
  }
  @media (max-width:768px){
    .shop-nav-panel{
      width:min(320px,90vw);
      right:16px;
      top:86px;
    }
    .shop-nav-toggle{
      bottom:16px;
      right:16px;
    }
  }
  @media (min-width:769px){
    .sg-tbl .btn{
      min-width:40px;
    }
  }
  @media (max-width:768px){
    .sg-tbl .btn{
      display:inline-block;
      margin:.25rem .25rem !important;
    }
    .sg-tbl td[data-label="Actions"] .d-flex{
      flex-direction:column;
      align-items:flex-start !important;
    }
    .sg-tbl td[data-label="Actions"] .fw-bold{
      display:block;
      margin-bottom:.5rem;
      font-size:1.1rem;
    }
    .sg-tbl .btn{
      width:100%;
    }
  }
  @media (max-width:576px){
    .sg-tbl thead{display:none}
    .sg-tbl tr{
      display:block;
      margin-bottom:.75rem;
      border:1px solid rgba(255,255,255,.12);
      border-radius:.5rem;
      padding:.5rem;
      background:rgba(0,0,0,.15);
    }
    .sg-tbl td{display:block;border:0;padding:.4rem 0}
    .sg-tbl td::before{
      content:attr(data-label);
      font-weight:600;
      color:#8bd3ff;
      display:block;
      margin-bottom:.25rem;
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.5px;
    }
  }
</style>

<script>
(()=>{
// ---------- Seeded RNG ----------
function hashString(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return (h>>>0)>>>0}
function mulberry32(a){return function(){let t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296}}
function prand(seedStr){const s = seedStr? hashString(seedStr) : Math.floor(Math.random()*2**32); return mulberry32(s) }
const $ = (id)=>document.getElementById(id);

// ---------- Settlement Profiles ----------
const SETTLEMENT = {
  village: { price:[1.10,1.35], stock:[5,8], weights:{common:0.75, uncommon:0.23, rare:0.02}, allowRare:'low', uniquePct:15 },
  town:    { price:[0.95,1.15], stock:[7,12], weights:{common:0.60, uncommon:0.33, rare:0.07}, allowRare:'mid', uniquePct:25 },
  capital: { price:[0.85,1.20], stock:[10,16],weights:{common:0.45, uncommon:0.40, rare:0.15}, allowRare:'high', uniquePct:40 }
};

 // ---------- Presets ----------
  const PRESETS = {
    core: {
      label: "Core (common town)",
      select: [
        "General Goods","Grocer","Inn/Tavern","Tailor","Cobbler",
        "Blacksmith (Arms/Armor)","Stables","Carpenter","Farrier",
        "Fabric Shop","Messenger","Bookshop/Library"
      ],
      allowRare: "auto",          // keep settlement-driven rarity
      uniquePct: null             // null = don't override user/current
    },
    adventurer: {
      label: "Adventurer’s Hub",
      select: [
        "Adventuring Gear","Potions & Elixirs","Arcane Scrolls","Divine Scrolls",
        "Blacksmith (Arms/Armor)","Cartographer","Alchemist/Apothecary",
        "Stables","General Goods","Bookshop/Library","Magic Items"
      ],
      allowRare: "yes",           // encourage rares
      uniquePct: 30               // tasteful bump
    },
    shady: {
      label: "Shady Bazaar",
      select: [
        "Black Market","Pawn Shop","Oddities","Fortune Teller",
        "Clockwork Repair","Pet Shop","Adventuring Gear"
      ],
      allowRare: "yes",
      uniquePct: 35
    }
  };

  const DEFAULT_SHOP_TYPES = new Set(PRESETS.core.select);

  // Apply a preset: check the right boxes & (optionally) tweak knobs
  function applyPreset(key){
    if(!key || key === "custom") return;
    const p = PRESETS[key];
    if(!p) return;

    // select types (only these)
    document.querySelectorAll("#sg-types input").forEach(i=>{
      i.checked = p.select.includes(i.dataset.type);
    });

    // optional knobs (still editable by user)
    if(p.allowRare) $("sg-allowRare").value = (p.allowRare === "yes" ? "yes" : (p.allowRare === "no" ? "no" : "auto"));
    if(typeof p.uniquePct === "number") $("sg-uniquePct").value = p.uniquePct;
  }

  // Utility: populate preset dropdown and keep it in sync
  function initPresets(){
    const sel = $("sg-preset");
    sel.innerHTML = [
      `<option value="custom">Custom (manual)</option>`,
      ...Object.entries(PRESETS).map(([k,v])=>`<option value="${k}">${v.label}</option>`)
    ].join("");

    if (PRESETS.core){
      sel.value = "core";
      applyPreset("core");
    }

    sel.addEventListener("change", ()=>{
      applyPreset(sel.value);
    });

    // If user manually toggles any checkbox, mark preset as "custom"
    $("sg-types").addEventListener("change", ()=>{
      $("sg-preset").value = "custom";
    });
  }

// ---------- Shopkeeper Name & Personality ----------
const SHOPKEEPER_NAMES = {
  generic: ["Aldric","Mara","Torin","Elise","Gareth","Nessa","Orin","Lyra","Bram","Celia","Doran","Fenna","Gregor","Hilde","Ivan","Jora","Kael","Leta","Merrick","Nina"],
  exotic: ["Zephyra","Corvax","Silvain","Meridia","Thalion","Vexara","Quentis","Lunara","Draven","Isolde"],
  humble: ["Tom","Bessie","Jack","Molly","Ben","Annie","Will","Rose","Sam","Nell"],
  scholarly: ["Professor Aldwin","Magistra Thalia","Archivist Quill","Scholar Pemberton","Sage Mirelle"]
};

const SHOPKEEPER_PERSONALITY = {
  fitting: {
    "Blacksmith (Arms/Armor)": ["gruff and practical","muscular with soot-stained hands","speaks in clipped, efficient sentences","has burn scars and a no-nonsense attitude"],
    "Potions & Elixirs": ["speaks in a dreamy, distracted manner","has stained fingers from herb work","constantly tasting and smelling mixtures","obsessed with precise measurements"],
    "Bookshop/Library": ["wears reading spectacles on a chain","speaks in hushed, reverent tones","knows every book's location by heart","gets excited about rare editions"],
    "Tailor": ["has pins stuck in their collar","measures people with their eyes habitually","speaks of fabrics with genuine passion","always impeccably dressed"],
    "General Goods": ["friendly and chatty","knows everyone's business","remembers what each customer usually buys","has a knack for finding exactly what you need"],
    "Alchemist/Apothecary": ["mutters chemical formulas under their breath","has faint chemical burns on hands","obsessed with cataloging ingredients","speaks in technical jargon"],
    "Magic Items": ["eyes gleam with arcane knowledge","fingers crackle with residual magic","speaks in riddles about enchantments","protective of their wares"],
    "Arcane Scrolls": ["robed in deep blue or purple","speaks of magic theory constantly","has ink-stained fingers","quotes ancient wizards"],
    "Divine Scrolls": ["wears holy symbol prominently","blesses customers habitually","speaks of divine will","calm and serene demeanor"],
    "Inn/Tavern": ["jovial and welcoming","smells of cooking and ale","knows all the local gossip","treats regulars like family"],
    "Stables": ["smells of hay and horse","speaks gently to animals","covered in dust and horsehair","practical and down-to-earth"],
    "Cobbler": ["hunched from years of work","speaks while working their awl","proud of their craft","judges people by their shoes"],
    "Carpenter": ["wood shavings in their hair","smells of fresh sawdust","strong hands, careful eye","speaks of grain and joints"],
    "default": ["knowledgeable about their trade","takes pride in their work","efficient and professional","fair in their dealings"]
  },
  ironic: {
    "Blacksmith (Arms/Armor)": ["delicate and refined, speaks of beauty in brutality","squeamish about violence despite making weapons","obsessed with decorative flourishes over function","has never actually used a weapon"],
    "Potions & Elixirs": ["terrified of getting sick","refuses to taste their own products","allergic to common herbs","keeps meticulous records but can't remember recipes"],
    "Bookshop/Library": ["barely literate, inherited the shop","judges books by their covers","can't remember titles, only colors of spines","hates reading, loves collecting"],
    "Tailor": ["dresses terribly, claims it's 'avant-garde'","colorblind but insists on choosing fabrics","can't sew a straight line, hires others","allergic to most fabrics"],
    "General Goods": ["forgetful, can't find anything","hates small talk despite running a social hub","terrible at inventory, always out of stock","dislikes people, inherited family business"],
    "Alchemist/Apothecary": ["clumsy, constantly breaking beakers","has no sense of smell","follows recipes by rote without understanding","superstitious about 'bad luck' ingredients"],
    "Magic Items": ["completely non-magical, can't sense enchantments","relies entirely on a catalog from previous owner","terrified of magic but makes a living from it","sells items based on how shiny they are"],
    "default": ["clearly doesn't enjoy their work","inherited the business reluctantly","would rather be doing anything else","secretly dreams of a different career"]
  },
  wrongField: {
    "Blacksmith (Arms/Armor)": ["wanted to be a baker, makes weapon-shaped bread on the side","trained as a musician, hums while hammering","former scholar who failed at magic, took up smithing in frustration","aspiring artist who treats each blade as a sculpture"],
    "Potions & Elixirs": ["trained chef who treats potions like recipes","former adventurer who got tired of buying overpriced healing","wannabe wizard who couldn't master real spells","herbalist who stumbled into potion-making by accident"],
    "Bookshop/Library": ["failed bard who writes terrible poetry in the margins","former soldier organizing books like military ranks","retired thief who now 'legally acquires' rare books","inventor who keeps engineering diagrams mixed with books"],
    "Tailor": ["former armor smith who got bored with metal","wannabe painter who uses fabric instead of canvas","ex-sailor who only knows how to patch sails","accountant who treats sewing like mathematics"],
    "General Goods": ["overqualified wizard slumming as shopkeeper","former noble who lost their fortune","retired assassin in witness protection","bored adventurer who settled down"],
    "Alchemist/Apothecary": ["former poisoner who went legitimate","cook who thought alchemy would be similar","failed healer turned ingredient supplier","herbalist who can't stand blood"],
    "Magic Items": ["con artist selling 'genuine' magic items","former thief fencing magical goods","wizard who was expelled and selling their old homework","collector who accidentally opened a shop"],
    "default": ["clearly overqualified for this job","seems out of place but competent","has an interesting backstory if you ask","makes the best of an odd situation"]
  }
};

// ---------- Flavor / Quirk Pools (non-plot) ----------
const FLAV_ADJ = ["sturdy","well-made","neatly finished","serviceable","balanced","polished","matte","lacquered","rifled","fine-grain","braided","stitched","grooved"];
const FLAV_MAT = ["oakwood","ashwood","yew","maple","pine","boiled leather","suede","bronze","iron","copper","pewter","tin","linen","wool","canvas","felt","parchment","rag paper","glass"];
const FLAV_DEC = ["herringbone","chevron","crosshatch","spiral","ringed","flecked","knotted","chiseled","etched"];
const FLAV_UNIQUE = [
  "inset with river-stone flecks",
  "faintly citrus-scented",
  "keeps a steady warmth to the touch",
  "finished in deep indigo dye",
  "edges burnish to a soft sheen with use",
  "balanced for comfortable carry",
  "trim stitched in contrasting thread",
  "grain shows a pleasant wave",
  "subtle maker’s circle under the base",
  "polished to mirror-bright"
];

// ---------- Shop Data ----------
// price is in silver pieces (sp). rarity: 'common' | 'uncommon' | 'rare'
const SHOPS = {
  // --- General Goods Stores ---
  "General Goods": [
    {n:"Lantern, hooded", d:"Metal hood and hinged panels.", u:"Portable light", sp:120, r:"common"},
    {n:"Lamp oil (flask)", d:"Refined mineral oil.", u:"Fuel", sp:10, r:"common"},
    {n:"Rope (50 ft, hemp)", d:"Twisted 3-strand.", u:"Climbing/tie-down", sp:10, r:"common"},
    {n:"Sack, large", d:"Woven burlap.", u:"Carrying", sp:2, r:"common"},
    {n:"Bedroll", d:"Canvas roll with ties.", u:"Camping", sp:10, r:"common"},
    {n:"Chalk (10 sticks)", d:"Packed in paper.", u:"Marking", sp:2, r:"common"},
    {n:"Waterskin", d:"Seamed leather, cork stop.", u:"Carry water", sp:8, r:"common"},
    {n:"Fishing kit", d:"Line, hooks, corks.", u:"Basic fishing", sp:25, r:"uncommon"},
    {n:"Lock, simple", d:"Warded tumbler, 2 keys.", u:"Securing", sp:300, r:"uncommon"},
    {n:"Candle (tallow, 12)", d:"Short burn, smokey.", u:"Room light", sp:3, r:"common"},
    {n:"Candle (beeswax, 6)", d:"Clean burn, mild scent.", u:"Room light", sp:6, r:"common"},
    {n:"Lantern glass, spare", d:"Fits most hooded types.", u:"Replace cracked pane", sp:8, r:"common"},
    {n:"Lantern glass, colored (set)", d:"Amber/blue/green.", u:"Signal or mood light", sp:15, r:"uncommon"},
    {n:"Oil, long-burn (flask)", d:"Slow, steady flame.", u:"Extend lantern time", sp:18, r:"uncommon"},
    {n:"Oil, scented (flask)", d:"Lavender or pine.", u:"Mask odors", sp:12, r:"common"},
    {n:"Twine ball (300 ft)", d:"Hemp, light test.", u:"Marking & bundling", sp:4, r:"common"},
    {n:"Cord (100 ft, thin)", d:"Braided plant fiber.", u:"Rig light loads", sp:8, r:"common"},
    {n:"Net, casting (small)", d:"Weighted fringe.", u:"Fish in shallows", sp:40, r:"uncommon"},
    {n:"Bucket, oak", d:"Hooped and tarred.", u:"Carry liquids", sp:6, r:"common"},
    {n:"Kettle, tin", d:"Wire handle.", u:"Boil water/tea", sp:14, r:"common"},
    {n:"Ladle & spoon set", d:"Wooden utensils.", u:"Serve & cook", sp:4, r:"common"},
    {n:"Jar, clay (6) with lids", d:"Wax-seal ready.", u:"Store dry goods", sp:10, r:"common"},
    {n:"Jug, stoneware", d:"Cork-stoppered.", u:"Transport liquids", sp:7, r:"common"},
    {n:"Pouch, belt", d:"Toggled flap.", u:"Carry coins/small gear", sp:8, r:"common"},
    {n:"Straps, leather (pair)", d:"Pre-punched.", u:"Tie down kit", sp:6, r:"common"},
    {n:"Needle & thread kit", d:"Steel needles, linen.", u:"Field mending", sp:6, r:"common"},
    {n:"Shears, cloth", d:"Serrated edge.", u:"Cut fabric/cord", sp:16, r:"uncommon"},
    {n:"Tacks & nails (50)", d:"Mixed sizes.", u:"Quick fasteners", sp:5, r:"common"},
    {n:"Wooden stakes (10)", d:"Pointed ends.", u:"Tent/line anchors", sp:4, r:"common"},
    {n:"Broom & brush set", d:"Stiff bristle.", u:"Camp cleanup", sp:5, r:"common"},
    {n:"Soap, soft (herbal)", d:"Mild lather.", u:"Personal wash", sp:5, r:"common"},
    {n:"Dye packet (cloth)", d:"Simple hues.", u:"Color garments", sp:12, r:"uncommon"},
    {n:"Cork stoppers (12)", d:"Assorted sizes.", u:"Seal bottles", sp:3, r:"common"},
    {n:"Chalk line reel", d:"Twined spool.", u:"Straight marks", sp:10, r:"common"},
    {n:"Canvas roll (5×5 ft)", d:"Grommeted corners.", u:"Cover/groundsheet", sp:22, r:"uncommon"},
    {n:"Box, lockable (small)", d:"Hasp & hinge.", u:"Keep trinkets", sp:40, r:"uncommon"},
    {n:"Scale, pocket", d:"Pan & weights.", u:"Weigh coin/ingots", sp:90, r:"uncommon"},
    {n:"Hourglass, short", d:"About 10 minutes.", u:"Time tasks", sp:45, r:"uncommon"},
    {n:"Bell, hand", d:"Clear tone.", u:"Signal/alerts", sp:16, r:"common"}
  ],

  // --- Food & Drink ---
  "Bakery": [
    {n:"Loaf, hearty", d:"Crusty rye or wheat.", u:"Meal", sp:2, r:"common"},
    {n:"Sweet roll (pair)", d:"Glazed, spice-dusted.", u:"Snack", sp:3, r:"common"},
    {n:"Travel biscuits (dozen)", d:"Hard, dry, long-keeping.", u:"Rations", sp:4, r:"common"}
  ],
  "Butcher": [
    {n:"Cured sausage (link)", d:"Hung and smoked.", u:"Meal", sp:2, r:"common"},
    {n:"Salted jerky (1/2 lb)", d:"Lean cuts, well dried.", u:"Rations", sp:5, r:"common"},
    {n:"Soup bones", d:"Marrow-rich.", u:"Stock", sp:1, r:"common"}
  ],
  "Grocer": [
    {n:"Dried beans (1 lb)", d:"Canvas bag.", u:"Meal", sp:3, r:"common"},
    {n:"Dried fruit (packet)", d:"Apple or plum.", u:"Snack", sp:4, r:"common"},
    {n:"Spice pouch", d:"Pepper, cumin, or herb mix.", u:"Cooking", sp:10, r:"uncommon"},
    {n:"Flour (5 lb)", d:"Cloth sack.", u:"Baking staple", sp:6, r:"common"},
    {n:"Oats (2 lb)", d:"Rolled grain.", u:"Porridge/rations", sp:4, r:"common"},
    {n:"Rice (2 lb)", d:"Long-grain.", u:"Meal base", sp:5, r:"common"},
    {n:"Barley (2 lb)", d:"Pearled.", u:"Soups & beer mash", sp:4, r:"common"},
    {n:"Salt (1 lb)", d:"Coarse crystals.", u:"Preserve/season", sp:5, r:"common"},
    {n:"Sugar (1 lb)", d:"Cane loaf shards.", u:"Sweeten/tonics", sp:12, r:"uncommon"},
    {n:"Honey (jar)", d:"Amber, raw comb.", u:"Sweetener/soothe throat", sp:14, r:"uncommon"},
    {n:"Herb bundle (fresh)", d:"Thyme, parsley, bay.", u:"Cooking", sp:4, r:"common"},
    {n:"Tea leaves (tin)", d:"Black or green.", u:"Brewed drink", sp:10, r:"uncommon"},
    {n:"Chicory grounds", d:"Roasted root.", u:"Coffee substitute", sp:6, r:"common"},
    {n:"Coffee beans (small)", d:"Dark roast.", u:"Strong brew", sp:16, r:"uncommon"},
    {n:"Vinegar (bottle)", d:"Cider or wine.", u:"Pickling/cooking", sp:6, r:"common"},
    {n:"Olive oil (flask)", d:"Cold-pressed.", u:"Cooking/lamp fuel", sp:18, r:"uncommon"},
    {n:"Pickled vegetables (jar)", d:"Carrot, onion, beet.", u:"Rations/side", sp:8, r:"common"},
    {n:"Dried mushrooms (packet)", d:"Forest mix.", u:"Soup/stew umami", sp:7, r:"common"},
    {n:"Hard cheese (wedge)", d:"Aged, salty.", u:"Travel staple", sp:10, r:"common"},
    {n:"Butter (half-lb)", d:"Wrapped in leaf.", u:"Cooking/spread", sp:6, r:"common"},
    {n:"Nuts (1 lb)", d:"Walnut/almond mix.", u:"Snack/trail mix", sp:12, r:"uncommon"},
    {n:"Seeds, trail (packet)", d:"Sunflower, pumpkin.", u:"Snack", sp:4, r:"common"},
    {n:"Smoked fish (strip)", d:"Firm & salty.", u:"Ration/protein", sp:6, r:"common"},
    {n:"Salt pork (slab)", d:"Cured & ready.", u:"Travel meat", sp:12, r:"uncommon"},
    {n:"Onions (5)", d:"Paper skins.", u:"Cooking base", sp:3, r:"common"},
    {n:"Potatoes (5)", d:"Starchy keepers.", u:"Hearty meals", sp:3, r:"common"},
    {n:"Dried peppers (string)", d:"Hot & smoky.", u:"Spice dishes", sp:7, r:"common"},
    {n:"Baking spices (tin)", d:"Cinnamon, clove.", u:"Sweets & mulled drinks", sp:14, r:"uncommon"},
    {n:"Preserves (jar)", d:"Berry jam.", u:"Spread/dessert", sp:10, r:"common"},
    {n:"Lemon salts (packet)", d:"Citrus crystals.", u:"Flavor/clean fish smell", sp:6, r:"common"},
    {n:"Yeast cakes (4)", d:"Starter-ready.", u:"Bread brewing", sp:5, r:"common"},
    {n:"Cured olives (jar)", d:"Brine-packed.", u:"Snack/ garnish", sp:9, r:"common"},
    {n:"Herbal tonics (2)", d:"Mild bitters.", u:"Aid digestion", sp:8, r:"common"}
  ],
  "Inn/Tavern": [
    {n:"Meal, simple", d:"Bread, stew, drink.", u:"Meal (1 person)", sp:5, r:"common"},
    {n:"Meal, hearty", d:"Meat, greens, ale.", u:"Meal (1 person)", sp:10, r:"common"},
    {n:"Lodging (1 night)", d:"Common room cot.", u:"Rest (1 person)", sp:10, r:"common"},
    {n:"Private room (1 night)", d:"Lockable door, basin.", u:"Rest (1 person)", sp:30, r:"uncommon"}
  ],

  // --- Clothing & Craft ---
  "Tailor": [
    {n:"Shirt, linen", d:"Plain weave.", u:"Clothing", sp:12, r:"common"},
    {n:"Trousers, wool", d:"Twill weave.", u:"Clothing", sp:18, r:"common"},
    {n:"Cloak, hooded", d:"Clasped at neck.", u:"Outerwear", sp:25, r:"uncommon"}
  ],
  "Cobbler": [
    {n:"Shoes, soft", d:"Suede uppers.", u:"Footwear", sp:20, r:"common"},
    {n:"Boots, sturdy", d:"Thick soles.", u:"Footwear", sp:40, r:"uncommon"},
    {n:"Repair, resoling", d:"Return next day.", u:"Service", sp:15, r:"common"}
  ],
  "Tanner": [
    {n:"Leather scraps (bundle)", d:"Useful for patches.", u:"Crafting", sp:6, r:"common"},
    {n:"Hide, cured", d:"2×3 ft.", u:"Crafting", sp:25, r:"uncommon"},
    {n:"Belt blanks (pair)", d:"Pre-punched ends.", u:"Crafting", sp:8, r:"common"}
  ],
  "Fabric Shop": [
    {n:"Bolt, linen (5 yd)", d:"Undyed.", u:"Sewing", sp:50, r:"common"},
    {n:"Bolt, wool (5 yd)", d:"Plain colors.", u:"Sewing", sp:80, r:"uncommon"},
    {n:"Thread & needles kit", d:"Wooden spool.", u:"Sewing", sp:6, r:"common"}
  ],

  // --- Tools & Materials ---
  "Blacksmith (Arms/Armor)": [
    {n:"Dagger", d:"Simple crossguard.", u:"Weapon", sp:200, r:"common"},
    {n:"Spear", d:"Ash shaft, leaf head.", u:"Weapon", sp:100, r:"common"},
    {n:"Shield, wooden", d:"Iron boss.", u:"Defense", sp:500, r:"uncommon"},
    {n:"Helmet, open", d:"Riveted bands.", u:"Armor part", sp:600, r:"uncommon"},
    {n:"Shortsword", d:"Leaf-shaped blade.", u:"Weapon", sp:300, r:"common"},
    {n:"Longsword", d:"Fuller down the center.", u:"Weapon", sp:450, r:"uncommon"},
    {n:"Handaxe", d:"Bearded head.", u:"Weapon/utility", sp:180, r:"common"},
    {n:"Battleaxe", d:"Broad crescent.", u:"Weapon", sp:420, r:"uncommon"},
    {n:"Warhammer", d:"Square face, spike.", u:"Weapon", sp:380, r:"uncommon"},
    {n:"Mace", d:"Flanged head.", u:"Weapon", sp:260, r:"common"},
    {n:"Maul", d:"Two-handed sledge.", u:"Weapon", sp:480, r:"uncommon"},
    {n:"Pike (12 ft)", d:"Socketed head.", u:"Reach weapon", sp:320, r:"uncommon"},
    {n:"Halberd", d:"Axe, hook, spike.", u:"Polearm", sp:500, r:"uncommon"},
    {n:"Glaive", d:"Curved blade.", u:"Polearm", sp:460, r:"uncommon"},
    {n:"Morningstar", d:"Spiked flanges.", u:"Weapon", sp:360, r:"uncommon"},
    {n:"Javelins (5)", d:"Straight iron heads.", u:"Thrown weapon", sp:120, r:"common"},
    {n:"Darts (10)", d:"Needle-steel tips.", u:"Thrown weapon", sp:50, r:"common"},
    {n:"Arrowheads (20)", d:"Broadhead/bodkin mix.", u:"Ammo crafting", sp:80, r:"common"},
    {n:"Bolt heads (20)", d:"Square quarrels.", u:"Ammo crafting", sp:90, r:"common"},
    {n:"Buckler", d:"Bossed center.", u:"Defense", sp:360, r:"uncommon"},
    {n:"Shield, steel-rimmed", d:"Reinforced edge.", u:"Defense", sp:650, r:"uncommon"},
    {n:"Chain shirt", d:"Riveted rings.", u:"Armor", sp:1200, r:"uncommon"},
    {n:"Scale shirt", d:"Lapped plates.", u:"Armor", sp:1000, r:"uncommon"},
    {n:"Brigandine vest", d:"Hidden rivets.", u:"Armor", sp:1500, r:"rare"},
    {n:"Gauntlets (pair)", d:"Articulated knuckles.", u:"Armor part", sp:220, r:"uncommon"},
    {n:"Greaves (pair)", d:"Strapped plates.", u:"Armor part", sp:240, r:"uncommon"},
    {n:"Gorget", d:"Neck protection.", u:"Armor part", sp:180, r:"uncommon"},
    {n:"Coif, mail", d:"Hood of rings.", u:"Armor part", sp:300, r:"uncommon"},
    {n:"Scabbard, leather", d:"Steel chape.", u:"Carry a blade", sp:80, r:"common"},
    {n:"Strap & buckle set", d:"Armor fittings.", u:"Repair/fit armor", sp:60, r:"common"},
    {n:"Whetstone, coarse", d:"Open grit.", u:"Edge shaping", sp:3, r:"common"},
    {n:"Sharpening service", d:"While-you-wait.", u:"Restore edge", sp:12, r:"common"}
  ],
  "Farrier": [
    {n:"Horseshoes (set of 4)", d:"Sized to fit.", u:"Mount care", sp:20, r:"common"},
    {n:"Hoof pick", d:"Curved tip.", u:"Mount care", sp:5, r:"common"},
    {n:"Farrier service", d:"Shoe/trim per mount.", u:"Service", sp:50, r:"common"}
  ],
  "Carpenter": [
    {n:"Ladder (10 ft)", d:"Pinned rungs.", u:"Access", sp:30, r:"common"},
    {n:"Crate, large", d:"Rope handles.", u:"Storage", sp:12, r:"common"},
    {n:"Repair service (small)", d:"Furniture mends.", u:"Service", sp:20, r:"common"}
  ],
  "Wheelwright": [
    {n:"Handcart", d:"Single-axle.", u:"Hauling", sp:800, r:"uncommon"},
    {n:"Wagon wheel", d:"Band of iron.", u:"Repair", sp:300, r:"uncommon"},
    {n:"Grease pot", d:"Tallow-based.", u:"Maintenance", sp:8, r:"common"}
  ],

  // --- Services ---
  "Stables": [
    {n:"Stabling (per day)", d:"Feed & water.", u:"Service", sp:10, r:"common"},
    {n:"Tack & bit", d:"Leather straps.", u:"Riding", sp:25, r:"common"},
    {n:"Saddle, pack", d:"For loads.", u:"Riding", sp:50, r:"uncommon"}
  ],
  "Messenger": [
    {n:"Local delivery", d:"Within town walls.", u:"Service", sp:10, r:"common"},
    {n:"Regional courier", d:"1–2 days’ ride.", u:"Service", sp:80, r:"uncommon"},
    {n:"Notice posting", d:"Board & corners.", u:"Service", sp:5, r:"common"}
  ],

  // --- Specialty: Adventuring / Magic / Knowledge / Alchemy / Arts ---
  "Adventuring Gear": [
    {n:"Backpack, framed", d:"Stiffened with ash slats.", u:"Carry + organized slots", sp:50, r:"common"},
    {n:"Bedroll, winter-lined", d:"Wool batting.", u:"Sleep warm outdoors", sp:25, r:"common"},
    {n:"Blanket, heavy", d:"Thick weave.", u:"Cold nights / patient care", sp:8, r:"common"},
    {n:"Crowbar", d:"Flattened chisel end.", u:"Leverage & prying", sp:20, r:"common"},
    {n:"Hammer, climber’s", d:"Point & flat faces.", u:"Set pitons", sp:15, r:"common"},
    {n:"Piton (10)", d:"Ringed iron spikes.", u:"Climbing anchors", sp:5, r:"common"},
    {n:"Chalk (20 sticks)", d:"Wax-wrapped.", u:"Marking/maze routes", sp:3, r:"common"},
    {n:"Tinderbox", d:"Flint, steel, charcloth.", u:"Start fires", sp:6, r:"common"},
    {n:"Torch bundle (10)", d:"Pitch-soaked heads.", u:"Light (1 hr each)", sp:5, r:"common"},
    {n:"Rations (7 days)", d:"Hard biscuit & dried meat.", u:"Travel food", sp:35, r:"common"},
    {n:"Waterskin (2 qt)", d:"Wax-lined.", u:"Carry water", sp:8, r:"common"},
    {n:"Mess kit", d:"Pan, cup, cutlery.", u:"Cook/eat", sp:6, r:"common"},
    {n:"Cook’s utensils", d:"Pans, ladle, spice tins.", u:"Camp cooking", sp:40, r:"uncommon"},
    {n:"Healer’s kit (10 uses)", d:"Bandage, splints, salves.", u:"Stabilize w/o check", sp:150, r:"uncommon"},
    {n:"Climber’s kit", d:"Pitons, harness, rope.", u:"Secure ascents", sp:250, r:"uncommon"},
    {n:"Grappling hook, folding", d:"Collapsible tines.", u:"Climb/grab edges", sp:25, r:"uncommon"},
    {n:"Ball bearings (bag)", d:"Iron shots.", u:"Create slippery area", sp:10, r:"uncommon"},
    {n:"Hunting trap", d:"Spring jaw.", u:"Snare small/med game", sp:50, r:"uncommon"},
    {n:"Manacles", d:"Chain & locks.", u:"Restrain captive", sp:200, r:"uncommon"},
    {n:"Lock, good", d:"Tumbler & 2 keys.", u:"Secure a container", sp:600, r:"rare"},
    {n:"Mirror, steel", d:"Polished plate.", u:"Peeking corners/signals", sp:50, r:"uncommon"},
    {n:"Pole (10-ft)", d:"Tapered pine.", u:"Probe/tripwire check", sp:5, r:"common"},
    {n:"Shovel", d:"D-handle.", u:"Digging/burying", sp:20, r:"common"},
    {n:"Sledgehammer", d:"Heavy head.", u:"Break objects", sp:40, r:"uncommon"},
    {n:"Fishing tackle", d:"Line, hooks, bobbers.", u:"Catch fish", sp:25, r:"uncommon"},
    {n:"Tent, two-person", d:"Treated canvas.", u:"Shelter", sp:200, r:"uncommon"},
    {n:"Caltrops (bag)", d:"Spiked jacks.", u:"Hinder pursuit", sp:10, r:"uncommon"},
    {n:"Acid (vial)", d:"Stoppered glass.", u:"Corrode small object", sp:250, r:"rare"},
    {n:"Alchemist’s fire (flask)", d:"Thick resin.", u:"Ignites & clings", sp:400, r:"rare"},
    {n:"Antitoxin (vial)", d:"Bitter herbal.", u:"Bolster vs poison", sp:300, r:"uncommon"},
    {n:"Spyglass (simple)", d:"Ground glass.", u:"See distant targets", sp:2500, r:"rare"},
    {n:"Signal whistle", d:"Piercing shrill.", u:"Alerts long distance", sp:5, r:"common"},
    {n:"Ink & quills set", d:"Black/sepia inks.", u:"Write/draw", sp:20, r:"common"},
    {n:"Parchment (10 sheets)", d:"Fine vellum.", u:"Notes/maps", sp:10, r:"common"},
    {n:"Sealing wax & stamp", d:"Custom sigil blank.", u:"Seal letters", sp:25, r:"uncommon"},
    {n:"Lantern, bullseye", d:"Shuttered beam.", u:"Focused light cone", sp:120, r:"common"},
    {n:"Lantern, hooded (shutter kit)", d:"Extra shutters.", u:"Control spill light", sp:20, r:"common"},
    {n:"Oil, smokeless (flask)", d:"Refined.", u:"Clean burn", sp:25, r:"uncommon"},
    {n:"Rope, silk (50 ft)", d:"Tight braid.", u:"Light, strong climbing", sp:100, r:"uncommon"},
    {n:"Chain (10 ft)", d:"Riveted links.", u:"Heavy securing", sp:50, r:"uncommon"},
    {n:"Pulley & tackle set", d:"Wood/iron blocks.", u:"Hoisting loads", sp:180, r:"uncommon"},
    {n:"Goggles, dust", d:"Tight seal.", u:"Sand/wind protection", sp:40, r:"common"},
    {n:"Bed net (insect)", d:"Fine mesh.", u:"Block biting insects", sp:25, r:"common"},
    {n:"Waterskin, large (4 qt)", d:"Double stitched.", u:"Carry more water", sp:14, r:"common"},
    {n:"Barrel, small", d:"Hooped oak.", u:"Bulk storage", sp:60, r:"common"},
    {n:"Bottle, glass (6)", d:"Corked.", u:"Transport liquids", sp:18, r:"common"},
    {n:"Pads & splints set", d:"Birch slats.", u:"Field injury care", sp:35, r:"common"},
    {n:"Herbal poultices (5)", d:"Camphor scent.", u:"Soothe minor wounds", sp:50, r:"uncommon"},
    {n:"Salve of warmth", d:"Resinous.", u:"Ward mild cold exposure", sp:45, r:"common"},
    {n:"Clamp-saw", d:"Folded frame.", u:"Quiet wood cutting", sp:40, r:"uncommon"},
    {n:"Chisel & wedge set", d:"Tempered.", u:"Stone/door work", sp:30, r:"common"},
    {n:"Hand drill", d:"Twist bit.", u:"Make pilot holes", sp:25, r:"common"},
    {n:"Tarp, waxed (10×10)", d:"Grommeted corners.", u:"Shelter/cover", sp:60, r:"uncommon"},
    {n:"Cloak, weatherproof", d:"Waxed canvas.", u:"Rain protection", sp:45, r:"common"},
    {n:"Boot spikes", d:"Threaded studs.", u:"Ice traction", sp:28, r:"uncommon"},
    {n:"Snowshoes", d:"Laced frame.", u:"Travel over snow", sp:60, r:"uncommon"},
    {n:"Climbing gloves", d:"Suede grip.", u:"Safer ascents", sp:22, r:"common"},
    {n:"Throwing rope spool (100 ft)", d:"Light fiber.", u:"Long throws/anchors", sp:120, r:"uncommon"},
    {n:"Earplugs (waxed)", d:"Moldable.", u:"Muffle loud sounds", sp:6, r:"common"},
    {n:"Signal mirror (bright)", d:"Highly polished.", u:"Long-range signals", sp:55, r:"uncommon"},
    {n:"Messenger’s tube", d:"Sealed brass.", u:"Protect documents", sp:35, r:"common"},
    {n:"Padlock (good)", d:"Three-pin tumbler.", u:"Secure gear", sp:600, r:"rare"},
    {n:"Snares, wire (3)", d:"Pre-tied loops.", u:"Small game traps", sp:25, r:"common"},
    {n:"Spikes, iron (10)", d:"Square-cut.", u:"Jam doors, anchors", sp:20, r:"common"},
    {n:"Tongs, long", d:"Heat-safe.", u:"Handle hot objects", sp:18, r:"common"},
    {n:"Fire kit, storm", d:"Spark-rod & tinder.", u:"Light fires in wind", sp:25, r:"uncommon"},
    {n:"Cooking tripod", d:"Collapsible.", u:"Hang pot over fire", sp:22, r:"common"},
    {n:"Pan, cast-iron", d:"Seasoned.", u:"Camp cooking", sp:20, r:"common"},
    {n:"Soap, lye block (3)", d:"Harsh cleaner.", u:"Tough grime", sp:6, r:"common"},
    {n:"Glue, strong (jar)", d:"Pine pitch.", u:"Repair kit", sp:20, r:"common"},
    {n:"Gaffer’s tape (cloth roll)", d:"Tacky weave.", u:"Wraps/repairs", sp:12, r:"common"},
    {n:"Camouflage cloth", d:"Mottled fabric.", u:"Conceal gear", sp:60, r:"uncommon"},
    {n:"Disguise kit (refills)", d:"Grease paints, hair.", u:"Refresh disguise kit", sp:45, r:"uncommon"},
    {n:"Healer’s kit (refills)", d:"Gauze, salves.", u:"Restock 10 uses", sp:90, r:"uncommon"},
    {n:"Mount feed (3 days)", d:"Oats & chaff.", u:"Travel rations for mounts", sp:15, r:"common"},
    {n:"Saddle, riding", d:"Padded tree.", u:"Comfortable long rides", sp:120, r:"uncommon"},
    {n:"Saddle bags, large", d:"Reinforced seams.", u:"Extra carry on mount", sp:80, r:"uncommon"},
    {n:"Tether line & hobble", d:"Leather & iron.", u:"Secure mount", sp:20, r:"common"},
    {n:"Whetstone, fine", d:"Hard grit.", u:"Keep blades sharp", sp:4, r:"common"},
    {n:"Toolkit, tinker's (lite)", d:"Picks, files, wire.", u:"Quick field repairs", sp:180, r:"uncommon"},
    {n:"Toolkit, climber's (refit)", d:"Spare carabiners.", u:"Replace worn pieces", sp:90, r:"uncommon"},
    {n:"Rope ladder (20 ft)", d:"Hardwood rungs.", u:"Quick climbs", sp:40, r:"uncommon"},
    {n:"Collapsible pole (10 ft)", d:"Sleeved sections.", u:"Probe spans", sp:55, r:"uncommon"},
    {n:"Mallet, wooden", d:"Thick head.", u:"Drive stakes/pitons", sp:6, r:"common"},
    {n:"Door chocks (6)", d:"Wedges of oak.", u:"Hold/quiet doors", sp:5, r:"common"},
    {n:"Prybar, small", d:"Curved cat’s paw.", u:"Quiet leverage", sp:12, r:"common"},
    {n:"Rope, tarred (50 ft)", d:"Weather-resistant.", u:"All-weather line", sp:18, r:"uncommon"},
    {n:"Hook, grapnel (fixed)", d:"Three-tine.", u:"Climb/grab", sp:18, r:"common"},
    {n:"Ram, portable", d:"Two-person carry.", u:"Breach doors", sp:120, r:"uncommon"},
    {n:"Wedges, iron (3)", d:"Square splitters.", u:"Force doors/logs", sp:14, r:"common"},
    {n:"Line thrower spool", d:"Weighted knot.", u:"Cast rope farther", sp:30, r:"uncommon"},
    {n:"Ration bars (3 days)", d:"Dense, bland.", u:"Emergency food", sp:14, r:"common"},
    {n:"Waterskin, wineskin", d:"Thick bladder.", u:"Carry spirits/water", sp:10, r:"common"},
    {n:"Field filter, handpump", d:"Canvas & reed.", u:"Strain silt", sp:45, r:"uncommon"},
    {n:"Fire paste (tube)", d:"Ignites when spread.", u:"Start damp fires", sp:28, r:"uncommon"},
    {n:"Spare flint & steel", d:"Wrapped kit.", u:"Backup ignition", sp:5, r:"common"},
    {n:"Bedroll, summer", d:"Lightweight.", u:"Warm climates", sp:8, r:"common"},
    {n:"Tent, four-person", d:"Guy lines & pegs.", u:"Group shelter", sp:380, r:"uncommon"},
    {n:"Ground spikes (12)", d:"Hole & hook.", u:"Tie-downs", sp:12, r:"common"},
    {n:"Hammer, camp", d:"Flat & puller.", u:"Stake work", sp:14, r:"common"},
    {n:"Sack, waterproof", d:"Waxed inner.", u:"Keep gear dry", sp:20, r:"uncommon"},
    {n:"Satchel, oilskin", d:"Roll-top.", u:"Rainproof carry", sp:28, r:"uncommon"},
    {n:"Canteen, tin (2 qt)", d:"Strapped cap.", u:"Water carry", sp:10, r:"common"},
    {n:"Cooking spit & hooks", d:"Breakdown frame.", u:"Campfire cooking", sp:16, r:"common"},
    {n:"Spade, folding", d:"Pinned hinge.", u:"Dig/trench", sp:28, r:"uncommon"},
    {n:"Hatchet", d:"Belt loop.", u:"Woodcutting/tool", sp:24, r:"common"},
    {n:"Saw, hand", d:"Crosscut teeth.", u:"Cut spars/planks", sp:26, r:"common"},
    {n:"Tarp, canvas (8×12)", d:"Reinforced edge.", u:"Shelter/cover", sp:40, r:"common"},
    {n:"Crampons, strap-on", d:"Iron points.", u:"Ice travel", sp:38, r:"uncommon"},
    {n:"Gaiters, waxed", d:"Buckle closures.", u:"Mud/snow legs", sp:22, r:"common"},
    {n:"Hood, muffle", d:"Wool-lined.", u:"Dampen sound/breath", sp:18, r:"common"},
    {n:"Marker dye (vial)", d:"Bright stain.", u:"Mark doors/trails", sp:12, r:"common"},
    {n:"Whistle, signal (two-tone)", d:"Dual chamber.", u:"Coded signals", sp:8, r:"common"},
    {n:"Mirror, shard-safe", d:"Backed leather.", u:"Peek around corners", sp:32, r:"uncommon"},
    {n:"Sling pouch & stones", d:"Smooth river rock.", u:"Simple ranged shots", sp:6, r:"common"},
    {n:"Crowfoot (heavy caltrops)", d:"Large tines.", u:"Stop mounts", sp:30, r:"uncommon"},
    {n:"Rope bridge kit (20 ft)", d:"Planks & lines.", u:"Span small gaps", sp:160, r:"rare"}
  ],
  "Magic Items": [
    {n:"Minor healing draught", d:"Red-tinted cordial.", u:"Restore a bit of vigor", sp:500, r:"uncommon"},
    {n:"Scroll, simple ward", d:"Short protective verse.", u:"One-use ward", sp:450, r:"uncommon"},
    {n:"Charm, clean & dry", d:"Keeps gear fresh.", u:"Keeps item clean", sp:250, r:"uncommon"},
    {n:"Lamp, ever-wick", d:"Tiny sustained glow.", u:"Dim light source", sp:800, r:"rare"},
    {n:"Coin of Warmth", d:"Always slightly warm.", u:"Hand-warming/comfort", sp:260, r:"uncommon"},
    {n:"Feather of Soft Landing", d:"Drifts forever.", u:"Negates a short fall once/day", sp:520, r:"uncommon"},
    {n:"Whetstone, Ever-Sharp", d:"Never wears down.", u:"Restores mundane blade edge", sp:480, r:"uncommon"},
    {n:"Chalk, Endless stub", d:"Never shortens.", u:"Write/mark unlimited", sp:350, r:"uncommon"},
    {n:"Cloak Clasp of Dryness", d:"Repels water.", u:"Keeps garment dry in rain", sp:600, r:"uncommon"},
    {n:"Mote-Jar", d:"Captures a firefly glow.", u:"Thumb-bright lamp (toggle)", sp:550, r:"uncommon"},
    {n:"Band, Sure Knot", d:"Tiny runes.", u:"Knots can’t slip untied", sp:420, r:"uncommon"},
    {n:"Tinder-Twig Bundle", d:"Sparks on strike.", u:"Light fires in wind (10 uses)", sp:300, r:"uncommon"},
    {n:"Boot Tags of Quiet Step", d:"Leather tabs.", u:"Slightly muffles footfalls", sp:750, r:"rare"},
    {n:"Quill of Fair Script", d:"Steadies hand.", u:"Neat writing, no blot", sp:380, r:"uncommon"},
    {n:"Seal of Fresh Provisions", d:"Cold rune.", u:"Food in sealed box spoils slower", sp:720, r:"rare"},
    {n:"Stone of the North", d:"Points home.", u:"Always turns toward a set place", sp:800, r:"rare"},
    {n:"Lamp, Night-safe", d:"Never tips over lit.", u:"Failsafe lantern charm", sp:520, r:"uncommon"},
    {n:"Thread of True Color", d:"Glows to match.", u:"Mends without visible seam", sp:450, r:"uncommon"},
    {n:"Cup of Tepid Comfort", d:"Steam or cool.", u:"Keeps drink pleasantly warm/cool", sp:600, r:"uncommon"},
    {n:"Charm, Vermin Ward", d:"Carved spider knot.", u:"Keeps insects/rodents at bay (small area)", sp:480, r:"uncommon"},
    {n:"Mirror of Honest Face (palm)", d:"Silvered shard.", u:"Reveals smudges/disguises faintly", sp:900, r:"rare"},
    {n:"Pebble of Echo", d:"Hums when dropped.", u:"Repeats last loud sound quietly", sp:360, r:"uncommon"},
    {n:"Bottle, Self-Corking", d:"Clicks shut.", u:"Won’t spill if knocked", sp:320, r:"uncommon"},
    {n:"Parchment of Recall (sheet)", d:"Faint glyph border.", u:"Returns to the owner’s pack at dusk", sp:650, r:"rare"}
  ],
  "Bookshop/Library": [
    {n:"Primer, common tongue", d:"Letters & phrases.", u:"Study", sp:100, r:"common"},
    {n:"Bestiary, local", d:"Sketches & notes.", u:"Reference", sp:250, r:"uncommon"},
    {n:"Ledger (blank)", d:"Ruled pages.", u:"Records", sp:60, r:"common"},
    {n:"Treatise, old customs", d:"Regional law & rites.", u:"Reference", sp:180, r:"uncommon"},
    {n:"Almanac, current year", d:"Moons, tides, planting.", u:"Reference", sp:80, r:"common"},
    {n:"Gazetteer of the Realm", d:"Town & trade notes.", u:"Reference/travel", sp:220, r:"uncommon"},
    {n:"Atlas, pocket roads", d:"Fold-out plates.", u:"Wayfinding", sp:180, r:"uncommon"},
    {n:"Chapbook, heroic ballads", d:"Broadside collection.", u:"Culture/perform", sp:30, r:"common"},
    {n:"Herbal Handbook", d:"Sketches & uses.", u:"Field reference", sp:160, r:"uncommon"},
    {n:"Scribe’s Kit (basic)", d:"Quills, penknife, sand.", u:"Writing set", sp:70, r:"common"},
    {n:"Ink (quality) & nibs", d:"Blue-black bottle.", u:"Crisp script", sp:40, r:"common"},
    {n:"Book repair kit", d:"Paste, tape, cloth.", u:"Mend bindings", sp:90, r:"uncommon"},
    {n:"Treatise on Monsters, Vol. II", d:"Regional threats.", u:"Reference", sp:260, r:"uncommon"},
    {n:"Religious Hymnals (set)", d:"Common rites.", u:"Ceremony/music", sp:120, r:"common"},
    {n:"Ledger (waterproof covers)", d:"Waxed boards.", u:"Durable records", sp:90, r:"uncommon"},
    {n:"Manual of Etiquette", d:"Courtly protocol.", u:"Social reference", sp:150, r:"uncommon"},
    {n:"Children’s Primer (illustrated)", d:"Bright letters.", u:"Teach reading", sp:60, r:"common"},
    {n:"History, Founding of Argaloth", d:"Scholarly edition.", u:"Lore", sp:240, r:"uncommon"},
    {n:"Best-Selling Romance", d:"Dog-eared already.", u:"Leisure reading", sp:40, r:"common"},
    {n:"Travel Letters (collected)", d:"Merchant routes.", u:"Rumors & routes", sp:170, r:"uncommon"},
    {n:"Rhetoric & Logic", d:"Exercises & forms.", u:"Study/scholastic", sp:200, r:"uncommon"},
    {n:"Calligraphy Set (fine)", d:"Brushes & guides.", u:"Decorative script", sp:180, r:"uncommon"},
    {n:"Bookmarks, ribbon (6)", d:"Colored silk.", u:"Mark passages", sp:12, r:"common"},
    {n:"Reading stone (lens)", d:"Mild magnifier.", u:"Aid small text", sp:110, r:"uncommon"}
  ],
  "Cartographer": [
    {n:"Town map (current)", d:"Streets & gates.", u:"Navigation", sp:60, r:"common"},
    {n:"Region map", d:"Roads & rivers.", u:"Travel", sp:150, r:"uncommon"},
    {n:"Compass, simple", d:"Magnetized needle.", u:"Direction", sp:300, r:"rare"}
  ],
  "Alchemist/Apothecary": [
    {n:"Antiseptic tincture", d:"Cleans minor wounds.", u:"Sterilize", sp:120, r:"uncommon"},
    {n:"Antidote (common)", d:"Herbal binding agents.", u:"Counter mild toxin", sp:300, r:"uncommon"},
    {n:"Smoke pellet (pair)", d:"Short, dense puff.", u:"Cover/escape", sp:80, r:"uncommon"},
    {n:"Scented salts", d:"Sharper wakefulness.", u:"Rouse/focus", sp:40, r:"common"},
    {n:"Alcohol, high-proof (flask)", d:"Stinging clean.", u:"Disinfect/ignite", sp:20, r:"common"},
    {n:"Coagulant powder", d:"Astringent herbs.", u:"Slow minor bleeding", sp:35, r:"uncommon"},
    {n:"Pain salve", d:"Willow & mint.", u:"Ease aches", sp:28, r:"common"},
    {n:"Poultice kit (6)", d:"Clay tins, wraps.", u:"Reduce swelling", sp:60, r:"uncommon"},
    {n:"Antiseptic wash (bottle)", d:"Bitter bite.", u:"Clean wounds", sp:30, r:"common"},
    {n:"Repellent, insect (jar)", d:"Pine/tar base.", u:"Deter biting pests", sp:22, r:"common"},
    {n:"Deodorizing salts", d:"Citrus & soda.", u:"Mask odors", sp:16, r:"common"},
    {n:"Smelling salts, strong", d:"Sharp ammonia.", u:"Rouse the woozy", sp:18, r:"common"},
    {n:"Soporific tea blend", d:"Valerian & hops.", u:"Aid sleep (mild)", sp:20, r:"common"},
    {n:"Stimulant draught (mild)", d:"Bitter bark.", u:"Fight drowsiness", sp:24, r:"uncommon"},
    {n:"Charcoal filter pack (3)", d:"Cloth pouches.", u:"Clarify water", sp:18, r:"common"},
    {n:"Water purifying tablets (10)", d:"Alum & lime.", u:"Make water potable", sp:26, r:"uncommon"},
    {n:"Disinfectant powder", d:"Borax blend.", u:"Sterilize gear", sp:28, r:"common"},
    {n:"Binding resin (jar)", d:"Pine pitch, warm.", u:"Seal bandages", sp:22, r:"common"},
    {n:"Burn cream", d:"Aloe and fat.", u:"Soothe minor burns", sp:26, r:"common"},
    {n:"Antiemetic syrup", d:"Gingered honey.", u:"Settle stomach", sp:18, r:"common"},
    {n:"Lice comb & wash", d:"Camphor scent.", u:"Delousing kit", sp:16, r:"common"},
    {n:"Tooth powder", d:"Salt & herb.", u:"Mouth care", sp:8, r:"common"},
    {n:"Herbal disinfectant smoke", d:"Slow fumigation.", u:"Clean a small room", sp:32, r:"uncommon"},
    {n:"Tonic, iron", d:"Mineral-rich.", u:"Ease faintness", sp:20, r:"common"},
    {n:"Eye wash vial", d:"Sterile saline.", u:"Irritant relief", sp:14, r:"common"},
    {n:"Suture kit", d:"Hooks, thread, needle.", u:"Close wounds", sp:75, r:"uncommon"},
    {n:"Tourniquet band", d:"Buckled strap.", u:"Control bleeding", sp:18, r:"common"},
    {n:"Poisoner’s test paper (5)", d:"Color-change strips.", u:"Detect common toxins", sp:55, r:"uncommon"},
    {n:"Odor neutral gel", d:"Alum base.", u:"Hide trail/scent", sp:30, r:"uncommon"}
  ],
  "Jeweler": [
    {n:"Ring, brass", d:"Plain band.", u:"Adornment", sp:120, r:"common"},
    {n:"Earrings, copper", d:"Small hoops.", u:"Adornment", sp:160, r:"uncommon"},
    {n:"Necklace, glass bead", d:"Varied hues.", u:"Adornment", sp:220, r:"uncommon"},
    {n:"Ring, iron (blued)", d:"Matte finish.", u:"Adornment", sp:90, r:"common"},
    {n:"Ring, silver", d:"Polished band.", u:"Adornment", sp:220, r:"uncommon"},
    {n:"Ring, gold-washed", d:"Thin plating.", u:"Adornment", sp:260, r:"uncommon"},
    {n:"Band, signet (blank)", d:"Ready for crest.", u:"Seal letters", sp:280, r:"uncommon"},
    {n:"Pendant, moonstone", d:"Soft glow cabochon.", u:"Adornment", sp:420, r:"uncommon"},
    {n:"Brooch, filigree silver", d:"Knotwork.", u:"Fasten cloak", sp:300, r:"uncommon"},
    {n:"Neck chain, fine (18\")", d:"Box link.", u:"Pendant chain", sp:190, r:"common"},
    {n:"Bracelet, copper links", d:"Hammered finish.", u:"Adornment", sp:140, r:"common"},
    {n:"Earrings, silver drops", d:"Bell-shaped.", u:"Adornment", sp:260, r:"uncommon"},
    {n:"Hairpin, jeweled", d:"Glass gems.", u:"Style hair", sp:160, r:"uncommon"},
    {n:"Locket, photo/miniature", d:"Hinged oval.", u:"Hold keepsake", sp:280, r:"uncommon"},
    {n:"Cufflinks, brass", d:"Etched corners.", u:"Shirt fasteners", sp:150, r:"uncommon"},
    {n:"Charm, small gemstone", d:"Cut garnet.", u:"Chain charm", sp:220, r:"uncommon"},
    {n:"Tiara, simple", d:"Silver wire.", u:"Ceremonial wear", sp:520, r:"rare"},
    {n:"Circlet, bronze", d:"Leaf motif.", u:"Head adornment", sp:260, r:"uncommon"},
    {n:"Gem, tiny diamond (chip)", d:"For inlay.", u:"Setting supply", sp:700, r:"rare"},
    {n:"Gem, cut sapphire (small)", d:"Deep blue.", u:"Setting supply", sp:900, r:"rare"},
    {n:"Pearls (pair, river)", d:"Cream luster.", u:"Earring set", sp:480, r:"uncommon"},
    {n:"Engraving service", d:"Letters/sigil.", u:"Personalize jewelry", sp:60, r:"common"},
    {n:"Resizing service", d:"Same-day basic.", u:"Fit a ring", sp:70, r:"common"},
    {n:"Appraisal slip", d:"Stamped value.", u:"Insurance/records", sp:80, r:"uncommon"}
  ],
  "Painter/Sculptor": [
    {n:"Pigment set", d:"Earth tones.", u:"Art supplies", sp:140, r:"uncommon"},
    {n:"Brush kit", d:"Boar hair, fine.", u:"Art supplies", sp:80, r:"common"},
    {n:"Carving block", d:"Soft stone or wood.", u:"Sculpting", sp:100, r:"common"}
  ],
  "Fortune Teller": [
    {n:"Palm reading", d:"Lines & callus study.", u:"Service", sp:20, r:"common"},
    {n:"Card spread", d:"Symbolic draw.", u:"Service", sp:50, r:"uncommon"},
    {n:"Charm bundle", d:"Twine, bead, feather.", u:"Keepsake", sp:60, r:"common"}
  ],

  // --- Unique & Shady ---
  "Black Market": [
    {n:"Poison, mild", d:"Bitter extract.", u:"Toxin (light)", sp:800, r:"rare"},
    {n:"Lockpicks, slim set", d:"Fold case.", u:"Finesse tools", sp:400, r:"uncommon"},
    {n:"Stolen trinkets (assort.)", d:"Mixed small goods.", u:"Fencing", sp:200, r:"uncommon"},
    {n:"Poison, sleep (dose)", d:"Bitter almond.", u:"Induce short slumber", sp:900, r:"rare"},
    {n:"Poison, paralytic (dose)", d:"Viscous grey.", u:"Brief muscle lock", sp:1100, r:"rare"},
    {n:"Toxin, contact (dose)", d:"Oily film.", u:"Harm on touch", sp:1200, r:"rare"},
    {n:"Smoke bomb, heavy", d:"Pitch-black cloud.", u:"Dense cover, longer", sp:220, r:"uncommon"},
    {n:"Flash charge", d:"Magnesium flare.", u:"Blind momentarily", sp:260, r:"uncommon"},
    {n:"Acid, concentrated", d:"Hisses on air.", u:"Rapid corrosion", sp:380, r:"rare"},
    {n:"Lockpicks, master set", d:"Hardened tips.", u:"Bypass fine locks", sp:700, r:"rare"},
    {n:"Glass cutter & suction", d:"Quiet entry kit.", u:"Cut panes cleanly", sp:240, r:"uncommon"},
    {n:"Grapple claws (pair)", d:"Palm hooks.", u:"Climb silently", sp:300, r:"uncommon"},
    {n:"Garrote wire", d:"Silk-wrapped ends.", u:"Silent takedowns", sp:180, r:"uncommon"},
    {n:"Footpads, silent", d:"Felted soles.", u:"Muffle footsteps", sp:150, r:"uncommon"},
    {n:"Cloak with hidden pockets", d:"Secret seams.", u:"Conceal small items", sp:260, r:"uncommon"},
    {n:"Hollow book safe", d:"Cut pages.", u:"Hide valuables", sp:120, r:"uncommon"},
    {n:"Signet ring, burner", d:"Soft metal.", u:"Disposable seal", sp:200, r:"uncommon"},
    {n:"Forgery kit (illicit)", d:"Inks, stamps.", u:"Imitate documents", sp:500, r:"rare"},
    {n:"Coin scale, discreet", d:"Folds into case.", u:"Detect clipped coin", sp:180, r:"uncommon"},
    {n:"False-bottom flask", d:"Hidden chamber.", u:"Smuggle liquids", sp:90, r:"uncommon"},
    {n:"Blackjack (sapper’s sap)", d:"Weighted leather.", u:"Subdue quietly", sp:140, r:"uncommon"},
    {n:"Tar beads (track-break)", d:"Mask footprints.", u:"Confuse pursuit", sp:120, r:"uncommon"}
  ],
  "Pawn Shop": [
    {n:"Used cookware", d:"Dings & polish.", u:"Household", sp:8, r:"common"},
    {n:"Secondhand cloak", d:"Re-hemmed.", u:"Clothing", sp:12, r:"common"},
    {n:"Old instrument", d:"Well-tuned.", u:"Music", sp:160, r:"uncommon"},
    {n:"Bent candlesticks (pair)", d:"Brass, tarnished.", u:"Home goods", sp:6, r:"common"},
    {n:"Mismatched cutlery (set)", d:"Old silvered.", u:"Household", sp:5, r:"common"},
    {n:"Worn boots", d:"Half-sole left.", u:"Footwear (used)", sp:10, r:"common"},
    {n:"Secondhand satchel", d:"Scuffed flap.", u:"Carry gear", sp:9, r:"common"},
    {n:"Chipped buckler", d:"Edge nicks.", u:"Defense (used)", sp:160, r:"uncommon"},
    {n:"Dented helm", d:"Old crest sanded.", u:"Armor (used)", sp:180, r:"uncommon"},
    {n:"Dog-eared map", d:"Outdated roads.", u:"Navigation (iffy)", sp:20, r:"common"},
    {n:"Spyglass, cloudy", d:"Scratched lens.", u:"Long view (imperfect)", sp:280, r:"uncommon"},
    {n:"Cracked hourglass", d:"Leaky seam.", u:"Rough timing", sp:12, r:"common"},
    {n:"Tarnished signet ring", d:"Unknown crest.", u:"Curio/bribe", sp:70, r:"uncommon"},
    {n:"Old ledger (blank pages)", d:"Back half unused.", u:"Records", sp:12, r:"common"},
    {n:"Travel cloak, patched", d:"Many stitches.", u:"Clothing (used)", sp:8, r:"common"},
    {n:"Instrument, scuffed lute", d:"Holds tune.", u:"Music (used)", sp:90, r:"uncommon"},
    {n:"Tool roll, incomplete", d:"Missing pieces.", u:"Light repairs", sp:30, r:"common"},
    {n:"Coin miscellany (bag)", d:"Foreign & clipped.", u:"Trade curiosity", sp:40, r:"uncommon"}
  ],
  "Clockwork Repair": [
    {n:"Spring repair", d:"Handwatch/toy.", u:"Service", sp:120, r:"uncommon"},
    {n:"Gear set", d:"Assorted sizes.", u:"Parts", sp:90, r:"uncommon"},
    {n:"Key-wind toy", d:"Marching beetle.", u:"Novelty", sp:250, r:"uncommon"}
  ],
  "Pet Shop": [
    {n:"Songbird (caged)", d:"Simple melody.", u:"Companion", sp:200, r:"uncommon"},
    {n:"Pack rat (trained)", d:"Carries light load.", u:"Utility", sp:150, r:"uncommon"},
    {n:"Cat (tame)", d:"Mouser.", u:"Companion", sp:120, r:"common"}
  ],
  "Oddities": [
    {n:"Self-warming mug", d:"Keeps liquid warm.", u:"Comfort", sp:300, r:"rare"},
    {n:"Ink that fades by dawn", d:"Pale residue.", u:"Short-lived notes", sp:180, r:"uncommon"},
    {n:"Whistle, wind-tone", d:"Plays in breeze.", u:"Signal", sp:60, r:"common"}
  ],
  "Mercenary/Bounty": [
    {n:"Guard hire (per day)", d:"Watch & deter.", u:"Service", sp:200, r:"uncommon"},
    {n:"Courier-escort (per day)", d:"Armed rider.", u:"Service", sp:300, r:"uncommon"},
    {n:"Notice posting fee", d:"Guild board.", u:"Service", sp:20, r:"common"}
  ]
};

SHOPS["Potions & Elixirs"] = [
  {n:"Potion of Healing (minor)", d:"Ruby cordial with mint bite.", u:"Regain a small amount of HP", sp:500, r:"uncommon"},
  {n:"Potion of Healing (greater)", d:"Deep carmine, viscous.", u:"Regain a moderate amount of HP", sp:1500, r:"uncommon"},
  {n:"Potion of Healing (superior)", d:"Glows faintly when shaken.", u:"Regain a large amount of HP", sp:4500, r:"rare"},
  {n:"Antitoxin Draught", d:"Bitter bark & clove.", u:"Advantage vs common poisons (short duration)", sp:300, r:"uncommon"},
  {n:"Elixir of Climbing", d:"Amber with suspended grit.", u:"Improved climbing checks", sp:350, r:"uncommon"},
  {n:"Elixir of Waterbreathing", d:"Sea-salted, faint bubbles.", u:"Breathe water for 1 hour", sp:1200, r:"rare"},
  {n:"Elixir of Cat’s Reflex", d:"Silver swirl that settles fast.", u:"Boosts agility briefly", sp:900, r:"rare"},
  {n:"Elixir of Giant’s Vigor (lesser)", d:"Thick ochre.", u:"Brief melee potency", sp:1400, r:"rare"},
  {n:"Potion of Featherfall", d:"Weightless, wispy.", u:"Slow falling on next drop", sp:600, r:"uncommon"},
  {n:"Potion of Darkvision", d:"Inky black, tastes of licorice.", u:"See in dim light as day", sp:1200, r:"rare"},
  {n:"Potion of Invisibility (short)", d:"Crystal-clear; bottle fogs.", u:"Turn invisible briefly", sp:2500, r:"rare"},
  {n:"Fire Breath Phial", d:"Smolders at the cork.", u:"Exhale small fire cone 1–3 times", sp:950, r:"rare"},
  {n:"Resistance Tonic (fire)", d:"Spicy heat.", u:"Resist fire briefly", sp:700, r:"uncommon"},
  {n:"Resistance Tonic (cold)", d:"Arctic bite.", u:"Resist cold briefly", sp:700, r:"uncommon"},
  {n:"Resistance Tonic (acid)", d:"Acrid tang.", u:"Resist acid briefly", sp:700, r:"uncommon"},
  {n:"Resistance Tonic (lightning)", d:"Crackles softly.", u:"Resist lightning briefly", sp:700, r:"uncommon"},
  {n:"Stoneflesh Draft", d:"Grey grit, chalky finish.", u:"Skin hardens; blunt resilience", sp:1600, r:"rare"},
  {n:"Elixir of Vitality", d:"Herbal warmth.", u:"Cures minor fatigue/poisoned", sp:800, r:"uncommon"},
  {n:"Potion of Speed (short)", d:"Vibrant yellow, fizzing.", u:"Burst of speed & extra action (short)", sp:2800, r:"rare"},
  {n:"Night’s Rest Phial", d:"Lavender hue.", u:"Sleep recovers a bit extra", sp:300, r:"common"},
  {n:"Antiplague Tonic", d:"Camphor & honey.", u:"Bolster vs disease", sp:350, r:"uncommon"},
  {n:"Iron Stomach Draft", d:"Peppery bite.", u:"Ignore spoiled/strange food ill effects", sp:120, r:"common"},
  {n:"Potion of Spiderwalk", d:"Viscous, climbs the glass.", u:"Climb walls briefly", sp:1500, r:"rare"},
  {n:"Elixir of Truth (mild)", d:"Clear, cooling.", u:"Makes lies harder to speak", sp:900, r:"rare"},
  {n:"Smelling Salts (vial)", d:"Pungent ammonia.", u:"Rouse a stunned/unconscious ally (mild)", sp:90, r:"common"},
  {n:"Potion of Healing (common brew)", d:"Rosehip and iron tang.", u:"Restore a small amount of HP", sp:500, r:"uncommon"},
  {n:"Draught of Second Wind", d:"Savory, warming.", u:"Small burst of stamina mid-fight", sp:600, r:"uncommon"},
  {n:"Scout’s Tonic", d:"Green, grassy nose.", u:"Boost to stealth and perception, brief", sp:750, r:"uncommon"},
  {n:"Potion of Clarity", d:"Lemon-clear, brisk.", u:"Sharpened focus on skill checks, brief", sp:700, r:"uncommon"},
  {n:"Potion of Stoneskin (lesser)", d:"Grit settles slow.", u:"Mild resistance to weapon blows", sp:1600, r:"rare"},
  {n:"Potion of Heroism (short)", d:"Blue fizz.", u:"Minor temp HP + courage", sp:1200, r:"rare"},
  {n:"Potion of Resistance (force)", d:"Thick, humming.", u:"Resist force damage, brief", sp:900, r:"rare"},
  {n:"Potion of Resistance (necrotic)", d:"Ashen swirl.", u:"Resist necrotic, brief", sp:900, r:"rare"},
  {n:"Potion of Resistance (radiant)", d:"Pale glow.", u:"Resist radiant, brief", sp:900, r:"rare"},
  {n:"Potion of Resistance (thunder)", d:"Foams on pour.", u:"Resist thunder, brief", sp:900, r:"rare"},
  {n:"Cold Iron Tonic", d:"Metallic finish.", u:"Advantage vs charm/fear (short)", sp:850, r:"rare"},
  {n:"Hunter’s Elixir", d:"Amber flecks.", u:"Advantage on tracking checks", sp:600, r:"uncommon"},
  {n:"Silent Step Draught", d:"Barely ripples.", u:"Mutes footfalls (brief stealth boon)", sp:800, r:"rare"},
  {n:"Potion of Gaseous Form (short)", d:"Mist trapped in glass.", u:"Slip through gaps", sp:2600, r:"rare"},
  {n:"Potion of Mind Shielding (mild)", d:"Opalescent.", u:"Veils surface thoughts briefly", sp:1400, r:"rare"},
  {n:"Potion of Read Magic", d:"Ink-tinted.", u:"Understand arcane glyphs briefly", sp:500, r:"uncommon"},
  {n:"Potion of Comprehend Languages", d:"Layered script scent.", u:"Understand speech text briefly", sp:650, r:"uncommon"},
  {n:"Elixir of Swimming", d:"Briny; slick mouthfeel.", u:"Swim speed boost", sp:500, r:"uncommon"},
  {n:"Sea-Legs Philter", d:"Doesn’t slosh.", u:"Ignore ship-/mount-sway penalties", sp:300, r:"common"},
  {n:"Potion of Fire Resistance (strong)", d:"Embers inside.", u:"Longer fire resistance", sp:1500, r:"rare"},
  {n:"Potion of Cold Resistance (strong)", d:"Frost clings.", u:"Longer cold resistance", sp:1500, r:"rare"},
  {n:"Elixir of Evasion", d:"Snaps on tongue.", u:"Slight edge vs area effects", sp:1300, r:"rare"},
  {n:"Elixir of Fortitude", d:"Root-heavy.", u:"Slight edge vs physical saves", sp:1300, r:"rare"},
  {n:"Elixir of Will", d:"Bitter bark.", u:"Slight edge vs mental saves", sp:1300, r:"rare"},
  {n:"Potion of Night Eye", d:"Smoky purple.", u:"Low-light vision improvement", sp:900, r:"rare"},
  {n:"Potion of Silent Image (bottled)", d:"Shifts in light.", u:"One short-lived minor illusion", sp:700, r:"rare"},
  {n:"Potion of Blur", d:"Double-vision swirl.", u:"Harder to hit briefly", sp:1700, r:"rare"},
  {n:"Elixir of Haste (very short)", d:"Stings like nettle.", u:"Brief speed burst", sp:1800, r:"rare"},
  {n:"Potion of Jumping", d:"Springy mouthfeel.", u:"Greatly increases jump distance", sp:500, r:"uncommon"},
  {n:"Potion of Animal Friendship", d:"Earthy, sweet.", u:"Soothe a beast briefly", sp:900, r:"rare"},
  {n:"Potion of Barkskin (lesser)", d:"Leaf sediment.", u:"Slightly toughened hide", sp:1400, r:"rare"},
  {n:"Wanderer’s Restorative", d:"Herbal citrus.", u:"Remove minor exhaustion (1 level)", sp:1200, r:"rare"},
  {n:"Potion of Freedom of Movement (short)", d:"Silky glide.", u:"Ignore restraints/terrain (short)", sp:2800, r:"rare"}
];

SHOPS["Arcane Scrolls"] = [
  {n:"Spell Scroll (Cantrip): Light", d:"Soft gold seal.", u:"Cast a simple light cantrip once", sp:120, r:"common"},
  {n:"Spell Scroll (Cantrip): Prestidigitation", d:"Wax flecks.", u:"Minor tricks & cleaning", sp:150, r:"common"},
  {n:"Spell Scroll (1st): Magic Missile", d:"Precise script.", u:"Guaranteed force bolts", sp:400, r:"uncommon"},
  {n:"Spell Scroll (1st): Shield", d:"Silver thread.", u:"Reactionary arcane ward", sp:450, r:"uncommon"},
  {n:"Spell Scroll (1st): Feather Fall", d:"Margin feathers.", u:"Prevent falling harm", sp:400, r:"uncommon"},
  {n:"Spell Scroll (1st): Detect Magic", d:"Aurum filigree.", u:"Sense magic auras", sp:350, r:"uncommon"},
  {n:"Spell Scroll (2nd): Invisibility", d:"Faintly translucent vellum.", u:"Turn a creature invisible", sp:1100, r:"rare"},
  {n:"Spell Scroll (2nd): Misty Step", d:"Violet ink cloud.", u:"Short-range teleport", sp:1000, r:"rare"},
  {n:"Spell Scroll (2nd): Levitate", d:"Vertical script.", u:"Float a target", sp:900, r:"rare"},
  {n:"Spell Scroll (2nd): Spider Climb", d:"Sticky wax stamp.", u:"Climb surfaces", sp:900, r:"rare"},
  {n:"Spell Scroll (3rd): Fireball", d:"Singed edge.", u:"Explosive fire sphere", sp:2200, r:"rare"},
  {n:"Spell Scroll (3rd): Counterspell", d:"Cross-hatch ward.", u:"Interrupt spellcasting", sp:2400, r:"rare"},
  {n:"Spell Scroll (3rd): Fly", d:"Feather quill bound.", u:"Grant flight briefly", sp:2200, r:"rare"},
  {n:"Spell Scroll (3rd): Dispel Magic", d:"Unbinding knot seal.", u:"End ongoing magic", sp:2100, r:"rare"},
  {n:"Spell Scroll (4th): Greater Invisibility", d:"Vanishing ink.", u:"Sustained invisibility", sp:4200, r:"rare"},
  {n:"Spell Scroll (4th): Dimension Door", d:"Twin door sigils.", u:"Mid-range teleport", sp:4200, r:"rare"},
  {n:"Spell Scroll (5th): Wall of Force", d:"Rigid emboss.", u:"Invisible barrier", sp:6800, r:"rare"},
  {n:"Spell Scroll (5th): Cone of Cold", d:"Frost-rimmed vellum.", u:"Frigid blast", sp:6500, r:"rare"},
   // Cantrips
  {n:"Spell Scroll (Cantrip): Mage Hand", d:"Palm glyph in margin.", u:"Spectral hand tricks", sp:140, r:"common"},
  {n:"Spell Scroll (Cantrip): Minor Illusion", d:"Checker watermark.", u:"Small sound or image", sp:160, r:"common"},
  {n:"Spell Scroll (Cantrip): Ray of Frost", d:"Frost-kissed edge.", u:"Icy ray", sp:150, r:"common"},

  // 1st-level
  {n:"Spell Scroll (1st): Alarm", d:"Bell sigil.", u:"Wards an area", sp:380, r:"uncommon"},
  {n:"Spell Scroll (1st): Detect Magic", d:"Aurum filigree.", u:"Sense auras", sp:350, r:"uncommon"},
  {n:"Spell Scroll (1st): Identify", d:"Lens sketch.", u:"Discern magical properties", sp:420, r:"uncommon"},
  {n:"Spell Scroll (1st): Tasha’s Hideous Laughter", d:"Laughing mask seal.", u:"Compel fits of mirth", sp:420, r:"uncommon"},
  {n:"Spell Scroll (1st): Grease", d:"Oily smear.", u:"Create slick area", sp:380, r:"uncommon"},
  {n:"Spell Scroll (1st): Fog Cloud", d:"Grey wash.", u:"Create obscuring mist", sp:380, r:"uncommon"},

  // 2nd-level
  {n:"Spell Scroll (2nd): Mirror Image", d:"Trifold visage.", u:"Illusory duplicates", sp:1100, r:"rare"},
  {n:"Spell Scroll (2nd): Web", d:"Sticky stamp.", u:"Restraining webs", sp:950, r:"rare"},
  {n:"Spell Scroll (2nd): See Invisibility", d:"Faint eye watermark.", u:"Perceive the unseen", sp:1200, r:"rare"},
  {n:"Spell Scroll (2nd): Hold Person", d:"Binding knot.", u:"Paralyze a humanoid", sp:1100, r:"rare"},
  {n:"Spell Scroll (2nd): Scorching Ray", d:"Singed sigils.", u:"Rays of fire", sp:1000, r:"rare"},
  {n:"Spell Scroll (2nd): Shatter", d:"Fracture motif.", u:"Thunderous break", sp:1000, r:"rare"},

  // 3rd-level
  {n:"Spell Scroll (3rd): Haste", d:"Slanted script.", u:"Speed + extra action", sp:2400, r:"rare"},
  {n:"Spell Scroll (3rd): Hypnotic Pattern", d:"Spiral inks.", u:"Mesmerize a crowd", sp:2300, r:"rare"},
  {n:"Spell Scroll (3rd): Lightning Bolt", d:"Jagged runes.", u:"Line of lightning", sp:2200, r:"rare"},
  {n:"Spell Scroll (3rd): Tiny Hut (Leomund’s)", d:"Dome seal.", u:"Stationary shelter", sp:2300, r:"rare"},
  {n:"Spell Scroll (3rd): Water Breathing", d:"Blue cord.", u:"Group water breathing", sp:2100, r:"rare"},
  {n:"Spell Scroll (3rd): Phantom Steed", d:"Horseshoe mark.", u:"Conjure fast mount", sp:2000, r:"rare"},
  {n:"Spell Scroll (3rd): Nondetection", d:"Cross-veiled sigil.", u:"Foils scrying", sp:2100, r:"rare"},

  // 4th-level
  {n:"Spell Scroll (4th): Banishment", d:"Outer ring seal.", u:"Exile a target", sp:4400, r:"rare"},
  {n:"Spell Scroll (4th): Polymorph", d:"Morphic margin.", u:"Transform a creature", sp:4400, r:"rare"},
  {n:"Spell Scroll (4th): Stoneskin", d:"Granite texture.", u:"Resistance vs nonmagical weapons", sp:4600, r:"rare"},
  {n:"Spell Scroll (4th): Greater Invisibility", d:"Vanishing ink.", u:"Sustained invisibility", sp:4200, r:"rare"},
  {n:"Spell Scroll (4th): Fabricate", d:"Joinery diagram.", u:"Turn raw into finished goods", sp:4300, r:"rare"},

  // 5th-level
  {n:"Spell Scroll (5th): Telekinesis", d:"Floating glyphs.", u:"Move objects by will", sp:6800, r:"rare"},
  {n:"Spell Scroll (5th): Animate Objects", d:"Dotted pathways.", u:"Objects spring to life", sp:6800, r:"rare"},
  {n:"Spell Scroll (5th): Wall of Stone", d:"Strata lines.", u:"Raise stone barrier", sp:6800, r:"rare"},
  {n:"Spell Scroll (5th): Passwall", d:"Doorline motif.", u:"Create a passage", sp:6600, r:"rare"},
  {n:"Spell Scroll (5th): Synaptic Static", d:"Frayed letters.", u:"Psychic detonation", sp:7000, r:"rare"}
];

SHOPS["Divine Scrolls"] = [
  {n:"Spell Scroll (Cantrip): Guidance", d:"Green twine.", u:"Small skill boon", sp:120, r:"common"},
  {n:"Spell Scroll (1st): Cure Wounds", d:"Rose stamp.", u:"Restore HP to a creature", sp:400, r:"uncommon"},
  {n:"Spell Scroll (1st): Bless", d:"Triple dot seal.", u:"Bolster allies’ attacks & saves", sp:400, r:"uncommon"},
  {n:"Spell Scroll (1st): Protection from Evil & Good", d:"Twin wards.", u:"Ward against certain creatures", sp:450, r:"uncommon"},
  {n:"Spell Scroll (2nd): Lesser Restoration", d:"Clean white ribbon.", u:"End one harmful condition", sp:1000, r:"rare"},
  {n:"Spell Scroll (2nd): Aid", d:"Braided cord.", u:"Increase HP maximum briefly", sp:950, r:"rare"},
  {n:"Spell Scroll (3rd): Revivify", d:"Golden leaf.", u:"Return a creature moments after death", sp:2600, r:"rare"},
  {n:"Spell Scroll (3rd): Beacon of Hope", d:"Sunburst seal.", u:"Healing and save advantage", sp:2000, r:"rare"},
  {n:"Spell Scroll (4th): Death Ward", d:"Bone-white wax.", u:"Prevent a fatal drop once", sp:4200, r:"rare"},
  {n:"Spell Scroll (5th): Greater Restoration", d:"Heavy parchment.", u:"End severe debilitation", sp:7000, r:"rare"},
  // Cantrips
  {n:"Spell Scroll (Cantrip): Thaumaturgy", d:"Bellflower seal.", u:"Minor wonders", sp:120, r:"common"},
  {n:"Spell Scroll (Cantrip): Spare the Dying", d:"Lily stamp.", u:"Stabilize a creature", sp:140, r:"common"},

  // 1st-level
  {n:"Spell Scroll (1st): Sanctuary", d:"Halo mark.", u:"Ward a creature from attacks", sp:380, r:"uncommon"},
  {n:"Spell Scroll (1st): Detect Evil and Good", d:"Six-point ward.", u:"Sense aberrations/fiends/undead", sp:380, r:"uncommon"},
  {n:"Spell Scroll (1st): Purify Food and Drink", d:"Clear seal.", u:"Cleanse provisions", sp:300, r:"common"},
  {n:"Spell Scroll (1st): Shield of Faith", d:"Linked rings.", u:"Shimmering defense", sp:420, r:"uncommon"},

  // 2nd-level
  {n:"Spell Scroll (2nd): Silence", d:"Blank circle.", u:"No sound within area", sp:1000, r:"rare"},
  {n:"Spell Scroll (2nd): Spiritual Weapon", d:"Blade motif.", u:"Summon floating weapon", sp:1100, r:"rare"},
  {n:"Spell Scroll (2nd): Gentle Repose", d:"White ribbon.", u:"Prevents decay/undeath", sp:900, r:"rare"},
  {n:"Spell Scroll (2nd): Prayer of Healing", d:"Sunburst margins.", u:"Group healing out of combat", sp:1000, r:"rare"},

  // 3rd-level
  {n:"Spell Scroll (3rd): Remove Curse", d:"Broken chain.", u:"Lift a curse", sp:2100, r:"rare"},
  {n:"Spell Scroll (3rd): Spirit Guardians", d:"Haloed figures.", u:"Protective divine spirits", sp:2500, r:"rare"},
  {n:"Spell Scroll (3rd): Daylight", d:"Radiant seal.", u:"Bright light sphere", sp:2000, r:"rare"},
  {n:"Spell Scroll (3rd): Mass Healing Word", d:"Chord notation.", u:"Rally multiple allies", sp:2100, r:"rare"},

  // 4th-level
  {n:"Spell Scroll (4th): Banishment", d:"Outer ring.", u:"Exile a foe", sp:4300, r:"rare"},
  {n:"Spell Scroll (4th): Guardian of Faith", d:"Tower motif.", u:"Stationary divine sentinel", sp:4200, r:"rare"},
  {n:"Spell Scroll (4th): Freedom of Movement", d:"Unbound knot.", u:"Ignore restraints", sp:4200, r:"rare"},

  // 5th-level
  {n:"Spell Scroll (5th): Dispel Evil and Good", d:"Cleansing seal.", u:"Breaks enchantments, banishes", sp:6800, r:"rare"},
  {n:"Spell Scroll (5th): Mass Cure Wounds", d:"Wide arc sun.", u:"Heal several allies", sp:6800, r:"rare"},
  {n:"Spell Scroll (5th): Hallow", d:"Consecrated wax.", u:"Sanctify a site", sp:7200, r:"rare"}
];


// ---------- Build type checkboxes ----------
(function(){
  const wrap = $("sg-types");
  const defaultSet = DEFAULT_SHOP_TYPES || new Set();
  Object.keys(SHOPS).forEach(k=>{
    const id = "sgt-"+k.replace(/[^a-z0-9]/gi,'');
    const col = document.createElement("div"); col.className="col";
    const isDefault = defaultSet.size ? defaultSet.has(k) : k !== "Black Market";
    col.innerHTML = `<div class="form-check">
        <input class="form-check-input" type="checkbox" id="${id}" data-type="${k}" ${isDefault?"checked":""}>
        <label class="form-check-label" for="${id}">${k}</label>
      </div>`;
    wrap.appendChild(col);
  });
})();

// ---------- Helpers ----------
function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
function within(rng, [a,b]){ return a + rng()*(b-a) }
function choiceByRarity(rng, items, weights, allowRare){
  // Map gating to a per-pick chance for 'rare' entering the pool
  const rareGate = (allowRare==='no') ? 0
                 : (allowRare==='auto') ? 0.02
                 : (allowRare==='low') ? 0.03
                 : (allowRare==='mid') ? 0.08
                 : (allowRare==='high') ? 0.15
                 : 0.05; // sane fallback

  const pool = items.filter(it => it.r !== 'rare' || rng() < rareGate);
  // Fallback if we accidentally eliminated all items
  const safePool = pool.length ? pool : items.filter(it => it.r !== 'rare');
  const usePool  = safePool.length ? safePool : items;

  const w = usePool.map(it => it.r==='common' ? weights.common
                             : it.r==='uncommon' ? weights.uncommon
                             : weights.rare);
  const total = w.reduce((a,b)=>a+b,0);
  let r = rng()*total;
  for(let i=0;i<usePool.length;i++){ if((r-=w[i])<=0) return usePool[i]; }
  return usePool[usePool.length-1];
}

function formatPrice(sp){
  if(sp>=10){ const gp = sp/10; return (gp%1? gp.toFixed(1): gp.toFixed(0))+" gp"; }
  return sp+" sp";
}
function priceWithSettlement(rng, baseSp, settle){
  const mul = within(rng, SETTLEMENT[settle].price);
  return Math.max(1, Math.round(baseSp*mul));
}
function uniqueLine(rng){
  const adj = pick(rng, FLAV_ADJ), mat = pick(rng, FLAV_MAT), dec = pick(rng, FLAV_DEC), uq = pick(rng, FLAV_UNIQUE);
  return `${adj} ${mat}, ${dec} pattern; ${uq}.`;
}
function decorateDesc(rng, d){
  if(rng()<0.6) d += ` ${pick(rng, FLAV_ADJ)} finish.`;
  if(rng()<0.35) d += ` ${pick(rng, FLAV_DEC)} detail.`;
  return d;
}

function slugifyShop(type, idx){
  const base = type.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
  return `shop-${base||'entry'}-${idx+1}`;
}

function populateShopNav(entries){
  const panel = $("sgNavPanel");
  const list = $("sgNavList");
  const toggle = $("sgNavToggle");
  if(!panel || !list || !toggle) return;

  if(!entries.length){
    list.innerHTML = "";
    panel.classList.add("d-none");
    toggle.classList.add("d-none");
    return;
  }

  list.innerHTML = entries.map((entry, idx)=>`
    <button type="button" class="shop-nav-link btn btn-sm btn-outline-light w-100 ${idx?"mt-1":""}" data-target="${entry.id}">
      ${entry.label}
    </button>
  `).join("");

  panel.classList.remove("d-none");
  toggle.classList.add("d-none");
}

function collapseShopNav(){
  const panel = $("sgNavPanel");
  const toggle = $("sgNavToggle");
  if(!panel || !toggle) return;
  panel.classList.add("d-none");
  toggle.classList.remove("d-none");
}

function expandShopNav(){
  const panel = $("sgNavPanel");
  const toggle = $("sgNavToggle");
  if(!panel || !toggle) return;
  panel.classList.remove("d-none");
  toggle.classList.add("d-none");
}

function scrollToShop(targetId){
  const el = document.getElementById(targetId);
  if(!el) return;
  const navHeight = document.getElementById("mainNav")?.offsetHeight || 0;
  const clearance = navHeight + 12;
  const top = el.getBoundingClientRect().top + window.scrollY - clearance;
  window.scrollTo({ top: Math.max(0, top), behavior: "smooth" });
}

// ---------- Shopkeeper Generation ----------
function makeShopkeeper(rng, shopType){
  // Determine shopkeeper type: 70% fitting, 20% ironic, 10% wrong field
  const roll = rng();
  let type, namePool;

  if (roll < 0.70) {
    type = 'fitting';
    namePool = pick(rng, [SHOPKEEPER_NAMES.generic, SHOPKEEPER_NAMES.generic, SHOPKEEPER_NAMES.humble]);
  } else if (roll < 0.90) {
    type = 'ironic';
    namePool = pick(rng, [SHOPKEEPER_NAMES.generic, SHOPKEEPER_NAMES.exotic]);
  } else {
    type = 'wrongField';
    namePool = pick(rng, [SHOPKEEPER_NAMES.exotic, SHOPKEEPER_NAMES.scholarly, SHOPKEEPER_NAMES.generic]);
  }

  const name = pick(rng, namePool);

  // Get personality trait based on type and shop
  const personalitySet = SHOPKEEPER_PERSONALITY[type][shopType] || SHOPKEEPER_PERSONALITY[type].default;
  const personality = pick(rng, personalitySet);

  return { name, personality, type };
}

// ---------- Generation ----------
function generate(){
  const seed = $("sg-seed").value.trim();
  const rng = prand(seed);
  const settlement = $("sg-settlement").value;
  const itemsPerShop = Math.max(5, Math.min(20, +$("sg-itemsPerShop").value||9));

  // Unique chance (user override or settlement default)
  const uniquePct = Math.max(0, Math.min(100, +$("sg-uniquePct").value||SETTLEMENT[settlement].uniquePct));
  const allowRareSel = $("sg-allowRare").value;
  const selected = [...document.querySelectorAll("#sg-types input:checked")].map(x=>x.dataset.type);
  if(!selected.length){ alert("Select at least one shop type."); return; }

  // meta pills
  const meta = $("sg-meta"); meta.innerHTML="";
  const presetOpt = $("sg-preset") ? $("sg-preset").value : "custom";
  const presetLabel = (presetOpt !== "custom") ? PRESETS[presetOpt].label : "Custom";
  [
    ["Preset", presetLabel],
    ["Settlement", settlement],
    ["Items/shop", itemsPerShop],
    ["Unique chance", uniquePct+"%"],
    ["Shop types", selected.length],
    ["Seed", seed||"(random)"]
  ].forEach(([k,v])=>{
    const sp=document.createElement("span");
    sp.className="sg-pill";
    sp.textContent=`${k}: ${v}`;
    meta.appendChild(sp);
  });


  const out = $("sg-out"); out.innerHTML="";
  const navEntries = [];

  // map UI select → gating token for choiceByRarity (expects 'no'|'auto'|'low'|'mid'|'high')
  const allowToken = (t)=>(
    t==='auto' ? SETTLEMENT[settlement].allowRare
    : t==='yes' ? 'high'
    : 'no'
  );

  selected.forEach((type, idx)=>{
    // Generate shopkeeper
    const shopkeeper = makeShopkeeper(rng, type);

    // One consistent markup per shop for realism
    const [pmin,pmax] = SETTLEMENT[settlement].price;
    const shopMarkup = within(rng, [pmin,pmax]); // e.g., 0.95–1.15 in towns
    const markupPct = Math.round((shopMarkup-1)*100);

    const shop = document.createElement("div");
    shop.className = "sg-shopcard";
    const anchorId = slugifyShop(type, idx);
    shop.id = anchorId;
    navEntries.push({ id: anchorId, label: type });
    shop.innerHTML = `
      <div class="p-3 border-bottom border-secondary d-flex justify-content-center align-items-start flex-wrap gap-2">
        <div class="text-center">
          <div class="fw-bold fs-5"><i class="bi bi-shop me-2"></i>${type}</div>
          <div class="text-muted small mt-1">
            <i class="bi bi-geo-alt-fill me-1"></i>${settlement.charAt(0).toUpperCase() + settlement.slice(1)}
            <span class="mx-2">•</span>
            <i class="bi bi-tag-fill me-1"></i>Markup: ${markupPct>=0?'+':''}${markupPct}%
          </div>
        </div>
      </div>
      <div class="p-3 border-bottom border-secondary bg-dark bg-opacity-25">
        <div class="d-flex justify-content-center align-items-start gap-2">
          <i class="bi bi-person-circle text-info fs-5"></i>
          <div>
            <div class="fw-semibold text-light">${shopkeeper.name}</div>
            <div class="small text-muted fst-italic">${shopkeeper.personality}</div>
          </div>
        </div>
      </div>
      <div class="p-0">
        <div class="table-responsive">
          <table class="sg-tbl">
            <thead><tr><th scope="col" style="width:22%">Item</th><th scope="col" style="width:32%">Description</th><th scope="col" style="width:12%">Use</th><th scope="col" style="width:8%">Stock</th><th scope="col" style="width:26%">Actions</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="sg-uniq mt-2 mx-3 mb-3"></div>
      </div>`;
    out.appendChild(shop);

    const tbody   = shop.querySelector("tbody");
    const uniqBox = shop.querySelector(".sg-uniq");

    const items   = SHOPS[type];
    const weights = SETTLEMENT[settlement].weights;
    const [stockMin, stockMax] = SETTLEMENT[settlement].stock;

    const seenKeys   = new Set();
    const listedNames= new Set();
    let tries = 0, rowsHtml = "";

    // Guard: avoid long spins if pool is tiny after rare gating
    const maxTries = Math.min(itemsPerShop, items.length) * 20;

    while (listedNames.size < itemsPerShop && tries++ < maxTries){
      const allowRare = allowToken(allowRareSel);
      const it = choiceByRarity(rng, items, weights, allowRare);
      const key = it.n+"|"+it.r;
      if(seenKeys.has(key)) continue;
      seenKeys.add(key);

      // Generate stock quantity based on settlement and rarity
      let stockQty;
      if (it.r === 'rare') {
        stockQty = Math.floor(rng() * 3) + 1; // 1-3 for rare items
      } else if (it.r === 'uncommon') {
        stockQty = Math.floor(rng() * (stockMax - stockMin + 1)) + stockMin; // Full settlement range
      } else {
        // Common items get more stock
        const bonus = Math.floor((stockMax - stockMin) * 0.5);
        stockQty = Math.floor(rng() * (stockMax - stockMin + 1 + bonus)) + stockMin;
      }

      // Extra surcharge on rares varies by settlement (previous behavior), then apply shop markup
      const rareAdj = (it.r==='rare')
        ? (settlement==='village'?1.6 : settlement==='town'?1.3 : 1.15)
        : 1;
      const sp = Math.max(1, Math.round(it.sp * rareAdj * shopMarkup));

      const d = decorateDesc(rng, it.d);
      const badge = it.r==='rare'
        ? ' <span class="badge text-bg-danger ms-1">rare</span>'
        : it.r==='uncommon'
        ? ' <span class="badge text-bg-warning text-dark ms-1">uncommon</span>'
        : '';

      rowsHtml += `
        <tr>
          <td data-label="Item">
            <div class="fw-semibold">${it.n}</div>
            ${badge}
          </td>
          <td data-label="Description" class="text-muted">${d}</td>
          <td data-label="Use" class="small">${it.u}</td>
          <td data-label="Stock" class="text-center"><span class="badge bg-secondary">${stockQty}</span></td>
          <td data-label="Actions">
            <div class="d-flex flex-wrap gap-1 align-items-center">
              <span class="fw-bold text-success me-2">${formatPrice(sp)}</span>
              <button class="btn btn-outline-info btn-sm negotiate-btn"
                data-item="${it.n.replace(/"/g, '&quot;')}"
                data-price="${sp}"
                data-rarity="${it.r || 'common'}"
                title="Negotiate Price">
                <i class="bi bi-chat-dots"></i>
              </button>
              <button class="btn btn-outline-success btn-sm add-to-character-btn"
                data-item="${it.n.replace(/"/g, '&quot;')}"
                data-description="${d.replace(/"/g, '&quot;')}"
                data-use="${it.u.replace(/"/g, '&quot;')}"
                data-price="${sp}"
                data-rarity="${it.r || 'common'}"
                title="Add to Character Inventory">
                <i class="bi bi-person-plus"></i>
              </button>
            </div>
          </td>
        </tr>`;

      listedNames.add(it.n);
    }

    tbody.innerHTML = rowsHtml;

    // Unique item (guaranteed not to duplicate a listed item)
    if (rng()*100 < uniquePct){
      let base, guard=0;
      do { base = pick(rng, items); } while (listedNames.has(base.n) && guard++ < 50);
      const usp = Math.max(1, Math.round(base.sp * 1.35 * shopMarkup));
      uniqBox.textContent = `Unique Stock: ${base.n} — ${uniqueLine(rng)} (${formatPrice(usp)})`;
    }
  });

  populateShopNav(navEntries);
}

// Copy / Download
function copyOut(){
  const blocks = [...document.querySelectorAll("#sg-out .sg-shopcard")].map(card=>{
    const title = card.querySelector(".fw-semibold").textContent.trim();
    const shopkeeperDivs = card.querySelectorAll(".p-2.border-bottom")[1]?.querySelectorAll("div");
    const shopkeeperInfo = shopkeeperDivs ? `Shopkeeper: ${shopkeeperDivs[0].textContent.replace('Shopkeeper: ', '')} - ${shopkeeperDivs[1].textContent}` : '';
    const rows = [...card.querySelectorAll("tbody tr")].map(tr=>{
      const t = tr.children[0].innerText.replace(/\s+(common|uncommon|rare)$/,'');
      const d = tr.children[1].innerText;
      const u = tr.children[2].innerText;
      const stock = tr.children[3].innerText;
      const p = tr.children[4].innerText;
      return `- ${t} | ${d} | Use: ${u} | Stock: ${stock} | ${p}`;
    });
    const uniq = card.querySelector(".sg-uniq").textContent.trim();
    return `# ${title}\n${shopkeeperInfo}\n${rows.join("\n")}${uniq?`\n* ${uniq}`:""}`;
  });
  if(!blocks.length) return;
  navigator.clipboard.writeText(blocks.join("\n\n"));
}
function downloadOut(){
  const text = [...document.querySelectorAll("#sg-out .sg-shopcard")].map(card=>card.innerText).join("\n\n---\n\n");
  if(!text.trim()) return;
  const blob = new Blob([text], {type:"text/plain"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.download="shops.txt"; a.click(); URL.revokeObjectURL(url);
}

// ---------- Negotiate Price Mechanic ----------
function calculateNegotiateDC(rarity){
  const dcMap = {
    'common': 12,
    'uncommon': 15,
    'rare': 18
  };
  return dcMap[rarity] || 15;
}

function showNegotiateModal(itemName, basePrice, rarity){
  const dc = calculateNegotiateDC(rarity);

  // Create modal if it doesn't exist
  let modal = document.getElementById("negotiateModal");
  if(!modal){
    modal = document.createElement("div");
    modal.id = "negotiateModal";
    modal.className = "modal fade";
    modal.tabIndex = -1;
    modal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header border-secondary">
            <h5 class="modal-title"><i class="bi bi-chat-dots me-2"></i>Negotiate Price</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <h6 class="text-info" id="negotiateItem"></h6>
              <p class="mb-1"><strong>Base Price:</strong> <span id="negotiateBasePrice"></span></p>
              <p class="mb-0"><strong>Rarity:</strong> <span id="negotiateRarity" class="badge"></span></p>
            </div>
            <hr class="border-secondary">
            <div class="mb-3">
              <h6 class="text-warning"><i class="bi bi-dice-6 me-2"></i>Persuasion Check</h6>
              <p class="mb-2"><strong>DC:</strong> <span id="negotiateDC"></span> <span id="negotiateDCLabel" class="text-secondary small"></span></p>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-dark table-bordered">
                <thead>
                  <tr>
                    <th>Result</th>
                    <th>Price</th>
                    <th>Discount</th>
                  </tr>
                </thead>
                <tbody id="negotiateResults"></tbody>
              </table>
            </div>
            <div class="alert alert-info small mb-0">
              <i class="bi bi-info-circle me-1"></i>
              Players make a <strong>Persuasion</strong> check. Success grants discounts; critical failure increases the price (shopkeeper offended)!
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);
  }

  // Populate modal content
  document.getElementById("negotiateItem").textContent = itemName;
  document.getElementById("negotiateBasePrice").textContent = formatPrice(basePrice);

  const rarityBadge = document.getElementById("negotiateRarity");
  rarityBadge.textContent = rarity.charAt(0).toUpperCase() + rarity.slice(1);
  rarityBadge.className = 'badge ' + (rarity === 'rare' ? 'text-bg-danger' : rarity === 'uncommon' ? 'text-bg-warning text-dark' : 'text-bg-secondary');

  document.getElementById("negotiateDC").textContent = dc;
  document.getElementById("negotiateDCLabel").textContent = `(${rarity === 'rare' ? 'Hard' : rarity === 'uncommon' ? 'Standard' : 'Easy'})`;

  // Calculate price outcomes
  const sp = basePrice;
  const outcomes = [
    { result: `Critical Success (Nat 20 or ${dc + 10}+)`, price: Math.max(1, Math.round(sp * 0.70)), discount: '30% off', class: 'table-success' },
    { result: `Success by 5+ (${dc + 5}+)`, price: Math.max(1, Math.round(sp * 0.80)), discount: '20% off', class: 'table-success' },
    { result: `Success (${dc}+)`, price: Math.max(1, Math.round(sp * 0.90)), discount: '10% off', class: 'table-success' },
    { result: `Failure (${dc - 1} or less)`, price: sp, discount: 'No discount', class: '' },
    { result: `Critical Failure (Nat 1 or ${dc - 10} or less)`, price: Math.max(1, Math.round(sp * 1.10)), discount: '+10% (offended!)', class: 'table-danger' }
  ];

  const tbody = document.getElementById("negotiateResults");
  tbody.innerHTML = outcomes.map(o => `
    <tr class="${o.class}">
      <td>${o.result}</td>
      <td>${formatPrice(o.price)}</td>
      <td>${o.discount}</td>
    </tr>
  `).join('');

  // Show modal
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

// ---------- Add to Character Inventory ----------
const STORAGE_KEY_CHARACTERS = 'dmtoolboxCharactersV1';

async function loadCharactersFromStorage() {
  // Check if IndexedDB is available
  if (typeof IndexedDBStorage !== 'undefined' && IndexedDBStorage.isSupported()) {
    try {
      let characters = await IndexedDBStorage.loadCharacters();
      if (characters.length === 0) {
        characters = await IndexedDBStorage.migrateFromLocalStorage(STORAGE_KEY_CHARACTERS);
      }
      return characters;
    } catch (error) {
      console.error('IndexedDB failed, falling back to localStorage:', error);
      return loadFromLocalStorage();
    }
  }
  return loadFromLocalStorage();
}

function loadFromLocalStorage() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_CHARACTERS);
    if (!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch (error) {
    console.error('Error loading characters from localStorage:', error);
    return [];
  }
}

async function saveCharactersToStorage(characters) {
  if (typeof IndexedDBStorage !== 'undefined' && IndexedDBStorage.isSupported()) {
    try {
      await IndexedDBStorage.saveCharacters(characters);
      return;
    } catch (error) {
      console.error('IndexedDB save failed, falling back to localStorage:', error);
    }
  }

  try {
    localStorage.setItem(STORAGE_KEY_CHARACTERS, JSON.stringify(characters));
  } catch (error) {
    console.error('Error saving to localStorage:', error);
    alert('Failed to save character data. Storage may be full.');
  }
}

async function showAddToCharacterModal(itemName, description, use, price, rarity) {
  // Load characters
  const characters = await loadCharactersFromStorage();

  if (!characters || characters.length === 0) {
    alert('No characters found. Please create a character first on the Characters page.');
    return;
  }

  // Create modal if it doesn't exist
  let modal = document.getElementById("addToCharacterModal");
  if (!modal) {
    modal = document.createElement("div");
    modal.id = "addToCharacterModal";
    modal.className = "modal fade";
    modal.tabIndex = -1;
    modal.innerHTML = `
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content bg-dark text-light">
          <div class="modal-header border-secondary">
            <h5 class="modal-title"><i class="bi bi-person-plus me-2"></i>Add to Character Inventory</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <h6 class="text-success" id="addItemName"></h6>
              <p class="mb-1 small"><strong>Description:</strong> <span id="addItemDescription"></span></p>
              <p class="mb-1 small"><strong>Use:</strong> <span id="addItemUse"></span></p>
              <p class="mb-1"><strong>Price:</strong> <span id="addItemPrice"></span></p>
              <p class="mb-0"><strong>Rarity:</strong> <span id="addItemRarity" class="badge"></span></p>
            </div>
            <hr class="border-secondary">
            <div class="mb-3">
              <label for="shopCharacterSelect" class="form-label"><strong>Select Character</strong></label>
              <select class="form-select" id="shopCharacterSelect">
                <option value="">-- Choose a character --</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="shopItemQuantity" class="form-label">Quantity</label>
              <input type="number" class="form-control" id="shopItemQuantity" min="1" value="1">
            </div>
            <div class="mb-3">
              <label for="shopItemWeight" class="form-label">Weight per Item (lb)</label>
              <input type="number" class="form-control" id="shopItemWeight" min="0" step="0.1" value="0" placeholder="Optional">
            </div>
            <div class="mb-3">
              <label for="shopItemNotes" class="form-label">Additional Notes</label>
              <textarea class="form-control" id="shopItemNotes" rows="2" placeholder="Optional notes about this item..."></textarea>
            </div>
            <div class="form-check form-switch mb-2">
              <input class="form-check-input" type="checkbox" id="shopItemEquipped">
              <label class="form-check-label" for="shopItemEquipped">Equipped</label>
            </div>
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="shopItemAttuned">
              <label class="form-check-label" for="shopItemAttuned">Attuned</label>
            </div>
          </div>
          <div class="modal-footer border-secondary">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-success" id="confirmAddToCharacter">Add to Inventory</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(modal);

    // Add event listener for confirm button
    document.getElementById("confirmAddToCharacter").addEventListener("click", async () => {
      await confirmAddItemToCharacter(itemName, description, use);
    });
  }

  // Populate modal content
  document.getElementById("addItemName").textContent = itemName;
  document.getElementById("addItemDescription").textContent = description;
  document.getElementById("addItemUse").textContent = use;
  document.getElementById("addItemPrice").textContent = formatPrice(price);

  const rarityBadge = document.getElementById("addItemRarity");
  rarityBadge.textContent = rarity.charAt(0).toUpperCase() + rarity.slice(1);
  rarityBadge.className = 'badge ' + (rarity === 'rare' ? 'text-bg-danger' : rarity === 'uncommon' ? 'text-bg-warning text-dark' : 'text-bg-secondary');

  // Populate character dropdown
  const select = document.getElementById("shopCharacterSelect");
  select.innerHTML = '<option value="">-- Choose a character --</option>';
  characters.forEach((char, index) => {
    const option = document.createElement("option");
    option.value = index;
    option.textContent = char.name || `Unnamed Character ${index + 1}`;
    select.appendChild(option);
  });

  // Reset form fields
  document.getElementById("shopItemQuantity").value = 1;
  document.getElementById("shopItemWeight").value = 0;
  document.getElementById("shopItemNotes").value = '';
  document.getElementById("shopItemEquipped").checked = false;
  document.getElementById("shopItemAttuned").checked = false;

  // Show modal
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

async function confirmAddItemToCharacter(itemName, description, use) {
  const characterIndex = document.getElementById("shopCharacterSelect").value;

  if (!characterIndex && characterIndex !== 0) {
    alert('Please select a character.');
    return;
  }

  const quantity = parseInt(document.getElementById("shopItemQuantity").value) || 1;
  const weight = parseFloat(document.getElementById("shopItemWeight").value) || 0;
  const notes = document.getElementById("shopItemNotes").value.trim();
  const equipped = document.getElementById("shopItemEquipped").checked;
  const attuned = document.getElementById("shopItemAttuned").checked;

  // Load characters fresh from storage
  const characters = await loadCharactersFromStorage();
  const charIndex = parseInt(characterIndex);
  const character = characters[charIndex];

  if (!character) {
    alert('Character not found.');
    return;
  }

  // Initialize inventory array if it doesn't exist
  if (!Array.isArray(character.inventoryItems)) {
    character.inventoryItems = [];
  }

  console.log('Current inventory before adding:', character.inventoryItems.length, 'items');

  // Create item object
  const newItem = {
    name: itemName,
    quantity: quantity,
    weight: weight,
    equipped: equipped,
    attuned: attuned,
    notes: notes ? `${description}. ${use}. ${notes}` : `${description}. ${use}`
  };

  // Add item to character inventory (append to existing array)
  character.inventoryItems.push(newItem);

  console.log('Inventory after adding:', character.inventoryItems.length, 'items');

  // Update the character in the array
  characters[charIndex] = character;

  // Save ALL characters back to storage (preserving the entire array)
  await saveCharactersToStorage(characters);

  // Close modal
  const modal = document.getElementById("addToCharacterModal");
  const bsModal = bootstrap.Modal.getInstance(modal);
  bsModal.hide();

  // Show success message
  alert(`Successfully added "${itemName}" to ${character.name || 'character'}'s inventory!`);
}

// Wire up
document.addEventListener("DOMContentLoaded", ()=>{
  // Simple/Advanced mode toggle
  const advancedKey = 'dmtools.advancedMode.shop';
  const advancedToggle = $('advancedModeToggle');
  const settingsBody = $('shopSettingsBody');

  const isAdvanced = localStorage.getItem(advancedKey) === 'true';
  advancedToggle.checked = isAdvanced;
  if (isAdvanced) settingsBody.classList.add('advanced-mode');

  advancedToggle.addEventListener('change', () => {
    if (advancedToggle.checked) {
      settingsBody.classList.add('advanced-mode');
      localStorage.setItem(advancedKey, 'true');
    } else {
      settingsBody.classList.remove('advanced-mode');
      localStorage.setItem(advancedKey, 'false');
    }
  });

  initPresets();
  $("sg-generate").addEventListener("click", generate);
  $("sg-copy").addEventListener("click", copyOut);
  $("sg-download").addEventListener("click", downloadOut);
  $("sg-clear").addEventListener("click", ()=>{
    $("sg-out").innerHTML="";
    $("sg-meta").innerHTML="";
    populateShopNav([]);
  });
  $("sg-selectAll").addEventListener("click", (e)=>{
    e.preventDefault();
    document.querySelectorAll("#sg-types input").forEach(i=>i.checked=true);
    if($("sg-preset")) $("sg-preset").value = "custom";
  });
  $("sg-selectNone").addEventListener("click", (e)=>{
    e.preventDefault();
    document.querySelectorAll("#sg-types input").forEach(i=>i.checked=false);
    if($("sg-preset")) $("sg-preset").value = "custom";
  });

  if($("sgNavToggle")) $("sgNavToggle").addEventListener("click", expandShopNav);
  if($("sgNavDismiss")) $("sgNavDismiss").addEventListener("click", collapseShopNav);
  // Defaults tuned per settlement on change
  $("sg-settlement").addEventListener("change", ()=>{
    const s = $("sg-settlement").value;
    const def = SETTLEMENT[s].uniquePct;
    $("sg-uniquePct").value = def;
    const [min,max] = SETTLEMENT[s].stock;
    $("sg-itemsPerShop").value = Math.round((min+max)/2);
  });

  // Event delegation for negotiate buttons
  document.addEventListener("click", (e)=>{
    if(e.target.closest(".negotiate-btn")){
      const btn = e.target.closest(".negotiate-btn");
      const itemName = btn.getAttribute("data-item");
      const price = parseInt(btn.getAttribute("data-price"), 10);
      const rarity = btn.getAttribute("data-rarity");
      showNegotiateModal(itemName, price, rarity);
    }

    // Event delegation for add to character buttons
    if(e.target.closest(".add-to-character-btn")){
      const btn = e.target.closest(".add-to-character-btn");
      const itemName = btn.getAttribute("data-item");
      const description = btn.getAttribute("data-description");
      const use = btn.getAttribute("data-use");
      const price = parseInt(btn.getAttribute("data-price"), 10);
      const rarity = btn.getAttribute("data-rarity");
      showAddToCharacterModal(itemName, description, use, price, rarity);
    }

    const navLink = e.target.closest(".shop-nav-link");
    if(navLink){
      scrollToShop(navLink.dataset.target);
    }
  });

  // First run
  generate();
});
})();
</script>
<!-- ===== /Shop Generator ===== -->

    </div>
  </main>
  <!-- Footer -->
  <footer class="container-fluid mt-5 site-footer" role="contentinfo">
    <div class="footer-main py-3">
      <div class="container">
        <div class="row align-items-center text-center text-md-start">
          <!-- Left: Copyright -->
          <div class="col-12 col-md-4 mb-2 mb-md-0 text-md-start text-center">
            <small class="text-muted">&copy; 2025 Maybeme | The DM’s Toolbox</small>
          </div>

          <!-- Center: Logo -->
          <div class="col-12 col-md-4 text-center mb-2 mb-md-0">
            <img src="/images/White logo MM- no background.png" height="40" alt="Logo" class="footer-logo">
          </div>

          <!-- Right: Social Links + Settings -->
          <div class="col-12 col-md-4 d-flex justify-content-center justify-content-md-end align-items-center gap-2">
            <a href="https://www.linkedin.com/in/marlo-mayberry-930ab9b7/" class="socialicons" target="_blank" rel="noopener" aria-label="LinkedIn">
              <i class="bi bi-linkedin"></i>
            </a>
            <a href="https://github.com/M-ybeme" class="socialicons" target="_blank" rel="noopener" aria-label="GitHub">
              <i class="bi bi-github"></i>
            </a>
            <a href="https://ko-fi.com/maybemestoolbox" class="socialicons d-flex align-items-center" target="_blank" rel="noopener" title="Support The DM's Toolbox on Ko-fi">
              <i class="bi bi-cup-hot"></i>
            </a>
            <button type="button" class="socialicons" onclick="window.toggleDiagnosticsPanel?.()"
                    title="Open Settings &amp; Diagnostics" aria-label="Open Settings and Diagnostics panel">
              <i class="bi bi-gear"></i>
            </button>
          </div>
        </div>
      </div>
    </div>
  </footer>
  <script data-goatcounter="https://maybeme1990.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>