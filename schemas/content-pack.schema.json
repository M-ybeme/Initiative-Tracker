{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://dnddmtoolbox.app/schemas/content-pack.schema.json",
  "title": "DM's Toolbox Content Pack",
  "description": "Schema for private content packs that extend the SRD-only build at runtime.",
  "type": "object",
  "additionalProperties": false,
  "required": ["metadata"],
  "properties": {
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "name", "version", "license", "toolVersion"],
      "properties": {
        "id": {
          "type": "string",
          "pattern": "^[a-z0-9](?:[a-z0-9_.-]{0,61}[a-z0-9])?(?:\\.[a-z0-9](?:[a-z0-9_.-]{0,61}[a-z0-9])?)*$",
          "description": "Reverse-domain or slug identifier (e.g., com.example.eberron)."
        },
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 160
        },
        "version": {
          "type": "string",
          "pattern": "^([0-9]+\\.){2}[0-9]+$",
          "description": "Semantic version string (e.g., 1.0.0)."
        },
        "description": {
          "type": "string",
          "maxLength": 800
        },
        "authors": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1,
            "maxLength": 80
          },
          "minItems": 1,
          "uniqueItems": true
        },
        "license": {
          "type": "string",
          "minLength": 3,
          "maxLength": 200,
          "description": "Text describing how the pack may be used (e.g., Private use only)."
        },
        "source": {
          "type": "string",
          "maxLength": 200,
          "description": "Human-readable citation (e.g., Player's Handbook)."
        },
        "homepage": {
          "type": "string",
          "format": "uri"
        },
        "created": {
          "type": "string",
          "format": "date-time"
        },
        "updated": {
          "type": "string",
          "format": "date-time"
        },
        "toolVersion": {
          "type": "string",
          "pattern": "^([0-9]+\\.){2}[0-9]+$",
          "description": "Version of The DM's Toolbox that exported the pack."
        }
      }
    },
    "dependencies": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id"],
        "additionalProperties": false,
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-z0-9](?:[a-z0-9_.-]{0,61}[a-z0-9])?(?:\\.[a-z0-9](?:[a-z0-9_.-]{0,61}[a-z0-9])?)*$"
          },
          "minVersion": {
            "type": "string",
            "pattern": "^([0-9]+\\.){2}[0-9]+$"
          }
        }
      },
      "uniqueItems": true
    },
    "allowlist": {
      "type": "object",
      "description": "Override entries for SRD gating. Keys correspond to SRDContentFilter types.",
      "additionalProperties": {
        "type": "array",
        "items": {
          "type": "string",
          "minLength": 1,
          "maxLength": 160
        },
        "uniqueItems": true
      }
    },
    "records": {
      "type": "array",
      "items": {
        "$ref": "#/$defs/record"
      }
    },
    "assets": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["id", "usage", "data"],
        "additionalProperties": false,
        "properties": {
          "id": {
            "type": "string",
            "pattern": "^[a-zA-Z0-9._-]{1,64}$"
          },
          "usage": {
            "type": "string",
            "enum": ["token", "portrait", "map-overlay", "handout"]
          },
          "data": {
            "type": "string",
            "contentEncoding": "base64",
            "description": "Data URL or base64 payload."
          },
          "description": {
            "type": "string",
            "maxLength": 200
          }
        }
      },
      "uniqueItems": true
    },
    "notes": {
      "type": "string",
      "maxLength": 2000
    }
  },
  "$defs": {
    "record": {
      "type": "object",
      "additionalProperties": false,
      "required": ["type", "id", "operation"],
      "properties": {
        "type": {
          "type": "string",
          "enum": [
            "class",
            "subclass",
            "feat",
            "background",
            "spell",
            "item",
            "generator-table",
            "class-resource",
            "class-equipment-choice",
            "class-equipment-default",
            "class-starting-gold",
            "beast",
            "artificer-infusion",
            "note"
          ]
        },
        "id": {
          "type": "string",
          "minLength": 1,
          "maxLength": 160
        },
        "operation": {
          "type": "string",
          "enum": ["add", "replace", "remove"]
        },
        "payload": {
          "oneOf": [
            { "$ref": "#/$defs/classPayload" },
            { "$ref": "#/$defs/subclassPayload" },
            { "$ref": "#/$defs/spellPayload" },
            { "$ref": "#/$defs/backgroundPayload" },
            { "$ref": "#/$defs/featPayload" },
            { "$ref": "#/$defs/itemPayload" },
            { "$ref": "#/$defs/generatorTablePayload" },
            { "$ref": "#/$defs/classResourcePayload" },
            { "$ref": "#/$defs/genericPayload" }
          ]
        }
      },
      "allOf": [
        {
          "if": {
            "properties": { "operation": { "const": "remove" } }
          },
          "then": {
            "not": { "required": ["payload"] }
          },
          "else": {
            "required": ["payload"]
          }
        },
        {
          "if": { "properties": { "type": { "const": "class" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/classPayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "subclass" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/subclassPayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "spell" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/spellPayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "background" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/backgroundPayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "feat" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/featPayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "item" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/itemPayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "generator-table" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/generatorTablePayload" } } }
        },
        {
          "if": { "properties": { "type": { "const": "class-resource" } } },
          "then": { "properties": { "payload": { "$ref": "#/$defs/classResourcePayload" } } }
        }
      ]
    },
    "classPayload": {
      "type": "object",
      "required": [
        "hitDice",
        "primaryAbility",
        "savingThrows",
        "armorProficiencies",
        "weaponProficiencies",
        "toolProficiencies",
        "spellcastingProgression",
        "featuresByLevel"
      ],
      "additionalProperties": true,
      "properties": {
        "hitDice": {
          "type": "string",
          "enum": ["d6", "d8", "d10", "d12"]
        },
        "primaryAbility": {
          "type": "string",
          "enum": ["str", "dex", "con", "int", "wis", "cha"]
        },
        "savingThrows": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": ["str", "dex", "con", "int", "wis", "cha"]
          },
          "minItems": 2,
          "maxItems": 2,
          "uniqueItems": true
        },
        "armorProficiencies": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "weaponProficiencies": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "toolProficiencies": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "spellcastingProgression": {
          "type": "string",
          "enum": ["none", "half", "third", "full"]
        },
        "featuresByLevel": {
          "type": "object",
          "propertyNames": {
            "pattern": "^([1-9]|1[0-9]|20)$"
          },
          "additionalProperties": {
            "type": "array",
            "items": {
              "type": "string",
              "minLength": 1
            }
          }
        },
        "resources": {
          "type": "array",
          "items": { "$ref": "#/$defs/classResourcePayload" }
        },
        "subclassLevels": {
          "type": "array",
          "items": {
            "type": "integer",
            "minimum": 1,
            "maximum": 20
          },
          "uniqueItems": true
        }
      }
    },
    "subclassPayload": {
      "type": "object",
      "required": ["parentClass", "featuresByLevel"],
      "additionalProperties": true,
      "properties": {
        "parentClass": {
          "type": "string",
          "minLength": 1,
          "maxLength": 80
        },
        "featuresByLevel": {
          "$ref": "#/$defs/classPayload/properties/featuresByLevel"
        }
      }
    },
    "spellPayload": {
      "type": "object",
      "required": [
        "title",
        "level",
        "school",
        "casting",
        "range",
        "components",
        "duration",
        "description"
      ],
      "additionalProperties": true,
      "properties": {
        "title": {
          "type": "string",
          "minLength": 1,
          "maxLength": 80
        },
        "level": {
          "type": "integer",
          "minimum": 0,
          "maximum": 9
        },
        "school": {
          "type": "string",
          "minLength": 3,
          "maxLength": 30
        },
        "casting": {
          "type": "string",
          "maxLength": 120
        },
        "range": {
          "type": "string",
          "maxLength": 80
        },
        "components": {
          "type": "string",
          "maxLength": 80
        },
        "duration": {
          "type": "string",
          "maxLength": 120
        },
        "description": {
          "type": "string",
          "maxLength": 4000
        },
        "classes": {
          "type": "array",
          "items": { "type": "string", "minLength": 1 },
          "uniqueItems": true
        }
      }
    },
    "backgroundPayload": {
      "type": "object",
      "required": ["name", "proficiencies", "equipment"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 80
        },
        "proficiencies": {
          "type": "object",
          "required": ["skills"],
          "properties": {
            "skills": {
              "type": "array",
              "items": { "type": "string" },
              "minItems": 2,
              "uniqueItems": true
            },
            "tools": {
              "type": "array",
              "items": { "type": "string" },
              "uniqueItems": true
            }
          }
        },
        "equipment": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        },
        "feature": {
          "type": "object",
          "required": ["name", "description"],
          "properties": {
            "name": { "type": "string", "minLength": 1 },
            "description": { "type": "string", "maxLength": 2000 }
          }
        }
      }
    },
    "featPayload": {
      "type": "object",
      "required": ["name", "summary"],
      "additionalProperties": true,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "maxLength": 80
        },
        "summary": {
          "type": "string",
          "maxLength": 1200
        },
        "prerequisites": {
          "type": "array",
          "items": { "type": "string", "maxLength": 120 },
          "uniqueItems": true
        }
      }
    },
    "itemPayload": {
      "type": "object",
      "required": ["name", "category"],
      "additionalProperties": true,
      "properties": {
        "name": { "type": "string", "maxLength": 80 },
        "category": { "type": "string", "maxLength": 40 },
        "cost": { "type": "string", "maxLength": 40 },
        "weight": { "type": "number", "minimum": 0 },
        "properties": {
          "type": "array",
          "items": { "type": "string" },
          "uniqueItems": true
        }
      }
    },
    "generatorTablePayload": {
      "type": "object",
      "required": ["table", "entries"],
      "additionalProperties": false,
      "properties": {
        "table": {
          "type": "string",
          "enum": ["loot", "shop", "tavern", "npc", "name"]
        },
        "entries": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "required": ["value"],
            "additionalProperties": false,
            "properties": {
              "value": { "type": "string", "maxLength": 400 },
              "weight": { "type": "number", "minimum": 0 },
              "tags": {
                "type": "array",
                "items": { "type": "string", "maxLength": 40 },
                "uniqueItems": true
              }
            }
          }
        }
      }
    },
    "classResourcePayload": {
      "type": "object",
      "required": ["className", "name", "max"],
      "additionalProperties": true,
      "properties": {
        "className": { "type": "string", "minLength": 1 },
        "name": { "type": "string", "minLength": 1 },
        "max": { "type": "integer", "minimum": 0 },
        "recovery": { "type": "string", "enum": ["short", "long", "encounter"] }
      }
    },
    "genericPayload": {
      "description": "Fallback structure for new record types; must be an object or array.",
      "type": ["object", "array"]
    }
  }
}
